window.wooga.castle.playerData = {"diamonds":0,"goals":{"4001":{"subgoals":{"4001s0":0},"state":1}},"xp":0,"level":1,"gold":1500,"map":{"entities":[{"x":-14,"y":10,"key":"nature/tree-small"},{"x":-15,"y":7,"key":"nature/tree-small"},{"x":-15,"y":5,"key":"nature/tree-big"},{"x":-3,"y":9,"key":"nature/tree-big"},{"x":-12,"y":2,"key":"buildings/castle_1"},{"x":-5,"y":5,"contract":{"startTime":128817470133,"state":"finished"},"key":"buildings/knights_house"},{"x":-6,"y":0,"contract":{"seedName":"farming/seed-pumpkin","state":"finished"},"key":"farming/basic_plot"},{"x":-4,"y":0,"contract":{"seedName":"farming/seed-pumpkin","state":"finished"},"key":"farming/basic_plot"},{"x":-6,"y":6,"key":"decorations/flower_sunflower"},{"x":0,"y":4,"key":"decorations/pond"},{"x":2,"y":-3,"key":"decorations/fountain_rock"},{"x":-2,"y":6,"key":"decorations/flower_sunflower"},{"x":-6,"y":-1,"key":"decorations/scarecrow"},{"x":-3,"y":-1,"key":"decorations/well"},{"x":-13,"y":11,"key":"nature/rock-big-1"},{"x":-14,"y":8,"key":"nature/rock-big-1"},{"x":-2,"y":1,"key":"nature/rock-big-1"},{"x":-5,"y":10,"contract":{"state":"idle"},"key":"buildings/ship_stage_1"},{"x":-10,"y":7,"key":"paths/road"},{"x":-5,"y":8,"key":"paths/road"},{"x":-8,"y":1,"key":"paths/road"},{"x":-9,"y":1,"key":"paths/road"},{"x":-9,"y":7,"key":"paths/road"},{"x":-8,"y":7,"key":"paths/road"},{"x":-7,"y":7,"key":"paths/road"},{"x":-7,"y":6,"key":"paths/road"},{"x":-7,"y":5,"key":"paths/road"},{"x":-7,"y":4,"key":"paths/road"},{"x":-7,"y":3,"key":"paths/road"},{"x":-7,"y":2,"key":"paths/road"},{"x":-7,"y":1,"key":"paths/road"},{"x":-7,"y":0,"key":"paths/road"},{"x":-6,"y":2,"key":"paths/road"},{"x":-8,"y":-2,"key":"paths/road"},{"x":-7,"y":-1,"key":"paths/road"},{"x":-7,"y":-2,"key":"paths/road"},{"x":-7,"y":-3,"key":"paths/road"},{"x":-6,"y":7,"key":"paths/road"},{"x":-5,"y":7,"key":"paths/road"},{"x":-4,"y":7,"key":"paths/road"},{"x":-3,"y":7,"key":"paths/road"},{"x":-2,"y":7,"key":"paths/road"},{"x":-1,"y":7,"key":"paths/road"},{"x":0,"y":7,"key":"paths/road"},{"x":-6,"y":-2,"key":"nature/tree-big"},{"x":-3,"y":-2,"key":"nature/tree-big"},{"x":-2,"y":0,"key":"nature/tree-big"},{"x":-5,"y":-2,"key":"nature/tree-big"},{"x":-12,"y":7,"key":"characters/troll"},{"x":-13,"y":-6,"contract":{"startTime":132881747013,"state":"finished"},"key":"buildings/lighthouse"},{"x":-4,"y":-12,"contract":{"startTime":132881747013,"state":"finished"},"key":"buildings/fortress"},{"x":8,"y":-6,"contract":{"startTime":132881747013,"state":"finished"},"key":"buildings/ozzystent"},{"x":10,"y":9,"contract":{"startTime":132881747013,"state":"finished"},"key":"buildings/elves"},{"x":9,"y":-13,"contract":{"startTime":132881747013,"state":"finished"},"key":"buildings/vikingsmith"}],"height":32,"width":32},"dataVersion":0,"_lastEnergyUpdate":1312891410570,"food":400} ;
window.wooga.castle.entityDefinitions = {"item/key3":{"name":"Anchor","url":"unlock/anchor.png","height":2,"width":2},"contracts/exclamation":{"url":"contracts/exclamation_mark.png","height":1.64,"width":1.64},"buildings/bath_house":{"spritey":8,"name":"Bath House","selectable":true,"class":"house","diamondCost":12,"unlockCondition":"level","goldCost":4000,"unlockValue":12,"draggable":true,"url":"buildings30.png","destroyGainGold":1333,"icon":"buildings/bath_house-icon.png","contract":{"requiredTime":120000,"providedXP":1,"providedGold":84,"constructionTime":48000000,"requiredFood":45},"height":3,"unlockCost":10,"offsetY":-1,"width":4},"nature/tree-big-1-y":{"spritey":8,"hasWhackStates":true,"class":"tree","url":"nature/big-treev1-squashed.png","icon":"nature/tree-big-icon.png","rewards":{"whack":[],"complete":[{"amount":4,"type":"xp"}]},"whacks":4,"height":4,"offsetY":-3,"width":3},"buildings/ozzystent":{"spritey":0,"name":"Ozzy's Tent","selectable":true,"class":"statichouse","diamondCost":10,"unlockCondition":"item","goldCost":0,"unlockValue":"unlock/key","draggable":false,"url":"buildings/ozzystent.png","destroyGainGold":0,"icon":"buildings/royal_summer_house-icon.png","drops":"item/key4","contract":{"requiredTime":82800000,"providedXP":23,"providedGold":660,"requiredFood":0},"height":5,"unlockCost":1,"offsetY":-2,"width":3},"item/key4":{"name":"Rudder","url":"unlock/rudder.png","height":2,"width":2},"construction/4x2":{"spritey":10,"url":"construction.png","height":3,"offsetY":-1,"width":4},"invites/architect":{"name":"Hire an Architect","cost":20000,"specialistImg":"invites/architect.png"},"coastmap":{"url":"coastmap.png"},"buildings/ladys_house":{"spritey":19,"name":"Lady's House","selectable":true,"class":"uhouse","diamondCost":30,"unlockCondition":"level","goldCost":12000,"unlockValue":30,"draggable":true,"url":"buildings0.png","destroyGainGold":4000,"icon":"buildings/ladys_house-icon.png","contract":{"requiredTime":57600000,"providedXP":19,"providedGold":230,"constructionTime":18000000,"requiredFood":0},"height":4,"unlockCost":10,"offsetY":-1,"width":4},"buildings/elves":{"spritey":0,"name":"Tree House","selectable":true,"class":"statichouse","diamondCost":10,"unlockCondition":"item","goldCost":0,"unlockValue":"unlock/key","draggable":false,"url":"buildings/elves.png","destroyGainGold":0,"icon":"buildings/royal_summer_house-icon.png","drops":"item/key3","contract":{"requiredTime":82800000,"providedXP":22,"providedGold":640,"requiredFood":0},"height":5,"unlockCost":1,"offsetY":-1,"width":3},"item/key5":{"name":"Sails","url":"unlock/sails.png","height":2,"width":2},"invites/locksmith":{"name":"Hire a Locksmith","cost":3000,"specialistImg":"invites/locksmith.png"},"construction/4x3":{"spritey":13,"url":"construction.png","height":4,"offsetY":-1,"width":4},"buildings/elves-hidden":{"spritey":0,"url":"buildings/elves-hidden.png","height":5,"width":3},"construction/4x4":{"spritey":17,"url":"construction.png","height":5,"offsetY":-1,"width":4},"buildings/poor_house":{"spritey":5,"name":"Peasant House","selectable":true,"class":"uhouse","diamondCost":1,"unlockCondition":"level","goldCost":150,"unlockValue":1,"population":1,"draggable":true,"url":"buildings0.png","destroyGainGold":50,"icon":"buildings/poor_house-icon.png","contract":{"requiredTime":180000,"providedXP":1,"providedGold":10,"constructionTime":5000,"requiredFood":0},"height":3,"unlockCost":10,"offsetY":-1,"width":2},"invites/landscaper":{"name":"Hire a Landscaper","cost":50000,"specialistImg":"invites/landscaper.png"},"decorations/flower_rose":{"spritey":0,"name":"Rose","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":1,"draggable":true,"goldCost":50,"unlockValue":3,"url":"decorations.png","foodBoost":0,"goldBoost":1,"destroyGainGold":17,"icon":"decorations/flower_rose-icon.png","height":1,"offsetY":0,"width":1},"characters/giant":{"name":"Giant","selectable":false,"zIndex":10,"class":"enemy","whackRewards":[{"amount":1,"type":"xp"}],"draggable":false,"url":"characters/giant.png","icon":"characters/giant.png","animation":{"length":6},"height":6,"killRewards":[{"amount":100,"type":"gold"}],"hp":3,"xOffsetRight":-2,"xOffsetLeft":2,"offsetY":-5,"width":6},"buildings/lighthouse":{"spritey":0,"name":"Swamp Lighthouse","selectable":true,"class":"statichouse","diamondCost":10,"unlockCondition":"item","goldCost":0,"unlockValue":"unlock/key","draggable":false,"url":"buildings/lighthouse.png","destroyGainGold":0,"icon":"buildings/royal_summer_house-icon.png","drops":"item/key1","contract":{"requiredTime":82800000,"providedXP":20,"providedGold":600,"requiredFood":0},"height":6,"xOffsetRight":-1,"xOffsetLeft":1,"unlockCost":1,"offsetY":-4,"width":4},"unlock/1":{"name":"Dark Forest","spritey":24,"x":-16,"class":"unlockable","y":-6,"unlock":5,"url":"backgrounds/unlockies.png","contract":{"requiredTime":300000},"height":6,"width":16,"spritex":32},"paths/road-10":{"spritey":10,"url":"paths.png"},"buildings/artist_studio":{"spritey":4,"name":"Artist Studio","selectable":true,"class":"house","diamondCost":6,"unlockCondition":"level","goldCost":1200,"unlockValue":6,"draggable":true,"url":"buildings30.png","destroyGainGold":400,"icon":"buildings/artist_studio-icon.png","contract":{"requiredTime":90000,"providedXP":1,"providedGold":125,"constructionTime":24000000,"requiredFood":80},"height":4,"unlockCost":10,"offsetY":-1,"width":4},"invites/painter":{"name":"Hire a Painter","cost":40000,"specialistImg":"invites/painter.png"},"buildings/knights_house":{"spritey":11,"name":"Knight's House","selectable":true,"class":"uhouse","diamondCost":4,"unlockCondition":"level","goldCost":800,"unlockValue":4,"draggable":true,"url":"buildings0.png","destroyGainGold":267,"icon":"buildings/knights_house-icon.png","contract":{"requiredTime":82800000,"providedXP":28,"providedGold":200,"constructionTime":6000000,"requiredFood":0},"height":4,"unlockCost":10,"offsetY":-2,"width":3},"buildings/fortress":{"spritey":0,"name":"Fortified Fortress","selectable":true,"class":"statichouse","diamondCost":10,"unlockCondition":"item","goldCost":0,"unlockValue":"unlock/key","draggable":false,"url":"buildings/fortress.png","destroyGainGold":0,"icon":"buildings/royal_summer_house-icon.png","drops":"item/key2","contract":{"requiredTime":82800000,"providedXP":21,"providedGold":620,"requiredFood":0},"height":5,"unlockCost":1,"offsetY":-2,"width":3},"buildings/lighthouse-hidden":{"spritey":0,"url":"buildings/lighthouse-hidden.png","height":6,"width":4},"unlock/2":{"name":"Enchanted Outpost","spritey":0,"x":-16,"class":"unlockable","y":-14,"unlock":10,"url":"backgrounds/unlockies.png","contract":{"requiredTime":600000},"height":8,"width":16,"spritex":0},"paths/road-11":{"spritey":13,"url":"paths.png"},"contracts/no_road":{"url":"contracts/no_road.png","height":1.5,"width":1.5},"buildings/unicorn_stable":{"spritey":0,"name":"Unicorn Stable","selectable":true,"class":"house","diamondCost":21,"unlockCondition":"level","goldCost":6900,"unlockValue":21,"draggable":true,"url":"buildings30.png","destroyGainGold":2300,"icon":"buildings/unicorn_stable-icon.png","contract":{"requiredTime":180000,"providedXP":1,"providedGold":81,"constructionTime":58000000,"requiredFood":35},"height":4,"unlockCost":10,"offsetY":-1,"width":4},"farming/seed-strawberry":{"spritey":10,"name":"Strawberries","class":"seeds","unlockCondition":"level","unlockValue":5,"url":"farming.png","icon":"farming/seed-strawberry-icon.png","contract":{"requiredGold":65,"requiredTime":43200000,"providedFood":240,"providedXP":1}},"unlock/3":{"name":"Haunted Gardens","spritey":18,"x":0,"class":"unlockable","y":0,"unlock":15,"url":"backgrounds/unlockies.png","contract":{"requiredTime":1200000},"height":18,"width":16,"spritex":16},"paths/road-12":{"spritey":3,"url":"paths.png"},"invites/mechanic":{"name":"Hire a Mechanic","cost":10000,"specialistImg":"invites/mechanic.png"},"farming/seed-wheat":{"spritey":14,"name":"Wheat","class":"seeds","unlockCondition":"level","unlockValue":6,"url":"farming.png","icon":"farming/seed-wheat-icon.png","contract":{"requiredGold":75,"requiredTime":86400000,"providedFood":240,"providedXP":1}},"buildings/horse_stable":{"spritey":0,"name":"Horse Stable","selectable":true,"class":"house","diamondCost":11,"unlockCondition":"level","goldCost":3500,"unlockValue":11,"draggable":true,"url":"buildings20.png","destroyGainGold":1167,"icon":"buildings/horse_stable-icon.png","contract":{"requiredTime":90000,"providedXP":1,"providedGold":72,"constructionTime":48000000,"requiredFood":40},"height":4,"unlockCost":10,"offsetY":-1,"width":4},"invites/smith":{"name":"Hire a Smith","cost":30000,"specialistImg":"invites/smith.png"},"unlock/key":{"url":"unlock/key.png","height":2,"width":2},"unlock/4":{"name":"Oracle's Lair","spritey":24,"x":0,"class":"unlockable","y":-6,"unlock":24,"url":"backgrounds/unlockies.png","contract":{"requiredTime":86400000},"height":6,"width":16,"spritex":16},"paths/road-13":{"spritey":15,"url":"paths.png"},"buildings/ship_stage_1":{"spritey":0,"name":"Drydock","selectable":true,"class":"ship","url":"buildings0.png","upgradeTo":"buildings/ship_stage_2","contract":{"requiredTime":60000,"rewards":[{"amount":1000,"type":"gold"}]},"requiredItem":"item/key1","height":5,"upgradeCost":100,"offsetY":-3,"width":5},"decorations/flower_sunflower":{"spritey":6,"name":"Sunflower","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":2,"draggable":true,"goldCost":200,"unlockValue":9,"url":"decorations.png","foodBoost":0,"goldBoost":2,"destroyGainGold":67,"icon":"decorations/flower_sunflower-icon.png","height":2,"offsetY":-1,"width":1},"unlock/5":{"name":"Mystical Forge","spritey":0,"x":0,"class":"unlockable","y":-14,"unlock":32,"url":"backgrounds/unlockies.png","contract":{"requiredTime":86400000},"height":8,"width":16,"spritex":16},"paths/road-14":{"spritey":14,"url":"paths.png"},"buildings/ship_stage_2":{"spritey":0,"name":"Drydock 2","selectable":true,"class":"ship","url":"drydock.png","upgradeTo":"buildings/ship_stage_3","contract":{"requiredTime":480000,"rewards":[{"amount":2000,"type":"gold"}]},"requiredItem":"item/key2","height":5,"upgradeCost":100,"offsetY":-3,"width":5},"buildings/medieval_university":{"spritey":0,"name":"Medieval University","selectable":true,"class":"house","diamondCost":34,"unlockCondition":"level","goldCost":20000,"unlockValue":34,"draggable":true,"url":"buildings40.png","destroyGainGold":6667,"icon":"buildings/medieval_university-icon.png","contract":{"requiredTime":240000,"providedXP":1,"providedGold":95,"constructionTime":58000000,"requiredFood":40},"height":3,"unlockCost":10,"offsetY":-1,"width":4},"decorations/windmill":{"spritey":41,"name":"Windmill","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":1,"draggable":true,"goldCost":800,"unlockValue":7,"url":"decorations.png","foodBoost":8,"goldBoost":0,"destroyGainGold":267,"icon":"decorations/windmill-icon.png","height":3,"offsetY":-1,"width":2},"farming/seed-melon":{"spritey":6,"name":"Watermelons","class":"seeds","unlockCondition":"level","unlockValue":1,"url":"farming.png","icon":"farming/seed-melon-icon.png","contract":{"requiredGold":10,"requiredTime":180000,"providedFood":10,"providedXP":1}},"paths/road-15":{"spritey":9,"url":"paths.png"},"buildings/ship_stage_3":{"spritey":5,"name":"Drydock 3","selectable":true,"class":"ship","url":"drydock.png","upgradeTo":"buildings/ship_stage_4","contract":{"requiredTime":480000,"rewards":[{"amount":10000,"type":"gold"}]},"requiredItem":"item/key3","height":5,"upgradeCost":100,"offsetY":-3,"width":5},"nature/rock":{"hasWhackStates":true,"class":"rock","url":"nature/rocks.png","rewards":{"whack":[{"amount":3,"type":"xp"}],"complete":[{"amount":30,"type":"gold"}]},"whacks":4,"height":2,"offsetY":0,"width":2},"characters/troll":{"name":"Troll","selectable":false,"zIndex":10,"class":"enemy","whackRewards":[{"amount":1,"type":"xp"}],"draggable":false,"url":"characters/troll.png","icon":"characters/troll-icon.png","animation":{"length":6},"height":5,"killRewards":[{"amount":100,"type":"gold"}],"hp":3,"xOffsetRight":-4,"xOffsetLeft":1,"offsetY":-4,"width":8},"nature/tree-small-b":{"spritey":0,"hasWhackStates":true,"class":"tree","url":"nature/small-tree-squashed.png","icon":"nature/tree-small-icon.png","rewards":{"whack":[],"complete":[{"amount":2,"type":"xp"}]},"height":4,"whacks":5,"offsetY":-3,"width":2},"contracts/level":{"url":"contracts/level.png","height":1,"width":1},"decorations/watchtower":{"spritey":31,"name":"Watchtower","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":2,"draggable":true,"goldCost":15000,"unlockValue":61,"url":"decorations.png","foodBoost":0,"goldBoost":30,"destroyGainGold":5000,"icon":"decorations/watchtower-icon.png","height":5,"offsetY":-3,"width":2},"farming/seed-pumpkin":{"spritey":8,"name":"Pumpkins","class":"seeds","unlockCondition":"level","unlockValue":4,"url":"farming.png","icon":"farming/seed-pumpkin-icon.png","contract":{"requiredGold":50,"requiredTime":25200000,"providedFood":140,"providedXP":1}},"buildings/ship_stage_4":{"spritey":10,"name":"Drydock 4","selectable":true,"class":"ship","url":"drydock.png","upgradeTo":"buildings/ship_stage_5","contract":{"requiredTime":880000,"rewards":[{"amount":20000,"type":"gold"}]},"requiredItem":"item/key4","height":5,"upgradeCost":100,"offsetY":-3,"width":5},"contracts/food":{"url":"contracts/food.png","height":2,"width":2},"buildings/castle_10":{"spritey":80,"name":"Castle 10","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":4,"unlockCondition":"level","population":23,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_11","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/locksmith","invites/roofer","invites/mechanic"],"height":8,"upgradeCost":8000,"unlockCost":10,"offsetY":-3,"width":5},"contracts/constructed":{"url":"contracts/dryd_03.png","height":2,"width":2},"buildings/ship_stage_5":{"spritey":15,"name":"Drydock 5","selectable":true,"class":"ship","url":"drydock.png","upgradeTo":"buildings/ship_stage_6","contract":{"requiredTime":1280000,"rewards":[{"amount":35000,"type":"gold"}]},"requiredItem":"item/key5","height":5,"upgradeCost":100,"offsetY":-3,"width":5},"nature/tree-big-1-b":{"hasWhackStates":true,"class":"tree","url":"nature/big-treev1-squashed.png","icon":"nature/tree-big-icon.png","rewards":{"whack":[],"complete":[{"amount":4,"type":"xp"}]},"whacks":4,"height":4,"offsetY":-3,"width":3},"nature/tree-big-2-r":{"spritey":12,"hasWhackStates":true,"class":"tree","url":"nature/big-treev2-squashed.png","icon":"nature/tree-big-icon.png","rewards":{"whack":[],"complete":[{"amount":4,"type":"xp"}]},"whacks":4,"height":4,"offsetY":-3,"width":3},"decorations/flower_dalia":{"spritey":5,"name":"Dalia","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":1,"draggable":true,"goldCost":50,"unlockValue":3,"url":"decorations.png","foodBoost":0,"goldBoost":1,"destroyGainGold":17,"icon":"decorations/flower_dalia-icon.png","height":1,"offsetY":0,"width":1},"buildings/castle_11":{"spritey":88,"name":"Castle 11","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":4,"unlockCondition":"level","population":25,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_12","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/roofer","invites/mechanic","invites/architect"],"height":8,"upgradeCost":2000,"unlockCost":10,"offsetY":-3,"width":5},"buildings/fairy_house":{"spritey":15,"name":"Fairy's House","selectable":true,"class":"uhouse","diamondCost":3,"unlockCondition":"level","goldCost":1100,"unlockValue":3,"draggable":true,"url":"buildings0.png","destroyGainGold":367,"icon":"buildings/fairy_house-icon.png","contract":{"requiredTime":7200000,"providedXP":2,"providedGold":100,"constructionTime":600000,"requiredFood":0},"height":4,"unlockCost":10,"offsetY":-1,"width":3},"nature/tree-small-d":{"spritey":4,"hasWhackStates":true,"class":"tree","url":"nature/small-tree-squashed.png","icon":"nature/tree-small-icon.png","rewards":{"whack":[],"complete":[{"amount":2,"type":"xp"}]},"height":4,"whacks":5,"offsetY":-3,"width":2},"buildings/ship_stage_6":{"spritey":20,"name":"Drydock 6","selectable":true,"class":"ship","url":"drydock.png","height":5,"offsetY":-3,"width":5},"invites/mason":{"name":"Hire a Mason","cost":1000,"specialistImg":"invites/mason.png"},"buildings/castle_12":{"spritey":96,"name":"Castle 12","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":4,"unlockCondition":"level","population":27,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_13","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/roofer","invites/mechanic","invites/architect"],"height":8,"upgradeCost":12000,"unlockCost":10,"offsetY":-3,"width":5},"paths/road-0":{"spritey":8,"url":"paths.png"},"nature/tree-big-1-d":{"spritey":4,"hasWhackStates":true,"class":"tree","url":"nature/big-treev1-squashed.png","icon":"nature/tree-big-icon.png","rewards":{"whack":[],"complete":[{"amount":4,"type":"xp"}]},"whacks":4,"height":4,"offsetY":-3,"width":3},"buildings/castle_13":{"spritey":104,"name":"Castle 13","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":4,"unlockCondition":"level","population":29,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_14","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/roofer","invites/mechanic","invites/architect"],"height":8,"upgradeCost":24000,"unlockCost":10,"offsetY":-3,"width":5},"characters/person-skin":{"animationLength":1,"zIndex":5,"class":"person","url":"person.png","height":1,"width":1},"paths/road-1":{"spritey":5,"url":"paths.png"},"buildings/theatre":{"spritey":7,"name":"Open Air Theatre","selectable":true,"class":"house","diamondCost":17,"unlockCondition":"level","goldCost":5000,"unlockValue":17,"draggable":true,"url":"buildings20.png","destroyGainGold":1667,"icon":"buildings/theatre-icon.png","contract":{"requiredTime":180000,"providedXP":1,"providedGold":89,"constructionTime":38000000,"requiredFood":40},"height":4,"unlockCost":10,"offsetY":-1,"width":4},"buildings/castle_14":{"spritey":112,"name":"Castle 14","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":5,"unlockCondition":"level","population":31,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_15","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/roofer","invites/mechanic","invites/architect","invites/smith"],"height":8,"upgradeCost":8000,"unlockCost":10,"offsetY":-3,"width":5},"paths/road-2":{"spritey":4,"url":"paths.png"},"paths/road":{"class":"path","height":1,"offsetY":0,"width":1},"buildings/castle_15":{"spritey":120,"name":"Castle 15","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":5,"unlockCondition":"level","population":33,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_16","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/roofer","invites/mechanic","invites/architect","invites/smith"],"height":8,"upgradeCost":23000,"unlockCost":10,"offsetY":-3,"width":5},"buildings/dwarf_house":{"spritey":11,"name":"Dwarf's House","selectable":true,"class":"uhouse","diamondCost":5,"unlockCondition":"level","goldCost":1400,"unlockValue":5,"draggable":true,"url":"buildings20.png","destroyGainGold":467,"icon":"buildings/dwarf_house-icon.png","contract":{"requiredTime":32400000,"providedXP":11,"providedGold":160,"constructionTime":12000000,"requiredFood":0},"height":3,"unlockCost":10,"offsetY":-1,"width":4},"enemy/dying":{"url":"characters/poof.png","animation":{"length":26},"height":3,"width":3},"paths/road-3":{"spritey":0,"url":"paths.png"},"buildings/gingerbread_house":{"spritey":15,"name":"Gingerbread House","selectable":true,"class":"uhouse","diamondCost":22,"unlockCondition":"level","goldCost":7500,"unlockValue":22,"draggable":true,"url":"buildings30.png","destroyGainGold":2500,"icon":"buildings/gingerbread_house-icon.png","contract":{"requiredTime":25200000,"providedXP":8,"providedGold":160,"constructionTime":78000000,"requiredFood":0},"height":4,"unlockCost":10,"offsetY":-1,"width":3},"construction/3x2":{"spritey":3,"url":"construction.png","height":3,"offsetY":-1,"width":3},"buildings/castle_16":{"spritey":128,"name":"Castle 16","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":6,"unlockCondition":"level","population":35,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_17","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/roofer","invites/mechanic","invites/architect","invites/smith","invites/painter"],"height":8,"upgradeCost":1000,"unlockCost":10,"offsetY":-3,"width":5},"paths/road-4":{"spritey":6,"url":"paths.png"},"construction/3x3":{"spritey":6,"url":"construction.png","height":4,"offsetY":-1,"width":3},"buildings/castle_17":{"spritey":136,"name":"Castle 17","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":6,"unlockCondition":"level","population":37,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_18","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/roofer","invites/mechanic","invites/architect","invites/smith","invites/painter"],"height":8,"upgradeCost":17200,"unlockCost":10,"offsetY":-3,"width":5},"buildings/fortress-hidden":{"spritey":0,"url":"buildings/fortress-hidden.png","height":4,"width":3},"paths/road-5":{"spritey":11,"url":"paths.png"},"buildings/shoe_house":{"spritey":4,"name":"Shoe House","selectable":true,"class":"uhouse","diamondCost":7,"unlockCondition":"level","goldCost":1900,"unlockValue":7,"draggable":true,"url":"buildings20.png","destroyGainGold":633,"icon":"buildings/shoe_house-icon.png","contract":{"requiredTime":82800000,"providedXP":28,"providedGold":250,"constructionTime":48000000,"requiredFood":0},"height":3,"unlockCost":10,"offsetY":-1,"width":4},"contracts/repair":{"url":"contracts/dryd_01.png","height":2,"width":2.33},"buildings/castle_18":{"spritey":144,"name":"Castle 18","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":5,"unlockCondition":"level","population":39,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_19","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/architect","invites/smith","invites/painter","invites/landscaper"],"height":8,"upgradeCost":1000,"unlockCost":10,"offsetY":-3,"width":5},"buildings/royal_summer_house":{"spritey":7,"name":"Royal Summer House","selectable":true,"class":"uhouse","diamondCost":48,"unlockCondition":"level","goldCost":80000,"unlockValue":48,"draggable":true,"url":"buildings40.png","destroyGainGold":26667,"icon":"buildings/royal_summer_house-icon.png","contract":{"requiredTime":43200000,"providedXP":14,"providedGold":290,"constructionTime":38000000,"requiredFood":0},"height":4,"unlockCost":10,"offsetY":-1,"width":4},"nature/tree-big-2-y":{"spritey":8,"hasWhackStates":true,"class":"tree","url":"nature/big-treev2-squashed.png","icon":"nature/tree-big-icon.png","rewards":{"whack":[],"complete":[{"amount":4,"type":"xp"}]},"whacks":4,"height":4,"offsetY":-3,"width":3},"paths/road-6":{"spritey":2,"url":"paths.png"},"buildings/observatory":{"spritey":3,"name":"Observatory","selectable":true,"class":"house","diamondCost":15,"unlockCondition":"level","goldCost":4600,"unlockValue":15,"draggable":true,"url":"buildings40.png","destroyGainGold":1533,"icon":"buildings/observatory-icon.png","contract":{"requiredTime":30000,"providedXP":1,"providedGold":88,"constructionTime":68000000,"requiredFood":60},"height":4,"unlockCost":10,"offsetY":-2,"width":3},"characters/goblins":{"name":"Goblins","selectable":false,"zIndex":10,"class":"enemy","whackRewards":[{"amount":1,"type":"xp"}],"draggable":false,"url":"characters/goblins.png","icon":"characters/goblins.png","animation":{"length":6},"height":4,"killRewards":[{"amount":100,"type":"gold"}],"hp":3,"xOffsetRight":-1,"xOffsetLeft":1,"offsetY":-3,"width":5},"backgrounds/coast":{"url":"backgrounds/coast.png"},"buildings/castle_19":{"spritey":152,"name":"Castle 19","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":4,"unlockCondition":"level","population":41,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_19","icon":"castles/castle-icon.png","partyInvites":["invites/architect","invites/painter","invites/plumber","invites/landscaper"],"height":8,"upgradeCost":500,"unlockCost":10,"offsetY":-3,"width":5},"buildings/tailor_shop":{"spritey":15,"name":"Tailor Shop","selectable":true,"class":"house","diamondCost":8,"unlockCondition":"level","goldCost":1800,"unlockValue":8,"draggable":true,"url":"buildings40.png","destroyGainGold":600,"icon":"buildings/tailor_shop-icon.png","contract":{"requiredTime":120000,"providedXP":1,"providedGold":65,"constructionTime":96000000,"requiredFood":30},"height":4,"unlockCost":10,"offsetY":-1,"width":3},"paths/road-7":{"spritey":12,"url":"paths.png"},"contracts/hidden":{"url":"unlock/why_does_it_always_rain_on_me.png","height":-1,"offsetY":-3,"width":4},"farming/basic_plot":{"spritey":0,"name":"Farm plot","selectable":true,"class":"farm","unlockCondition":"level","unlockValue":-1,"goldCost":100,"draggable":true,"url":"farming.png","destroyGainGold":20,"icon":"farming/basic_plot-icon.png","height":2,"offsetY":0,"width":2},"paths/road-8":{"spritey":7,"url":"paths.png"},"decorations/well":{"spritey":36,"name":"Well","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":1,"draggable":true,"goldCost":3000,"unlockValue":11,"url":"decorations.png","foodBoost":0,"goldBoost":12,"destroyGainGold":1000,"icon":"decorations/well-icon.png","height":2,"offsetY":-1,"width":2},"invites/carpenter":{"name":"Hire a Carpenter","cost":200,"specialistImg":"invites/carpenter.png"},"buildings/wizards_house":{"spritey":4,"name":"Wizard's House","selectable":true,"class":"uhouse","diamondCost":9,"unlockCondition":"level","goldCost":3000,"unlockValue":9,"draggable":true,"url":"buildings10.png","destroyGainGold":1000,"icon":"buildings/wizards_house-icon.png","contract":{"requiredTime":57600000,"providedXP":19,"providedGold":200,"constructionTime":48000000,"requiredFood":0},"height":4,"unlockCost":10,"offsetY":-1,"width":4},"paths/road-9":{"spritey":1,"url":"paths.png"},"buildings/castle_1":{"spritey":8,"name":"Castle 1","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":1,"unlockCondition":"level","population":5,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_2","icon":"castles/castle-icon.png","partyInvites":["invites/carpenter"],"height":8,"upgradeCost":175,"unlockCost":10,"offsetY":-3,"width":5},"buildings/villager_house":{"spritey":8,"name":"Villager's House","selectable":true,"class":"uhouse","diamondCost":1,"unlockCondition":"level","goldCost":500,"unlockValue":1,"draggable":true,"url":"buildings0.png","destroyGainGold":167,"icon":"buildings/villager_house-icon.png","contract":{"requiredTime":300000,"providedXP":1,"providedGold":15,"constructionTime":30000,"requiredFood":0},"height":3,"unlockCost":10,"offsetY":-1,"width":3},"invites/plumber":{"name":"Hire a Plumber","cost":50000,"specialistImg":"invites/plumber.png"},"decorations/haybale":{"spritey":13,"name":"Hay Bale","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":1,"draggable":true,"goldCost":100,"unlockValue":3,"url":"decorations.png","foodBoost":1,"goldBoost":0,"destroyGainGold":33,"icon":"decorations/haybale-icon.png","height":2,"offsetY":-1,"width":1},"buildings/castle_2":{"spritey":16,"name":"Castle 2","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":1,"unlockCondition":"level","population":7,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_3","icon":"castles/castle-icon.png","partyInvites":["invites/mason"],"height":8,"upgradeCost":50,"unlockCost":10,"offsetY":-3,"width":5},"contracts/repaired":{"url":"contracts/dryd_03.png","height":2,"width":2},"farming/seed-beans":{"spritey":2,"name":"Beans","class":"seeds","unlockCondition":"level","unlockValue":3,"url":"farming.png","icon":"farming/seed-beans-icon.png","contract":{"requiredGold":18,"requiredTime":1800000,"providedFood":37,"providedXP":1}},"buildings/castle_3":{"spritey":24,"name":"Castle 3","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":1,"unlockCondition":"level","population":9,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_4","icon":"castles/castle-icon.png","partyInvites":["invites/mason"],"height":8,"upgradeCost":1025,"unlockCost":10,"offsetY":-3,"width":5},"buildings/ozzystent-hidden":{"spritey":0,"url":"buildings/ozzystent-hidden.png","height":4,"width":3},"buildings/wedding_chapel":{"spritey":8,"name":"Wedding Chapel","selectable":true,"class":"uhouse","diamondCost":40,"unlockCondition":"level","goldCost":35000,"unlockValue":40,"draggable":true,"url":"buildings10.png","destroyGainGold":11667,"icon":"buildings/wedding_chapel-icon.png","contract":{"requiredTime":43200000,"providedXP":14,"providedGold":260,"constructionTime":78000000,"requiredFood":0},"height":4,"unlockCost":10,"offsetY":-2,"width":3},"buildings/gold_mine":{"spritey":19,"name":"Gold Mine","selectable":true,"class":"house","diamondCost":26,"unlockCondition":"level","goldCost":9000,"unlockValue":26,"draggable":true,"url":"buildings30.png","destroyGainGold":3000,"icon":"buildings/gold_mine-icon.png","contract":{"requiredTime":240000,"providedXP":1,"providedGold":90,"constructionTime":58000000,"requiredFood":35},"height":4,"unlockCost":10,"offsetY":-1,"width":4},"buildings/castle_4":{"spritey":32,"name":"Castle 4","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":1,"unlockCondition":"level","population":11,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_5","icon":"castles/castle-icon.png","partyInvites":["invites/locksmith"],"height":8,"upgradeCost":300,"unlockCost":10,"offsetY":-3,"width":5},"nature/tree-small-r":{"spritey":12,"hasWhackStates":true,"class":"tree","url":"nature/small-tree-squashed.png","icon":"nature/tree-small-icon.png","rewards":{"whack":[],"complete":[{"amount":2,"type":"xp"}]},"height":4,"whacks":5,"offsetY":-3,"width":2},"buildings/castle_5":{"spritey":40,"name":"Castle 5","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":3,"unlockCondition":"level","population":13,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_6","icon":"castles/castle-icon.png","partyInvites":["invites/carpenter","invites/locksmith","invites/mason"],"height":8,"upgradeCost":675,"unlockCost":10,"offsetY":-3,"width":5},"buildings/straight_a_schoolhouse":{"spritey":13,"name":"Straight A Schoolhouse","selectable":true,"class":"house","diamondCost":9,"unlockCondition":"level","goldCost":2100,"unlockValue":9,"draggable":true,"url":"buildings10.png","destroyGainGold":700,"icon":"buildings/straight_a_schoolhouse-icon.png","contract":{"requiredTime":60000,"providedXP":1,"providedGold":40,"constructionTime":48000000,"requiredFood":20},"height":4,"unlockCost":10,"offsetY":-1,"width":4},"buildings/castle_6":{"spritey":48,"name":"Castle 6","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":2,"unlockCondition":"level","population":15,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_7","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/roofer"],"height":8,"upgradeCost":750,"unlockCost":10,"offsetY":-3,"width":5},"contracts/repairing":{"url":"contracts/dryd_02.png","height":2,"width":1},"nature/tree-big-1-r":{"spritey":12,"hasWhackStates":true,"class":"tree","url":"nature/big-treev1-squashed.png","icon":"nature/tree-big-icon.png","rewards":{"whack":[],"complete":[{"amount":4,"type":"xp"}]},"whacks":4,"height":4,"offsetY":-3,"width":3},"buildings/bakery":{"spritey":14,"name":"Bakery","selectable":true,"class":"house","diamondCost":1,"unlockCondition":"level","goldCost":800,"unlockValue":1,"draggable":true,"url":"buildings20.png","destroyGainGold":267,"icon":"buildings/bakery-icon.png","contract":{"requiredTime":60000,"providedXP":1,"providedGold":35,"constructionTime":60000,"requiredFood":15},"height":4,"unlockCost":10,"offsetY":-2,"width":4},"buildings/castle_7":{"spritey":56,"name":"Castle 7","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":2,"unlockCondition":"level","population":17,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_8","icon":"castles/castle-icon.png","partyInvites":["invites/locksmith","invites/roofer"],"height":8,"upgradeCost":925,"unlockCost":10,"offsetY":-3,"width":5},"buildings/castle_construction":{"url":"castles/castle_construction.png"},"decorations/scarecrow":{"spritey":24,"name":"Scarecrow","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":1,"draggable":true,"goldCost":1500,"unlockValue":9,"url":"decorations.png","foodBoost":12,"goldBoost":0,"destroyGainGold":500,"icon":"decorations/scarecrow-icon.png","height":3,"offsetY":-2,"width":2},"invites/roofer":{"name":"Hire a Roofer","cost":5000,"specialistImg":"invites/roofer.png"},"buildings/jokers_house":{"spritey":0,"name":"Joker's House","selectable":true,"class":"uhouse","diamondCost":19,"unlockCondition":"level","goldCost":6000,"unlockValue":19,"draggable":true,"url":"buildings10.png","destroyGainGold":2000,"icon":"buildings/jokers_house-icon.png","contract":{"requiredTime":21600000,"providedXP":7,"providedGold":190,"constructionTime":28000000,"requiredFood":0},"height":5,"unlockCost":10,"offsetY":-2,"width":4},"decorations/fairy_lamp_post":{"spritey":1,"name":"Fairy Lamp Post","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":2,"draggable":true,"goldCost":100,"unlockValue":60,"url":"decorations.png","foodBoost":1,"goldBoost":1,"destroyGainGold":33,"icon":"decorations/fairy_lamp_post-icon.png","height":3,"offsetY":-2,"width":1},"buildings/castle_8":{"spritey":64,"name":"Castle 8","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":3,"unlockCondition":"level","population":19,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_9","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/locksmith","invites/carpenter"],"height":8,"upgradeCost":7000,"unlockCost":10,"offsetY":-3,"width":5},"farming/seed-grapes":{"spritey":12,"name":"Grapes","class":"seeds","unlockCondition":"level","unlockValue":1,"url":"farming.png","icon":"farming/seed-vineyard-icon.png","contract":{"requiredGold":40,"requiredTime":14400000,"providedFood":100,"providedXP":1}},"decorations/fountain_rock":{"spritey":11,"name":"Fountain","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":1,"draggable":true,"goldCost":10000,"unlockValue":15,"url":"decorations.png","foodBoost":0,"goldBoost":20,"destroyGainGold":3333,"icon":"decorations/fountain_rock-icon.png","height":2,"offsetY":-1,"width":2},"nature/tree-big-2-b":{"hasWhackStates":true,"class":"tree","url":"nature/big-treev2-squashed.png","icon":"nature/tree-big-icon.png","rewards":{"whack":[],"complete":[{"amount":4,"type":"xp"}]},"whacks":4,"height":4,"offsetY":-3,"width":3},"buildings/castle_9":{"spritey":72,"name":"Castle 9","rootRoadPosition":{"x":2,"y":5},"selectable":true,"class":"castle","diamondCost":0,"friendsToUpgrade":4,"unlockCondition":"level","population":21,"goldCost":500,"unlockValue":1,"draggable":false,"url":"castles.png","destroyGainGold":125,"upgradeTo":"buildings/castle_10","icon":"castles/castle-icon.png","partyInvites":["invites/mason","invites/locksmith","invites/roofer","invites/mechanic"],"height":8,"upgradeCost":500,"unlockCost":10,"offsetY":-3,"width":5},"decorations/flower_daisy":{"spritey":4,"name":"Daisy","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":1,"draggable":true,"goldCost":50,"unlockValue":3,"url":"decorations.png","foodBoost":0,"goldBoost":1,"destroyGainGold":17,"icon":"decorations/flower_daisy-icon.png","height":1,"offsetY":0,"width":1},"buildings/vikingsmith-hidden":{"spritey":0,"url":"buildings/vikingsmith-hidden.png","height":4,"width":4},"buildings/vikingsmith":{"spritey":0,"name":"Formidable Forge","selectable":true,"class":"statichouse","diamondCost":10,"unlockCondition":"item","goldCost":0,"unlockValue":"unlock/key","draggable":false,"url":"buildings/vikingsmith.png","destroyGainGold":0,"icon":"buildings/royal_summer_house-icon.png","drops":"item/key5","contract":{"requiredTime":82800000,"providedXP":24,"providedGold":680,"requiredFood":0},"height":4,"unlockCost":1,"offsetY":-2,"width":4},"decorations/pond":{"spritey":21,"name":"Pond","selectable":true,"class":"decoration","unlockCondition":"level","influenceArea":2,"draggable":true,"goldCost":800,"unlockValue":9,"url":"decorations.png","foodBoost":0,"goldBoost":8,"destroyGainGold":267,"icon":"decorations/pond-icon.png","height":3,"offsetY":-1,"width":2},"buildings/silver_mine":{"spritey":11,"name":"Silver Mine","selectable":true,"class":"house","diamondCost":46,"unlockCondition":"level","goldCost":50000,"unlockValue":46,"draggable":true,"url":"buildings40.png","destroyGainGold":16667,"icon":"buildings/silver_mine-icon.png","contract":{"requiredTime":300000,"providedXP":1,"providedGold":140,"constructionTime":88000000,"requiredFood":70},"height":4,"unlockCost":10,"offsetY":-1,"width":4},"item/key1":{"name":"Hammer and Nails","url":"unlock/hammer_nails.png","height":2,"width":2},"nature/tree-big-2-d":{"spritey":4,"hasWhackStates":true,"class":"tree","url":"nature/big-treev2-squashed.png","icon":"nature/tree-big-icon.png","rewards":{"whack":[],"complete":[{"amount":4,"type":"xp"}]},"whacks":4,"height":4,"offsetY":-3,"width":3},"construction/2x2":{"spritey":0,"url":"construction.png","height":3,"offsetY":-1,"width":2},"nature/tree-small-y":{"spritey":8,"hasWhackStates":true,"class":"tree","url":"nature/small-tree-squashed.png","icon":"nature/tree-small-icon.png","rewards":{"whack":[],"complete":[{"amount":2,"type":"xp"}]},"height":4,"whacks":5,"offsetY":-3,"width":2},"item/key2":{"name":"Steering Wheel","url":"unlock/ship_wheel.png","height":2,"width":2},"contracts/gold":{"url":"contracts/gold.png","height":2,"width":2},"buildings/crazy_hogs_pub":{"spritey":11,"name":"Crazy Hogs Pub","selectable":true,"class":"house","diamondCost":2,"unlockCondition":"level","goldCost":600,"unlockValue":2,"draggable":true,"url":"buildings30.png","destroyGainGold":200,"icon":"buildings/crazy_hogs_pub-icon.png","contract":{"requiredTime":30000,"providedXP":1,"providedGold":62,"constructionTime":300000,"requiredFood":40},"height":4,"unlockCost":10,"offsetY":-1,"width":4},"contracts/contract":{"url":"contracts/contract.png","height":3,"width":2}} ;
window.wooga.castle.shopItems = {"houses":["buildings/poor_house","buildings/villager_house","buildings/knights_house","buildings/fairy_house","buildings/ladys_house","buildings/jokers_house","buildings/wizards_house","buildings/crazy_hogs_pub","buildings/wedding_chapel","buildings/straight_a_schoolhouse","buildings/horse_stable","buildings/shoe_house","buildings/theatre","buildings/dwarf_house","buildings/bakery","buildings/unicorn_stable","buildings/gingerbread_house","buildings/silver_mine","buildings/royal_summer_house","buildings/artist_studio","buildings/medieval_university","buildings/tailor_shop","buildings/gold_mine","buildings/bath_house","buildings/observatory"],"farming":["farming/basic_plot","farming/seed-melon","farming/seed-beans","farming/seed-grapes","farming/seed-pumpkin","farming/seed-strawberry","farming/seed-wheat"],"decoration":["decorations/flower_rose","decorations/flower_sunflower","decorations/flower_daisy","decorations/pond","decorations/haybale","decorations/flower_dalia","decorations/windmill","decorations/scarecrow","decorations/well","decorations/fountain_rock"]} ;
window.wooga.castle.goals = {"line/1":{"goals":{"goals/100":{"Icon":"","level":"1","goalID":100,"subgoals":[{"amount":"1","action":"game:enemy/kill","level":"1","icon":"characters/troll-icon.png","type":"listen","event":"game:enemy/kill","objects":{"entity.key":"characters/troll"},"rewards":[{"type":"gold","amount":"100"}],"subgoalText":"Whack the Troll","subgoalHint":"","subgoalID":"100s1"},{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/poor_house-icon.png","type":"listen","event":"game:entity/buy","objects":{"entity.key":"buildings/poor_house"},"rewards":[{"type":"gold","amount":"150"}],"subgoalText":"Build a Peasant's House","subgoalHint":"","subgoalID":"100s2"}],"rewards":[{"type":"xp","amount":"20"}],"storyTitle":"Introduction","finishedText":"King's Wishlist: 1 / 55 Fulfill all wishes to set Sail!"},"goals/101":{"Icon":"","level":"1","goalID":101,"subgoals":[{"amount":"2","action":"game:contract/collect","level":"1","icon":"farming/seed-pumpkin-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-pumpkin"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Collect 2 Pumpkins","subgoalHint":"Tap on the farms to collect","subgoalID":"101s1"},{"amount":"2","action":"game:contract/start","level":"1","icon":"farming/seed-vineyard-icon.png","type":"listen","event":"game:contract/start","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-grapes"},"rewards":[{"type":"gold","amount":"20"}],"subgoalText":"Plant 2 Grapes","subgoalHint":"Tip: Tap on empty farm plots to plant the desired seeds.","subgoalID":"101s2"}],"rewards":[{"type":"xp","amount":"5"}],"storyTitle":"Bread & Breakfast","finishedText":"King's Wishlist: 2 / 55 Fulfill all wishes to set Sail!"},"goals/102":{"Icon":"","level":"1","goalID":102,"subgoals":[{"amount":"1","action":"game:entity/whack-complete","level":"1","icon":"buildings/axe_icon.png","type":"listen","event":"game:entity/whack-complete","objects":{"entity.definition.class":"tree"},"rewards":[{"type":"gold","amount":"20"}],"subgoalText":"Chop down a tree","subgoalHint":"Tip: Tap on the trees 5x times to chop them. Chopping trees costs food!","subgoalID":"102s1"},{"amount":"1","action":"game:entity/whack-complete","level":"1","icon":"buildings/rock_icon.png","type":"listen","event":"game:entity/whack-complete","objects":{"entity.definition.class":"rock"},"rewards":[{"type":"gold","amount":"20"}],"subgoalText":"Smash a rock","subgoalHint":"Tip: Tap on the rocks 4x times to smash them","subgoalID":"102s2"}],"rewards":[{"type":"xp","amount":"10"}],"storyTitle":"Lumbering","finishedText":"King's Wishlist: 3 / 55 Fulfill all wishes to set Sail!"},"goals/103":{"Icon":"","level":"1","goalID":103,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/villager_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/villager_house"},"rewards":[{"type":"gold","amount":"100"}],"subgoalText":"Buy a Villager House","subgoalHint":"INFO: Each building adds ONE population to your village","subgoalID":"103s1"}],"rewards":[{"type":"xp","amount":"10"}],"storyTitle":"Flourishing Village","finishedText":"King's Wishlist: 4 / 55 Fulfill all wishes to set Sail!"},"goals/104":{"Icon":"","level":"1","goalID":104,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/bakery-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/bakery"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Build a Bakery","subgoalHint":"Tip: Look for the Bakery under the Buildings tab in Shop","subgoalID":"104s1"},{"amount":"1","action":"game:contract/start","level":"1","icon":"buildings/bakery-icon.png","type":"listen","event":"game:contract/start","objects":{"entity.definition.class":"house","entity.key":"buildings/bakery"},"rewards":[{"type":"gold","amount":"10"}],"subgoalText":"Supply to the Bakery","subgoalHint":"Tip: Tap on the Bakery to deliver supplies","subgoalID":"104s2"}],"rewards":[{"type":"xp","amount":"10"}],"storyTitle":"Baked Goodies","finishedText":"King's Wishlist: 5 / 55 Fulfill all wishes to set Sail!"},"goals/105":{"Icon":"","level":"1","goalID":105,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/crazy_hogs_pub-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/crazy_hogs_pub"},"rewards":[{"type":"gold","amount":"600"}],"subgoalText":"Build Crazy Hog's Pub","subgoalHint":"Look for Crazy Hog's Pub under Houses tab in Shop","subgoalID":"105s1"},{"amount":"1","action":"game:contract/start","level":"1","icon":"buildings/crazy_hogs_pub-icon.png","type":"listen","event":"game:contract/start","objects":{"entity.definition.class":"house","entity.key":"buildings/crazy_hogs_pub"},"rewards":[{"type":"gold","amount":"100"}],"subgoalText":"Supply to Crazy Hog's Pub","subgoalHint":"Tap on the Pub to supply food","subgoalID":"105s2"}],"rewards":[{"type":"xp","amount":"10"}],"storyTitle":"Merry Making","finishedText":"King's Wishlist: 6 / 55 Fulfill all wishes to set Sail!"},"goals/106":{"Icon":"","level":"1","goalID":106,"subgoals":[{"amount":"6","action":"game:entity/whack-complete","level":"1","icon":"buildings/axe_icon.png","type":"listen","event":"game:entity/whack-complete","objects":{"entity.definition.class":"tree"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Chop Down Trees (x 6)","subgoalHint":"Tip: Tap on the trees to chop them. Chopping trees costs 15 food!","subgoalID":"106s1"},{"amount":"1","action":"game:building/connected","level":"1","icon":"buildings/lighthouse_icon.png","type":"have","event":"game:building/connected","objects":{"key":"buildings/lighthouse","connected":true},"rewards":[{"type":"gold","amount":"250"}],"subgoalText":"Rescue the Light House","subgoalHint":"TIP: Build a road leading to the dark clouds","subgoalID":"106s2"}],"rewards":[{"type":"xp","amount":"25"}],"storyTitle":"Dark Forest","finishedText":"King's Wishlist: 7 / 55 Fulfill all wishes to set Sail!"},"goals/107":{"Icon":"","level":"1","goalID":107,"subgoals":[{"amount":"1","action":"game:castle/upgrade","level":"1","icon":"buildings/upgrade_icon.png","type":"listen","event":"game:castle/upgrade","objects":{"entity.definition.class":"castle"},"rewards":[{"type":"gold","amount":"250"}],"subgoalText":"Upgrade Your Castle","subgoalHint":"TIP: Upgrading allows for more houses = more population!","subgoalID":"107s1"}],"rewards":[{"type":"xp","amount":"10"}],"storyTitle":"Castle Upgrade","finishedText":"King's Wishlist: 8 / 55 Fulfill all wishes to set Sail!"},"goals/108":{"Icon":"","level":"1","goalID":108,"subgoals":[{"amount":"2","action":"game:entity/buy","level":"1","icon":"farming/basic_plot-icon.png","type":"listen","event":"game:entity/buy","objects":{"entity.key":"farming/basic_plot"},"rewards":[{"type":"gold","amount":"200"}],"subgoalText":"Buy 2 Farm Plots","subgoalHint":"TIP: Having more farm plots will increase your food production","subgoalID":"108s1"},{"amount":"5","action":"game:entity/whack-complete","level":"1","icon":"buildings/axe_icon.png","type":"listen","event":"game:entity/whack-complete","objects":{"entity.definition.class":"tree"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Chop Down Trees (x 5)","subgoalHint":"Tip: Tap on the trees to chop them. Chopping trees costs 15 food!","subgoalID":"108s2"},{"amount":"4","action":"game:contract/start","level":"1","icon":"farming/seed-beans-icon.png","type":"listen","event":"game:contract/start","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-beans"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Plant 4 Beans","subgoalHint":"Look under Farming tab in Shop","subgoalID":"108s3"}],"rewards":[{"type":"xp","amount":"20"}],"storyTitle":"Hungry Citizens","finishedText":"King's Wishlist: 9 / 55 Fulfill all wishes to set Sail!"},"goals/109":{"Icon":"","level":"1","goalID":109,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/fairy_house-icon.png","type":"listen","event":"game:entity/buy","objects":{"entity.key":"buildings/fairy_house"},"rewards":[{"type":"gold","amount":"100"}],"subgoalText":"Build a Fairy House","subgoalHint":"Look under Houses tab in Shop","subgoalID":"109s1"}],"rewards":[{"type":"xp","amount":"25"}],"storyTitle":"MagicLand Party","finishedText":"King's Wishlist: 10 / 55 Fulfill all wishes to set Sail!"},"goals/110":{"Icon":"","level":"1","goalID":110,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"decorations/flower_daisy-icon.png","type":"listen","event":"game:entity/buy","objects":{"entity.key":"decorations/flower_daisy"},"rewards":[{"type":"gold","amount":"25"}],"subgoalText":"Place One Daisy","subgoalHint":"Look under Decorations tab in Shop","subgoalID":"110s1"},{"amount":"1","action":"game:entity/buy","level":"1","icon":"decorations/haybale-icon.png","type":"listen","event":"game:entity/buy","objects":{"entity.key":"decorations/haybale"},"rewards":[{"type":"gold","amount":"100"}],"subgoalText":"Place One Haybale","subgoalHint":"Decorations boost your gold and food output","subgoalID":"110s2"}],"rewards":[{"type":"xp","amount":"10"}],"storyTitle":"Decorations","finishedText":"King's Wishlist: 11 / 55 Fulfill all wishes to set Sail!"},"goals/111":{"Icon":"","level":"1","goalID":111,"subgoals":[{"amount":"4","action":"game:entity/whack-complete","level":"1","icon":"buildings/axe_icon.png","type":"listen","event":"game:entity/whack-complete","objects":{"entity.definition.class":"tree"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Chop Down Trees (x 4)","subgoalHint":"TIP: Chop trees in the Unlocked Region","subgoalID":"111s1"}],"rewards":[{"type":"xp","amount":"25"}],"storyTitle":"Explorations","finishedText":"King's Wishlist: 12 / 55 Fulfill all wishes to set Sail!"},"goals/112":{"Icon":"","level":"1","goalID":112,"subgoals":[{"amount":"1","action":"game:entity/move","level":"1","icon":"buildings/moveBuilding_icon.png","type":"listen","event":"game:entity/move","objects":{"entity.definition.class":"house"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Move a House","subgoalHint":"TIP: Tap and hold on a house to activate MOVE MODE","subgoalID":"112s1"}],"rewards":[{"type":"xp","amount":"10"}],"storyTitle":"Rearranging Chores ","finishedText":"King's Wishlist: 13 / 55 Fulfill all wishes to set Sail!"},"goals/113":{"Icon":"","level":"1","goalID":113,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/villager_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/villager_house"},"rewards":[{"type":"gold","amount":"100"}],"subgoalText":"Buy a Villager House","subgoalHint":"INFO: Each building adds ONE population to your village","subgoalID":"113s1"}],"rewards":[{"type":"xp","amount":"20"}],"storyTitle":"Growing Village","finishedText":"King's Wishlist: 14 / 55 Fulfill all wishes to set Sail!"},"goals/114":{"Icon":"","level":"1","goalID":114,"subgoals":[{"amount":"2","action":"game:enemy/kill","level":"1","icon":"characters/troll-icon.png","type":"listen","event":"game:enemy/kill","objects":{"entity.key":"characters/troll"},"rewards":[{"type":"gold","amount":"100"}],"subgoalText":"Whack 2 Trolls","subgoalHint":"TIP: Trolls hide behind the trees!","subgoalID":"114s1"}],"rewards":[{"type":"xp","amount":"35"}],"storyTitle":"Troll Menace","finishedText":"King's Wishlist: 15 / 55 Fulfill all wishes to set Sail!"},"goals/115":{"Icon":"","level":"1","goalID":115,"subgoals":[{"amount":"5","action":"game:contract/collect","level":"1","icon":"buildings/taxes_icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"house"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Collect Taxes (x 5)","subgoalHint":"Tap on any building to collect taxes","subgoalID":"115s1"}],"rewards":[{"type":"xp","amount":"45"}],"storyTitle":"Taxation","finishedText":"King's Wishlist: 16 / 55 Fulfill all wishes to set Sail!"},"goals/116":{"Icon":"","level":"1","goalID":116,"subgoals":[{"amount":"2","action":"game:entity/buy","level":"1","icon":"buildings/bakery-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/bakery"},"rewards":[{"type":"gold","amount":"600"}],"subgoalText":"Have 2 Bakeries","subgoalHint":"Look for Bakert under Houses tab in Shop","subgoalID":"116s1"},{"amount":"1","action":"game:contract/start","level":"1","icon":"buildings/bakery-icon.png","type":"listen","event":"game:contract/start","objects":{"entity.definition.class":"house","entity.key":"buildings/bakery"},"rewards":[{"type":"gold","amount":"200"}],"subgoalText":"Supply the Bakery (x 1)","subgoalHint":"Tap on the Bakery to supply fruits","subgoalID":"116s2"}],"rewards":[{"type":"xp","amount":"35"}],"storyTitle":"Bread & Breakfast","finishedText":"King's Wishlist: 17 / 55 Fulfill all wishes to set Sail!"},"goals/117":{"Icon":"","level":"1","goalID":117,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/poor_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/poor_house"},"rewards":[{"type":"gold","amount":"400"}],"subgoalText":"Build Peasant's House (x 1)","subgoalHint":"INFO: Peasant houses deliver gold every 3 minutes!","subgoalID":"117s1"},{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/villager_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/villager_house"},"rewards":[{"type":"gold","amount":"300"}],"subgoalText":"Build Villager's House (x 1)","subgoalHint":"TIP: Rearrange your houses and farms to accomodate more houses","subgoalID":"117s2"}],"rewards":[{"type":"xp","amount":"30"}],"storyTitle":"Labor Shortage","finishedText":"King's Wishlist: 18 / 55 Fulfill all wishes to set Sail!"},"goals/118":{"Icon":"","level":"1","goalID":118,"subgoals":[{"amount":"5","action":"game:contract/collect","level":"1","icon":"farming/seed-melon-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-melon"},"rewards":[{"type":"gold","amount":"25"}],"subgoalText":"Collect Watermelons (x 5)","subgoalHint":"TIP: Turn ON notifications to never miss a harvest!","subgoalID":"118s1"},{"amount":"6","action":"game:entity/whack-complete","level":"1","icon":"buildings/axe_icon.png","type":"listen","event":"game:entity/whack-complete","objects":{"entity.definition.class":"tree"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Chop Down Trees (x 6)","subgoalHint":"Tip: Tap on the trees to chop them. Chopping trees costs 15 food!","subgoalID":"118s2"}],"rewards":[{"type":"xp","amount":"50"}],"storyTitle":"Party Catering","finishedText":"King's Wishlist: 19 / 55 Fulfill all wishes to set Sail!"},"goals/119":{"Icon":"","level":"1","goalID":119,"subgoals":[{"amount":"2","action":"game:entity/buy","level":"1","icon":"buildings/knights_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/knights_house"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Have 2 Knight's House","subgoalHint":"Look under the Houses tab in Shop","subgoalID":"119s1"}],"rewards":[{"type":"xp","amount":"45"}],"storyTitle":"Party Security","finishedText":"King's Wishlist: 20 / 55 Fulfill all wishes to set Sail!"},"goals/120":{"Icon":"","level":"1","goalID":120,"subgoals":[{"amount":"1","action":"game:building/connected","level":"1","icon":"buildings/fortress_icon.png","type":"have","event":"game:building/connected","objects":{"key":"buildings/fortress","connected":true},"rewards":[{"type":"gold","amount":"500"}],"subgoalText":"Rescue the Fortress","subgoalHint":"TIP: Build a road leading to the dark clouds","subgoalID":"120s1"},{"amount":"10","action":"game:entity/whack-complete","level":"1","icon":"buildings/axe_icon.png","type":"listen","event":"game:entity/whack-complete","objects":{"entity.definition.class":"tree"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Chop Down Trees (x 10)","subgoalHint":"TIP: Chop trees in the Unlocked Region","subgoalID":"120s2"}],"rewards":[{"type":"xp","amount":"65"}],"storyTitle":"Enchanted Outpost","finishedText":"King's Wishlist: 21 / 55 Fulfill all wishes to set Sail!"},"goals/121":{"Icon":"","level":"1","goalID":121,"subgoals":[{"amount":1,"action":"game:boosts/maybe-change","level":"1","icon":"buildings/goldBoost_icon.png","type":"listen","event":"game:boosts/maybe-change","objects":{"entity.boost":"5","entity.key":"buildings/fairy_house"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Boost FairyHouse by (+ 5%)","subgoalHint":"TIP: Place decorations near the Fairy House","subgoalID":"121s1"}],"rewards":[{"type":"xp","amount":"50"}],"storyTitle":"Concert Decor","finishedText":"King's Wishlist: 22 / 55 Fulfill all wishes to set Sail!"},"goals/122":{"Icon":"","level":"1","goalID":122,"subgoals":[{"amount":"8","action":"game:contract/collect","level":"1","icon":"farming/seed-vineyard-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-grapes"},"rewards":[{"type":"gold","amount":"300"}],"subgoalText":"Collect Grapes (x 8)","subgoalHint":"TIP: Turn ON notifications to never miss a harvest!","subgoalID":"122s1"}],"rewards":[{"type":"xp","amount":"150"}],"storyTitle":"Wine Tasting","finishedText":"King's Wishlist: 23 / 55 Fulfill all wishes to set Sail!"},"goals/123":{"Icon":"","level":"1","goalID":123,"subgoals":[{"amount":"12","action":"game:entity/whack-complete","level":"1","icon":"buildings/axe_icon.png","type":"listen","event":"game:entity/whack-complete","objects":{"entity.definition.class":"tree"},"rewards":[{"type":"gold","amount":"450"}],"subgoalText":"Chop Down Trees (x 12)","subgoalHint":"Tip: Tap on the trees to chop them. Chopping trees costs 15 food!","subgoalID":"123s1"}],"rewards":[{"type":"xp","amount":"30"}],"storyTitle":"Fuel Shortage","finishedText":"King's Wishlist: 24 / 55 Fulfill all wishes to set Sail!"},"goals/124":{"Icon":"","level":"1","goalID":124,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/dwarf_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/dwarf_house"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Build a Dwarf's House","subgoalHint":"Look under the Houses tab in Shop","subgoalID":"124s1"}],"rewards":[{"type":"xp","amount":"75"}],"storyTitle":"Handymen","finishedText":"King's Wishlist: 25 / 55 Fulfill all wishes to set Sail!"},"goals/125":{"Icon":"","level":"1","goalID":125,"subgoals":[{"amount":"2","action":"game:entity/move","level":"1","icon":"buildings/moveBuilding_icon.png","type":"listen","event":"game:entity/move","objects":{"entity.definition.class":"house"},"rewards":[{"type":"gold","amount":"100"}],"subgoalText":"Move 2 Houses","subgoalHint":"TIP: Tap and hold on a building to activate MOVE MODE","subgoalID":"125s1"}],"rewards":[{"type":"xp","amount":"25"}],"storyTitle":"Village Planner","finishedText":"King's Wishlist: 26 / 55 Fulfill all wishes to set Sail!"},"goals/126":{"Icon":"","level":"1","goalID":126,"subgoals":[{"amount":"8","action":"game:contract/collect","level":"1","icon":"farming/seed-pumpkin-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-pumpkin"},"rewards":[{"type":"gold","amount":"500"}],"subgoalText":"Collect Pumpkins (x 8)","subgoalHint":"TIP: Turn ON notifications to never miss a harvest!","subgoalID":"126s1"},{"amount":"6","action":"game:contract/start","level":"1","icon":"buildings/bakery-icon.png","type":"listen","event":"game:contract/start","objects":{"entity.definition.class":"house","entity.key":"buildings/bakery"},"rewards":[{"type":"gold","amount":"250"}],"subgoalText":"Supply to Bakery (x 6)","subgoalHint":"Tap on the Bakery to supply fruits","subgoalID":"126s2"}],"rewards":[{"type":"xp","amount":"150"}],"storyTitle":"Pumpkin Pies!","finishedText":"King's Wishlist: 27 / 55 Fulfill all wishes to set Sail!"},"goals/127":{"Icon":"","level":"1","goalID":127,"subgoals":[{"amount":"10","action":"game:contract/collect","level":"1","icon":"buildings/taxes_icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"house"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Collect Taxes (x 10)","subgoalHint":"Tap on any building to collect taxes","subgoalID":"127s1"}],"rewards":[{"type":"xp","amount":"55"}],"storyTitle":"Taxation ","finishedText":"King's Wishlist: 28 / 55 Fulfill all wishes to set Sail!"},"goals/128":{"Icon":"","level":"1","goalID":128,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/artist_studio-icon.png","type":"listen","event":"game:entity/buy","objects":{"entity.key":"buildings/artist_studio"},"rewards":[{"type":"gold","amount":"750"}],"subgoalText":"Build an Art Studio","subgoalHint":"Look under the Houses tab in Shop","subgoalID":"128s1"},{"amount":"1","action":"game:contract/start","level":"1","icon":"buildings/artist_studio-icon.png","type":"listen","event":"game:contract/start","objects":{"entity.definition.class":"house","entity.key":"buildings/artist_studio"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Supply the Art Studio (x 1)","subgoalHint":"Tap on the studio to supply food","subgoalID":"128s2"}],"rewards":[{"type":"xp","amount":"75"}],"storyTitle":"Creative Freedom","finishedText":"King's Wishlist: 29 / 55 Fulfill all wishes to set Sail!"},"goals/129":{"Icon":"","level":"1","goalID":129,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/villager_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/villager_house"},"rewards":[{"type":"gold","amount":"300"}],"subgoalText":"Build Villager's House (x 1)","subgoalHint":"TIP: Rearrange your houses and farms to accomodate more houses","subgoalID":"129s1"},{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/poor_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/poor_house"},"rewards":[{"type":"gold","amount":"400"}],"subgoalText":"Build Peasant's House (x 1)","subgoalHint":"INFO: Peasant houses deliver gold every 3 minutes!","subgoalID":"129s2"}],"rewards":[{"type":"xp","amount":"45"}],"storyTitle":"Population Growth","finishedText":"King's Wishlist: 30 / 55 Fulfill all wishes to set Sail!"},"goals/130":{"Icon":"","level":"1","goalID":130,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/shoe_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/shoe_house"},"rewards":[{"type":"gold","amount":"500"}],"subgoalText":"Build a Shoe House","subgoalHint":"Look under Houses tab in Shop","subgoalID":"130s1"},{"amount":"4","action":"game:entity/whack-complete","level":"1","icon":"buildings/axe_icon.png","type":"listen","event":"game:entity/whack-complete","objects":{"entity.definition.class":"tree"},"rewards":[{"type":"gold","amount":"50"}],"subgoalText":"Chop Down Trees (x 4)","subgoalHint":"TIP: Chop trees in the Unlocked Region","subgoalID":"130s2"}],"rewards":[{"type":"xp","amount":"75"}],"storyTitle":"Knights' Boots","finishedText":"King's Wishlist: 31 / 55 Fulfill all wishes to set Sail!"},"goals/131":{"Icon":"","level":"1","goalID":131,"subgoals":[{"amount":"1","action":"game:building/connected","level":"1","icon":"buildings/vikingsmith_icon.png","type":"have","event":"game:building/connected","objects":{"key":"buildings/elves","connected":true},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Rescue the Treehouse","subgoalHint":"TIP: Build a road leading to the dark clouds. Reconnect to road if previously unlocked.","subgoalID":"131s1"},{"amount":"15","action":"game:entity/whack-complete","level":"1","icon":"buildings/axe_icon.png","type":"listen","event":"game:entity/whack-complete","objects":{"entity.definition.class":"tree"},"rewards":[{"type":"gold","amount":"450"}],"subgoalText":"Chop Down Trees (x 15)","subgoalHint":"TIP: Chop trees in the unlocked region","subgoalID":"131s2"}],"rewards":[{"type":"xp","amount":"150"}],"storyTitle":"Haunted Gardens","finishedText":"King's Wishlist: 32 / 55 Fulfill all wishes to set Sail!"},"goals/132":{"Icon":"","level":"1","goalID":132,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/straight_a_schoolhouse-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/straight_a_schoolhouse"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Build a School House","subgoalHint":"Look under Houses tab in Shop","subgoalID":"132s1"}],"rewards":[{"type":"xp","amount":"95"}],"storyTitle":"Schooling!","finishedText":"King's Wishlist: 33 / 55 Fulfill all wishes to set Sail!"},"goals/133":{"Icon":"","level":"1","goalID":133,"subgoals":[{"amount":"5","action":"game:contract/start","level":"1","icon":"farming/seed-strawberry-icon.png","type":"listen","event":"game:contract/start","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-strawberry"},"rewards":[{"type":"gold","amount":"500"}],"subgoalText":"Plant Strawberries (x 5)","subgoalHint":"Tap on the farms to plant desired seeds","subgoalID":"133s1"},{"amount":"10","action":"game:contract/collect","level":"1","icon":"farming/seed-strawberry-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-strawberry"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Collect Strawberries (x 10)","subgoalHint":"TIP: Turn ON notifications to never miss a harvest!","subgoalID":"133s2"}],"rewards":[{"type":"xp","amount":"100"}],"storyTitle":"Strawberry Shortcake","finishedText":"King's Wishlist: 34 / 55 Fulfill all wishes to set Sail!"},"goals/134":{"Icon":"","level":"1","goalID":134,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/horse_stable-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/horse_stable"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Build a Horse Stable","subgoalHint":"Look under Houses tab in Shop","subgoalID":"134s1"}],"rewards":[{"type":"xp","amount":"100"}],"storyTitle":"Knights' Horses!","finishedText":"King's Wishlist: 35 / 55 Fulfill all wishes to set Sail!"},"goals/135":{"Icon":"","level":"1","goalID":135,"subgoals":[{"amount":"20","action":"game:contract/collect","level":"1","icon":"farming/seed-melon-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-melon"},"rewards":[{"type":"gold","amount":"250"}],"subgoalText":"Collect Watermelons (x 20)","subgoalHint":"Tap on the farms to collect","subgoalID":"135s1"},{"amount":"15","action":"game:contract/collect","level":"1","icon":"farming/seed-beans-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-beans"},"rewards":[{"type":"gold","amount":"350"}],"subgoalText":"Collect Beans (x 15)","subgoalHint":"Tap on the farms to collect","subgoalID":"135s2"},{"amount":"10","action":"game:contract/collect","level":"1","icon":"farming/seed-wheat-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-wheat"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Collect Wheat (x 10)","subgoalHint":"TIP: Turn ON notifications to never miss a harvest!","subgoalID":"135s3"}],"rewards":[{"type":"xp","amount":"150"}],"storyTitle":"Food Shortage!","finishedText":"King's Wishlist: 36 / 55 Fulfill all wishes to set Sail!"},"goals/136":{"Icon":"","level":"1","goalID":136,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/observatory-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/observatory"},"rewards":[{"type":"gold","amount":"2000"}],"subgoalText":"Build an Observatory","subgoalHint":"Look under Houses tab in Shop","subgoalID":"136s1"}],"rewards":[{"type":"xp","amount":"100"}],"storyTitle":"Astronomy","finishedText":"King's Wishlist: 37 / 55 Fulfill all wishes to set Sail!"},"goals/137":{"Icon":"","level":"1","goalID":137,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/villager_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/villager_house"},"rewards":[{"type":"gold","amount":"300"}],"subgoalText":"Build Villager's House (x 1)","subgoalHint":"TIP: Rearrange your houses and farms to accomodate more houses","subgoalID":"137s1"},{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/poor_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/poor_house"},"rewards":[{"type":"gold","amount":"400"}],"subgoalText":"Build Peasant's House (x 1)","subgoalHint":"INFO: Peasant houses deliver gold every 3 minutes!","subgoalID":"137s2"}],"rewards":[{"type":"xp","amount":"100"}],"storyTitle":"Labor Shortage","finishedText":"King's Wishlist: 38 / 55 Fulfill all wishes to set Sail!"},"goals/138":{"Icon":"","level":"1","goalID":138,"subgoals":[{"amount":1,"action":"game:boosts/maybe-change","level":"1","icon":"buildings/goldBoost_icon.png","type":"listen","event":"game:boosts/maybe-change","objects":{"entity.boost":"5","entity.key":"buildings/knights_house"},"rewards":[{"type":"gold","amount":"250"}],"subgoalText":"Boost KnightHouse (+ 5%)","subgoalHint":"TIP: Place decorations near the Knights House","subgoalID":"138s1"}],"rewards":[{"type":"xp","amount":"100"}],"storyTitle":"Knights Boost","finishedText":"King's Wishlist: 39 / 55 Fulfill all wishes to set Sail!"},"goals/139":{"Icon":"","level":"1","goalID":139,"subgoals":[{"amount":"30","action":"game:contract/collect","level":"1","icon":"farming/seed-melon-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-melon"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Collect Watermelons (x 30)","subgoalHint":"Look under the farming tab in Shop","subgoalID":"139s1"}],"rewards":[{"type":"xp","amount":"150"}],"storyTitle":"Hungry Villagers!","finishedText":"King's Wishlist: 40 / 55 Fulfill all wishes to set Sail!"},"goals/140":{"Icon":"","level":"1","goalID":140,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/jokers_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/jokers_house"},"rewards":[{"type":"gold","amount":"2500"}],"subgoalText":"Build a Joker's House","subgoalHint":"Look under the Houses tab in Shop","subgoalID":"140s1"}],"rewards":[{"type":"xp","amount":"100"}],"storyTitle":"Standup Comedy","finishedText":"King's Wishlist: 41 / 55 Fulfill all wishes to set Sail!"},"goals/141":{"Icon":"","level":"1","goalID":141,"subgoals":[{"amount":"10","action":"game:contract/collect","level":"1","icon":"farming/seed-pumpkin-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-pumpkin"},"rewards":[{"type":"gold","amount":"750"}],"subgoalText":"Collect Pumpkins (x 10)","subgoalHint":"TIP: Turn ON notifications to never miss a harvest!","subgoalID":"141s1"}],"rewards":[{"type":"xp","amount":"150"}],"storyTitle":"Knights' Wishes","finishedText":"King's Wishlist: 42 / 55 Fulfill all wishes to set Sail!"},"goals/142":{"Icon":"","level":"1","goalID":142,"subgoals":[{"amount":"20","action":"game:contract/collect","level":"1","icon":"farming/seed-wheat-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-wheat"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Collect Wheat (x 20)","subgoalHint":"TIP: Turn ON notifications to never miss a harvest!","subgoalID":"142s1"}],"rewards":[{"type":"xp","amount":"200"}],"storyTitle":"Bread Shortage","finishedText":"King's Wishlist: 43 / 55 Fulfill all wishes to set Sail!"},"goals/143":{"Icon":"","level":"1","goalID":143,"subgoals":[{"amount":"1","action":"game:building/connected","level":"1","icon":"buildings/ozzystent_icon.png","type":"have","event":"game:building/connected","objects":{"key":"buildings/ozzystent","connected":true},"rewards":[{"type":"gold","amount":"3000"}],"subgoalText":"Rescue the Oracle's Tent","subgoalHint":"TIP: Build a road leading to the dark clouds. Reconnect to road if previously unlocked.","subgoalID":"143s1"}],"rewards":[{"type":"xp","amount":"75"}],"storyTitle":"Oracle's Lair","finishedText":"King's Wishlist: 44 / 55 Fulfill all wishes to set Sail!"},"goals/144":{"Icon":"","level":"1","goalID":144,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/tailor_shop-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/tailor_shop"},"rewards":[{"type":"gold","amount":"500"}],"subgoalText":"Build a Tailor House","subgoalHint":"Look under Houses tab in Shop","subgoalID":"144s1"}],"rewards":[{"type":"xp","amount":"100"}],"storyTitle":"Gold Mining","finishedText":"King's Wishlist: 45 / 55 Fulfill all wishes to set Sail!"},"goals/145":{"Icon":"","level":"1","goalID":145,"subgoals":[{"amount":"30","action":"game:contract/collect","level":"1","icon":"farming/seed-strawberry-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-strawberry"},"rewards":[{"type":"gold","amount":"1500"}],"subgoalText":"Collect Strawberries (x 30)","subgoalHint":"TIP: Turn ON notifications to never miss a harvest!","subgoalID":"145s1"}],"rewards":[{"type":"xp","amount":"120"}],"storyTitle":"Strawberry Pies","finishedText":"King's Wishlist: 46 / 55 Fulfill all wishes to set Sail!"},"goals/146":{"Icon":"","level":"1","goalID":146,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/ladys_house-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/ladys_house"},"rewards":[{"type":"gold","amount":"5000"}],"subgoalText":"Build a Lady's House","subgoalHint":"Look under the Houses tab in Shop","subgoalID":"146s1"}],"rewards":[{"type":"xp","amount":"130"}],"storyTitle":"My Fair Lady","finishedText":"King's Wishlist: 47 / 55 Fulfill all wishes to set Sail!"},"goals/147":{"Icon":"","level":"1","goalID":147,"subgoals":[{"amount":"30","action":"game:contract/collect","level":"1","icon":"farming/seed-pumpkin-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-pumpkin"},"rewards":[{"type":"gold","amount":"3000"}],"subgoalText":"Collect Pumpkins (x 30)","subgoalHint":"TIP: Turn ON notifications to never miss a harvest!","subgoalID":"147s1"},{"amount":"30","action":"game:contract/collect","level":"1","icon":"farming/seed-melon-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-melon"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Collect Watermelons (x 30)","subgoalHint":"Look under the farming tab in Shop","subgoalID":"147s2"},{"amount":"30","action":"game:contract/collect","level":"1","icon":"farming/seed-vineyard-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-grapes"},"rewards":[{"type":"gold","amount":"2000"}],"subgoalText":"Collect Grapes (x 30)","subgoalHint":"Look under the farming tab in Shop","subgoalID":"147s3"},{"amount":"25","action":"game:contract/collect","level":"1","icon":"farming/seed-beans-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-beans"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Collect Beans (x 25)","subgoalHint":"Look under the farming tab in Shop","subgoalID":"147s4"}],"rewards":[{"type":"xp","amount":"250"}],"storyTitle":"King Sized Meal","finishedText":"King's Wishlist: 48 / 55 Fulfill all wishes to set Sail!"},"goals/148":{"Icon":"","level":"1","goalID":148,"subgoals":[{"amount":"2","action":"game:entity/buy","level":"1","icon":"decorations/well-icon.png","type":"listen","event":"game:entity/buy","objects":{"entity.key":"decorations/well"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Buy 2 Wells","subgoalHint":"Look under the decorations tab in Shop","subgoalID":"148s1"},{"amount":"2","action":"game:entity/buy","level":"1","icon":"decorations/fountain_rock-icon.png","type":"listen","event":"game:entity/buy","objects":{"entity.key":"decorations/fountain_rock"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Buy 2 Fountains","subgoalHint":"Place fountains near houses for gold boost","subgoalID":"148s2"},{"amount":"3","action":"game:entity/buy","level":"1","icon":"decorations/scarecrow-icon.png","type":"listen","event":"game:entity/buy","objects":{"entity.key":"decorations/scarecrow"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Buy 3 Scarecrows","subgoalHint":"Place the Scarecrow near farm plots for food boost","subgoalID":"148s3"}],"rewards":[{"type":"xp","amount":"300"}],"storyTitle":"Outdoor Deco","finishedText":"King's Wishlist: 49 / 55 Fulfill all wishes to set Sail!"},"goals/149":{"Icon":"","level":"1","goalID":149,"subgoals":[{"amount":"1","level":"1","icon":"buildings/bath_house-icon.png","type":"listen","objects":{"entity.key":"buildings/bath_house"},"rewards":[{"type":"gold","amount":"1000"}],"subgoalText":"Buy a Bath House","subgoalHint":"Look under the Houses tab in Shop","subgoalID":"149s1"}],"rewards":[{"type":"xp","amount":"300"}],"storyTitle":"Roman Baths","finishedText":"King's Wishlist: 50 / 55 Fulfill all wishes to set Sail!"},"goals/150":{"Icon":"","level":"1","goalID":150,"subgoals":[{"amount":"50","action":"game:contract/collect","level":"1","icon":"buildings/taxes_icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"house"},"rewards":[{"type":"gold","amount":"5000"}],"subgoalText":"Collect Taxes (x 50)","subgoalHint":"Tap on any building to collect taxes","subgoalID":"150s1"}],"rewards":[{"type":"xp","amount":"300"}],"storyTitle":"Heavy Taxes","finishedText":"King's Wishlist: 51 / 55 Fulfill all wishes to set Sail!"},"goals/151":{"Icon":"","level":"1","goalID":151,"subgoals":[{"amount":"1","action":"game:entity/buy","level":"1","icon":"buildings/wedding_chapel-icon.png","type":"have","event":"game:entity/buy","objects":{"entity.key":"buildings/wedding_chapel"},"rewards":[{"type":"gold","amount":"4000"}],"subgoalText":"Build a Wedding Chapel","subgoalHint":"Look under Houses tab in Shop","subgoalID":"151s1"}],"rewards":[{"type":"xp","amount":"400"}],"storyTitle":"Matrimonials","finishedText":"King's Wishlist: 52 / 55 Fulfill all wishes to set Sail!"},"goals/152":{"Icon":"","level":"1","goalID":152,"subgoals":[{"amount":"1","action":"game:building/connected","level":"1","icon":"buildings/elves_icon.png","type":"have","event":"game:building/connected","objects":{"key":"buildings/vikingsmith","connected":true},"rewards":[{"type":"gold","amount":"6000"}],"subgoalText":"Rescue the Forge","subgoalHint":"TIP: Build a road leading to the dark clouds. Reconnect to road if previously unlocked.","subgoalID":"152s1"}],"rewards":[{"type":"xp","amount":"250"}],"storyTitle":"Final Frontier","finishedText":"King's Wishlist: 53 / 55 Fulfill all wishes to set Sail!"},"goals/153":{"Icon":"","level":"1","goalID":153,"subgoals":[{"amount":"10","action":"game:enemy/kill","level":"1","icon":"characters/baby_icon.png","type":"listen","event":"game:enemy/kill","objects":{"entity.key":"characters/troll"},"rewards":[{"type":"gold","amount":"3000"}],"subgoalText":"Whack Trolls (x 10)","subgoalHint":"TIP: Chop some trees to spawn the trolls. Storks are scared of trolls!","subgoalID":"153s1"},{"amount":"20","action":"game:contract/collect","level":"1","icon":"farming/seed-pumpkin-icon.png","type":"listen","event":"game:contract/collect","objects":{"entity.definition.class":"house","entity.key":"farming/seed-pumpkin"},"rewards":[{"type":"gold","amount":"10000"}],"subgoalText":"Collect Pumpkins (x 20)","subgoalHint":"TIP: Turn on notifications to never miss a harvest!","subgoalID":"153s2"},{"amount":"30","action":"game:contract/start","level":"1","icon":"farming/seed-vineyard-icon.png","type":"listen","event":"game:contract/start","objects":{"entity.definition.class":"farm","contract.seedName":"farming/seed-grapes"},"rewards":[{"type":"gold","amount":"5000"}],"subgoalText":"Plant Grapes (x 30)","subgoalHint":"TIP: Turn on notifications to never miss a harvest!","subgoalID":"153s3"}],"rewards":[{"type":"xp","amount":"250"}],"storyTitle":"For My Grandson","finishedText":"King's Wishlist: 54 / 55 Fulfill all wishes to set Sail!"},"goals/154":{"Icon":"","level":"1","goalID":154,"subgoals":[{"amount":"1","action":"game:building/connected","level":"1","icon":"buildings/coming_soon.png","type":"listen","event":"game:building/connected","objects":{"key":"buildings/vikingsmith","connected":true},"rewards":[{"type":"gold","amount":"0"}],"subgoalText":"More Wishes Coming Soon!","subgoalHint":"Your Ship will sail in no time!","subgoalID":"154s1"}],"rewards":[{"type":"xp","amount":"0"}],"storyTitle":"Coming Soon!","finishedText":"King's Wishlist: 55 / 55 Fulfill all wishes to set Sail!"}}}} ;
window.wooga.castle.version = "ccf1055604db90bf5d002b18373530d620141775" ;
window.wooga.castle.tutorial = [{"arrow":{"left":0,"position":[-14,6],"top":10,"rotation":0},"center":[-16,5],"scroll":true,"text":"Squaak! That's a hideous troll... Tap on him to fight!","can":["punch-enemy","hardware/info"],"show":null,"next":"game:enemy/whack"},{"arrow":{"left":0,"position":[-14,6],"top":10,"rotation":0},"center":[-16,5],"scroll":true,"text":"Tap once more... On his head!","can":"punch-enemy","show":null,"next":"game:enemy/whack"},{"arrow":{"left":0,"position":[-14,6],"top":10,"rotation":0},"center":[-16,5],"scroll":true,"text":"A final tap should scare him off!","can":["punch-enemy","kill-enemy","progress-goal"],"show":null,"next":"game:enemy/kill"},{"arrow":{"left":50,"position":"#goals-drawer","type":"right","top":-15,"rotation":0},"scroll":true,"text":"Squaak! You fulfilled my King's wish! Tap the Magic Scroll to see his wishlist.","can":"enter-goals","show":null,"next":"view:goals/show"},{"arrow":{"left":-230,"position":".xgoals .subgoal-list .subgoal:nth-of-type(1) .description .button","top":-140,"rotation":0},"textY":360,"text":"The King rewards generously for fulfilling his wishes! Collect your reward...","can":"collect-subgoal","show":null,"next":"game:goal/subgoal-collected"},{"arrow":{"left":-70,"position":".xgoals .head .cancel","top":15,"rotation":35},"textY":80,"text":"Tap the close button to proceed...","can":"close-goals","show":null,"next":"view:goals/close"},{"arrow":{"left":-65,"position":"#showShopButton","top":-40,"rotation":325},"text":"Let's build a house in this village... You can buy one in the Shop.","can":["enter-shop","show-overlay","progress-goal"],"show":null,"next":"view:shop/show"},{"back":"view:shop/close","arrow":{"left":40,"position":"[data-itemname=\"buildings/poor_house\"] .image img","type":"left","top":25,"rotation":15},"center":[-14,6],"hide":["view:shop/seed"],"scroll":true,"text":"Buy a Peasant's House by tapping the green button...","can":"shop/preview","valid":{"can":{"value":"buildings/poor_house","key":"entityName"},"next":{"value":"buildings/poor_house","key":"entityName"}},"show":["view:shop/show","view:shop/change-department"],"next":"view:shop/preview"},{"arrow":{"left":16,"position":[-14,5],"type":"right","top":0},"center":[-14,6],"text":"Drag the house over to the highlighted area & confirm!","can":["shoppreviewmode/accept","progress-goal"],"valid":{"can":[{"value":-12,"key":"mapX"},{"value":11,"key":"mapY"}]},"hilite":{"position":[-12,11],"height":2,"width":2},"show":"view:shop/preview","subroutine":"housePlacementCorrections","next":["game:entity/buy"]},{"arrow":{"left":-65,"position":"#showCursorButton","top":-40,"rotation":325},"text":"Houses need roads that lead to the Castle! Tap the Road button...","can":["enter-roads","progress-goal"],"show":"view:shop/preview","next":"view:roadsMode/set"},{"arrow":{"left":0,"position":[-9,9],"type":"right","top":-10,"rotation":0},"scroll":true,"text":"Build roads by tapping the map... One tap at the time!","can":"add-road","valid":{"can":[{"value":-10,"key":"x"},{"value":10,"key":"y"}]},"hilite":{"position":[-10,10],"height":1,"width":1},"show":null,"next":"game:road/add"},{"arrow":{"left":0,"position":[-9,10],"type":"right","top":-10,"rotation":-35},"scroll":true,"text":"Tap once more to connect the house.","can":"add-road","valid":{"can":[{"value":-10,"key":"x"},{"value":11,"key":"y"}]},"hilite":{"position":[-10,11],"height":1,"width":1},"show":null,"next":"game:road/add"},{"arrow":{"left":-70,"position":".hud_mode.roads .close","top":15,"rotation":35},"scroll":true,"textY":80,"text":"You are doing grrreat! Tap here to stop building roads.","can":"leave-roads","show":null,"next":"view:roads/accept"},{"arrow":{"left":50,"position":"#goals-drawer","type":"right","top":-15,"rotation":0},"scroll":true,"text":"Squaak! I sense the chosen one in you that the prophecy has foretold... Tap the Magic Scroll!","can":"enter-goals","show":null,"next":"view:goals/show"},{"arrow":{"left":-230,"position":".xgoals .subgoal-list .subgoal:nth-of-type(1) .description .button","top":-140,"rotation":0},"textY":360,"text":"Fulfill all King's wishes to get generous rewards and to finish building your ship!","can":"collect-subgoal","show":null,"next":"game:goal/subgoal-collected"}] ;
window.wooga.castle.levels = {"predefined":[null,{"xp":70,"rewards":[{"amount":50,"type":"food"}],"nextLevel":1},{"xp":70,"rewards":[{"amount":75,"type":"food"}],"nextLevel":2},{"xp":90,"rewards":[{"amount":100,"type":"food"}],"nextLevel":3},{"xp":110,"rewards":[{"amount":225,"type":"food"}],"nextLevel":4},{"xp":130,"rewards":[{"amount":250,"type":"food"}],"nextLevel":5},{"xp":150,"rewards":[{"amount":275,"type":"food"}],"nextLevel":6},{"xp":170,"rewards":[{"amount":250,"type":"food"}],"nextLevel":7},{"xp":190,"rewards":[{"amount":275,"type":"food"}],"nextLevel":8},{"xp":210,"rewards":[{"amount":250,"type":"food"}],"nextLevel":9},{"xp":230,"rewards":[{"amount":275,"type":"food"}],"nextLevel":10},{"xp":250,"rewards":[{"amount":250,"type":"food"}],"nextLevel":11},{"xp":270,"rewards":[{"amount":275,"type":"food"}],"nextLevel":12},{"xp":290,"rewards":[{"amount":250,"type":"food"}],"nextLevel":13},{"xp":310,"rewards":[{"amount":275,"type":"food"}],"nextLevel":14},{"xp":330,"rewards":[{"amount":250,"type":"food"}],"nextLevel":15},{"xp":350,"rewards":[{"amount":275,"type":"food"}],"nextLevel":16},{"xp":370,"rewards":[{"amount":250,"type":"food"}],"nextLevel":17},{"xp":390,"rewards":[{"amount":275,"type":"food"}],"nextLevel":18},{"xp":410,"rewards":[{"amount":250,"type":"food"}],"nextLevel":19},{"xp":430,"rewards":[{"amount":275,"type":"food"}],"nextLevel":20},{"xp":450,"rewards":[{"amount":250,"type":"food"}],"nextLevel":21},{"xp":470,"rewards":[{"amount":275,"type":"food"}],"nextLevel":22},{"xp":490,"rewards":[{"amount":250,"type":"food"}],"nextLevel":23},{"xp":510,"rewards":[{"amount":275,"type":"food"}],"nextLevel":24},{"xp":530,"rewards":[{"amount":250,"type":"food"}],"nextLevel":25},{"xp":550,"rewards":[{"amount":275,"type":"food"}],"nextLevel":26},{"xp":570,"rewards":[{"amount":250,"type":"food"}],"nextLevel":27},{"xp":590,"rewards":[{"amount":275,"type":"food"}],"nextLevel":28},{"xp":610,"rewards":[{"amount":250,"type":"food"}],"nextLevel":29},{"xp":630,"rewards":[{"amount":275,"type":"food"}],"nextLevel":30},{"xp":650,"rewards":[{"amount":250,"type":"food"}],"nextLevel":31},{"xp":670,"rewards":[{"amount":275,"type":"food"}],"nextLevel":32},{"xp":690,"rewards":[{"amount":250,"type":"food"}],"nextLevel":33},{"xp":710,"rewards":[{"amount":275,"type":"food"}],"nextLevel":34},{"xp":730,"rewards":[{"amount":250,"type":"food"}],"nextLevel":35},{"xp":750,"rewards":[{"amount":275,"type":"food"}],"nextLevel":36},{"xp":770,"rewards":[{"amount":250,"type":"food"}],"nextLevel":37},{"xp":790,"rewards":[{"amount":275,"type":"food"}],"nextLevel":38},{"xp":810,"rewards":[{"amount":250,"type":"food"}],"nextLevel":39},{"xp":830,"rewards":[{"amount":275,"type":"food"}],"nextLevel":40},{"xp":850,"rewards":[{"amount":250,"type":"food"}],"nextLevel":41},{"xp":870,"rewards":[{"amount":275,"type":"food"}],"nextLevel":42},{"xp":890,"rewards":[{"amount":250,"type":"food"}],"nextLevel":43},{"xp":910,"rewards":[{"amount":275,"type":"food"}],"nextLevel":44},{"xp":930,"rewards":[{"amount":250,"type":"food"}],"nextLevel":45},{"xp":950,"rewards":[{"amount":275,"type":"food"}],"nextLevel":46},{"xp":970,"rewards":[{"amount":250,"type":"food"}],"nextLevel":47},{"xp":990,"rewards":[{"amount":275,"type":"food"}],"nextLevel":48},{"xp":1010,"rewards":[{"amount":250,"type":"food"}],"nextLevel":49},{"xp":1030,"rewards":[{"amount":275,"type":"food"}],"nextLevel":50},{"xp":1050,"rewards":[{"amount":250,"type":"food"}],"nextLevel":51},{"xp":1070,"rewards":[{"amount":275,"type":"food"}],"nextLevel":52},{"xp":1090,"rewards":[{"amount":250,"type":"food"}],"nextLevel":53},{"xp":1110,"rewards":[{"amount":275,"type":"food"}],"nextLevel":54},{"xp":1130,"rewards":[{"amount":250,"type":"food"}],"nextLevel":55},{"xp":1150,"rewards":[{"amount":275,"type":"food"}],"nextLevel":56},{"xp":1170,"rewards":[{"amount":250,"type":"food"}],"nextLevel":57},{"xp":1190,"rewards":[{"amount":275,"type":"food"}],"nextLevel":58},{"xp":1210,"rewards":[{"amount":250,"type":"food"}],"nextLevel":59},{"xp":1230,"rewards":[{"amount":275,"type":"food"}],"nextLevel":60}]} ;
(function(b,c){var a={};a.ajax=function(e){var d=new XMLHttpRequest(),g=null,f;e.error=e.error||function(){};d.onreadystatechange=function(){if(d.readyState==4){if(e.dataType&&(""+e.dataType).toLowerCase()==="json"){try{e.success(JSON.parse(this.responseText))}catch(h){e.error(h)}}else{e.success(this.responseText)}}};d.onerror=function(){};if(e.data){g=[];for(f in e.data){g.push(encodeURIComponent(f)+"="+encodeURIComponent(e.data[f]))}g=g.join("&")}d.open(e.type||"GET",e.url,c!==e.async?e.async:true);d.setRequestHeader("content-type",e.contentType?e.contentType:"application/x-www-form-urlencoded");d.setRequestHeader("X-Requested-With","XMLHttpRequest");d.send(g)};b.$=a})(window);(function(){var rsplit=function(string,regex){var result=regex.exec(string),retArr=new Array(),first_idx,last_idx,first_bit;while(result!=null){first_idx=result.index;last_idx=regex.lastIndex;if((first_idx)!=0){first_bit=string.substring(0,first_idx);retArr.push(string.substring(0,first_idx));string=string.slice(first_idx)}retArr.push(result[0]);string=string.slice(result[0].length);result=regex.exec(string)}if(!string==""){retArr.push(string)}return retArr},chop=function(string){return string.substr(0,string.length-1)},extend=function(d,s){for(var n in s){if(s.hasOwnProperty(n)){d[n]=s[n]}}};EJS=function(options){options=typeof options=="string"?{view:options}:options;this.set_options(options);if(options.precompiled){this.template={};this.template.process=options.precompiled;EJS.update(this.name,this);return}if(options.element){if(typeof options.element=="string"){var name=options.element;options.element=document.getElementById(options.element);if(options.element==null){throw name+"does not exist!"}}if(options.element.value){this.text=options.element.value}else{this.text=options.element.innerHTML}this.name=options.element.id;this.type="["}else{if(options.url){options.url=EJS.endExt(options.url,this.extMatch);this.name=this.name?this.name:options.url;var url=options.url;var template=EJS.get(this.name,this.cache);if(template){return template}if(template==EJS.INVALID_PATH){return null}try{this.text=EJS.request(url+(this.cache?"":"?"+Math.random()))}catch(e){}if(this.text==null){throw ({type:"EJS",message:"There is no template at "+url})}}}var template=new EJS.Compiler(this.text,this.type);template.compile(options,this.name);EJS.update(this.name,this);this.template=template};EJS.prototype={render:function(object,extra_helpers){object=object||{};this._extra_helpers=extra_helpers;var v=new EJS.Helpers(object,extra_helpers||{});return this.template.process.call(object,object,v)},update:function(element,options){if(typeof element=="string"){element=document.getElementById(element)}if(options==null){_template=this;return function(object){EJS.prototype.update.call(_template,element,object)}}if(typeof options=="string"){params={};params.url=options;_template=this;params.onComplete=function(request){var object=eval(request.responseText);EJS.prototype.update.call(_template,element,object)};EJS.ajax_request(params)}else{element.innerHTML=this.render(options)}},out:function(){return this.template.out},set_options:function(options){this.type=options.type||EJS.type;this.cache=options.cache!=null?options.cache:EJS.cache;this.text=options.text||null;this.name=options.name||null;this.ext=options.ext||EJS.ext;this.extMatch=new RegExp(this.ext.replace(/\./,"."))}};EJS.endExt=function(path,match){if(!path){return null}match.lastIndex=0;return path+(match.test(path)?"":this.ext)};EJS.Scanner=function(source,left,right){extend(this,{left_delimiter:left+"%",right_delimiter:"%"+right,double_left:left+"%%",double_right:"%%"+right,left_equal:left+"%=",left_comment:left+"%#"});this.SplitRegexp=left=="["?/(\[%%)|(%%\])|(\[%=)|(\[%#)|(\[%)|(%\]\n)|(%\])|(\n)/:new RegExp("("+this.double_left+")|(%%"+this.double_right+")|("+this.left_equal+")|("+this.left_comment+")|("+this.left_delimiter+")|("+this.right_delimiter+"\n)|("+this.right_delimiter+")|(\n)");this.source=source;this.stag=null;this.lines=0};EJS.Scanner.to_text=function(input){if(input==null||input===undefined){return""}if(input instanceof Date){return input.toDateString()}if(input.toString){return input.toString()}return""};EJS.Scanner.prototype={scan:function(block){scanline=this.scanline;regex=this.SplitRegexp;if(!this.source==""){var source_split=rsplit(this.source,/\n/);for(var i=0;i<source_split.length;i++){var item=source_split[i];this.scanline(item,regex,block)}}},scanline:function(line,regex,block){this.lines++;var line_split=rsplit(line,regex);for(var i=0;i<line_split.length;i++){var token=line_split[i];if(token!=null){try{block(token,this)}catch(e){throw {type:"EJS.Scanner",line:this.lines}}}}}};EJS.Buffer=function(pre_cmd,post_cmd){this.line=new Array();this.script="";this.pre_cmd=pre_cmd;this.post_cmd=post_cmd;for(var i=0;i<this.pre_cmd.length;i++){this.push(pre_cmd[i])}};EJS.Buffer.prototype={push:function(cmd){this.line.push(cmd)},cr:function(){this.script=this.script+this.line.join("; ");this.line=new Array();this.script=this.script+"\n"},close:function(){if(this.line.length>0){for(var i=0;i<this.post_cmd.length;i++){this.push(pre_cmd[i])}this.script=this.script+this.line.join("; ");line=null}}};EJS.Compiler=function(source,left){this.pre_cmd=["var ___ViewO = [];"];this.post_cmd=new Array();this.source=" ";if(source!=null){if(typeof source=="string"){source=source.replace(/\r\n/g,"\n");source=source.replace(/\r/g,"\n");this.source=source}else{if(source.innerHTML){this.source=source.innerHTML}}if(typeof this.source!="string"){this.source=""}}left=left||"<";var right=">";switch(left){case"[":right="]";break;case"<":break;default:throw left+" is not a supported deliminator";break}this.scanner=new EJS.Scanner(this.source,left,right);this.out=""};EJS.Compiler.prototype={compile:function(options,name){options=options||{};this.out="";var put_cmd="___ViewO.push(";var insert_cmd=put_cmd;var buff=new EJS.Buffer(this.pre_cmd,this.post_cmd);var content="";var clean=function(content){content=content.replace(/\\/g,"\\\\");content=content.replace(/\n/g,"\\n");content=content.replace(/"/g,'\\"');return content};this.scanner.scan(function(token,scanner){if(scanner.stag==null){switch(token){case"\n":content=content+"\n";buff.push(put_cmd+'"'+clean(content)+'");');buff.cr();content="";break;case scanner.left_delimiter:case scanner.left_equal:case scanner.left_comment:scanner.stag=token;if(content.length>0){buff.push(put_cmd+'"'+clean(content)+'")')}content="";break;case scanner.double_left:content=content+scanner.left_delimiter;break;default:content=content+token;break}}else{switch(token){case scanner.right_delimiter:switch(scanner.stag){case scanner.left_delimiter:if(content[content.length-1]=="\n"){content=chop(content);buff.push(content);buff.cr()}else{buff.push(content)}break;case scanner.left_equal:buff.push(insert_cmd+"(EJS.Scanner.to_text("+content+")))");break}scanner.stag=null;content="";break;case scanner.double_right:content=content+scanner.right_delimiter;break;default:content=content+token;break}}});if(content.length>0){buff.push(put_cmd+'"'+clean(content)+'")')}buff.close();this.out=buff.script+";";var to_be_evaled="/*"+name+"*/this.process = function (_CONTEXT,_VIEW) { try { with(_VIEW) { with (_CONTEXT) {"+this.out+" return ___ViewO.join('');}}}catch(e) {e.lineNumber=null;throw e;}};";try{eval(to_be_evaled)}catch(e){if(typeof JSLINT!="undefined"){JSLINT(this.out);for(var i=0;i<JSLINT.errors.length;i++){var error=JSLINT.errors[i];if(error.reason!="Unnecessary semicolon."){error.line++;var e=new Error();e.lineNumber=error.line;e.message=error.reason;if(options.view){e.fileName=options.view}throw e}}}else{throw e}}}};EJS.config=function(options){EJS.cache=options.cache!=null?options.cache:EJS.cache;EJS.type=options.type!=null?options.type:EJS.type;EJS.ext=options.ext!=null?options.ext:EJS.ext;var templates_directory=EJS.templates_directory||{};EJS.templates_directory=templates_directory;EJS.get=function(path,cache){if(cache==false){return null}if(templates_directory[path]){return templates_directory[path]}return null};EJS.update=function(path,template){if(path==null){return}templates_directory[path]=template};EJS.INVALID_PATH=-1};EJS.config({cache:true,type:"<",ext:".ejs"});EJS.Helpers=function(data,extras){this._data=data;this._extras=extras;extend(this,extras)};EJS.Helpers.prototype={view:function(options,data,helpers){if(!helpers){helpers=this._extras}if(!data){data=this._data}return new EJS(options).render(data,helpers)},to_text:function(input,null_text){if(input==null||input===undefined){return null_text||""}if(input instanceof Date){return input.toDateString()}if(input.toString){return input.toString().replace(/\n/g,"<br />").replace(/''/g,"'")}return""}};EJS.newRequest=function(){var factories=[function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new XMLHttpRequest()},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];for(var i=0;i<factories.length;i++){try{var request=factories[i]();if(request!=null){return request}}catch(e){continue}}};EJS.request=function(path){var request=new EJS.newRequest();request.open("GET",path,false);try{request.send(null)}catch(e){return null}if(request.status==404||request.status==2||(request.status==0&&request.responseText=="")){return null}return request.responseText};EJS.ajax_request=function(params){params.method=(params.method?params.method:"GET");var request=new EJS.newRequest();request.onreadystatechange=function(){if(request.readyState==4){if(request.status==200){params.onComplete(request)}else{params.onComplete(request)}}};request.open(params.method,params.url);request.send(null)}})();EJS.Helpers.prototype.date_tag=function(b,f,d){if(!(f instanceof Date)){f=new Date()}var c=["January","February","March","April","May","June","July","August","September","October","November","December"];var o=[],a=[],e=[];var l=f.getFullYear();var n=f.getMonth();var g=f.getDate();for(var h=l-15;h<l+15;h++){o.push({value:h,text:h})}for(var q=0;q<12;q++){a.push({value:(q),text:c[q]})}for(var m=0;m<31;m++){e.push({value:(m+1),text:(m+1)})}var j=this.select_tag(b+"[year]",l,o,{id:b+"[year]"});var p=this.select_tag(b+"[month]",n,a,{id:b+"[month]"});var k=this.select_tag(b+"[day]",g,e,{id:b+"[day]"});return j+p+k};EJS.Helpers.prototype.form_tag=function(b,a){a=a||{};a.action=b;if(a.multipart==true){a.method="post";a.enctype="multipart/form-data"}return this.start_tag_for("form",a)};EJS.Helpers.prototype.form_tag_end=function(){return this.tag_end("form")};EJS.Helpers.prototype.hidden_field_tag=function(a,b,c){return this.input_field_tag(a,b,"hidden",c)};EJS.Helpers.prototype.input_field_tag=function(a,b,c,d){d=d||{};d.id=d.id||a;d.value=b||"";d.type=c||"text";d.name=a;return this.single_tag_for("input",d)};EJS.Helpers.prototype.is_current_page=function(a){return(window.location.href==a||window.location.pathname==a?true:false)};EJS.Helpers.prototype.link_to=function(c,a,b){if(!c){var c="null"}if(!b){var b={}}if(b.confirm){b.onclick=' var ret_confirm = confirm("'+b.confirm+'"); if(!ret_confirm) { return false;} ';b.confirm=null}b.href=a;return this.start_tag_for("a",b)+c+this.tag_end("a")};EJS.Helpers.prototype.submit_link_to=function(c,a,b){if(!c){var c="null"}if(!b){var b={}}b.onclick=b.onclick||"";if(b.confirm){b.onclick=' var ret_confirm = confirm("'+b.confirm+'"); if(!ret_confirm) { return false;} ';b.confirm=null}b.value=c;b.type="submit";b.onclick=b.onclick+(a?this.url_for(a):"")+"return false;";return this.start_tag_for("input",b)};EJS.Helpers.prototype.link_to_if=function(b,f,a,d,e,c){return this.link_to_unless((b==false),f,a,d,e,c)};EJS.Helpers.prototype.link_to_unless=function(b,e,a,d,c){d=d||{};if(b){if(c&&typeof c=="function"){return c(e,a,d,c)}else{return e}}else{return this.link_to(e,a,d)}};EJS.Helpers.prototype.link_to_unless_current=function(d,a,c,b){c=c||{};return this.link_to_unless(this.is_current_page(a),d,a,c,b)};EJS.Helpers.prototype.password_field_tag=function(a,b,c){return this.input_field_tag(a,b,"password",c)};EJS.Helpers.prototype.select_tag=function(f,c,b,d){d=d||{};d.id=d.id||f;d.value=c;d.name=f;var h="";h+=this.start_tag_for("select",d);for(var e=0;e<b.length;e++){var g=b[e];var a={value:g.value};if(g.value==c){a.selected="selected"}h+=this.start_tag_for("option",a)+g.text+this.tag_end("option")}h+=this.tag_end("select");return h};EJS.Helpers.prototype.single_tag_for=function(a,b){return this.tag(a,b,"/>")};EJS.Helpers.prototype.start_tag_for=function(a,b){return this.tag(a,b)};EJS.Helpers.prototype.submit_tag=function(a,b){b=b||{};b.type=b.type||"submit";b.value=a||"Submit";return this.single_tag_for("input",b)};EJS.Helpers.prototype.tag=function(e,c,d){if(!d){var d=">"}var f=" ";for(var a in c){if(c[a]!=null){var b=c[a].toString()}else{var b=""}if(a=="Class"){a="class"}if(b.indexOf("'")!=-1){f+=a+'="'+b+'" '}else{f+=a+"='"+b+"' "}}return"<"+e+f+d};EJS.Helpers.prototype.tag_end=function(a){return"</"+a+">"};EJS.Helpers.prototype.text_area_tag=function(a,b,c){c=c||{};c.id=c.id||a;c.name=c.name||a;b=b||"";if(c.size){c.cols=c.size.split("x")[0];c.rows=c.size.split("x")[1];delete c.size}c.cols=c.cols||50;c.rows=c.rows||4;return this.start_tag_for("textarea",c)+b+this.tag_end("textarea")};EJS.Helpers.prototype.text_tag=EJS.Helpers.prototype.text_area_tag;EJS.Helpers.prototype.text_field_tag=function(a,b,c){return this.input_field_tag(a,b,"text",c)};EJS.Helpers.prototype.url_for=function(a){return'window.location="'+a+'";'};EJS.Helpers.prototype.img_tag=function(c,b,a){a=a||{};a.src=c;a.alt=b;return this.single_tag_for("img",a)};var wooga=wooga||{};wooga.castle=wooga.castle||{};wooga.castle.config=wooga.castle.config||{};(function(){var d=25*(window.devicePixelRatio||1);var a={};a.urlFor=function(f){var e=wooga.castle.config.manifest;return e?e[f]:f};a.urlForEntityImage=function(e){return a.urlFor(wooga.castle.IMAGES_BASE_URL+e)};a.bind=function(f,e){return function(){f.apply(e,arguments)}};a.mixin=function(f,e){var g;for(g in e){if(e.hasOwnProperty(g)){f.prototype[g]=e[g]}}};a.extend=function(e){Array.prototype.slice.call(arguments,1).forEach(function(f){var g;for(g in f){e[g]=f[g]}});return e};a.pushIfUnique=function(f,e){e.forEach(function(g){if(f.indexOf(g)<0){f.push(g)}})};a.PubSubMixin={subscribe:function(g,f,e){if(typeof this._PubSubBroker_subscribers==="undefined"){this._PubSubBroker_subscribers={}}var h=this._PubSubBroker_subscribers;if(typeof h[g]==="undefined"){h[g]=[]}h[g].push({fn:f,scope:e||this})},publish:function(g,f){var h=this._PubSubBroker_subscribers;if(f){f._channel=g}if(typeof h!=="undefined"){var e=Object.keys(h).filter(function(j){return j[j.length-1]==="/"?g.indexOf(j)===0:g===j});e.forEach(function(j){h[j].forEach(function(k){k.fn.call(k.scope,f)})})}},unsubscribe:function(g,f,e){var h=this._PubSubBroker_subscribers||{};if(typeof h[g]!=="undefined"){e=e||this;h[g]=h[g].filter(function(j){return !(j.fn===f&&e===j.scope)})}}};a.ObservableMixin={addEventHandler:function(h,g,f){var e=this._Observable_handlers=this._Observable_handlers||{};e[h]=e[h]||[];e[h].push({fn:g,scope:f||this})},removeEventHandler:function(h,g,f){f=f||this;var e=this._Observable_handlers;if(e&&e[h]){e[h]=e[h].filter(function(j){return(j.fn!==g)||(j.scope!==f)})}},fireEvent:function(g,h){h=h||{};h.target=h.target||this;var e=false;var f=this._Observable_handlers;if(f&&f[g]){f[g].forEach(function(j){if(j.fn.call(j.scope,h)===false){e=true}})}if(this.eventsBubbleTarget&&!e){this.eventsBubbleTarget.fireEvent(g,h)}}};a.Deferred=(function(){var e=function(){this.state=e.State.PENDING;this.callbacks=[];this.errbacks=[]};e.State={SUCCESS:1,PENDING:0,FAILURE:-1};e.prototype.addCallback=function(g,f){if(this.state===e.State.PENDING){this.callbacks.push({fn:g,scope:f})}else{if(this.state===e.State.SUCCESS){g.apply(f,this.result)}}return this};e.prototype.addErrback=function(g,f){if(this.state===e.State.PENDING){this.errbacks.push({fn:g,scope:f})}else{if(this.state===e.State.FAILURE){g.apply(f,this.result)}}return this};e.prototype.callback=function(){if(this.state===e.State.PENDING){this.state=e.State.SUCCESS;this.result=Array.prototype.slice.call(arguments);while(this.callbacks.length){var f=this.callbacks.shift();f.fn.apply(f.scope,this.result)}}};e.prototype.errback=function(){if(this.state===e.State.PENDING){this.state=e.State.FAILURE;this.result=Array.prototype.slice.call(arguments);while(this.errbacks.length){var f=this.errbacks.shift();f.fn.apply(f.scope,this.result)}}};return e}());var c={TIMEOUT:750,coordinates:[],preventGhostClick:function(e,f){c.coordinates.push(e,f);window.setTimeout(c.pop,c.TIMEOUT)},pop:function(){c.coordinates.splice(0,2)},onClick:function(g){var f,e,h;for(f=0;f<c.coordinates.length;f+=2){e=c.coordinates[f];h=c.coordinates[f+1];if(Math.abs(g.clientX-e)<d&&Math.abs(g.clientY-h)<d){g.stopPropagation();g.preventDefault()}}}};a.clickBuster=c;document.addEventListener("click",c.onClick,true);a.addTouchHandler=function(g,m,n){var j,h;var k,l,f,e;k=function(){g.removeEventListener("touchend",l,false);document.body.removeEventListener("touchmove",e,false)};l=function(o){o.stopPropagation();k();m.call(n||this,o);if(o.type==="touchend"){c.preventGhostClick(j,h)}};f=function(o){o.stopPropagation();g.addEventListener("touchend",l,false);document.body.addEventListener("touchmove",e,false);j=o.touches[0].clientX;h=o.touches[0].clientY};e=function(o){if(Math.abs(o.touches[0].clientX-j)>d||Math.abs(o.touches[0].clientY-h)>d){k()}};g.addEventListener("touchstart",f,false);g.addEventListener("click",l,true)};a.addLongTouchHandler=function(e,g,f){var j=null;var h=function(){if(j){clearTimeout(j)}};e.addEventListener("touchstart",function(k){j=window.setTimeout(function(){g.call(f,k)},950)},false);["touchend","touchmove"].forEach(function(k){e.addEventListener(k,h,false)});return a};a.enableScrollability=function(k){var f=0,g;var r,j;var p,l;var s=function(t){r=t;k.style.webkitTransform="translate3d(0, "+t+"px ,0)"};var m=function(){var v=k.offsetParent.offsetHeight-k.scrollHeight,t=0;var u;if(v>0){u=0}else{if(r>t){u=t}else{if(r<v){u=v}else{u=r}}}s(u)};var o=function(u){var t=u.touches?u.touches[0]:u;p=Math.abs(t.clientY-f);return a.can("scroll element",k)&&p>d};var h=function(u){var t=u.touches?u.touches[0]:u;g=t.clientX;f=t.clientY;j=r;p=false;l=true};var e=function(u){if(!l){return}var t=u.touches?u.touches[0]:u;if(p||o(t)){s(j+t.clientY-f)}};var q=function(){if(p){m();a.clickBuster.preventGhostClick(g,f)}l=false};var n=wooga.castle.capabilities.desktop;k.addEventListener(n?"mousedown":"touchstart",h,false);k.addEventListener(n?"mousemove":"touchmove",e,false);k.addEventListener(n?"mouseup":"trouchend",q,false);s(0);k.setAttribute("data-scrollability-enabled","true");return{animateTo:s,element:k}};a.enableScrollabilityX=function(k,r){r=true;var f=0,g=0;var h,q=0;var p,l;var t=function(u){h=u;if(r){k.style.webkitTransform="translate3d("+u+"px, 0 ,0)"}else{k.style.webkitTransform="translate3d(0, "+u+"px,0)"}};var m=function(){var u=k.offsetParent.offsetWidth-k.scrollWidth,y=k.offsetParent.offsetHeight-k.scrollHeight,x=0,v=0;var w;if(r){if(u>0){w=0}else{if(h>x){w=x}else{if(h<u){w=u}else{w=h}}}}else{if(y>0){w=0}else{if(h>v){w=v}else{if(h<y){w=y}else{w=h}}}}t(w)};var o=function(v){var u=v.touches?v.touches[0]:v;p=r?Math.abs(u.clientX-g):p=Math.abs(u.clientY-f);return a.can("scrollX element",k)&&p>d};var j=function(v){var u=v.touches?v.touches[0]:v;g=u.clientX;f=u.clientY;q=h;p=false;l=true};var e=function(v){if(!l){return}var u=v.touches?v.touches[0]:v;if(p||o(u)){if(r){t(q+u.clientX-g)}else{t(q+u.clientY-f)}}};var s=function(){if(p){m();a.clickBuster.preventGhostClick(g,f)}l=false};var n=wooga.castle.capabilities.desktop;k.addEventListener(n?"mousedown":"touchstart",j,false);k.addEventListener(n?"mousemove":"touchmove",e,false);k.addEventListener(n?"mouseup":"trouchend",s,false);t(0)};a.escapeForRegex=function b(f){if(!b.specialsRE){var e=["/",".","*","+","?","|","(",")","[","]","{","}","\\"];b.specialsRE=new RegExp("(\\"+e.join("|\\")+")","g")}return f.replace(b.specialsRE,"\\$1")};a.addClass=function(f,e){a.removeClass(f,e).className+=" "+e;return f};a.removeClass=function(g,f){var e=[];f.split(/\s+/g).forEach(function(h){e.push(a.escapeForRegex(h))});if(g.className){g.className=g.className.replace(new RegExp("\\b"+e.join("|")+"\\b","g"),"").replace(/^\s|\s$/g,"")}return g};a.hasClass=function(f,e){return f.className.match(new RegExp("\\b"+a.escapeForRegex(e)+"\\b","g"))};a.toggleClass=function(g,f,e){if(typeof e==="undefined"){e=!a.hasClass(g,f)}if(e){a.addClass(g,f)}else{a.removeClass(g,f)}return g};wooga.notify=a.notify=function(f,e){wooga.castle.Notifier.show(f,e)};wooga.yesno=function(e,h,g,f){h=h||function(){};g=g||function(){};if(navigator.notification&&navigator.notification.confirm){navigator.notification.confirm(e,function(j){(j===2?h:g)()},f,"Cancel,OK")}else{(window.confirm(e)?h:g)()}};a.sign=function(e){return e?(e<0?String(e):"+"+e):"0"};a.getPublisher=function(e){var f=wooga.castle;switch(e){case"game":f=wooga.castle.Game.instance();break;case"view":f=wooga.castle.Game.instance().worldView;break}return f};a.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"};a.offset=function(e){var g=0,f=0;do{g+=e.offsetLeft||0;f+=e.offsetTop||0}while((e=e.parentNode)!==null);return{left:g,top:f}};a.isVisible=function(e){return e.clientHeight&&e.clientWidth};a.deep=function(j,h){var e=j||0,g=h.split("."),f=0;do{e=e[g[f]]}while(++f<g.length&&typeof e!=="undefined");return e};a.can=function(f,e){return a.can[typeof e==="function"?"add":"answer"](f,e)};a.can.add=function(g,e){var f=a.can._[g]||[];if(-1===f.indexOf(e)){f.push(e)}a.can._[g]=f;a.when(g);return a.can};a.can.remove=function(g,e){var f=a.can._[g]||[];f=f.filter(function(h){return h!==e});a.can._[g]=f;a.when(g);return a.can};a.can.answer=function(j,h){h=h||{};h._action=h._action||j;if("*"!==j&&!a.can("*",h)){return false}var g=a.can._[j]||[],e=g.length,f;while(e--){f=g[e];if(typeof f==="function"){if(false===f(h)){return false}}}return true};a.can._={};a.when=function(f,g){a.when._[f]=a.when._[f]||[];var e=a.when._[f];if("function"===typeof g){e.push(g);a.when(f)}else{if(e.length&&a.can(f)){a.when._[f]=e.filter(function(h){h({_action:f});return false})}}return a};a.when._={};a.oprop=function(f,e,g){Object.defineProperty(f,e,{value:g,writable:true,enumerable:true,configurable:true})};a.parents=function(f,e){return f.parentNode?((-1!==Array.prototype.indexOf.call(f.parentNode.querySelectorAll(e),f))?f:a.parents(f.parentNode,e)):null};a.removeOnAnimationEnd=function(e,g,f){return a.removeOnEvent("webkitAnimationEnd",e,g,f)};a.removeOnTransitionEnd=function(e,g,f){return a.removeOnEvent("webkitTransitionEnd",e,g,f)};a.removeOnEvent=function(k,f,l,j){var h=l,e=j,g=f;l=j=f=null;if(g){g.addEventListener(k,function(m){if(m.target===g&&g.parentNode){g.parentNode.removeChild(g);if(typeof h==="function"){h.call(e,g)}}},false)}return g};a.attachRemoteConsole=function(g){var e=document.createElement("script");e.type="text/javascript";e.src="http://"+g+"/target/target-script-min.js#anonymous";var f=document.getElementsByTagName("script")[0];f.parentNode.insertBefore(e,f)};a["extends"]=function(h,f){try{h.prototype=new f();h.prototype.constructor=h;h.prototype.parent=f}catch(g){h.prototype=a.extend(h.prototype,f.prototype,{constructor:h,parent:f})}finally{return h}};a.publish=function(g,h){var f=wooga.castle,j,e=":";if(-1!==g.indexOf(e)){j=g.split(e);f=a.getPublisher(j[0])||f;g=j[1]}f.publish(g,h);return this};a.subscribe=function(j,g,f){var h=wooga.castle,k,e=":";if(-1!==j.indexOf(e)){k=j.split(e);h=a.getPublisher(k[0])||h;j=k[1]}h.subscribe(j,g,f);return this};a.unsubscribe=function(j,g,f){var h=wooga.castle,k,e=":";if(-1!==j.indexOf(e)){k=j.split(e);h=a.getPublisher(k[0])||h;j=k[1]}h.unsubscribe(j,g,f);return this};a.isSPA=function(){return window.navigator.standalone||wooga.castle.isNativeWrapper()};a.getElementTop=function(e){var f=0;while(e.offsetParent){f+=e.offsetTop;e=e.offsetParent}return f-wooga.castle.game.worldView.scrollTop};a.getElementLeft=function(e){var f=0;while(e.offsetParent){f+=e.offsetLeft;e=e.offsetParent}return f-wooga.castle.game.worldView.scrollLeft};a.disabler=function(){return false};a.getEntityImageUrl=function(e){return a.urlForEntityImage((wooga.castle.entityDefinitions[e]||0).url)};a.goldDelta=function(e){return Math.abs(e-wooga.castle.playerData.gold)};a.goldDeltaMessage=function(f,e){return"You need "+a.goldDelta(f)+" more gold to "+(e||"do that")};wooga.castle.utils=a}());(function(){wooga.castle.Viewport={getScale:function(){var a=1/(window.devicePixelRatio||1);return wooga.castle.capabilities.iPad&&(0.5===a)?0.75:a},setScale:function(a){setTimeout(function(){document.querySelector("#viewport").setAttribute("content","width=device-width, height=device-height, initial-scale="+a+", minimum-scale="+a+", maximum-scale="+a+", user-scalable=no")},0)},reset:function(){this.setScale(this.getScale())},getClientSize:function(){return{width:window.innerWidth,height:window.innerHeight}},maximize:function(){var a=this;setTimeout(function(){document.body.style.height="10000px";window.scrollTo(0,0)},50);setTimeout(function(){var b=a.getClientSize();document.body.style.width=b.width+"px";document.body.style.height=b.height+"px"},100)}}}());(function(){wooga.castle.GRID_UNIT=48;wooga.castle.IMAGES_BASE_URL="images/entities/";wooga.castle.capabilities={touch:/(iPod|iPhone|iPad|Android)/.test(navigator.userAgent),iPod:navigator.userAgent.indexOf("iPod")!==-1,android:/Android/i.test(navigator.userAgent),desktop:!(/(iPod|iPhone|iPad|Android)/.test(navigator.userAgent)),iPad:/iPad/.test(navigator.userAgent)};wooga.castle.capabilities.iPad=wooga.castle.capabilities.iPad||wooga.castle.capabilities.desktop;wooga.castle.click_event_string=wooga.castle.capabilities.touch?"touchend":"click";if(wooga.castle.capabilities.desktop&&!wooga.castle.switches.iframed){window.stop();document.location="ipad.html"}wooga.castle.isNativeWrapper=function(){var b=!wooga.castle.capabilities.desktop&&!wooga.castle.capabilities.android&&(!/Safari/.test(navigator.userAgent));wooga.castle.isNativeWrapper=function(){return b};return b};document.addEventListener("touchstart",function(){},false);document.addEventListener("DOMContentLoaded",function a(){wooga.castle.Viewport.reset();wooga.castle.Viewport.maximize();if(wooga.castle.capabilities.iPod){var b=document.getElementById("loadingScreen");b.querySelector("p").innerHTML="Oops! Magic Land is currently not supported on the iPod.";b.querySelector(".progress").style.display=document.querySelector(".comic").style.display="none";return}if(wooga.castle.capabilities.iPad){wooga.castle.utils.addClass(document.body,"ipad")}document.querySelector(".comic .button.share").addEventListener(wooga.castle.click_event_string,function(d){document.querySelector(".comic").style.display="none";document.querySelector(".intro").style.display="block";d.preventDefault()},false);document.querySelector(".intro .button").addEventListener(wooga.castle.click_event_string,function(d){document.querySelector(".intro").style.display="none";d.preventDefault()},false);wooga.castle.utils.addClass(document.body,(wooga.castle.utils.isSPA()||wooga.castle.isNativeWrapper())?"fullscreen":"browser");function c(d){if(d&&d!=="null"){if(typeof d==="string"){wooga.castle.playerData=JSON.parse(d)}else{wooga.castle.playerData=d}}setTimeout(function(){wooga.castle.init(wooga.castle.playerData,wooga.castle.Viewport.getClientSize())},200)}wooga.gameStarter=c;(function(){wooga.castle.Storage.config=wooga.castle.isNativeWrapper()?"ios":"local";var e=wooga.castle.Storage.restore("playerData"),d=document.querySelector(".comic"),f=document.querySelector(".intro");if(!e){e=wooga.castle.Storage.restore("playerData_"+localStorage.uuid)}if(e||wooga.castle.switches.nowelcome){d.style.display=f.style.display="none";d.style.visibility=f.style.visibility="hidden"}else{d.style.display="block"}c(e)}())},false)}());(function(){var a=wooga.castle.utils,b=Object.create(null),d=function(c){return{value:c,writable:false,enumerable:true,configurable:true}};Object.defineProperty(b,"domains",d(Object.create(null)));Object.defineProperty(b,"domain",d(function(e,c){b.domains[e]=c;return this}));Object.defineProperty(b,"get",d(function(c){return a.deep(this.domains,c)}));Object.defineProperty(b,"set",d(function(c,f,e){e=e||"*";if(!this.domains[e]){this.domains[e]=Object.create(null)}this.domains[e][c]=f;return this}));Object.defineProperty(b,"translate",d(function(c,e){e=e||"*";if(!this.domains[e]){return c}return this.domains[e][c]||c}));wooga.castle.l10n=b;window.l=function(c,e){return b.translate(c,e)};window.l.set=function(){return b.set.apply(b,arguments)}}());(function(){var a=wooga.castle.utils;wooga.castle.switches=wooga.castle.switches||{};wooga.castle.capabilities=wooga.castle.capabilities||{};var b=function(f,k){var c=new a.Deferred();var g=0;var e=0;var j=false;var h=[],d={};Object.keys(f).forEach(function(l){var n=f[l];if(n.url){var o=a.urlForEntityImage(n.url);if(h.indexOf(n.url)===-1){h.push(n.url);e++;d[n.url]=n.image=new Image();var m=function(p){if(!j){j=true;wooga.notify("An error prevented the game from loading!","error")}};n.image.addEventListener("load",function(){if(++g===e){c.callback()}},false);n.image.addEventListener("error",function(p){m("image parsing error: "+n.image.src.slice(0,50))},false);n.image.src=o}else{n.image=d[n.url]}}});return c};wooga.castle.init=function(g,d){if(!(wooga.castle.switches.nowelcome||g.doneTutorial)){var c=function(j){var h=document.createElement("div");h.style.display="none";if(h.parentNode){h.parentNode.removeChild(h)}var k=wooga.castle.Tutorial.instance();if(k){setTimeout(function(){k.show()},25)}else{wooga.castle.subscribe("tutorial/ready",function(l){setTimeout(function(){l.show()},25)})}document.body.appendChild(h)};if(wooga.castle.gameReady){c.call(this)}else{wooga.castle.subscribe("game/ready",c,this)}}if(wooga.castle.switches.fast){var e;for(e in wooga.castle.entityDefinitions){if(wooga.castle.entityDefinitions.hasOwnProperty(e)){var f=wooga.castle.entityDefinitions[e];if(f.contract){f.contract.requiredTime*=0.0001}}}}b(wooga.castle.entityDefinitions,g).addCallback(function(){wooga.castle.initGame(g,d)})};wooga.castle.initGame=function(o,j){a.can("hardware/info",a.disabler);var g=wooga.castle.rootNode=document.getElementById("game"),c=document.getElementById("mlm-content");var r=new wooga.castle.Game({playerData:o,entitiesDefinition:wooga.castle.entityDefinitions});r.subscribe("player/level-up",function(){b(wooga.castle.entityDefinitions,o)});var q=new wooga.castle.WorldView(r,{rootNode:g,gridUnit:wooga.castle.GRID_UNIT,mapWidth:wooga.castle.playerData.map.width,mapHeight:wooga.castle.playerData.map.height,offsetWidth:j.width,offsetHeight:j.height});var m=new wooga.castle.HUD(r,q);var h=new wooga.castle.GameModesManager(r,q,m,{rootNode:g});var e=new wooga.castle.Shop(r,q,{rootNode:c},h);var n=new wooga.castle.Goals(r,q,{rootNode:c});var p=new wooga.castle.AnimsFactory(q);var f=new wooga.castle.NotificationHandler(r);var l=new wooga.castle.TransactionsManager(r);var d=new wooga.castle.UnlockableAreaKeyHandler(r);a.addClass(document.body,"gridUnit-"+window.wooga.castle.GRID_UNIT);if(Math.abs(window.orientation)===90){a.addClass(document.body,"landscape")}if(wooga.castle.capabilities.IOS){a.addClass(document.body,"ios")}r.init();document.body.style.backgroundImage="none";var t=new wooga.castle.People(r);var s=new wooga.castle.PeopleView(t,q,h);g.style.display="block";var k={game:r,hud:m,worldView:q,rootNode:g,domNode:c};wooga.castle.publish("map is alterable",k);setTimeout(function(){wooga.castle.gameReady=true;wooga.castle.publish("game/ready",k);window.scrollTo(0,0);wooga.castle.tokens.set(o.tokens||[])},16)};(function(f){var e=[];function j(k){e=k}function h(k){return e.indexOf(k)!==-1}function g(){wooga.castle.playerData.tokens=e;wooga.castle.game.publish("player/update")}function d(k){e=e.filter(function(l){return l!==k});g()}function c(){var k;do{k=Math.random()}while(-1!==e.indexOf(k));e.push(k);g();return k}f.tokens={set:j,valid:h,remove:d,generate:c}}(wooga.castle));(function(){var c,d=wooga.castle.utils.PubSubMixin;for(c in d){if(d.hasOwnProperty(c)){wooga.castle[c]=a.bind(d[c],wooga.castle)}}}());wooga.castle.scrollLock=function(c){if(c){if(!wooga.castle.scrollLock.enabled){document.body.addEventListener("touchmove",wooga.castle.scrollLock.fn,false);wooga.castle.scrollLock.enabled=true}}else{document.body.removeEventListener("touchmove",wooga.castle.scrollLock.fn,false);wooga.castle.scrollLock.enabled=false}};wooga.castle.scrollLock.fn=function(c){c.preventDefault()}}());(function(){var a=wooga.castle.utils;var b=Object.create(null);b.json=function(d,f,e){if(typeof f==="object"){f=JSON.stringify(f)}var c=new a.Deferred();var g=new XMLHttpRequest();g.onreadystatechange=function(){if(g.readyState===4){if(g.status<400&&g.status!==0){try{c.callback({data:g.responseText?JSON.parse(g.responseText.replace(/^POST\{/,"{")):null})}catch(h){console.log(d);console.log(g.responseText);c.callback({data:null})}}else{c.errback({data:g.status,xhr:g})}}};g.open(e,d);g.setRequestHeader("Content-Type","application/json");g.setRequestHeader("X-Requested-With","XMLHttpRequest");g.send(f);return c};b.deleteJSON=function(c,d){return b.json(c,d,"DELETE")};b.postJSON=function(c,d){return b.json(c,d,"POST")};b.putJSON=function(c,d){return b.json(c,d,"PUT")};b.getJSON=function(d,e){if(typeof e==="undefined"){e=true}var c=new a.Deferred(),f=new XMLHttpRequest();f.onreadystatechange=function(){if(f.readyState===4){if(f.status<400){try{c.callback({data:JSON.parse(f.responseText)})}catch(g){console.log(74)}}else{c.errback()}}};f.open("GET",d,e);f.send();return c};b.getCached=function(d){var c=new a.Deferred();var e=new XMLHttpRequest();e.onreadystatechange=function(){if(e.readyState===4){if(e.status<400){c.callback({data:e.responseText})}else{c.errback()}}};e.open("GET",d);e.send();return c};b.get=function(c){return b.getCached(c)};b.getTemplate=function(c){var d=b.getCached(c);d.addCallback(function(e){e.data=(new EJS({text:e.data})).render({urlFor:a.urlFor})});return d};wooga.castle.net=b}());var rated=false;var rateAfterSeconds=1800;var rateAppUrl="http://itunes.apple.com/WebObjects/MZStore.woa/wa/viewContentsUserReviews?id=506729389&onlyLatestVersion=false&type=Purple+Software";var rateApp=function(){var d="Magic Land HD";var c="Do you like Magic Land HD? \nRate it now and get 4000 gold! \n \n \ue32f\ue32f\ue32f\ue32f\ue32f\n ";var a=function(){wooga.castle.game.increase("gold",4000);window.location.href=rateAppUrl};var b=function(){};wooga.yesno(c,a,b,d)};window.wooga.castle.utils.subscribe("game/ready",function(){if(wooga.castle.isNativeWrapper()){window.setInterval(function(){var a=window.wooga.castle.playerData.totalPlayTime;if(a>window.rateAfterSeconds&&a<(window.rateAfterSeconds+60)&&!window.rated){window.rated=true;window.rateApp()}},5000)}});(function(){var b=wooga.castle.utils,c=40*1000;var a=null;var d=function(f){if(a){throw"Game was already instantiated."}a=this;this.playerData=f.playerData;b.publish("have player data",{game:this,playerData:this.playerData});wooga.castle.playerData=this.playerData;this.entitiesDefinition=f.entitiesDefinition;wooga.castle.xp=new wooga.castle.XP(this.playerData,this);this.entities=[];this.decorations=[];this.worldEntity=new wooga.castle.WorldEntity(this);var e=this.mapWidth=this.playerData.map.width,g=this.mapHeight=this.playerData.map.height;this.mapRel={halfWidth:e/2,halfHeight:g/2};this.mapRel.x={first:-this.mapRel.halfWidth,last:this.mapRel.halfWidth};this.mapRel.y={first:-this.mapRel.halfHeight,last:this.mapRel.halfHeight};this.generateGridMaps();this.initializeSubscriptions();this.initActivityCheck()};b.mixin(d,b.PubSubMixin);b.mixin(d,b.ObservableMixin);d.instance=function(){return a};(function(){var e=5000;d.prototype._updateContracts=function(){if(window.wakeup_already_called){this.publish("wake-up",{})}else{window.wakeup_already_called=true}var g,h,f=wooga.castle.House.ContractState.PAUSED,j=wooga.castle.House.ContractState.IDLE;for(g=0;g<this.entities.length;g++){h=this.entities[g];if((h.is("any house")&&h.contractState!==f&&h.contractState!==j)||h.is("farm")){if(h.contract!==null&&typeof h.contract!=="undefined"){var k=h.contractStartTime+h.contract.requiredTime-Date.now();if(k<=0){clearTimeout(h.contractTimeout);h.finishContract()}}}}};d.prototype._updatesAfterPhoneIdle=function(){if(!this.playerData){return}var f=Math.max(0,Date.now()-(this.playerData._lastActiveCheck||0));var h=Math.floor(f/e);var g=h%e;if(h){if((Date.now()-this.playerData._lastActiveCheck)>1.5*e){this._updateContracts();if(this.playerData.doneTutorial){wooga.notify("Remember to finish the King's Wishlist!")}}}this.playerData._lastActiveCheck=Date.now()+g};d.prototype.initActivityCheck=function(){setInterval(b.bind(this._updatesAfterPhoneIdle,this),2000)}}());d.prototype.initializeSubscriptions=function(){this.subscribe("contract/start",this.contractStartHandler);this.subscribe("contract/collect",this.contractCollectHandler);this.subscribe("contract/",this.updateMapData);this.subscribe("entity/buy",this.buyHandler);this.subscribe("entity/buy",this.updateMapData);this.subscribe("entity/move",this.updateMapData);this.subscribe("entity/move",this.onEntityMove);this.subscribe("entity/buy",this.onEntityBoughtAndPlaced);this.subscribe("player/level-up",this.levelUp);this.subscribe("tutorial/done",this.enemyRespawn);this.subscribe("enemy/kill",this.enemyRespawn)};d.prototype.generateGridMaps=function(){this.gridMap={};this.gridMapCoastSubSet={};var q=this.entitiesDefinition.coastmap.image,o=q.width,k=q.height,e,j,m,g,l,f=document.createElement("canvas"),p=f.getContext("2d"),n=this.mapRel;f.height=k;f.width=o;p.drawImage(q,0,0,o,k);e=p.getImageData(0,0,o,k);for(j=n.y.first,g=n.y.last;j<g;j++){this.gridMapCoastSubSet[j]={};for(m=n.x.first,l=n.x.last;m<l;m++){this.gridMapCoastSubSet[j][m]=e.data[((j+n.halfHeight)*this.mapWidth+(m+n.halfWidth))*4]===0}}for(j=n.y.first,g=n.y.last;j<g;j++){this.gridMap[j]={};for(m=n.x.first,l=n.x.last;m<l;m++){this.gridMap[j][m]=[]}}};d.prototype.enemyRespawn=function(){var e=this;setTimeout(function(){if(e.playerData.doneTutorial){b.publish("spawn enemy")}},c)};d.prototype.init=function(){this.playerData.map.entities.sort(function(f,e){var h=f.key,g=e.key;return(h.indexOf("path")!==-1||h.indexOf("farm")!==-1)?-1:(g.indexOf("path")!==-1||g.indexOf("farm")!==-1?1:(f.y-e.y))}).forEach(this.createEntity,this);this.decorations.forEach(function(e){e.applyBoosts()});wooga.castle.game=this;this.publish("game/init",{game:this});this.subscribe("castle/upgrade",function(e){this.castle=e.entityView.entity},this);this.publish("player/update");wooga.castle.publish("game/init",{game:this})};d.prototype.createEntity=function(f){var e;switch(this.entitiesDefinition[f.key]["class"]){case"castle":e=new wooga.castle.Castle(this,f);this.castle=e;break;case"house":e=new wooga.castle.House(this,f);break;case"uhouse":e=new wooga.castle.UnfoodedHouse(this,f);break;case"statichouse":e=new wooga.castle.SpecialBuilding(this,f);break;case"ship":e=new wooga.castle.Ship(this,f);break;case"farm":e=new wooga.castle.FarmField(this,f);break;case"enemy":e=new wooga.castle.Enemy(this,f);break;case"decoration":e=new wooga.castle.Decoration(this,f);this.decorations.push(e);break;case"whackable":e=new wooga.castle[(/tree/.test(f.key)?"Tree":"Whackable")](this,f);break;case"tree":e=new wooga.castle.Tree(this,f);break;case"unlockable":e=new wooga.castle.UnlockableArea(this,f);break;case"rock":e=new wooga.castle.Rock(this,f);break;default:e=new wooga.castle.Entity(this,f)}this.entities.push(e);if(!e.preview){this.addToGridMap(e,e.x,e.y)}return e};d.prototype.removeEntity=function(e){this.entities.splice(this.entities.indexOf(e),1);this.removeFromGridMap(e,e.x,e.y);if(e.destructor){e.destructor()}if(e instanceof wooga.castle.Decoration){e.removeBoosts();this.decorations.splice(this.decorations.indexOf(e),1)}else{if(e instanceof wooga.castle.House||e instanceof wooga.castle.FarmField){this.decorations.forEach(function(f){f.removeEntity(e)})}}};d.prototype.onEntityMove=function(f){var e=f.entity;this.removeFromGridMap(e,f.prevX,f.prevY);this.addToGridMap(e,e.x,e.y);this.updateBoosts(e)};d.prototype.onEntityBoughtAndPlaced=function(e){this.updateBoosts(e.entity)};d.prototype.updateBoosts=function(e){if(e instanceof wooga.castle.Decoration){e.applyBoosts().broadcastChangeAfterMove()}else{if(e instanceof wooga.castle.House||e instanceof wooga.castle.FarmField){this.decorations.forEach(function(f){f.applyBoosts().broadcastChangeAfterMove()})}}};d.prototype.addToGridMap=function(h,f,l){var j,g;var e=l+h.definition.height+(h.definition.offsetY||0);var k=f+h.definition.width;if("undefined"!==typeof h.definition.xOffsetLeft){f+=h.definition.xOffsetLeft}if("undefined"!==typeof h.definition.xOffsetRight){k+=h.definition.xOffsetRight}for(j=l;j<e;j++){for(g=f;g<k;g++){if(this.gridMap[j]&&this.gridMap[j][g]){this.gridMap[j][g].push(h)}}}};d.prototype.removeFromGridMap=function(g,l,k){var f,j,e,h;var m=k+g.definition.height+(g.definition.offsetY||0);var n=l+g.definition.width;if("undefined"!==typeof g.definition.xOffsetLeft){l+=g.definition.xOffsetLeft}if("undefined"!==typeof g.definition.xOffsetRight){n+=g.definition.xOffsetRight}for(f=k;f<m;f++){for(j=l;j<n;j++){if(this.gridMap[f]&&this.gridMap[f][j]){e=this.gridMap[f][j];h=e.indexOf(g);if(h>-1){e.splice(h,1)}}}}};d.prototype.testCollisions=function(j,g){var h,f,e;var l=j.x+j.width;var k=j.y+j.height;for(h=j.y;h<k;h++){for(f=j.x;f<l;f++){if(this.gridMapCoastSubSet[h]&&this.gridMapCoastSubSet[h][f]){return true}if(this.gridMap[h]&&this.gridMap[h][f]){e=this.gridMap[h][f];if(e.length&&(!g||(e.indexOf(g)===-1))){return true}}else{return true}}}return false};d.prototype.testCollisions2=function(p,h,n,m){var g,o,f;var k=p.x+p.width;var e=p.y+p.height;var q=false,l=false;for(g=p.y;g<e;g++){for(o=p.x;o<k;o++){l=false;if(this.gridMapCoastSubSet[g][o]){q=true;if(!n){return q}}f=this.gridMap[g][o];if(this.gridMap[g]&&f){if(f.length&&(!h||(f.indexOf(h)===-1))){q=true;if(!n){return q}if(n&&m){var j;for(j=0;j<m.length;j++){if(f[0]===m[j]){l=true}}if(!l){m[m.length]=f[0]}}else{return q}}}else{q=true;if(!n){return q}}}}return q};d.prototype.contractStartHandler=function(e){this.publish("player/update")};d.prototype.contractCollectHandler=function(f){var e=f.contract;if(e.providedFood){if(f.entity){this.playerData.food+=f.entity.getContractValue()}else{this.playerData.food+=e.providedFood}}if(e.providedGold){if(f.entity!=="undefined"){this.playerData.gold+=f.entity.getContractValue()}else{this.playerData.gold+=e.providedGold}}if(e.providedXP){wooga.castle.xp.addXP(e.providedXP)}this.publish("player/update")};d.prototype.levelUp=function(){this.publish("player/update")};d.prototype.buyHandler=function(f){var e=f.entity;this.drain("gold",e.definition.goldCost);switch(e.definition["class"]){case"house":case"uhouse":this.publish("population/change",e);if(e.contract.constructionTime){e.startConstruction()}else{e.activateContract()}break;case"decoration":e.applyBoosts().broadcastChangeAfterMove();break}this.publish("player/update")};d.prototype.drain=function(h,g,f){if(typeof g==="undefined"){g=1}var e=false;if("food"===h){this.foodNotificationHandler(h,g,30)}if(this.playerData[h]-g>=0){if("xp"!==h){this.playerData[h]-=g}else{wooga.castle.xp.addXP(Math.abs(g))}wooga.castle.publish("game/"+(g>0?"drain":"increase")+"-"+h,{entityView:f,amount:g,text:b.sign(-1*g)+" "+h});this.publish("player/update");e=true}else{if(f){wooga.castle.publish("game/not-enough-"+h,{entityView:f,text:"Not enough "+h+"!"})}}return e};d.prototype.foodNotificationHandler=function(f,e,g){if(!this.playerData.recievedFoodBonus){if((this.playerData[f]-e)<0){this.publish("popup/info",{url:"templates/popup.html",text:"Oh, you ran out of fruit. Don't worry, here is some extra food. But try to plant some seeds right away"});this.playerData[f]+=500;this.publish("player/update");this.playerData.recievedFoodBonus=true}}else{if((this.playerData[f]-e)<g&&(this.playerData[f]-e)>0){wooga.notify("You need to plant more seeds!")}}};d.prototype.hasStat=function(f,e){return this.playerData[f]-e>=0};d.prototype.getStat=function(e){return this.playerData[e]};d.prototype.increase=function(g,f,e){if(typeof f==="undefined"){f=1}return this.drain(g,-f,e)};d.prototype.getPopulation=function(){var e=0;this.entities.forEach(function(f){if(f.is(["house","uhouse"])){e+=f.definition.population||1}});return e};d.prototype.updateMapData=function(){this.playerData.map.entities=this.entities.map(function(f){var e=f.toSerializable();if(f.is(["house","uhouse"])){if(f.contract){e.contract={state:f.contractState};if(f.contractStartTime){e.contract.startTime=f.contractStartTime}if(f.contractPauseTime){e.contract.pauseTime=f.contractPauseTime}}}else{if(f.is("statichouse")){if(typeof f.isHidden!=="undefined"){e.isHidden=f.isHidden}}else{if(f.is("farm")&&f.contract){e.contract={seedName:f.seedName,state:f.contractState,startTime:f.contractStartTime}}else{if(f.is("ship")){if(f.contract){e.contract={state:f.contractState};if(f.contractStartTime){e.contract.startTime=f.contractStartTime}}}}}}return e},this);this.publish("map/update");return this};d.prototype.isAreaOnCoast=function(h){var e,k,f,g,j=this.gridMapCoastSubSet;for(k=h.y,g=k+h.height;k<g;k++){for(e=h.x,f=e+h.width;e<f;e++){if(j[k][e]){return true}}}return false};wooga.castle.Game=d}());(function(b){var a=b.utils;function c(e,d){this.manager=d;if((typeof e==="number")||!e){this.setLevel(e||1);this.setXP(0)}else{this.load(e)}if(this.level>=4){document.body.setAttribute("data-level-treshold",4)}}c.prototype.level=1;c.prototype.xp=0;c.prototype.manager=null;c.prototype.xpToLevelUP=function(e){if(!arguments.length){e=this.level}if(e===0){return 10}var d=this.xpToLevelUP(e-1)+1;this.xpToLevelUP=function(){return d};return d};c.prototype.setLevel=function(d){this.manager.playerData.level=this.level=d};c.prototype.maxEnergy=function(d){if(!arguments.length){d=this.level}if(d===0){return 11}return this.maxEnergy(d-1)+1};c.prototype.setXP=function(d){this.manager.playerData.xp=this.xp=d};c.prototype.addXP=function(d){this.setXP(this.xp+d);if(this.xp>=this.xpToLevelUP()){this.levelUP()}else{this.write();this.manager.publish("player/update")}};c.prototype.load=function(d){this.setLevel(d.level);this.setXP(d.xp)};c.prototype.write=function(){b.game.playerData.level=this.level;b.game.playerData.xp=this.xp};c.read=c.prototype.read=function(){var d={};d.level=parseInt(b.game.playerData.level,10);d.xp=parseInt(b.game.playerData.xp,10);return d};c.prototype.levelUP=function(){var d=this.xp-this.xpToLevelUP();if(d>=0){wooga.castle.xp=new c({level:this.level+1,xp:0},this.manager);a.publish("player/level-up",{level:wooga.castle.xp.level});a.publish("game:player/level-up",{level:wooga.castle.xp.level});b.xp.addXP(d)}};c.prototype.rewards=function(){return[]};(function(d){c.levelInfo=d;c.prototype._xpToLevelUp=c.prototype.xpToLevelUP;c.prototype.xpToLevelUP=function(f){if(!arguments.length){f=this.level}var e=c.levelInfo.predefined[f]?c.levelInfo.predefined[f].xp:this._xpToLevelUp(f);this.xpToLevelUP=function(){return e};return e};c.prototype.rewards=function(){var e=c.levelInfo.predefined[this.level]&&c.levelInfo.predefined[this.level].rewards?c.levelInfo.predefined[this.level].rewards:{};this.rewards=function(){return e};return e};c.prototype._maxEnergy=c.prototype.maxEnergy;c.prototype.maxEnergy=function(f){if(!arguments.length){f=this.level}var e=c.levelInfo.predefined[f]&&c.levelInfo.predefined[f].maxEnergy?c.levelInfo.predefined[f].maxEnergy:this._maxEnergy(f);this.maxEnergy=function(){return e};return e}}(b.levels));b.XP=c}(wooga.castle));(function(){var a=wooga.castle.utils;var b=wooga.castle.GameModesManager=function(e,c,g,f){this.game=e;this.view=c;this.hud=g;this.mode=b.Mode.BASIC;var h={rootNode:f.rootNode};this.infoMode=new wooga.castle.InfoMode(this,h);this.moveMode=new wooga.castle.MoveMode(this,h);this.shopPreviewMode=new wooga.castle.ShopPreviewMode(this,h);this.seedMode=new wooga.castle.SeedMode(this,h);this.roadsMode=new wooga.castle.RoadsMode(this,h);this.castleUpgradeMode=new wooga.castle.CastleUpgradeMode(this,h);this.destroyMode=new wooga.castle.DestroyMode(this,h);c.addEventHandler("touch",function d(k){var j=k.target;if(this.mode===b.Mode.BASIC&&j.isFocusable()&&a.can("focus any entity")){this.view.publish("entity/focus",j);this.setMode(b.Mode.INFO,{target:j})}else{if(-1!==[b.Mode.INFO,b.Mode.DESTROY].indexOf(this.mode)){this.view.publish("entity/blur");this[(b.Mode.INFO===this.mode?"info":"destroy")+"Mode"].deactivate();d.call(this,k)}}},this);c.addEventHandler("longtouch",function(k){var j=k.target;if((this.mode===b.Mode.BASIC)&&j.entity.draggable){this.setMode(b.Mode.MOVE,{target:j});j.fireEvent("dragstart");j.addEventHandler("touchend",function l(m){j.dragend();j.removeEventHandler("touchend",l)})}},this);c.subscribe("shop/preview",function(j){this.setMode(b.Mode.SHOP_PREVIEW,{entityName:j.entityName})},this);c.subscribe("shop/seed",function(j){this.setMode(b.Mode.SEED,{entityName:j.entityName,targetFarmField:j.targetEntity})},this);c.subscribe("roadsMode/set",function(j){this.setMode(b.Mode.ROADS)},this);c.subscribe("castleUpgradeMode/set",function(j){this.setMode(b.Mode.CASTLE_UPGRADE,{target:j.target})},this);c.subscribe("castleUpgradeScreen/close",function(j){this.setMode(b.Mode.BASIC)},this);c.subscribe("request-mode",function(j){this.setMode(j.mode,j)},this);this.setMode(b.Mode.BASIC)};a.mixin(b,a.ObservableMixin);b.Mode={BASIC:"basic",INFO:"info",MOVE:"move",SHOP:"shop",SHOP_PREVIEW:"shop-preview",SEED:"seed",ROADS:"roads",CASTLE_UPGRADE:"castle-upgrade",DESTROY:"destroy-arr",YESNO:"yesnoer"};b.prototype.setMode=function(d,c){if(d!==b.Mode.BASIC){this.hud.hide()}a.removeClass(document.body,this.mode);this.mode=d;this.view.mode=d;document.body.setAttribute("data-mode",d);a.addClass(document.body,this.mode);switch(d){case b.Mode.BASIC:this.hud.show();break;case b.Mode.INFO:this.infoMode.activate(c);break;case b.Mode.SHOP:break;case b.Mode.MOVE:if(a.can("move-entity",c.target.entity)){this.moveMode.activate(c)}else{this.setMode(b.Mode.BASIC);return}break;case b.Mode.SHOP_PREVIEW:this.shopPreviewMode.activate(c);break;case b.Mode.SEED:this.seedMode.activate(c);break;case b.Mode.ROADS:this.roadsMode.activate(c);break;case b.Mode.CASTLE_UPGRADE:this.castleUpgradeMode.activate(c);break;case b.Mode.DESTROY:this.destroyMode.activate(c);break;case b.Mode.YESNO:break}this.view.publish("mode-change",this)}}());(function(){var a=wooga.castle.utils;wooga.castle.WorldEntity=function(c){if(!c){return}this.game=c;this.selectable=false};var b=wooga.castle.WorldEntity;a.mixin(b,a.ObservableMixin)}());(function(){var a=wooga.castle.utils;wooga.castle.Entity=function(c,d){if(!c||!d){return}this.game=c;this.eventsBubbleTarget=c.worldEntity;this.id=Math.random();this.x=d.x;this.y=d.y;this.key=d.key;this.definition=c.entitiesDefinition[d.key];this.selectable=this.definition.selectable||false;this.draggable=this.definition.draggable||false;this.preview=d.preview;this.boost=0;this.contractValue=0};var b=wooga.castle.Entity;a.mixin(b,a.ObservableMixin);b.prototype.move=function(c){var e=this.x,d=this.y;this.x=c.x;this.y=c.y;this.game.publish("entity/move",{entity:this,prevX:e,prevY:d})};b.prototype.buy=function(c){this.x=c.x;this.y=c.y;delete this.preview;this.game.addToGridMap(this,this.x,this.y);this.game.publish("entity/buy",{entity:this})};b.prototype.isColliding=function(c){return this.game.testCollisions({x:c.x,y:c.y,width:this.definition.width,height:this.definition.height+this.definition.offsetY},this)};b.prototype.is=function(d){if(!a.isArray(d)){d=[d]}var c=this.definition["class"];return d.filter(function(e){if(e==="any house"){return["house","uhouse","statichouse"].indexOf(c)!==-1}if(e==="movable house"){return["house","uhouse"].indexOf(c)!==-1}return c===e}).length!==0};b.findEntityDefinitionByPath=function(e,c,g){var f=[],d;if(typeof g==="undefined"){g=true}for(d in e.entitiesDefinition){if(e.entitiesDefinition.hasOwnProperty(d)){if(d.indexOf(c)!==-1){f.push(e.entitiesDefinition[d]);if(g){break}}}}return g?(f.length?f[0]:null):f};b.prototype.updateBoost=function(c,d){if(typeof this.contractState==="undefined"){return}if((d==="gold"&&["house","uhouse","statichouse"].indexOf(this.definition["class"])!==-1)||(d==="food"&&this.definition["class"]==="farm")){if((this.boost+c)>0){this.boost+=c}else{this.boost=0}}if(this.contractState!=="finished"&&this.contractState!=="idle"){if(d==="gold"&&this.definition["class"]==="house"&&this.contract.providedGold){this.contractValue=this.contract.providedGold+Math.round(this.contract.providedGold*(this.boost/100))}else{if(d==="food"&&this.definition["class"]==="farm"&&this.contract.providedFood){this.contractValue=this.contract.providedFood+Math.round(this.contract.providedFood*(this.boost/100))}}}};b.prototype.toSerializable=function(){return{key:this.key,x:this.x,y:this.y}};b.prototype.getCallableName=function(){return this.definition["class"]};b.prototype.getProperName=function(){return this.definition.name};b.prototype.getInfoModeString=function(){return""}}());(function(){var b=wooga.castle.utils;var a;wooga.castle.House=function(c,d){wooga.castle.Entity.call(this,c,d);if(!arguments.length){return this}this.contract=this.definition.contract;if(d.contract){if(d.constructionStartTime){this.constructionStartTime=d.constructionStartTime;if(this.constructionStartTime+this.contract.constructionTime>Date.now()){this.contractState=a.ContractState.CONSTRUCTION;this.constructionCountdown()}else{this.finishConstruction()}}else{this.restoreContract(d.contract)}}this.addEventHandler("destroy",this.beforeDestroy,this)};a=wooga.castle.House;b["extends"](a,wooga.castle.Entity);a.ContractState={CONSTRUCTION:"construction",CONSTRUCTED:"constructed",INACTIVE:"inactive",IDLE:"idle",STARTED:"started",PAUSED:"paused",FINISHED:"finished"};a.prototype.resetConnection=function(){this.wasConnected=this.connected;this.connected=false;this.pauseContract()};a.prototype.disconnect=function(c){this.connected=false;this.pauseContract();if(this.wasConnected&&!c){this.game.publish("building/disconnected",this)}this.wasConnected=false};a.prototype.connect=function(c){this.connected=true;this.unpauseContract();if(!this.wasConnected&&!c){this.fireEvent("connected to road");this.game.publish("building/connected",this)}this.wasConnected=true};a.prototype.startConstruction=function(){this.contractState=a.ContractState.CONSTRUCTION;this.fireEvent("startConstruction");this.constructionStartTime=Date.now();this.constructionCountdown();this.game.publish("construction/start",{entity:this})};a.prototype.constructionCountdown=function(){var c=this.constructionStartTime?this.getConstructionTimeLeft():this.contract.constructionTime;this.constructionTimeout=setTimeout(b.bind(this.finishConstruction,this),c)};a.prototype.finishConstruction=function(){this.contractState=a.ContractState.CONSTRUCTED;this.constructionTimeLeft=0;this.fireEvent("finishConstruction")};a.prototype.acceptConstruction=function(){delete this.constructionStartTime;this.fireEvent("acceptConstruction");this.activateContract();if(!this.connected){this.pauseContract()}};a.prototype.activateContract=function(){this.contractState=a.ContractState.IDLE;this.game.publish("contract/update",{entity:this,update:{state:this.contractState}});this.fireEvent("contractChange")};a.prototype.startContract=function(){if(this.contractState===a.ContractState.INACTIVE||this.contractState===a.ContractState.IDLE){if(this.game.drain("food",this.contract.requiredFood,this.entityView)){this.contractState=a.ContractState.STARTED;this.contractStartTime=Date.now();this.contractTimeout=setTimeout(b.bind(this.finishContract,this),this.contract.requiredTime);this.game.publish("contract/start",{entity:this,contract:this.contract,update:{state:this.contractState,startTime:this.contractStartTime}});this.fireEvent("contractChange")}}this.contractValue=this.contract.providedGold+Math.round(this.contract.providedGold*(this.boost/100))};a.prototype.restoreContract=function(d){var c=Date.now();this.contractState=d.state;this.contractStartTime=Math.min(d.startTime||0,c);this.contractPauseTime=Math.min(d.pauseTime||0,c);this.contractValue=this.contract.providedGold;if(this.contractState===a.ContractState.STARTED){var e=this.getContractTimeLeft();if(e>0){this.contractTimeout=setTimeout(b.bind(this.finishContract,this),e)}else{this.finishContract()}}};a.prototype.finishContract=function(){this.contractState=a.ContractState.FINISHED;this.game.publish("contract/update",{entity:this,update:{state:this.contractState}});this.fireEvent("contractChange")};a.prototype.pauseContract=function(){if(this.contractState===a.ContractState.INACTIVE||this.contractState===a.ContractState.IDLE||this.contractState===a.ContractState.STARTED||this.contractState===a.ContractState.FINISHED){this.contractState=a.ContractState.PAUSED;clearTimeout(this.contractTimeout);this.contractPauseTime=Date.now();this.game.publish("contract/update",{entity:this,update:{state:this.contractState,pauseTime:this.contractPauseTime}});this.fireEvent("contractChange")}};a.prototype.unpauseContract=function(){if(this.contractState===a.ContractState.PAUSED){if(this.contractStartTime){var c=Date.now();this.contractStartTime+=c-this.contractPauseTime;var d=this.getContractTimeLeft();if(d>0){this.contractState=a.ContractState.STARTED;this.contractTimeout=setTimeout(b.bind(this.finishContract,this),d)}else{this.contractState=a.ContractState.FINISHED}}else{this.contractState=a.ContractState.IDLE}this.contractPauseTime=null;this.game.publish("contract/update",{entity:this,update:{state:this.contractState,startTime:this.contractStartTime,pauseTime:null}});this.fireEvent("contractChange")}};a.prototype.collectContract=function(c){this.contractState=a.ContractState.IDLE;this.contractStartTime=null;this.game.publish("contract/collect",{entity:this,entityView:c,contract:this.contract,update:{state:this.contractState,startTime:null}});this.fireEvent("contractChange")};a.prototype.getContractTimeLeft=function(){return this.contractStartTime+this.contract.requiredTime-Date.now()};a.prototype.getConstructionTimeLeft=function(){return this.constructionStartTime+this.contract.constructionTime-Date.now()};a.prototype.getContractValue=function(){var c=this.contractValue;if(this.contract){this.contractValue=this.contract.providedGold+Math.round(this.contract.providedGold*(this.boost/100));if(this.contractState!==a.ContractState.FINISHED&&this.contractState!==a.ContractState.IDLE){c=this.contractValue}}return c};a.prototype.getInfoModeString=function(){var d;switch(this.contractState){case a.ContractState.STARTED:var c=this.getContractValue();d='<div class="progress"><div style="width: 0%;"></div></div><p>Gives you '+c+' coins in <span id="timeLeft">'+b.formatTime(this.getContractTimeLeft())+"</span></p>";break;case a.ContractState.CONSTRUCTION:d='<div class="progress"><div style="width: 0%;"></div></div><p>Construction finishes in <span id="timeLeft">'+b.formatTime(this.getConstructionTimeLeft())+"</span></p>";break;default:d="<p>Please connect to road</p>"}return d};a.prototype.toSerializable=function(){var c=wooga.castle.Entity.prototype.toSerializable.call(this);c.contract=this.contract;c.constructionStartTime=this.constructionStartTime;return c};a.prototype.beforeDestroy=function(){if(this.contract){this.contractState=a.ContractState.INACTIVE;this.contractStartTime=null;this.contract=null;clearTimeout(this.contractTimeout)}delete this.constructionStartTime;clearTimeout(this.constructionTimeout)};a.prototype.destructor=function(){this.fireEvent("destroy",{entity:this})}}());(function(){var a=wooga.castle.utils;var b=function(c,d){wooga.castle.Entity.call(this,c,d);if(!d.contract||(d.contract.state===b.ContractState.IDLE)){this.setIdle()}else{this.contractState=d.contract.state;this.activateContract(d.contract.seedName,true);this.contractValue=this.contract.providedFood;if(this.contractState===b.ContractState.STARTED){this.contractStartTime=d.contract.startTime;var e=this.contractStartTime+this.contract.requiredTime-Date.now();if(e>0){this._timeout=setTimeout(a.bind(this.finishContract,this),e)}else{this.finishContract()}}}};b.prototype=new wooga.castle.Entity();b.prototype.constructor=b;b.ContractState={IDLE:"idle",STARTED:"started",FINISHED:"finished"};b.prototype.checkContract=function(){var c=this.contractStartTime+this.contract.requiredTime-Date.now();if(c>0){clearTimeout(this._timeout);this._timeout=setTimeout(a.bind(this.finishContract,this),c)}else{this.finishContract()}};b.prototype.activateContract=function(d,c){this.seedName=d;this.contract=this.game.entitiesDefinition[d].contract;this.contract.seedName=this.contract.seedName||d;if(!c){this.fireEvent("contractActivate");this.fireEvent("contractChange")}};b.prototype.startContract=function(){this.contractState=b.ContractState.STARTED;this.contractStartTime=Date.now();this._timeout=setTimeout(a.bind(this.finishContract,this),this.contract.requiredTime);this.game.drain("gold",this.contract.requiredGold);this.game.publish("contract/start",{entity:this,contract:this.contract,update:{seedName:this.seedName,state:this.contractState,startTime:this.startTime}});this.contractValue=this.contract.providedFood+Math.round(this.contract.providedFood*(this.boost/100));this.fireEvent("contractChange")};b.prototype.finishContract=function(){this.contractState=b.ContractState.FINISHED;this.game.publish("contract/update",{entity:this,contract:this.contract,update:{state:this.contractState}});this.fireEvent("contractChange")};b.prototype.collectContract=function(c){var d=this.contract;this.game.publish("contract/collect",{entity:this,entityView:c,contract:d});this.fireEvent("contractCollect");this.setIdle()};b.prototype.setIdle=function(){this.contract=null;this.contractStartTime=null;this.contractState=b.ContractState.IDLE;this.seedName=null;this.fireEvent("contractChange")};b.prototype.getContractValue=function(){var c=this.contractValue;if(this.contract){this.contractValue=this.contract.providedFood+Math.round(this.contract.providedFood*(this.boost/100));if(this.contractState!==b.ContractState.FINISHED&&this.contractState!==b.ContractState.IDLE){c=this.contractValue}}return c};b.prototype.getInfoModeString=function(){var c=this.contractStartTime+this.contract.requiredTime-Date.now();return'<div class="progress"><div style="width: 0%;"></div></div><p>Gives you '+this.getContractValue()+' food in <span id="timeLeft">'+a.formatTime(c)+"</span></p>"};wooga.castle.FarmField=b}());(function(){var c,a;var d=function(f){c=this.scrollLeft-f.x;a=this.scrollTop-f.y;this.isScrolling=true};var b=function(f){this.scrollTo(f.x+c,f.y+a)};var e=function(f){this.isScrolling=false};wooga.castle.WorldViewScrollabilityMixin={initScrollability:function(){this.center();this.addEventHandler("dragstart",d,this);this.addEventHandler("drag",b,this);this.addEventHandler("dragend",e,this)},center:function(){this.scrollLeft=0;this.scrollTop=Math.round(this.offsetHeight-this.mapHeight*this.gridUnit);this.publish("centered",this)},centerToTile:function(f,g){this.scrollTo((this.offsetWidth*0.5-(this.mapWidth*0.5+f)*this.gridUnit),(this.offsetHeight*0.5-(this.mapHeight*0.5+g)*this.gridUnit))},scrollTo:function(g,f){if(!this.isDragAllowed){return}this.setScrollLeft(Math.round(g)).setScrollTop(Math.round(f));this.fireEvent("scrolled",this)},setScrollLeft:function(j){if(!this.isDragAllowed){return}var f=Math.round(this.canvas.width-this.mapWidth*this.gridUnit),h=0;var g=j;if(g>h){g=h}else{if(g<f){g=f}}if(this.offsetWidth<this.mapWidth*this.gridUnit){this.scrollLeft=g}return this},setScrollTop:function(j){if(!this.isDragAllowed){return}var f=Math.round(this.canvas.height-this.mapHeight*this.gridUnit),h=0;var g=j;if(g>h){g=h}else{if(g<f){g=f}}if(this.offsetHeight<this.mapHeight*this.gridUnit){this.scrollTop=g}return this}}}());(function(){var a=wooga.castle.utils;wooga.castle.View=function(){};var b=wooga.castle.View;a.mixin(b,a.ObservableMixin);b.prototype.constructor=b;b.prototype.destructor=function(){};b.prototype.touch=function(c){this.fireEvent("touch",c)};b.prototype.touchend=function(c){this.fireEvent("touchend",c)};b.prototype.longtouch=function(c){this.fireEvent("longtouch",c)};b.prototype.dragstart=function(c){this.fireEvent("dragstart",c)};b.prototype.drag=function(c){this.fireEvent("drag",c)};b.prototype.dragend=function(c){this.fireEvent("dragend",c)}}());(function(){var e=10;var b=750;var a=wooga.castle.utils;wooga.castle.WorldView=function(o,f){wooga.castle.View.call(this);var p=this,l=this;this.isDragAllowed=true;this.focusedEntityView=undefined;var m=function(){wooga.castle.Viewport.maximize();setTimeout(function(){var j=wooga.castle.Viewport.getClientSize();l.offsetWidth=j.width;l.offsetHeight=j.height;if(l.canvas){l.canvas.width=j.width;l.canvas.height=j.height}l.center();if(!wooga.castle.capabilities.desktop){a.toggleClass(document.body,"landscape",(j.width>j.height))}p.isScrolled=true;a.publish("view:orientation/change")},100)};wooga.castle.updateOrientation=m;window.addEventListener("orientationchange",m,false);wooga.castle.OverlayUrlBar.instance();wooga.castle.OverlayUrlBar.hide();var h=wooga.castle.capabilities.touch;var n=function(){var j=true,s=function(){if(j){j=false;return}wooga.castle.OverlayUrlBar.show()},r,q=function(){if(r){clearTimeout(r)}j=true;r=setTimeout(function(){j=false},1000)};if(!a.isSPA()){window.addEventListener("scroll",s,false)}document.querySelector("#enforce-urlBarRemove").addEventListener(h?"touchend":"click",function(){q();window.scrollTo(0,0);wooga.castle.OverlayUrlBar.hide()},false);wooga.castle.OverlayUrlBar.hide()};wooga.castle.subscribe("game/ready",n);this.game=o;this.entity=o.worldEntity;this.rootNode=f.rootNode;this.gridUnit=f.gridUnit;this.mapWidth=f.mapWidth;this.mapHeight=f.mapHeight;this.mapWidthPx=this.mapWidth*this.gridUnit;this.mapHeightPx=this.mapHeight*this.gridUnit;this.offsetWidth=f.offsetWidth;this.offsetHeight=f.offsetHeight;this.scrollLeft=0;this.scrollTop=Math.round(-(this.mapHeight*this.gridUnit-this.offsetHeight));this.rendering=true;this.mode=wooga.castle.GameModesManager.Mode.BASIC;this.entitiesViews={};this.visibleEntitiesViews=[];this.bufferCanvasChanges=[];this.addEventHandler("scrolled",function(){this.isScrolled=true},this);this.hitMap=[];var k,g;for(k=0;k<this.mapHeight;k++){this.hitMap[k*this.gridUnit]=[];for(g=0;g<this.mapWidth;g++){this.hitMap[k*this.gridUnit][g*this.gridUnit]=[]}}this.isFocusedEntityViewDefault=function(j){return false};this.isFocusedEntityView=this.isFocusedEntityViewDefault;this.createCanvas();this.createBufferCanvas();this.createGridCanvas();this.createInfoCanvas();this.initWorldInteractions();this.initScrollability();this.initRenderingLoop();this.addEventHandler("dragend",this.filterVisibleViews);o.subscribe("game/init",this.onGameInit,this);this.moveEntityView=null;o.subscribe("moveMode/activated",this.setMoveEntityView,this);o.subscribe("moveMode/deactivated",function(j){this.removeMoveEntityView(j);this.enableRendering()},this);o.subscribe("shopPreviewMode/activated",this.setMoveEntityView,this);o.subscribe("shopPreviewMode/deactivated",function(j){this.removeMoveEntityView(j);this.enableRendering()},this);this.subscribe("mode-change",function(){this.forceGrid();this.enableRendering()},this);this.subscribe("entity/focus",function(j){this.ensureEntityIsVisible(j);this.enableRendering()},this);this.subscribe("entity/ensureVisible",function(j){this.ensureEntityIsVisible(j);this.enableRendering()},this);wooga.castle.publish("game/worldViewInit",{view:this});this.initializeRenderSubscriptions()};var d=wooga.castle.WorldView;d.prototype=new wooga.castle.View();d.prototype.constructor=d;a.mixin(d,a.PubSubMixin);a.mixin(d,wooga.castle.WorldViewScrollabilityMixin);d.TRANSPARENCY_THRESHOLD=20;d.prototype.initializeRenderSubscriptions=function(){wooga.castle.subscribe("game/ready",this.enableRendering,this);a.subscribe("spawn",this.enableRendering,this);a.subscribe("game:road/",this.enableRendering,this);a.subscribe("game:entity/whack",this.enableRendering,this);a.subscribe("game:entity/whack-complete",this.enableRendering,this);a.subscribe("game:contract/collect",this.enableRendering,this);a.subscribe("game:contract/start",this.enableRendering,this);this.subscribe("invalidate",this.enableRendering,this);this.subscribe("entity/moved",this.enableRendering,this);this.subscribe("hud/",this.enableRendering,this);this.subscribe("enemy/animation-start",function(){this.enableAnimating()},this);this.subscribe("enemy/animation-end",function(){this.stopAnimating();this.enableRendering()},this)};d.prototype.createCanvas=function(){var f=document.createElement("canvas");f.width=this.offsetWidth;f.height=this.offsetHeight;f.getContext("2d").shadowColor="rgba(255, 255, 255, 1)";this.rootNode.appendChild(f);this.canvas=f;this.ctx=f.getContext("2d")};d.prototype.createBufferCanvas=function(){var f=document.createElement("canvas");f.width=this.mapWidthPx;f.height=this.mapHeightPx;this.bufferCanvas=f;this.bufferCtx=f.getContext("2d")};d.prototype.setGridVisible=function(f){a.toggleClass(this.gridCanvas,"hidden",f)};d.prototype.createGridCanvas=function(){var g=document.createElement("canvas"),f=g.getContext("2d");g.id="grid-map";g.width=this.mapWidthPx;g.height=this.mapHeightPx;this.drawWorldGrid(f);this.gridCanvas=g;this.rootNode.parentNode.appendChild(g)};d.prototype.createInfoCanvas=function(){var g=document.createElement("canvas"),f=g.getContext("2d");g.id="info-grid";g.width=this.mapWidthPx;g.height=this.mapHeightPx;if(wooga.castle.DEV){this.drawInfoGrid(f)}this.infoCanvas=g;this.rootNode.parentNode.appendChild(g)};d.prototype.onGameInit=function(f){f.game.worldView=this;this.game.entities.forEach(function(g){this.createEntityView(g,true)},this);this.filterVisibleViews();this.redrawBufferCanvas()};d.prototype.createEntityView=function(g,h){var f;switch(g.definition["class"]){case"castle":f=new wooga.castle.CastleView(this,g);break;case"house":case"uhouse":f=new wooga.castle.HouseView(this,g);break;case"statichouse":f=new wooga.castle.SpecialBuildingView(this,g);break;case"ship":f=new wooga.castle.ShipView(this,g);break;case"farm":f=new wooga.castle.FarmFieldView(this,g);break;case"enemy":f=new wooga.castle.EnemyView(this,g);break;case"path":f=new wooga.castle.RoadView(this,g);break;case"decoration":f=new wooga.castle.DecorationView(this,g);break;case"whackable":case"tree":case"rock":f=new wooga.castle.WhackableView(this,g);break;case"unlockable":f=new wooga.castle.UnlockableAreaView(this,g);break;default:f=new wooga.castle.EntityView(this,g)}this.addToHitmap(f);this.entitiesViews[g.id]=f;if(!h){this.filterVisibleViews();this.bufferCanvasChanges.push(f)}return f};d.prototype.removeEntityView=function(f){this.removeFromHitmap(f);delete this.entitiesViews[f.entity.id];this.filterVisibleViews();this.bufferCanvasChanges.push(f)};d.prototype.filterVisibleViews=function(){var g,f;this.visibleEntitiesViews=[];for(g in this.entitiesViews){if(this.entitiesViews.hasOwnProperty(g)){f=this.entitiesViews[g];if(this.isEntityOnScreen(f)||f.isDraggable){this.visibleEntitiesViews.push(f)}}}};d.prototype.isEntityOnScreen=function(f){return((f.x<-this.scrollLeft+this.offsetWidth)&&(f.x+f.width>-this.scrollLeft)&&(f.y<-this.scrollTop+this.offsetHeight)&&(f.y+f.height>-this.scrollTop))};d.prototype.getPanningMargins=function(){if(!this._panningMargins){var f=this.gridUnit;this._panningMargins={left:3*f,right:3*f,top:7*f,bottom:4*f}}return this._panningMargins};d.prototype.ensureEntityIsVisible=function(k){var p=k.x,n=k.y,r=k.width,j=k.height,g=this.scrollLeft,x=this.scrollTop,s=this.offsetWidth,l=this.offsetHeight,q=this.getPanningMargins(),f=(p>-g+q.left),v=(p+r<-g+s-q.right),u=(n>-x+q.top),o=(n+j<-x+l-q.bottom),t,m;if(!(f&&v&&u&&o)){if(!f){t=-p+q.left}if(!v){t=-(p+r+q.right)+s}if(!u){m=-n+q.top}if(!o){m=-(n+j+q.bottom)+l}if(t){this.setScrollLeft(t)}if(m){this.setScrollTop(m)}if(t||m){this.fireEvent("scrolled",this)}}return this};d.prototype.stopRendering=function(){this.rendering=false};d.prototype.enableRendering=function(){this.rendering=true};d.prototype.stopAnimating=function(){this.animating=false};d.prototype.enableAnimating=function(){this.animating=true};d.prototype.initRenderingLoop=function(){var m=this,o=this,p=this.ctx;var j=document.getElementById("bg").style;var k=document.getElementById("game_overlay").style;var l=this.gridCanvas.style;var n=this.infoCanvas.style;this.scrollTo(this.scrollLeft,this.scrollTop);var f,h=0;o.rendering=false;o.animating=false;var g=function(){h++;if(wooga.castle.DEV&&h%50===0){o.drawInfoGrid(o.infoCanvas.getContext("2d"))}if(o.rendering||o.animating||o.isScrolled){if(m.isScrolled){var s="translate3d("+m.scrollLeft+"px, "+m.scrollTop+"px, 0)";j.webkitTransform=s;k.webkitTransform=s;l.webkitTransform=s;n.webkitTransform=s;m.isScrolled=false}m.updateBufferCanvas();var q=Math.min(m.offsetWidth,m.mapWidthPx,m.mapWidthPx+m.scrollLeft);var r=Math.min(m.offsetHeight,m.mapHeightPx,m.mapHeightPx+m.scrollTop);p.clearRect(0,0,m.offsetWidth,m.offsetHeight);p.drawImage(m.bufferCanvas,Math.max(0,-m.scrollLeft),Math.max(0,-m.scrollTop),q,r,Math.max(0,m.scrollLeft),Math.max(0,m.scrollTop),q,r);m.visibleEntitiesViews.forEach(function(t){t.drawDynamic(m.scrollLeft+t.x,m.scrollTop+t.y)})}if(!o.animating){o.stopRendering()}setTimeout(g,1000/30)};f=Date.now();g()};d.prototype.drawWorldGrid=function(f){var j=this.gridUnit,g,k,l=this.mapWidth,h=this.mapHeight;f.strokeStyle="rgba(255, 255, 255, 0.2)";f.lineWidth=j/24;for(g=1;g<l;g++){f.beginPath();f.moveTo(g*j,0);f.lineTo(g*j,this.mapHeightPx);f.stroke();f.closePath()}for(k=1;k<h;k++){f.beginPath();f.moveTo(0,k*j);f.lineTo(this.mapWidthPx,k*j);f.stroke();f.closePath()}};d.prototype.drawInfoGrid=function(w){var h=this.gridUnit,r,p,m,k,u,s,v=this.mapWidth,o=this.mapHeight,g=this.game.gridMapCoastSubSet,q=this.hitMap,t=this.game.mapRel,j,f,n,l=w.canvas.width;w.canvas.width=l;w.strokeStyle="#ff0000";w.font="12px Arial";w.lineWidth=1;for(m=t.y.first,k=t.y.last;m<k;m++){for(r=t.x.first,p=t.x.last;r<p;r++){u=(r+v/2)*h;s=(m+o/2)*h;n=g[m][r];f=q[s][u];if(n){w.fillStyle="rgba(0, 0, 0, 0.6)";w.fillRect(u,s,h,h)}else{w.strokeRect(u,s,h,h)}w.fillStyle="rgba(255, 255, 255, 0.45)";w.fillText(r+"/"+m,u,s-h+12)}}w.strokeStyle="#0000ff";this.visibleEntitiesViews.forEach(function(x){if(x.entity){j=x.entity.definition;w.fillStyle="#ffff00";w.fillRect(x.x,x.y,x.width,x.height);w.fillStyle="#ff0000";w.fillRect(x.x,x.y-j.offsetY*h,x.width,x.height+j.offsetY*h);w.fillStyle="#000";w.fillText(x.entity.key,x.x,x.y+12,x.width)}})};var c=function(f){a.pushIfUnique(this,[f])};d.prototype.updateBufferCanvas=function(){if(this.bufferCanvasChanges.length){var f=this.bufferCtx;f.save();f.beginPath();var h,j;for(h=0;h<this.bufferCanvasChanges.length;h++){j=this.bufferCanvasChanges[h];f.rect(j.x,j.y,j.width,j.height)}f.clip();this.staticClearRect(0,0,this.bufferCanvas.width,this.bufferCanvas.height);var g=[];while(this.bufferCanvasChanges.length){this.getCollidingEntitiesViews(this.bufferCanvasChanges.shift()).forEach(c,g)}g.sort(function(l,k){var n=l.entity.definition["class"],m=k.entity.definition["class"];return((n==="path"||n==="farm")?-1:(m==="path"||m==="farm")?1:((l.y+l.height)-(k.y+k.height)))}).forEach(function(k){k.drawStatic()});f.restore()}};d.prototype.getCollidingEntitiesViews=function(n){var p=[];var f=this.gridUnit;var g=Math.max(n.x,0);var m=Math.min(n.x+n.width,this.mapWidthPx);var o=Math.max(n.y,0);var h=Math.min(n.y+n.height,this.mapHeightPx);var l,k;for(l=o;l<h;l+=f){for(k=g;k<m;k+=f){if(this.hitMap[l]&&this.hitMap[l][k]){this.hitMap[l][k].forEach(c,p)}}}return p};d.prototype.addToHitmap=function(g){var l=this.gridUnit;var k=Math.max(g.x,0);var o=Math.min(g.x+g.width,this.mapWidthPx);var f=Math.max(g.y,0);var n=Math.min(g.y+g.height,this.mapHeightPx);var m,h;for(m=f;m<n;m+=l){for(h=k;h<o;h+=l){this.hitMap[m][h].push(g)}}};d.prototype.removeFromHitmap=function(m){var f=this.gridUnit,o=m.entity.id;var g=Math.max(m.x,0);var n=Math.min(m.x+m.width,this.mapWidthPx);var p=Math.max(m.y,0);var h=Math.min(m.y+m.height,this.mapHeightPx);var l,k;var q=function(j){return j.entity.id!==o};for(l=p;l<h;l+=f){for(k=g;k<n;k+=f){if(this.hitMap[l]&&this.hitMap[l][k]){this.hitMap[l][k]=this.hitMap[l][k].filter(q)}}}};d.prototype.redrawBufferCanvas=function(){this.staticClearRect(0,0,this.bufferCanvas.width,this.bufferCanvas.height);var f;for(f in this.entitiesViews){if(this.entitiesViews.hasOwnProperty(f)){this.entitiesViews[f].drawStatic()}}};d.prototype.staticClearRect=function(g,j,h,f){this.bufferCtx.clearRect(g,j,h,f)};d.prototype.initWorldInteractions=function(){var f=document.body;if(wooga.castle.capabilities.touch){wooga.castle.scrollLock(true);f.addEventListener("touchstart",this,false);f.addEventListener("touchmove",this,false);f.addEventListener("touchend",this,false)}else{f.addEventListener("mousedown",this,false);f.addEventListener("mousemove",this,false);f.addEventListener("mouseup",this,false)}};d.prototype.handleEvent=(function(){var h,f,g,j,k,m,l;return function(n){if(n.target.nodeName.toLowerCase()!=="canvas"&&!a.hasClass(n.target,"actionIcon")){return}var o=n.touches?n.touches[0]:n;if(o&&o.clientX){o={clientX:o.clientX,clientY:o.clientY}}switch(n.type){case"touchstart":case"mousedown":h=o.clientX;f=o.clientY;g=true;j=false;k=false;l=this.findEntityViewByClientXY(h,f);m=setTimeout(function(){g=false;j=true;l.longtouch({x:h,y:f})},b);l.fireEvent("touchstart");break;case"touchmove":case"mousemove":if(k||((j||g)&&(Math.abs(o.clientX-h)>e||Math.abs(o.clientY-f)>e))){if(k){this.enableRendering();l.drag({x:o.clientX,y:o.clientY})}else{this.enableRendering();clearTimeout(m);g=false;j=false;k=true;l.dragstart({x:o.clientX,y:o.clientY})}}break;case"touchend":case"mouseup":clearTimeout(m);if(g){l.touch({x:h,y:f})}if(k){l.dragend()}l.touchend();g=false;j=false;k=false;if(n.type==="touchend"){a.clickBuster.preventGhostClick(h,f)}l=this;break}}}());d.prototype.clientXYtoWorldXY=function(f){return{x:Math.floor((f.x-this.scrollLeft)/this.gridUnit-this.mapWidth/2),y:Math.floor((f.y-this.scrollTop)/this.gridUnit-this.mapHeight/2)}};d.prototype.getCenterCoordinates=function(){return{x:Math.floor((-this.scrollLeft+this.offsetWidth/2)/this.gridUnit-this.mapWidth/2),y:Math.floor((-this.scrollTop+this.offsetHeight/2)/this.gridUnit-this.mapHeight/2)}};d.prototype.setMoveEntityView=function(f){this.moveEntityView="undefined"!==typeof f.target?f.target:f.entityView};d.prototype.removeMoveEntityView=function(f){this.moveEntity=null};d.prototype.findEntityViewByClientXY=(function(){var f=document.createElement("canvas").getContext("2d");return function(j,h){var z=this,v=j-this.scrollLeft,u=h-this.scrollTop,k=this.gridUnit;var q,n,g,t,r,s,p=0,w=0;if((this.mode===wooga.castle.GameModesManager.Mode.MOVE||this.mode===wooga.castle.GameModesManager.Mode.SHOP_PREVIEW)&&this.moveEntityView!==null){if(this.moveEntityView instanceof wooga.castle.DecorationView){w=this.moveEntityView.entity.definition.influenceArea}else{if(this.moveEntityView.entity.definition.width<=2&&this.moveEntityView.entity.definition.height+this.moveEntityView.entity.definition.offsetY<=2){w=1}}if(v>=this.moveEntityView.x-w*k&&v<(this.moveEntityView.x+this.moveEntityView.width+w*k)&&u>=this.moveEntityView.y-w*k-this.moveEntityView.entity.definition.offsetY*k&&u<(this.moveEntityView.y+this.moveEntityView.height+w*k)){return this.moveEntityView}}var o=this.hitMap[u-(u%k)][v-(v%k)]||[];o=o.sort(function(y,x){return(x.y+x.height)-(y.y+y.height)});var m=o.length;for(p=0;p<m;p++){q=o[p];if(!this.isFocusedEntityView()||this.isFocusedEntityView(q)){if(q.entity.is("unlockable")){return q}var l=q.getImageFrame(true);t=v-q.x;r=u-q.y;n=q.image;f.canvas.width=l.width;f.canvas.height=l.height;f.clearRect(0,0,l.width,l.height);f.drawImage(n,l.x,l.y,l.width,l.height,0,0,l.width,l.height);g=f.getImageData(0,0,l.width,l.height);s=g.data[(r*l.width+t)*4+3];if(s>d.TRANSPARENCY_THRESHOLD){return q}}}return z}}());d.prototype.isFocusable=function(){return this.entity.selectable};d.prototype.allowDrag=function(f){this.isDragAllowed=f};d.prototype.forceGrid=function(){var f=true,g=wooga.castle.GameModesManager.Mode;switch(this.mode){case g.MOVE:case g.SHOP_PREVIEW:case g.ROADS:f=false;break}a.toggleClass(this.gridCanvas,"invisible",f)}}());(function(){var a=wooga.castle.utils;wooga.castle.EntityView=function(c,d){if(!c||!d){return}wooga.castle.View.call(this);this.view=c;this.entity=d;if(this.entity.selectable){this.actions={move:true,destroy:true}}this.eventsBubbleTarget=c;this.ctx=c.canvas.getContext("2d");this.bufferCtx=c.bufferCanvas.getContext("2d");this.entity.entityView=this;this.x=(d.x+c.mapWidth/2)*c.gridUnit;this.y=(d.y+(d.definition.offsetY||0)+c.mapHeight/2)*c.gridUnit;this.flexX=0;this.flexY=0;this.zIndex=d.definition.zIndex||0;this.image=d.definition.image;this.width=d.definition.width*c.gridUnit;this.height=d.definition.height*c.gridUnit;this.colliding=false;this.dynamic=0;this.showBoostInfo=false;this.cacheImageFrame();this.initDraggability();this.iconCircle=Date.now()};var b=wooga.castle.EntityView;b.prototype=new wooga.castle.View();b.prototype.constructor=b;b.prototype.initDraggability=function(){this.addEventHandler("dragstart",function(c){if(this.isDraggable){this.beforeMove();return false}});this.addEventHandler("drag",function(c){if(this.isDraggable){this.moveTo(c,true);return false}});this.addEventHandler("dragend",function(){if(this.isDraggable){this.moved();this.isCollidingCache=this.isColliding();return false}})};b.prototype.isColliding=function(){return this.entity.isColliding({x:(this.x/this.view.gridUnit-this.view.mapWidth/2),y:(this.y/this.view.gridUnit-this.view.mapHeight/2-this.entity.definition.offsetY)})};b.prototype.getImageFrame=function(){return this.defaultImageFrame};b.prototype.setImageFrame=function(d){var c=this.view.gridUnit;var e=this.defaultImageFrame;e.width=d.width*c;e.height=d.height*c;e.x=(d.spritex||0)*c;e.y=(d.spritey||0)*c};b.prototype.cacheImageFrame=function(){this.defaultImageFrame=this.getImageFrameForDefinition(this.entity.definition);return this};b.prototype.getImageFrameForDefinition=function(c){return{x:(c.spritex||0)*this.view.gridUnit,y:(c.spritey||0)*this.view.gridUnit,width:this.width,height:this.height}};b.prototype.beforeMove=function(){this.view.removeFromHitmap(this);this.makeDynamic()};b.prototype.moveTo=function(e,f){var d=this.view.gridUnit;var c=e.x-this.view.scrollLeft-(this.width-d)/2;var g=e.y-this.view.scrollTop-(this.height-d)/2;this.flexX=c%d-d/2;this.flexY=g%d-d/2;this.x=c-c%d;this.y=g-g%d+Math.min(this.entity.definition.offsetY,-1)*d;if(f){this.y-=d}this.fireEvent("moved",this);return this};b.prototype.moved=function(){if(this._afterMovedTimeoutEV){clearTimeout(this._afterMovedTimeoutEV)}delete this.isCollidingCache;var c=this;this._afterMovedTimeoutEV=setTimeout(function(){c.clearFlex();c.view.addToHitmap(c);c.makeStatic();c.view.publish("entity/moved",{entity:c})},50)};b.prototype.clearFlex=function(){this.flexX=0;this.flexY=0};b.prototype.draw=function(d,c,f){var e=this.getImageFrame();d.drawImage(this.image,e.x,e.y,e.width,e.height,c+this.flexX,f+this.flexY,e.width,e.height)};b.prototype.drawStatic=function(){if(!this.dynamic&&!this.entity.preview){this.draw(this.bufferCtx,this.x,this.y)}};b.prototype.drawDynamic=function(c,d){if(this.isDraggable&&!this.isCollidingCache){this.drawBaseGrid()}if(this.dynamic||this.entity.preview){this.draw(this.ctx,c,d)}if(this.isDraggable&&this.isCollidingCache){this.drawBaseGrid()}};b.prototype.drawBaseGrid=function(){var o=this.ctx;var e=this.view.hitMap,h=this.view.gridUnit,j=this.view;var s=this.x,u=s+this.width;var d=this.y-this.entity.definition.offsetY*h,f=this.y+this.height;var n,p,k=false;var g=wooga.castle.Tutorial.instance();this.actionsMenu.setActionEnabled("confirm",false);var v,l;for(v=d;v<f;v+=h){for(l=s;l<u;l+=h){if(e[v]&&e[v][l]){n=false;var q=this.entity.game.playerData.map.width,m=this.entity.game.playerData.map.height,t=Math.floor(l/h-q/2),r=Math.floor(v/h-m/2);if(wooga.castle.playerData.doneTutorial||!g){if(this.view.game.testCollisions({x:t,y:r,width:1,height:1},this.entity)){n=true}}else{var c=g.screen.config.hilite;if(!(t>=c.x&&t<(c.x+c.width)&&r>=c.y&&r<(c.y+c.height))){n=true}}p=n?"rgba(255, 0, 0, 0.5)":"rgba(0, 255, 0, 0.5)";o.fillStyle=p;o.strokeStyle=p;o.fillRect(l+j.scrollLeft,v+j.scrollTop,h,h);o.strokeRect(l+j.scrollLeft,v+j.scrollTop,h,h);k=k||n}}}if(!k){this.actionsMenu.setActionEnabled("confirm",true)}};b.prototype.makeDynamic=function(){if(!this.dynamic){this.view.bufferCanvasChanges.push(this)}this.dynamic++};b.prototype.makeStatic=function(){if(this.dynamic>0){this.dynamic--}if(!this.dynamic){this.view.bufferCanvasChanges.push(this)}};b.prototype.isFocusable=function(){return this.entity.selectable};b.prototype.drawBoostInfo=function(){if(this.entity.boost<=0){return}var l=this.ctx,k="Bonus",h=this.entity.boost+" %";var j=l.measureText(k),g=l.measureText(h);var d=this.width/2-j.width/2,c=this.width/2-g.width/2,f=this.view.gridUnit/1.5,e=this.view.gridUnit/1.49;l.font=e+"px 'Luckiest Guy'";l.strokeStyle="rgba(0, 0, 0, 1)";l.strokeText(k,this.x+this.view.scrollLeft+d,this.y+this.width/2+this.view.scrollTop);l.strokeText(h,this.x+this.view.scrollLeft+c,this.y+this.width/2+this.view.gridUnit/1.7+this.view.scrollTop);l.font=f+"px 'Luckiest Guy'";l.fillStyle="rgba(86, 255, 255, 1)";l.fillText(k,this.x+this.view.scrollLeft+d,this.y+this.width/2+this.view.scrollTop);l.fillText(h,this.x+this.view.scrollLeft+c,this.y+this.width/2+this.view.gridUnit/1.7+this.view.scrollTop)};b.prototype.findNewPosition=function(){var g=this.entity.game.playerData.map.width,l=this.entity.game.playerData.map.height;var c=0,p=0,j=0,o=0,n=0,e=false,d=100,k=this.x,h=this.y;do{j+=1;c=Math.floor(Math.random()*(g))-g/2;p=Math.floor(Math.random()*(l))-l/2;o=(c+g/2)*this.view.gridUnit;n=(p+this.entity.definition.offsetY+l/2)*this.view.gridUnit;if((this.entity.definition.width+c+g/2)>=g||(this.entity.definition.height+p+l/2)>=l||o<0||n<0){e=true}else{e=false}}while((this.isEntityColliding(o,n)||e||(k===o&&h===n))&&j<d);if(j>=d){var f,m;for(f=-l/2;f<l/2;f++){for(m=-g/2;m<g/2;m++){c=m;p=f;o=(c+g/2)*this.view.gridUnit;n=(p+this.entity.definition.offsetY+l/2)*this.view.gridUnit;if(!this.isEntityColliding(o,n)&&k!==o&&h!==n){this.entity.move({x:c,y:p});return true}}}}else{this.entity.move({x:c,y:p});return true}return false};b.prototype.isEntityColliding=function(n,l){var o=false;var d=this.view.hitMap,k=this.view.gridUnit,g=this.entity.game.gridMapCoastSubSet,u=this.entity.game.playerData.map;var r="undefined"===typeof n?this.x:n,s=r+this.width;var c=("undefined"===typeof l?this.y:l)-this.entity.definition.offsetY*k,f=c+this.height+this.entity.definition.offsetY*k,m=this.entity;if("undefined"!==typeof m.definition.xOffsetLeft){r+=m.definition.xOffsetLeft*k}if("undefined"!==typeof m.definition.xOffsetRight){s+=m.definition.xOffsetRight*k}if(s>u.width*k||f>u.height*k){return true}var v,p,q,h,t;var j=function(w){return !w.is(["path","farm"])};var e={x:Math.floor(r/k-u.width/2),y:Math.floor(c/k-u.height/2),width:Math.floor((s-r)/k),height:Math.floor((f-c)/k)};if(this.entity.game.isAreaOnCoast(e)){return true}for(v=c;v<f;v+=k){for(p=r;p<s;p+=k){if(m.is("enemy")){t=d[v]&&d[v][p];if(t){for(q=0;q<t.length;q++){h=t[q];if(h!==this&&j(h.entity)){return true}}}}}}return false};b.prototype.invalidate=function(){this.image=this.entity.definition.image;this.cacheImageFrame();this.invalidatePosition();return this};b.prototype.invalidatePosition=function(){var c={x:this.x,y:this.y,width:this.width,height:this.height};this.view.removeFromHitmap(this);this.x=(this.entity.x+this.view.mapWidth/2)*this.view.gridUnit;this.y=(this.entity.y+this.entity.definition.offsetY+this.view.mapHeight/2)*this.view.gridUnit;this.view.addToHitmap(this);this.view.bufferCanvasChanges.push(this,c);a.publish("view:invalidate");return this};a.can("touch-view",function(c){if(c.view.mode===wooga.castle.GameModesManager.Mode.MOVE){return c.view.isFocusedEntityView(c)}return !c.view.isFocusedEntityView(c)&&!c.busy})}());(function(){var a=wooga.castle.utils,d=wooga.castle.EntityView,b=wooga.castle.House.ContractState;wooga.castle.HouseView=function(e,f){if(!arguments.length){return this}this.bindToEntity(f);d.call(this,e,f);this.busy=false;if(f.contractState===b.CONSTRUCTION||f.contractState===b.CONSTRUCTED){this.useConstructionDefinition()}this.updateImage();this._initIconDefinitions().setActionIcon();this.addEventHandler("touch",this.touchHandler)};var c=wooga.castle.HouseView;a["extends"](c,d);c.prototype.isFocusable=function(){var e=(this.entity.contractState===b.STARTED||this.entity.contractState===b.PAUSED)&&(!this.entity.contractStartTime||(Date.now()-this.entity.contractStartTime>100));var f=(this.entity.contractState===b.CONSTRUCTION)&&((Date.now()-this.entity.constructionStartTime>100));return e||f};c.prototype.bindToEntity=function(e){if(this.entity){this.entity.removeEventHandler("contractChange",this.setActionIcon,this);this.entity.removeEventHandler("destroy",this.setActionIcon,this);this.entity.removeEventHandler("startConstruction",this.startConstruction,this);this.entity.removeEventHandler("finishConstruction",this.finishConstruction,this);this.entity.removeEventHandler("acceptConstruction",this.acceptConstruction,this)}this.entity=e;e.entityView=this;this.entity.addEventHandler("contractChange",this.setActionIcon,this);this.entity.addEventHandler("destroy",this.setActionIcon,this);this.entity.addEventHandler("startConstruction",this.startConstruction,this);this.entity.addEventHandler("finishConstruction",this.finishConstruction,this);this.entity.addEventHandler("acceptConstruction",this.acceptConstruction,this);return this};c.prototype._initIconDefinitions=function(){this.iconDefinitions=this.iconDefinitions||{};this.iconDefinitions.start=this._initIconDefinition("contracts/contract");this.iconDefinitions.collect=this._initIconDefinition("contracts/gold");this.iconDefinitions.no_road=this._initIconDefinition("contracts/no_road");this.iconDefinitions.constructed=this._initIconDefinition("contracts/constructed");return this};c.prototype._initIconDefinition=function(g){if(this.iconDefinitions[g]){return this.iconDefinitions[g]}var f=this.view.gridUnit,e=this.width,k=this.height,j=this.view.game.entitiesDefinition[g],l=j.width===-1?e:j.width*f,m=j.height===-1?k:j.height*f;return this._setIconOffsets({image:j.image,width:l,height:m})};c.prototype._setIconOffsets=function(e){e.offset={x:(this.width-e.width)*0.5,y:(this.height-e.height-(this.entity.definition.offsetY||0)*this.view.gridUnit)*0.5};return e};c.prototype.createActionIcon=function(){this.icon=document.createElement("div");this.icon.className="actionIcon";document.getElementById("game_overlay").appendChild(this.icon)};c.prototype.moved=function(){d.prototype.moved.call(this);if(this.afterMovedTimeout){clearTimeout(this.afterMovedTimeout)}var e=this;this.afterMovedTimeout=setTimeout(function(){e.setActionIcon()},100)};c.prototype.setActionIcon=function(){if(!this.icon){this.createActionIcon()}var e=this.icon;switch(this.entity.contractState){case b.CONSTRUCTED:this._changeActionIconByDefinition(this.iconDefinitions.constructed);e.style.display="";break;case b.IDLE:this._changeActionIconByDefinition(this.iconDefinitions.start);e.style.display="";break;case b.FINISHED:this._changeActionIconByDefinition(this.iconDefinitions.collect);e.style.display="";break;case b.PAUSED:this._changeActionIconByDefinition(this.iconDefinitions.no_road);e.style.display="";break;default:e.style.display="none"}e.className=this.entity.definition["class"]+" actionIcon "+this.entity.contractState};c.prototype.startConstruction=function(){this.useConstructionDefinition();this.updateImage()};c.prototype.finishConstruction=function(){this.setActionIcon()};c.prototype.acceptConstruction=function(){this.entity.definition=this.entity.defaultDefinition;this.updateImage()};c.prototype.useConstructionDefinition=function(){var e=this.view.game.entitiesDefinition["construction/"+this.entity.definition.width+"x"+(this.entity.definition.height+this.entity.definition.offsetY)];this.entity.defaultDefinition=a.extend({},this.entity.definition);this.entity.definition=a.extend({},this.entity.definition,e)};c.prototype.updateImage=function(){this.invalidate();this.image=this.entity.definition.image;this.width=this.entity.definition.width*this.view.gridUnit;this.height=this.entity.definition.height*this.view.gridUnit;this.setImageFrame(this.entity.definition)};c.prototype._changeActionIconByDefinition=function(f){if(f){f=this._setIconOffsets(f);var e=this.icon.style;e.background="url("+f.image.src+") 50% 50% no-repeat";e.width=f.width+"px";e.height=f.height+"px";e.top=this.y+f.offset.y+"px";e.left=this.x+f.offset.x+"px"}return this};c.prototype.drawDynamic=function(e,f){wooga.castle.EntityView.prototype.drawDynamic.call(this,e,f);if(this.showBoostInfo){this.drawBoostInfo()}};c.prototype.touchHandler=function(){if(a.can("touch-view",this)){if(!a.can("entity/contract/change",this)){return}switch(this.entity.contractState){case b.CONSTRUCTED:if(!this.busy){this.busy=true;this.view.publish("entity/contract/collecting",{entityView:this,text:"Finishing...",callback:a.bind(function(){this.entity.acceptConstruction();this.busy=false},this)})}break;case b.IDLE:this.entity.startContract();break;case b.FINISHED:if(!this.busy){this.busy=true;this.view.publish("entity/contract/collecting",{entityView:this,text:"Collecting...",callback:a.bind(this.collectContract,this)})}break}}};c.prototype.collectContract=function(){this.entity.collectContract(this);this.busy=false}}());(function(){var a=wooga.castle.utils;wooga.castle.FarmFieldView=function(d,e){wooga.castle.EntityView.call(this,d,e);e.addEventHandler("contractActivate",function(){this.cacheImageFrame();d.bufferCanvasChanges.push(this)},this);e.addEventHandler("contractCollect",function(){d.bufferCanvasChanges.push(this)},this);this.addEventHandler("touch",this.touchHandler);var f=this.view.gridUnit;var c=this.view.game.entitiesDefinition["contracts/food"];this.foodIconImage=c.image;this.foodIconWidth=c.width*f;this.foodIconHeight=c.height*f;this.foodIconOffsetX=(this.width-this.foodIconWidth)/2;this.foodIconOffsetY=(this.height-this.foodIconHeight-this.entity.definition.offsetY*f)/2;this.setActionIcon();this.entity.addEventHandler("contractChange",this.setActionIcon,this)};var b=wooga.castle.FarmFieldView;b.SpriteMap={"seeds/melon":1,"seeds/bean":2,"seeds/clover":3,"seeds/pumpkin":4,"seeds/strawberry":5,"seeds/grapes":6,"seeds/wheat":7};b.prototype=new wooga.castle.EntityView();b.prototype.parent=wooga.castle.EntityView;b.prototype.constructor=b;b.prototype.moved=function(){this.parent.prototype.moved.call(this);this.setActionIcon()};b.prototype.createActionIcon=function(){this.icon=document.createElement("div");this.icon.className="actionIcon";a.addTouchHandler(this.icon,this.touchHandler,this);document.getElementById("game_overlay").appendChild(this.icon)};b.prototype.setActionIcon=function(){if(!this.icon){this.createActionIcon()}var d=this.icon;d.style.display="";var c=wooga.castle.FarmField.ContractState;switch(this.entity.contractState){case c.FINISHED:d.style.background="url("+this.foodIconImage.src+")";d.style.width=this.foodIconWidth+"px";d.style.height=this.foodIconHeight+"px";d.style.top=this.y+this.foodIconOffsetY+"px";d.style.left=this.x+this.foodIconOffsetX+"px";break;default:d.style.display="none"}};b.prototype.touchHandler=function(){if(a.can("touch-view",this)){if(!a.can("entity/contract/change",this)){return}var c=wooga.castle.FarmField.ContractState;switch(this.entity.contractState){case c.IDLE:if(a.can("enter-shop")){var d=this;setTimeout(function(){d.view.publish("shop/show",{department:"farming",targetEntity:d.entity})},50)}break;case c.FINISHED:this.busy=true;this.view.publish("entity/contract/collecting",{entityView:this,text:"Harvesting...",callback:a.bind(this.collectContract,this)});break}this.cacheImageFrame()}};b.prototype.collectContract=function(){this.entity.collectContract(this);this.busy=false;this.cacheImageFrame()};b.prototype.isFocusable=function(){return this.entity.contractState===wooga.castle.FarmField.ContractState.STARTED};b.prototype.cacheImageFrame=function(){var c=this.entity.seedName?this.entity.game.entitiesDefinition[this.entity.seedName]:this.entity.definition;this.defaultImageFrame=this.getImageFrameForDefinition(c);return this};b.prototype.drawDynamic=function(c,e){wooga.castle.EntityView.prototype.drawDynamic.call(this,c,e);if(this.view.mode!==wooga.castle.GameModesManager.Mode.MOVE&&this.view.mode!==wooga.castle.GameModesManager.Mode.SHOP_PREVIEW&&this.view.mode!==wooga.castle.GameModesManager.Mode.ROADS&&this.view.mode!==wooga.castle.GameModesManager.Mode.SEED&&this.entity.game.playerData.doneTutorial){if(this.entity.contractState===wooga.castle.FarmField.ContractState.FINISHED){if(this.amimateContractIcons){var d=1+Math.sin(Date.now()/250)*0.09;this.icon.style.webkitTransform="scale3d("+d+", "+d+", 0)"}else{this.icon.style.webkitTransform="scale3d("+1+", "+1+", 0)"}if(this.iconCircle+5000<Date.now()){this.amimateContractIcons=(this.amimateContractIcons===true)?false:true;this.iconCircle=Date.now()}}}if(this.showBoostInfo){this.drawBoostInfo()}};b.prototype.destructor=function(){this.parent.prototype.destructor.call(this);if(this.icon&&this.icon.parentNode){this.icon.parentNode.removeChild(this.icon)}};a.can("enter-shop",function(){return wooga.castle.game.worldView.mode===wooga.castle.GameModesManager.Mode.BASIC})}());(function(){var a=wooga.castle.utils,b=30*1000;function c(d,e){wooga.castle.Entity.call(this,d,e);this.hp=this.definition.hp;this.punchesLeftUntilKill=this.definition.hp}wooga.castle.Enemy=c;a["extends"](c,wooga.castle.Entity);a.mixin(c,a.ObservableMixin);c.prototype.punch=function(){this.game.publish("enemy/whack",{entity:this});this.hp--;if(this.hp===0){this.remove()}};c.prototype.collectRewards=function(e){var d;for(d=0;d<e.length;++d){this.game.increase(e[d].type,e[d].amount,this)}if(e.length){this.game.publish("enemy/collectReward",{entity:this,rewards:e})}};c.prototype.remove=function(){this.game.publish("enemy/kill",{entity:this});this.fireEvent("remove");this.game.removeEntity(this)}}());(function(){var b=wooga.castle.utils;wooga.castle.EnemyView=function(c,d){wooga.castle.EntityView.call(this,c,d);this.animating=false;this.frameIndex=0;this.addEventHandler("touch",this.animatePunch,this);d.addEventHandler("remove",this.remove,this);this.enemyDef=d.definition;var e=this.view.gridUnit;this.dyingEnemyDef=this.view.game.entitiesDefinition["enemy/dying"];this.dyingEnemyImg=this.dyingEnemyDef.image;this.dyingEnemyWidth=this.dyingEnemyDef.width*e;this.dyingEnemyHeight=this.dyingEnemyDef.height*e;this.dyingEnemyOffsetX=(this.width-this.dyingEnemyWidth)/2;this.dyingEnemyOffsetY=(this.height-this.dyingEnemyHeight-this.entity.definition.offsetY*e)/2};var a=wooga.castle.EnemyView;a.prototype=new wooga.castle.EntityView();a.prototype.constructor=a;a.prototype.drawStatic=function(c,d){if(!this.animating){wooga.castle.EntityView.prototype.drawStatic.call(this,c,d)}};a.prototype.drawDynamic=function(c,d){if(this.animating){this.draw(this.ctx,c,d)}};a.prototype.getImageFrame=function(){if(this.animating){var c=this.width,d=this.height,e=this.frameIndex;return{x:e*c,y:0,width:c,height:d}}else{return wooga.castle.EntityView.prototype.getImageFrame.call(this)}};a.prototype.animatePunch=function(){if(!b.can("punch-enemy",this)){return}if(this.entity.punchesLeftUntilKill>0&&!this.animating){--this.entity.punchesLeftUntilKill;this.animating=true;this.view.bufferCanvasChanges.push(this);this.whackAnimation()}};a.prototype.whackAnimation=function(){b.publish("view:enemy/animation-start");var c=setInterval(b.bind(function(){this.frameIndex++;if(this.frameIndex===this.entity.definition.animation.length){clearInterval(c);this.onWhackAnimationEnd()}},this),1000/24)};a.prototype.onWhackAnimationEnd=function(){this.frameIndex=0;this.entity.collectRewards(this.entity.definition.whackRewards);if(this.entity.punchesLeftUntilKill===0){this.killAnimation()}else{this.animating=false;b.publish("view:enemy/animation-end");this.view.bufferCanvasChanges.push(this);this.entity.punch()}};a.prototype.killAnimation=function(){this.swapSprites(this.dyingEnemyImg,this.dyingEnemyWidth,this.dyingEnemyHeight,true);var c=setInterval(b.bind(function(){this.frameIndex++;if(this.frameIndex===this.dyingEnemyDef.animation.length){clearInterval(c);this.onKillAnimationEnd()}},this),800/24)};a.prototype.onKillAnimationEnd=function(){this.frameIndex=0;this.entity.collectRewards(this.entity.definition.killRewards);this.animating=false;b.publish("view:enemy/animation-end");this.view.bufferCanvasChanges.push(this);var c=this.view.gridUnit;this.swapSprites(this.enemyDef.image,this.enemyDef.width*c,this.enemyDef.height*c,false);this.entity.punch()};a.prototype.swapSprites=function(d,f,c,g){var e=this.view.gridUnit;this.image=d;this.width=f;this.height=c;this.x=g?this.x+this.dyingEnemyOffsetX/2:this.x-this.dyingEnemyOffsetX/2;this.y=g?this.y+this.dyingEnemyOffsetY/2:this.y-this.dyingEnemyOffsetY/2};a.prototype.remove=function(){this.view.removeEntityView(this)}}());(function(){var a=wooga.castle.utils;var b=function(c,d){wooga.castle.Entity.call(this,c,d);this.effectedEntities=[]};b.prototype=new wooga.castle.Entity();b.prototype.constructor=b;b.prototype.getInfluencedEntities=function(e,d,f){var c=this.definition.influenceArea;this.game.testCollisions2({x:"undefined"===typeof d?this.x-c:d-c,y:"undefined"===typeof f?this.y-c:f-c,width:this.definition.width+2*c,height:this.definition.height+this.definition.offsetY+2*c},this,true,e);return e};b.prototype.broadcastChangeAfterMove=function(){this.effectedEntities.forEach(function(c){a.publish("game:boosts/maybe-change",{entity:c,decoration:this})},this);return this};b.prototype.applyBoosts=function(c,d){if(this.effectedEntities.length){this.game.publish("decoration/hideBoost",{entityView:this.entityView});this.removeBoosts();this.effectedEntities=[]}this.getInfluencedEntities(this.effectedEntities,c,d);this.addBoosts();return this};b.prototype.addBoosts=function(){this.updateBoosts(false)};b.prototype.removeBoosts=function(){this.updateBoosts(true)};b.prototype.updateBoosts=function(d){var f=1,c,e;if(d){f=-1}for(e=0;e<this.effectedEntities.length;e++){c=this.effectedEntities[e];this.game.publish("boost/change",{entity:c,decoration:this});if(this.definition.goldBoost){c.updateBoost(f*this.definition.goldBoost,"gold")}if(this.definition.foodBoost){c.updateBoost(f*this.definition.foodBoost,"food")}}};b.prototype.getInfoModeString=function(){var c="<p>Nearby buildings get a ";var d=false;if(this.definition.goldBoost){c+="gold boost of "+this.definition.goldBoost+"%";d=true}if(this.definition.foodBoost){if(d){c+="</p><p>and a "}c+="food boost of "+this.definition.foodBoost+"%."}return c};b.prototype.removeEntity=function(c){this.effectedEntities.splice(this.effectedEntities.indexOf(c),1)};wooga.castle.Decoration=b}());(function(){var a=wooga.castle.utils;wooga.castle.DecorationView=function(c,d){wooga.castle.EntityView.call(this,c,d);var e=this;this.entity.game.subscribe("decoration/showBoost",function(g){if(g.entityView===this){this.entity.applyBoosts(g.x,g.y);var f=this;this.entity.effectedEntities.forEach(function(h){if((h instanceof wooga.castle.House&&f.entity.definition.goldBoost>0)||(h instanceof wooga.castle.FarmField&&f.entity.definition.foodBoost>0)){h.entityView.showBoostInfo=true}})}},this);this.entity.game.subscribe("decoration/hideBoost",function(f){if(f.entityView===this){this.entity.effectedEntities.forEach(function(g){if(g instanceof wooga.castle.House||g instanceof wooga.castle.FarmField){g.entityView.showBoostInfo=false}})}},this)};var b=wooga.castle.DecorationView;b.prototype=new wooga.castle.EntityView();b.prototype.constructor=b;b.prototype.drawInfluence=function(){var l=this.ctx;var c=this.view.gridUnit,h=this.view,g=this.entity.definition.influenceArea;var d=(this.x-g*c)+h.scrollLeft,f=(this.x+this.width+g*c)+h.scrollLeft,k=(this.y-(this.entity.definition.offsetY+g)*c)+h.scrollTop,e=(this.y+this.height+g*c)+h.scrollTop;this.drawRoundedRect(d,f,k,e);var j="rgba(86, 255, 255, 0.15)";l.fillStyle=j;l.fillRect(d,k,f-d,e-k)};b.prototype.drawDynamic=function(c,d){wooga.castle.EntityView.prototype.drawDynamic.call(this,c,d);if((this.view.mode===wooga.castle.GameModesManager.Mode.INFO&&(this.dynamic||this.entity.preview))||(this.view.mode===wooga.castle.GameModesManager.Mode.MOVE&&this.isDraggable)||(this.view.mode===wooga.castle.GameModesManager.Mode.SHOP_PREVIEW&&this.isDraggable)){this.drawInfluence()}};b.prototype.drawRoundedRect=function(g,k,c,j){var d=this.ctx,f=this.view.gridUnit,e=f/5,h="rgba(86, 255, 255, 0.7)";d.lineWidth=2;d.lineJoin="round";d.strokeStyle=h;d.beginPath();d.moveTo(g,c+e);d.arc(g+e,c+e,e,(Math.PI/180)*180,(Math.PI/180)*270,false);d.lineTo(k-e,c);d.arc(k-e,c+e,e,(Math.PI/180)*270,0,false);d.lineTo(k,j-e);d.arc(k-e,j-e,e,0,(Math.PI/180)*90,false);d.lineTo(g+e,j);d.arc(g+e,j-e,e,(Math.PI/180)*90,(Math.PI/180)*180,false);d.lineTo(g,c+e);d.stroke();d.closePath()};b.prototype.moveTo=function(c){wooga.castle.EntityView.prototype.moveTo.call(this,c,true);this.entity.game.publish("decoration/showBoost",{entityView:this,x:Math.floor(this.x/this.view.gridUnit-this.entity.game.playerData.map.width/2),y:Math.floor(this.y/this.view.gridUnit-this.entity.game.playerData.map.height/2)-this.entity.definition.offsetY})}}());(function(){var a=wooga.castle.utils;var b=function(){return false},e,d;var c;wooga.castle.Shop=function(g,f,h,j){this.manager=j;this.game=g;this.view=f;this.element=undefined;this.shopItems=wooga.castle.Shop.shopItems=wooga.castle.shopItems;this.template=undefined;this.rootNode=h.rootNode;wooga.castle.net.getCached(c.TEMPLATE_URL).addCallback(function(k){this.template=k.data;if(this.shopItems){this._build()}},this);this.view.subscribe("shop/show",function(k){this.targetEntity=null;if(k){this.targetEntity=k.targetEntity;if(k.department){this.activateDepartment(c.DEPARTMENT_ID_PATTERN.replace("{id}",k.department))}if(k.department&&this.targetEntity){this.lockActiveDepartment()}}this.show()},this);a.subscribe("game/ready",this.invalidate,this)};c=wooga.castle.Shop;c.TEMPLATE_URL=a.urlFor("templates/shop.html");c.DEFAULT_DEPARTMENT_INDEX=0;c.DEPARTMENT_ID_PATTERN="shop-{id}";c.IMAGES_BASE_URL=wooga.castle.IMAGES_BASE_URL;c.prototype._build=function(){var f=new EJS({text:this.template});var p={shop:"shop",houses:"houses",farming:"farming",farms:"farms",decoration:"decoration",specials:"specials"};e=document.querySelector("nav");d=document.getElementById("hud-goals");var j,k=0;var g={},m;var o=function(s){var r=this.game.entitiesDefinition[s]||0;var q;switch(r["class"]){case"house":case"uhouse":q={title:r.name,imgSrc:a.urlFor(c.IMAGES_BASE_URL+r.icon),name:s,"class":r["class"],goldCost:r.goldCost,population:r.population||1,contractRequiredFood:r.contract.requiredFood,contractRequiredTime:a.roundTime(r.contract.requiredTime),contractProvidedGold:r.contract.providedGold};break;case"farm":q={title:r.name,imgSrc:a.urlFor(c.IMAGES_BASE_URL+r.icon),name:s,"class":r["class"],goldCost:r.goldCost};break;case"seeds":q={title:r.name,imgSrc:a.urlFor(c.IMAGES_BASE_URL+r.icon),name:s,"class":r["class"],goldCost:r.goldCost,contractRequiredTime:a.roundTime(r.contract.requiredTime),contractRequiredGold:r.contract.requiredGold,contractProvidedFood:r.contract.providedFood};break;case"decoration":q={title:r.name,imgSrc:a.urlFor(c.IMAGES_BASE_URL+r.icon),name:s,"class":r["class"],goldCost:r.goldCost,influenceArea:r.influenceArea,goldBoost:r.goldBoost,foodBoost:r.foodBoost};break}q.unlockCondition=r.unlockCondition;q.unlockValue=r.unlockValue;return q};for(m in this.shopItems){if(this.shopItems.hasOwnProperty(m)){if(k++===c.DEFAULT_DEPARTMENT_INDEX){j=m}g[m]=this.shopItems[m].map(o,this);g[m].sort(this.sortShopItems)}}var h=document.createElement("div");h.id="shop";h.innerHTML=f.render({l10n:p,shopItems:g});a.addTouchHandler(h.querySelector("div.head button.cancel"),function(){if(a.can("shop/close")){this.hide(true)}},this);this._departmentsListElement=h.querySelector("ul.departments_list");a.addTouchHandler(this._departmentsListElement,this._departmentsListTouchHandler,this);this._departmentsElement=h.querySelector("div.departments");a.addTouchHandler(this._departmentsElement,this._departmentsTouchHandler,this);var l=h.querySelectorAll("ul.department");if(wooga.castle.capabilities.iPad){Array.prototype.forEach.call(l,a.enableScrollabilityX,true)}else{Array.prototype.forEach.call(l,a.enableScrollability)}var n=h.querySelector("#upgrade-castle .button");a.addTouchHandler(n,function(){var q=this.game.castle.entityView;this.view.scrollTo(-q.x,-q.y);this.view.filterVisibleViews();this.hide();if(wooga.castle.playerData.upgradingCastle){wooga.castle.CastleCompleteScreen.instance().show();this.deactivate();this.manager.setMode(wooga.castle.GameModesManager.Mode.BASIC)}else{this.view.publish("castleUpgradeMode/set",{target:q})}},this);this.rootNode.appendChild(h);this.element=h;this.activateDepartment(c.DEPARTMENT_ID_PATTERN.replace("{id}",j),true);a.subscribe("game:player/update",function(){this.invalidate()},this)};c.prototype.sortShopItems=function(g,f){return(g.unlockValue===f.unlockValue)?g.goldCost-f.goldCost:g.unlockValue-f.unlockValue};c.prototype._departmentsTouchHandler=function(g){a.clickBuster.preventGhostClick(g.x,g.y);var f=null;var h=g.target;while(h!==this._departmentsElement){if(h.nodeName==="LI"){f=h;break}else{h=h.parentNode}}if(f){if(this.activateShopPreviewMode(f.getAttribute("data-itemname"))){this.hide(false)}}};c.prototype.isPopulationMaxed=function(){return this.game.getPopulation()>=this.game.castle.definition.population};c.prototype.activateShopPreviewMode=function(j){if(!a.can("shop/preview",{entityName:j,targetEntity:this.targetEntity})){return}var f=this.game.entitiesDefinition[j],k=f.goldCost||f.contract.requiredGold,h=f.unlockCondition==="level"?f.unlockValue:1,g=["house","uhouse"].indexOf(f["class"])!==-1,m=g?f.population||1:0;if(wooga.castle.playerData.level<h){setTimeout(function(){wooga.notify("You can purchase this item at level "+h+" or above!","level")},1);return false}if(!this.game.hasStat("gold",k)){setTimeout(function(){wooga.notify(a.goldDeltaMessage(k,"buy this!"),"gold")},1);return false}if(g&&(this.game.getPopulation()+m>this.game.castle.definition.population)){setTimeout(function(){wooga.notify("You need to upgrade your castle to support more population.","population")},1);return false}var l;switch(f["class"]){case"house":case"uhouse":case"farm":case"decoration":l={entityName:j};if(a.can("shop/preview",l)){a.can("shop/preview",a.disabler);a.subscribe("game:shopPreviewMode/deactivated",function(){a.can.remove("shop/preview",a.disabler);a.can.remove("shop/seed",a.disabler)});this.view.publish("shop/preview",l)}else{return false}break;case"seeds":l={entityName:j,targetEntity:this.targetEntity};if(a.can("shop/seed",l)){a.can("shop/seed",a.disabler);a.subscribe("game:seedMode/deactivated",function(){a.can.remove("shop/preview",a.disabler);a.can.remove("shop/seed",a.disabler)});this.view.publish("shop/seed",l)}else{return false}break}return true};c.prototype._departmentsListTouchHandler=function(g){a.clickBuster.preventGhostClick(g.x,g.y);var f=null;var h=g.target;while(h!==this._departmentsListElement){if(h.nodeName==="A"){f=h;break}else{h=h.parentNode}}if(f){this.activateDepartment(f.getAttribute("href").replace("#",""));g.preventDefault()}};c.prototype.activateDepartment=function(f,h){if(!(a.can("change shop departments",f)||h)){return}var g=this.element.querySelectorAll(".departments .active, .departments_list .active");if(g){Array.prototype.forEach.call(g,function(j){j.className=j.className.replace("active","")})}a.addClass(this.element.querySelector("a[href$="+f+"]"),"active");a.addClass(document.getElementById(f),"active");this.invalidate();this.view.publish("shop/change-department",{departmentID:f})};c.prototype.lockActiveDepartment=function(){a.addClass(this.element,"locked")};c.prototype.unlockAllDepartments=function(){a.removeClass(this.element,"locked")};c.prototype.show=function(){this.manager.setMode(wooga.castle.GameModesManager.Mode.SHOP);a.can("show-overlay",b);this.view.rendering=false;if(wooga.castle.capabilities.iPad){e.style.visibility=d.style.visibility="hidden"}var f=this.element,g=this;setTimeout(function(){f.querySelector(".departments").style.display=""},10);this.view.publish("shop/visible",{shop:this});a.addClass(f,"active")};c.prototype.hide=function(h){var g=this;this.element.querySelector(".departments").style.display="none";a.removeClass(this.element,"active");a.can.remove("show-overlay",b);this.unlockAllDepartments();var f=h?"shop/close":"shop/hide";if(h){this.manager.setMode(wooga.castle.GameModesManager.Mode.BASIC)}setTimeout(function(){g.view.rendering=true;g.view.publish(f,{shop:g});g.view.publish("shop/hidden",{shop:g});if(wooga.castle.capabilities.iPad){e.style.visibility=d.style.visibility="visible"}},48)};c.prototype.invalidate=function(){var g=document.querySelector("#shop .head .gold"),j=this.game.getPopulation(),f=(this.game.castle.definition||{}).population||0;if(g){g.innerHTML=this.game.playerData.gold}a.toggleClass(document.getElementById("shop-houses"),"population-maxed",this.isPopulationMaxed());if(this.isPopulationMaxed()){var k=wooga.castle.CastleUpgradeMode.getEntityName().toLowerCase();[].map.call(this.element.querySelectorAll(".entity-name"),function(l){l.innerHTML=k},this)}var h=this.element.querySelector('.active[href$="#shop-houses"]');this.element.querySelector("#upgrade-castle").style.display=h&&this.isPopulationMaxed()?"block":"none";Array.prototype.forEach.call(this.element.querySelectorAll(".departments .department li"),function(n){var q=n.dataset?n.dataset.cost:parseInt(n.getAttribute("data-cost"),10),p=parseInt(n.dataset?n.dataset.population:n.getAttribute("data-population"),10),o=n.dataset?n.dataset.level:parseInt(n.getAttribute("data-level"),10),m=(j+p)>f;if(o>1){var l=wooga.castle.playerData.level<o;a.toggleClass(n,"unalevelable",l);if(l){n.setAttribute("title","Requires level "+o+"!")}}a.toggleClass(n,"unaffordable",!wooga.castle.game.hasStat("gold",q));a.toggleClass(n,"population-maxed",m);if(m){n.setAttribute("title","Population is too high!")}},this)}}());(function(){var d=wooga.castle.utils,e=function(){return false},a=function(h,g){this.game=h;this.view=g;this.elements={goalButton:document.getElementById("hud-goals")};this.createHUD();this.initButtons();this.playerUpdateHandler();d.subscribe("game/ready",function(){setTimeout(function(){document.getElementById("ui").removeAttribute("style")},1000)},this);h.subscribe("player/update",this.playerUpdateHandler,this);h.subscribe("goal/subgoal-complete",this.subgoalCompleteHandler,this);h.subscribe("goal/subgoal-collected",this.subgoalCollectedHandler,this);h.subscribe("goal/new",this.addStarNotification,this);h.subscribe("goals/complete",this.handleGoalComplete,this);g.subscribe("goals/no-goals",this.handleNoGoals,this);this.initGoalsAttentionGrabber();h.subscribe("popup/info",this.popupHandler,this);if(wooga.castle.switches.cheatmode){this.createCheatHUD()}};a.prototype.createCheatHUD=function(){var h=this.elements.goalButton;var g=document.createElement("button");g.className="time_inc";g.innerHTML+="+1h";d.addTouchHandler(g,this.incTime,this);h.appendChild(g)};a.prototype.incTime=function(){var g=1000*60*60;this.game.entities.forEach(function(h){if(h.contract){if(h instanceof wooga.castle.House){if(h.contractStartTime){h.pauseContract();h.contractStartTime-=g;h.unpauseContract()}}if(h instanceof wooga.castle.FarmField){if(h.contractStartTime){h.contractStartTime-=g;h.checkContract()}}}},this)};a.prototype.createHUD=function(){this.goldElement=document.querySelector("#coins");this.foodElement=document.querySelector("#food .info");this.xpElement=document.querySelector("#level .info")};a.prototype.playerUpdateHandler=function(){var n=wooga.castle.playerData,h=wooga.castle.xp,o=this.xpElement,m=(h.xpToLevelUP()-h.xp)+" XP to Level "+(h.level+1),j=this.game.getPopulation(),k=j+(this.game.castle?"/"+this.game.castle.definition.population:""),g=(this.game.castle?j/this.game.castle.definition.population:1),p;this.goldElement.innerHTML=n.gold;if(this.foodElement.innerHTML.indexOf(String(n.food))===-1){this.foodElement.innerHTML="Food: "+n.food;if(n.food===0){p=0}else{p=Math.round((Math.log(n.food)*Math.log(n.food))*1.7);d.addClass(this.foodElement.parentNode,"active");var l=this;setTimeout(function(){d.removeClass(l.foodElement.parentNode,"active")},1)}if(p>100){p=100}document.querySelector("#food .progress").style.width=p+"%"}document.querySelector("#population .info").innerHTML="Current Population: "+j+"<br>Castle allows: "+(this.game.castle?this.game.castle.definition.population:"");document.querySelector("#population .progress").style.width=100+"%";document.querySelector("#population #ratio").innerHTML=k;if(o.innerHTML.indexOf(String(m))===-1){o.innerHTML=m;document.querySelector("#level .bar").title=h.level;document.querySelector("#level .progress").style.width=Math.round(100*(h.xp/h.xpToLevelUP()))+"%";d.addClass(o.parentNode,"active");setTimeout(function(){d.removeClass(o.parentNode,"active")},1)}};a.prototype.addGoalButtonNotif=function(g){};a.prototype.getGoalIcon=function(g){return this.elements.goalButton.querySelector('a[data-line-id="'+g+'"]')};a.prototype.handleNoGoals=function(g){this.elements.goalButton.style.display="none"};a.prototype.subgoalCompleteHandler=function(g){if(!g){return}this.addGoalNotification(this.getGoalIcon(g.line.line.id));this.shakeGoalIcon();return this};a.prototype.subgoalCollectedHandler=function(g){if(!g){return}this.removeGoalNotification(this.getGoalIcon(g.line.line.id));return this};a.prototype.addGoalNotification=function(j,g){if(j){if(!g){var h=j?parseInt(j.getAttribute("data-notif-count"),10):null;if(isNaN(h)){h=1}else{h++}g=h}j.setAttribute("data-notif-count",g)}return this};a.prototype.removeGoalNotification=function(h){if(h){var g=h?parseInt(h.getAttribute("data-notif-count"),10):null;if(!isNaN(g)){g--;if(0===g){h.removeAttribute("data-notif-count")}else{h.setAttribute("data-notif-count",g)}}}return this};a.prototype.addStarNotification=function(k){var h=this.getGoalIcon(k.line.line.id),g,j=function(l){if(g){window.clearTimeout(g)}if(d.hasClass(l.target,"goalIcon")){l.target.removeAttribute("data-notif-count");l.target.removeEventListener(wooga.castle.click_event_string,j,false)}};h.addEventListener(wooga.castle.click_event_string,j,false);g=setTimeout(d.bind(function(){this.addGoalNotification(h,"\u2605");this.shakeGoalIcon()},this),3000);return this};a.prototype.handleGoalComplete=function(g){};a.prototype.handleNewGoal=function(g){this.addGoalButtonNotif({text:"New Goal","class":"new-goal",line:g.line})};a.prototype.initButtons=function(){d.addTouchHandler(document.querySelector("#showShopButton"),function(){if(d.can("enter-shop")){this.view.publish("shop/show")}},this);d.addTouchHandler(document.querySelector("#showCursorButton"),function(){if(d.can("enter-roads")){this.view.publish("roadsMode/set")}},this)};a.prototype.popupHandler=function(g){var h=this;wooga.castle.net.get(wooga.castle.utils.urlFor(g.url)).addCallback(function(j){h.showPopup(g,j,false)})};a.prototype.showPopup=function(h,g,l){var j=g.data;var k=function(n){var m=document.createElement("div");m.innerHTML=j;m.querySelector("p").innerHTML=h.text;m.querySelector(".share").addEventListener(wooga.castle.capabilities.touch?"touchend":"click",function(o){o.preventDefault();wooga.castle.Overlay.hide();m.style.display="none";if(m.parentNode){m.parentNode.removeChild(m)}if(l){window.location.reload()}},false);wooga.castle.Overlay.show();document.body.appendChild(m)};k.call(this)};a.prototype.hide=function(){d.addClass(document.querySelector("#ui"),"hide")};a.prototype.show=function(){d.removeClass(document.querySelector("#ui"),"hide")};a.prototype.initGoalsAttentionGrabber=function(){var h=d.bind(this.shakeGoalIcon,this);var g;var j=d.bind(function(k){clearTimeout(g);d.removeClass(this.elements.goalButton,"shake");g=setTimeout(h,a.GOALS_ATTENTION_GRABBER_TIMEOUT)},this);this.elements.goalButton.addEventListener("webkitAnimationEnd",j,false);this.elements.goalButton.addEventListener("click",j,false);g=setTimeout(h,a.GOALS_ATTENTION_GRABBER_TIMEOUT)};a.prototype.shakeGoalIcon=function(){this.getShakerFunction(this.elements.goalButton)();return this};a.prototype.getShakerFunction=function(g){return function(){wooga.castle.utils.addClass(g,"shake")}};a.GOALS_ATTENTION_GRABBER_TIMEOUT=3*60*1000;var c=function(){if(c._instance){return}var g=document.getElementById("#enforce-modal");if(!g){g=document.createElement("div");g.id="enforce-modal";d.addClass(g,"hidden");document.body.appendChild(g)}this.overlay=g;c._instance=this};c.instance=function(){return(c._instance||new c())};c.get=function(){return c.instance().overlay};c.show=function(){if(d.can("show-overlay")){d.removeClass(c.get(),"hidden");d.can("show-overlay",e)}return c};c.hide=function(){d.addClass(c.get(),"hidden");d.can.remove("show-overlay",e);return c};wooga.castle.Overlay=c;var f=function(){if(f._instance){return}var g=document.getElementById("enforce-urlBarRemove");if(!g){g=document.createElement("div");g.id="enforce-urlBarRemove";d.addClass(g,"hidden");document.body.appendChild(g)}this.overlayUrlBar=g;f._instance=this};f.instance=function(){return(f._instance||new f())};f.get=function(){return f.instance().overlayUrlBar};f.show=function(){d.removeClass(f.get(),"hidden");return f};f.hide=function(){d.addClass(f.get(),"hidden");return f};wooga.castle.OverlayUrlBar=f;var b=function(){var g=document.querySelector("#uiblocker");if(!g){g=document.createElement("div");g.id="uiblocker";d.addClass(g,"hidden");document.body.appendChild(g)}this.spinner=(function(h){var j=h.querySelector(".spinner");if(!j){j=document.createElement("div");j.className="spinner";h.appendChild(j)}return j}(g));this.blocker=g};b.prototype.show=function(){d.removeClass(this.blocker,"hidden")};b.prototype.hide=function(){d.addClass(this.blocker,"hidden")};a.UIBlocker=b;document.addEventListener("DOMContentLoaded",function(){wooga.castle.UIBlocker=new b()},false);wooga.castle.HUD=a}());(function(){var a=wooga.castle.utils,f=function(g,j){if(!g){return}this.view=g;this.rootNode=document.createElement("div");this.rootNode.id="doobers";g.rootNode.appendChild(this.rootNode);var h=wooga.castle.Game.instance();this.view.subscribe("entity/contract/collecting",function(k){this.createAnim({entityView:k.entityView,text:k.text,callback:k.callback})},this);h.subscribe("contract/collect",function(l){var k=l.entity.definition["class"]==="farm"?["contracts/food","food"]:["contracts/gold","coins"];l.feedback=k;this.showFeedback(a.extend({amount:l.entity.contractValue},l)).showXPFeedback(l)},this);h.subscribe("entity/destroy",function(k){k.rewards.forEach(function(l){this.showFeedback(a.extend({amount:l.amount,feedback:this.getFeedbackSettings(l.type)},k))},this);return},this);h.subscribe("castle/upgrade",function(k){this.castleUpgradeTransition(k.entityView);this.createAnim({entityView:k.entityView,text:k.text})},this);wooga.castle.subscribe("game/drain-gold",function(k){wooga.castle.DooberTooltip.get("coins").add(-k.amount);if(!k.entityView){return}this.supply(k.entityView,{icon:"contracts/gold",type:"coins"})},this);wooga.castle.subscribe("game/drain-food",function(k){wooga.castle.DooberTooltip.get("food").add(-k.amount)});this.view.subscribe("entity/whacking",function(k){this.createAnim(k)},this);h.subscribe("enemy/collectReward",function(m){m.entityView=this.view.entitiesViews[m.entity.id];var n=m.rewards,l;for(l=0;l<n.length;++l){if("xp"===n[l].type){this.showXPFeedback(m)}if("gold"===n[l].type){var k=["contracts/gold","coins"];m.feedback=k;m.amount=n[l].amount;this.showFeedback(m)}}},this);h.subscribe("house/throwOutKey",function(l){var k=["unlock/key","lock"];l.feedback=k;l.destination="#"+l.destination+" header";l.amount=1;this.showItemFeedback(l);delete l.amount},this);h.subscribe("goals/collectReward",function(m){var n=m.rewards,l;for(l=0;l<n.length;++l){if("gold"===n[l].type){var k=["contracts/gold","gold-in-goal-sceen"];m.feedback=k;m.amount=n[l].amount;this.showFeedback(m)}}},this);h.subscribe("contract/start",function(k){if(k.entity.contract.requiredFood){this.foodSupply(k.entity.entityView)}},this);h.subscribe("entity/whack-rewards",function(k){var l=a.extend({},k);l.entityView=k.entity.entityView;if(!l.entityView){return}k.rewards.forEach(function(m){this.showFeedback(a.extend({amount:m.amount,feedback:this.getFeedbackSettings(m.type)},l))},this)},this);this.view.subscribe("ship/upgrading",function(k){this.createAnim({entityView:k.entityView,text:k.text,callback:k.callback})},this);a.subscribe("house/drop",function(l){var k=[l.item,"lock"];l.feedback=k;l.destination="#game_overlay .ship.actionIcon";l.amount=1;this.showItemFeedback(l);delete l.amount},this)};f.prototype.castleUpgradeTransition=function(m){var q=document.createElement("div"),g=q.style,p=this.view,h=p.gridUnit,r=p.game.entitiesDefinition["buildings/castle_construction"],j=m.getImageFrameForDefinition(r),k=document.getElementById("game_overlay"),o,l;q.className="feedback_anim ";var n=r.image.cloneNode();q.appendChild(n);o=m.y;l=m.x;g.webkitTransform="translate3d("+(l)+"px,"+(o)+"px,0)";k.appendChild(q);setTimeout(function(){g.opacity=0;a.removeOnAnimationEnd(q)},10)};f.prototype.getFeedbackSettings=function(h){var g=[];switch(h){case"gold":g=["contracts/gold","coins"];break;case"food":g=["contracts/food","food"];break;case"xp":g=["contracts/level","level"];break}return g};f.prototype.createAnim=function(j){var n=this,m=j.entityView,l=document.createElement("div"),g=document.createElement("div"),h=document.createElement("div"),k=document.getElementById("game_overlay"),p=this.view;l.className="anim";g.className="text";h.className="progress";g.innerHTML=j.text;l.style.left=m.x+m.width/2+"px";l.style.top=m.y+"px";l.appendChild(g);l.appendChild(h);k.appendChild(l);l.addEventListener("webkitAnimationEnd",function o(q){if(q.target===l){l.removeEventListener("webkitAnimationEnd",o,false);k.removeChild(l);if(typeof j.callback==="function"){j.callback()}}},false);return l};f.prototype.showFeedback=function(x){var h=document.createElement("div"),n=this.view,w=this.rootNode,l=n.gridUnit,t=document.querySelector("#"+x.feedback[1]),o=n.game.entitiesDefinition[x.feedback[0]],k=this.figureAmount(x),g=x.entityView,u=h.style,p,j,v;if(k){h.className="feedback_anim to_"+x.feedback[1];h.appendChild(o.image.cloneNode());v=document.createTextNode(k);h.appendChild((function(){var z=document.createElement("span");z.innerText="+";return z}()));h.appendChild(v);var y=wooga.castle.game.playerData.map;var q=(typeof g!=="undefined")?g.y:(x.top+x.height/2);var m=(typeof g!=="undefined")?g.x:(x.left+x.width/2);var s=(typeof g!=="undefined")?g.width:0;var r=(typeof g!=="undefined")?g.height:0;p=(n.scrollTop+q+(r*0.5))-0.5*o.height*l;j=((n.scrollLeft+m+(s*0.5))-0.5*o.width*l);u.top=u.left=0;u.webkitTransform="translate3d("+(j)+"px,"+(p)+"px,0)";w.appendChild(h);setTimeout(function(){u.webkitTransform="translate3d("+(t.offsetLeft+10)+"px,"+(t.offsetTop)+"px,0)";a.removeOnAnimationEnd(h,function(){wooga.castle.DooberTooltip.get(x.feedback[1]).add(k)})},1)}return this};var b="@-webkit-keyframes {oName} {\n0%   { -webkit-transform: translateX(0); }\n100% { -webkit-transform: translateX({oEnd}px); }\n}";var e="@-webkit-keyframes {iName} {\n0%   { -webkit-transform: translateY(0); }\n50%  { -webkit-transform: translateY({iMid}px); }\n100% { -webkit-transform: translateY({iEnd}px); }\n}";var c=3000;var d={coins:{oEnd:-50,iMid:-50,iEnd:50},level:{oEnd:60,iMid:-50,iEnd:35},food:{oEnd:70,iMid:-125,iEnd:40},lock:{oEnd:70,iMid:-125,iEnd:40}};[b,e].forEach(function(g){Object.keys(d).forEach(function(h){var j=g.replace(/\{\w+\}/g,function(k){switch(k){case"{oName}":return h+"OuterAnimation";case"{iName}":return h+"InnerAnimation";default:return d[h][k.slice(1,-1)]}});document.styleSheets[0].insertRule(j,0)})});f.prototype.showItemFeedback=function(k){var r=document.createElement("div"),u=this.view,l=document.getElementById("game_overlay"),h=u.gridUnit,v=document.querySelector(k.destination),j=u.game.entitiesDefinition[k.feedback[0]],p=this.figureAmount(k),o=k.entityView,g=r.style,t,m,q,n=false;r.className="feedbacker to_"+k.feedback[1];r.appendChild(j.image.cloneNode());t=(o.y+(o.height*0.5))-0.5*j.height*h;m=(o.x+(o.width*0.5))-0.5*j.width*h;g.top=t+"px";g.left=m+"px";r.style.webkitTransform="translate3d(0px,0px,0)";setTimeout(function(){var w=d[k.feedback[1]];r.style.webkitTransform="translate3d("+w.oEnd+"px,"+w.iEnd+"px,0)"},50);var s=function(){if(!n){n=true;var x=a.offset(v);var w="translate3d("+(-(r.offsetLeft-x.left)+v.offsetWidth-58)+"px,"+(-(r.offsetTop-x.top))+"px,0)";g.webkitTransition="3s, opacity 2s 1s";g.webkitTransform=w;g.opacity=1;r.addEventListener("webkitTransitionEnd",function(y){if(r.parentNode){r.parentNode.removeChild(r);wooga.castle.game.publish("unlockable/keyTouch",{})}},false)}};a.addTouchHandler(r,function(){s()});l.appendChild(r);k.element=r;k.element._click=s;return this};f.prototype.figureAmount=function(g){var h=false;if(g.feedback){h=g.feedback[0].split("/").pop();if("level"===h){h="XP"}}return parseInt(g.amount||(g.contract?g.contract["provided"+h.charAt(0).toUpperCase()+h.slice(1)]:1),10)};f.prototype.foodSupply=function(g){return this.supply(g,{icon:"contracts/food",type:"food"})};f.prototype.supply=function(n,l){var o=document.createElement("div"),g=o.style,q=this.view,h=q.gridUnit,r=document.querySelector("#"+l.type),j=q.game.entitiesDefinition[l.icon],k=this.rootNode,p,m;o.className="feedback_anim "+l.type+"ie";o.appendChild(j.image.cloneNode());g.top=g.left=0;g.webkitTransform="translate3d("+(r.offsetLeft+10)+"px,"+(r.offsetTop)+"px,0)";k.appendChild(o);setTimeout(function(){p=(q.scrollTop+n.y+(n.height*0.5));m=((q.scrollLeft+n.x+(n.width*0.5))-0.5*j.width*h);g.webkitTransform="translate3d("+(m)+"px,"+(p)+"px,0)";g.opacity=1;a.removeOnAnimationEnd(o)},1)};f.prototype.showXPFeedback=function(g){return this.showFeedback({entityView:g.entityView,contract:g.contract,amount:g.amount,feedback:["contracts/level","level"]})};wooga.castle.AnimsFactory=f}());(function(){var a=wooga.castle.utils;a.formatTime=function(f){var e,b,c,g;if(f<=0){return"0:00"}else{e=Math.floor(f/1000);if(e<60){if(e<10){e="0"+e}return"0:"+e}else{b=Math.floor(e/60);e=e%60;if(e<10){e="0"+e}if(b<60){return b+":"+e}else{c=Math.floor(b/60);b=b%60;if(b<10){b="0"+b}return c+":"+b+":"+e}}}};a.roundTime=function(f){var e,b,c,g;if(f<=0){return"0sec."}else{e=Math.floor(f/1000);if(e<60){return e+"&thinsp;sec."}else{b=Math.floor(e/60);if(b<60){return b+"&thinsp;min."}else{c=Math.floor(b/60);if(c<24){return c+"h"}else{g=Math.floor(c/24);return g+"days"}}}}}}());(function(){var b=wooga.castle.utils;var a;wooga.castle.InfoMode=function(e,d){this.manager=e;this.parentNode=d.rootNode;this.build()};var c=wooga.castle.InfoMode;c.prototype.build=function(){var d=document.createElement("div");d.className="inPlace-info";this.closeButton=document.createElement("button");this.closeButton.className="close";d.appendChild(this.closeButton);this.infoPanel=document.createElement("div");this.infoPanel.className="info";d.appendChild(this.infoPanel);this.menu=document.createElement("div");this.menu.className="menu";d.appendChild(this.menu);b.publish("view:hud/infomode-opened");b.addTouchHandler(this.closeButton,this.deactivate,this);document.getElementById("game_overlay").appendChild(d);this.rootNode=d};c.prototype.activate=function(e){this.target=e.target;var d=this.target.entity;if(d.is("castle")&&wooga.castle.playerData.upgradingCastle){wooga.castle.CastleCompleteScreen.instance().show();this.deactivate();this.manager.setMode(wooga.castle.GameModesManager.Mode.BASIC);return}if(d.is("decoration")){this.target.makeDynamic()}this.infoPanel.innerHTML="<h1>"+d.getProperName()+"</h1><div class=specification>"+d.getInfoModeString()+"</div>";this.manager.view.isFocusedEntityView=function(f){return f===e.target};if(d.contractState===wooga.castle.House.ContractState.STARTED){this.showProgressBar(d.contractStartTime,d.contract.requiredTime)}else{if(d.contractState===wooga.castle.House.ContractState.CONSTRUCTION){this.showProgressBar(d.constructionStartTime,d.contract.constructionTime)}}b.publish("view:entity/focused",{entity:d,entityView:d.entityView,infoMode:this});this.showBoosts(d);this.show()};c.prototype.showProgressBar=function(d,f){var e=document.querySelector(".progress div"),g=document.getElementById("timeLeft");e.style.width=Math.floor(((Date.now()-d)/f)*100)+"%";a=setInterval(function(){var h=Date.now()-d;if((h/f)>=1){clearInterval(a)}g.innerHTML=b.formatTime(f-h);e.style.width=Math.floor((h/f)*100)+"%"},1000)};c.prototype.showBoosts=function(d){if(d.is("decoration")){d.game.publish("decoration/showBoost",{entityView:d.entityView,x:d.x,y:d.y})}if(d.is("farm")||d.is("any house")){if(d.boost){d.entityView.showBoostInfo=true}}};c.prototype.deactivate=function(){this.manager.view.isFocusedEntityView=this.manager.view.isFocusedEntityViewDefault;if(this.target.entity.is("decoration")){this.target.makeStatic()}this.menu.innerHTML="";clearInterval(a);if(this.target.actionsMenu){this.target.actionsMenu.destructor()}if(this.target instanceof wooga.castle.DecorationView){this.target.entity.game.publish("decoration/hideBoost",{entityView:this.target})}if(this.target instanceof wooga.castle.FarmFieldView||this.target instanceof wooga.castle.HouseView){if(this.target.entity.boost){this.target.entity.entityView.showBoostInfo=false;this.target.entity.entityView.makeStatic()}}this.hide();this.manager.setMode(wooga.castle.GameModesManager.Mode.BASIC);b.publish("view:hud/infomode-closed")};c.prototype.position=function(){var h=this.rootNode.style,d=this.target,k=d.y,j=Math.min(this.manager.view.mapWidthPx-160,Math.max(d.x+d.width*0.5,160)),f=d.view.gridUnit,e=false;if(d.entity.is("castle")){k=k+70}if(d.y<600){k+=d.height;e=true}b.toggleClass(this.rootNode,"reversed",e);if(d.entity.is("decoration")){var g=k+(d.entity.definition.influenceArea*f*(e?1:-1));h.webkitTransform="translate3d("+j+"px, "+g+"px, 0)"}else{h.webkitTransform="translate3d("+j+"px, "+k+"px, 0)"}};c.prototype.show=function(){this.position();this.rootNode.style.display="block"};c.prototype.hide=function(){this.rootNode.style.display="none"};c.prototype.handle=function(d,e){switch(d){case"move":this.deactivate();this.manager.setMode(wooga.castle.GameModesManager.Mode.MOVE,{target:this.target});break;case"destroy":this.deactivate();this.manager.setMode(wooga.castle.GameModesManager.Mode.DESTROY,{target:this.target});break;case"upgrade":this.deactivate();this.manager.setMode(wooga.castle.GameModesManager.Mode.CASTLE_UPGRADE,{target:this.target});break;default:wooga.log(d+" is unhandled");break}}}());(function(){var a=wooga.castle.utils,b=function(){return false};wooga.castle.MoveMode=function(e,d){this.manager=e;this.parentNode=d.rootNode;this.build()};var c=wooga.castle.MoveMode;c.prototype.build=function(){var d=document.createElement("div");d.className="hud_mode move";this.infoPanel=document.createElement("div");this.infoPanel.className="infoPanel";d.appendChild(this.infoPanel);this.infoPanel.innerHTML='<div class="specification"><h6>Drag <span class=entityclass></span></h6><p>Use your finger to choose the position, then press Accept</p></div>';this.closeButton=document.createElement("button");this.closeButton.className="close";d.appendChild(this.closeButton);a.addTouchHandler(this.closeButton,this.cancel,this);this.parentNode.appendChild(d);this.rootNode=d};c.prototype.handle=function(d,e){if("confirm"===d){this.confirm()}else{if("cancel"===d){this.cancel()}}};c.prototype.worldTouchListener=function(d){if(d.stopPropagation||this.locked){return false}this.target.beforeMove();this.target.moveTo(d,false);this.target.moved();this.onDragEnd()};c.prototype.activate=function(d){var e=d.target;this.target=e;this.manager.view.isFocusedEntityView=function(f){return f===e};a.can("touch-entity",b);a.can("entity/contract/change",b);this.infoPanel.querySelector(".entityclass").innerHTML=e.entity.getCallableName();this.manager.view.addEventHandler("touch",this.worldTouchListener,this);e.isDraggable=true;e.makeDynamic();this.targetStartX=e.x;this.targetStartY=e.y;e.actionsMenu=new wooga.castle.InPlaceActionsMenu(e,{actions:{cancel:true,confirm:true}},this);e.addEventHandler("dragend",this.onDragEnd,this);e.addEventHandler("touch",this.onTouch,this);this.onDragEnd();this.show();this.locked=false;this.manager.game.publish("moveMode/activated",this)};c.prototype.deactivate=function(){a.can.remove("entity/contract/change",b);a.can.remove("touch-entity",b);this.manager.view.isFocusedEntityView=this.manager.view.isFocusedEntityViewDefault;this.target.removeEventHandler("dragend",this.onDragEnd,this);this.target.removeEventHandler("touch",this.onTouch,this);this.manager.view.removeEventHandler("touch",this.worldTouchListener,this);this.target.isDraggable=false;this.target.makeStatic();if(this.target.actionsMenu){this.target.actionsMenu.destructor()}if(this.target instanceof wooga.castle.DecorationView){this.target.entity.game.publish("decoration/hideBoost",{entityView:this.target})}this.target=null;this.locked=false;this.hide();this.manager.setMode(wooga.castle.GameModesManager.Mode.BASIC);this.manager.game.publish("moveMode/deactivated",this)};c.prototype.onTouch=function(d){if(d.stopPropagation||this.locked){return false}d.stopPropagation=true;if(!this.target.isColliding()){this.locked=true;setTimeout(a.bind(this.confirm,this),100)}};c.prototype.show=function(){this.rootNode.style.display="block"};c.prototype.hide=function(){this.rootNode.style.display="none"};c.prototype.confirm=function(){var e=this.target;var d=this.manager.view.gridUnit;if((e.x!==this.targetStartX)||(e.y!==this.targetStartY)){e.moved();e.entity.move({x:e.entity.x+(e.x-this.targetStartX)/d,y:e.entity.y+(e.y-this.targetStartY)/d});if(e.entity.fireEvent){e.entity.fireEvent("entity/moved")}}this.deactivate()};c.prototype.cancel=function(){if(this.locked){return false}this.manager.view.removeFromHitmap(this.target);this.target.x=this.targetStartX;this.target.y=this.targetStartY;this.manager.view.addToHitmap(this.target);this.target.moved();this.deactivate()};c.prototype.onDragEnd=function(){var d=this.target;a.publish("view:entity/ensureVisible",d);var e=d.isColliding();d.actionsMenu.setActionEnabled("confirm",!e)};a.can("move-entity",function(d){return d.definition["class"]!=="castle"})}());(function(){var b=wooga.castle.utils,c=b.disabler;wooga.castle.ShopPreviewMode=function(e,d){this.manager=e;this.parentNode=d.rootNode;this._build()};var a=wooga.castle.ShopPreviewMode;b["extends"](a,wooga.castle.MoveMode);a.prototype._build=function(){var d=document.createElement("div");d.className="hud_mode shop";this.infoPanel=document.createElement("div");this.infoPanel.className="infoPanel";d.appendChild(this.infoPanel);var e=this.entity;this.infoPanel.innerHTML='<button class="close"></button><div class="specification"><h6>Place Your New <span></span></h6><p>Use finger to choose position, <br>then press Accept.</p></div>';this.closeButton=document.createElement("button");this.closeButton.className="close";b.addTouchHandler(this.closeButton,this.cancel,this);d.appendChild(this.closeButton);this.parentNode.appendChild(d);this.rootNode=d};a.prototype.activate=function(h){var d=this.manager.view.getCenterCoordinates();var g={center:d};this.manager.view.publish("shop/get preview center",g);d=g.center;var f=this.manager.game.createEntity({key:h.entityName,x:d.x,y:d.y,preview:true});var e=this.manager.view.createEntityView(f);e.isDraggable=true;this.manager.view.isFocusedEntityView=function(k){return k===e};this.entity=f;this.entityView=e;var j=f.getCallableName();j=j[0].toUpperCase()+j.slice(1);this.infoPanel.querySelector("h6 span").innerHTML=j;e.actionsMenu=new wooga.castle.InPlaceActionsMenu(e,{actions:{cancel:true,confirm:true}},this);e.addEventHandler("dragend",this.onDragEnd,this);e.addEventHandler("touch",this.onTouch,this);e.view.addEventHandler("touch",this.worldTouchListener,this);this.target=this.entityView;this.onDragEnd();this.show();this.locked=false;this.manager.game.publish("shopPreviewMode/activated",this);this.entity.game.publish("decoration/showBoost",{entityView:e,x:d.x,y:d.y});b.can("touch-entity",c);b.can("entity/contract/change",c)};a.prototype.deactivate=function(){this.manager.view.isFocusedEntityView=this.manager.view.isFocusedEntityViewDefault;this.entityView.isDraggable=false;this.entityView.removeEventHandler("dragend",this.onDragEnd,this);this.entityView.removeEventHandler("touch",this.onTouch,this);this.entityView.view.removeEventHandler("touch",this.worldTouchListener,this);if(this.entityView.actionsMenu){this.entityView.actionsMenu.destructor()}if(this.entityView instanceof wooga.castle.DecorationView){this.entityView.entity.game.publish("decoration/hideBoost",{entityView:this.entityView})}this.hide();this.locked=false;this.manager.setMode(wooga.castle.GameModesManager.Mode.BASIC);this.manager.game.publish("shopPreviewMode/deactivated",this);b.can.remove("touch-entity",c);b.can.remove("entity/contract/change",c)};a.prototype.confirm=function(){if(this.entityView.isColliding()){return}var d=this.manager.view,f=this.entityView.x/d.gridUnit-d.mapWidth/2,e=this.entityView.y/d.gridUnit-this.entity.definition.offsetY-d.mapHeight/2;this.mapX=f;this.mapY=e;delete this._action;if(!b.can("shoppreviewmode/accept",this)){return}this.deactivate();d.bufferCanvasChanges.push(this.entityView);this.entity.buy({x:f,y:e});if(this.entity.is("farm")&&this.manager.game.hasStat("gold",this.entity.definition.goldCost)){var g={entityName:this.entity.key};b.publish("view:shop/preview",g)}};a.prototype.cancel=function(){if(!b.can("shoppreviewmode/cancel",this)){delete this._action;return}this.deactivate();this.manager.view.removeEntityView(this.entityView);this.manager.game.removeEntity(this.entity)};a.prototype.onDragEnd=function(){this.parent.prototype.onDragEnd.call(this);this.entityView.actionsMenu.setActionEnabled("cancel",b.can("shoppreviewmode/cancel",this))}}());(function(){var a=wooga.castle.utils;wooga.castle.SeedMode=function(d,c){this.manager=d;this.parentNode=c.rootNode;this._build()};var b=wooga.castle.SeedMode;b.IMAGES_BASE_URL=wooga.castle.IMAGES_BASE_URL;b.prototype._build=function(){var c=document.createElement("div");c.className="hud_mode seed";this.infoPanel=document.createElement("div");this.infoPanel.className="infoPanel";c.appendChild(this.infoPanel);this.infoPanel.innerHTML='<div class="specification plant"><p>Touch Empty Farm Plot <br>to plant seed</p><i class="gold"></i></div>';this.seedImage=document.createElement("img");this.infoPanel.appendChild(this.seedImage);this.closeButton=document.createElement("button");this.closeButton.className="close";c.appendChild(this.closeButton);a.addTouchHandler(this.closeButton,this.deactivate,this);this.parentNode.appendChild(c);this.rootNode=c};b.prototype.touchHandler=function(c){if(c.target instanceof wooga.castle.FarmFieldView&&(c.target.entity.contractState===wooga.castle.FarmField.ContractState.IDLE)){if(this.manager.game.hasStat("gold",this.manager.game.entitiesDefinition[this.seedName].contract.requiredGold)){this.activateContract(c.target.entity);wooga.castle.publish("gold/drain",{entityView:c.target,text:"- "+this.manager.game.entitiesDefinition[this.seedName].contract.requiredGold+" gold"})}else{wooga.castle.publish("game/not-enough-gold",{entityView:c.target,text:"Not enough gold!"})}this.invalidate()}else{this.deactivate()}};b.prototype.activateContract=function(d){d.activateContract(this.seedName);var c=wooga.castle.Entity.findEntityDefinitionByPath(this.manager.game,this.seedName);this.invalidate();d.startContract();var e=this.manager.game.entities.filter(function(f){if(f instanceof wooga.castle.FarmField){if(f.contractState===wooga.castle.FarmField.ContractState.IDLE){return true}}return false},this);if(e.length===0){this.invalidate();this.deactivate()}};b.prototype.activate=function(c){this.seedName=c.entityName;this.seedImage.setAttribute("src",a.urlFor(b.IMAGES_BASE_URL+this.manager.game.entitiesDefinition[this.seedName].icon));this.manager.view.addEventHandler("touch",this.touchHandler,this);this.show();if(c.targetFarmField){this.activateContract(c.targetFarmField);wooga.castle.publish("gold/drain",{entityView:c.targetFarmField.entityView,text:"- "+this.manager.game.entitiesDefinition[this.seedName].contract.requiredGold+" gold"})}this.invalidate()};b.prototype.invalidate=function(){this.infoPanel.querySelector(".specification .gold").innerHTML=wooga.castle.playerData.gold};b.prototype.deactivate=function(){this.manager.view.removeEventHandler("touch",this.touchHandler,this);this.manager.game.publish("seedMode/deactivated",this);this.hide();this.manager.setMode(wooga.castle.GameModesManager.Mode.BASIC)};b.prototype.show=function(){this.invalidate();this.rootNode.style.display="block"};b.prototype.hide=function(){this.rootNode.style.display="none"}}());(function(){var b=wooga.castle.utils;wooga.castle.RoadsMode=function(g,f){this.manager=g;this.parentNode=f.rootNode;this._build();var h=this;g.game.subscribe("game/init",function(){h.updateConnections(true)});g.game.subscribe("entity/move",function(){h.updateConnections(false)});g.game.subscribe("entity/buy",function(){h.updateConnections(false)})};var c=wooga.castle.RoadsMode;c.prototype._build=function(){var f=document.createElement("div");f.className="hud_mode roads";this.infoPanel=document.createElement("div");this.infoPanel.className="infoPanel";this.infoPanel.innerHTML='<div class="specification"><h6>Edit Roads</h6><p>Tap to place roads for FREE, tap again to remove them.</p></div>';f.appendChild(this.infoPanel);this.closeButton=document.createElement("button");this.closeButton.className="close";f.appendChild(this.closeButton);b.addTouchHandler(this.closeButton,this.deactivate,this);this.parentNode.appendChild(f);this.rootNode=f};var a=function(f){return f.is("path")};var d=function(f){return f.is("any house")};c.prototype.tracePath=function(q,n,l,g,h,j){var o=this.manager.game.gridMap;if(o[l]&&o[l][n]){var p=o[l][n];var f=p.filter(a)[0];if(p.dirtyFlag!==g){p.dirtyFlag=g;if(f){var m=0;if(this.tracePath(q,n,l-1,g,h,j)){m+=1}if(this.tracePath(q,n+1,l,g,h,j)){m+=2}if(this.tracePath(q,n,l+1,g,h,j)){m+=4}if(this.tracePath(q,n-1,l,g,h,j)){m+=8}this.manager.view.entitiesViews[f.id].setRoadType(m);q.splice(q.indexOf(f),1)}else{if(h){var k=p.filter(d)[0];if(k){k.connect(j)}}}}return !!f}else{return false}};c.getRoadRootPosition=function(f){return{x:f.x+f.definition.rootRoadPosition.x,y:f.y+f.definition.rootRoadPosition.y}};c.prototype.updateConnections=function(k){var g=this.manager.game;var h=g.entities.filter(d);h.forEach(function(m){m.resetConnection()});var l=g.entities.filter(a);var j=c.getRoadRootPosition(g.castle);var f=true;do{this.tracePath(l,j.x,j.y,Math.random(),f,k);j=l[0];f=false}while(l.length);h.forEach(function(m){if(!m.connected){m.disconnect(k)}})};c.prototype.checkForDisconnected=function(){if(this.manager.game.playerData.doneTutorial){this.setDisconnectedRoadNotification(this.manager.game.entities.filter(function(f){return d(f)&&!f.connected}).length>0)}};var e;c.prototype.setDisconnectedRoadNotification=function(f){if(f){if(!e){e=document.querySelector(".no_road_notification");if(!e){return}e.addEventListener("webkitAnimationEnd",function(h){var g=h.target;g.style.webkitAnimationDuration=g.style.webkitAnimationName==="bounce, ine"?".5s, 5s":".5s, 20s";g.style.webkitAnimationName=g.style.webkitAnimationName==="bounce, ine"?"bounce, oute":"bounce, ine"},false)}e.style.display="block"}else{if(e){e.style.display="none"}}};c.prototype.activate=function(f){if(this.rootNode.style.display==="block"){return}this.manager.view.enableRendering();this.manager.view.isFocusedEntityView=function(g){return !g||(g.entity.definition["class"]==="path")};this.manager.view.addEventHandler("touch",this.touchHandler,this);this.show()};c.prototype.deactivate=function(){if(!b.can("leave-roads")){return}this.manager.view.stopRendering();this.manager.view.isFocusedEntityView=this.manager.view.isFocusedEntityViewDefault;this.manager.view.removeEventHandler("touch",this.touchHandler,this);this.hide();this.manager.view.publish("roads/accept");this.manager.setMode(wooga.castle.GameModesManager.Mode.BASIC)};c.prototype.show=function(){this.rootNode.style.display="block"};c.prototype.hide=function(){this.rootNode.style.display="none"};c.prototype.touchHandler=function(f){var m=this.manager.view,g=m.gridUnit;var o=f.x-m.scrollLeft;o-=o%g;var l=f.y-m.scrollTop;l-=l%g;var h=this.getReducedHits(o,l),n=this.manager.view.clientXYtoWorldXY(f),j=false,k;if(h.length===0){k={x:n.x,y:n.y,width:1,height:1};if(!this.manager.game.testCollisions(k,null)){this.addRoad(n)}else{j=true}}else{var p=h.filter(function(r){return r.entity.definition["class"]==="path"})[0];if(p){if(!this.isRootRoad(p.entity)){this.removeRoad(p.entity,p)}else{b.publish("view:root-road-tap",{entityView:p})}}else{j=true}}if(j){var q={entityView:{x:o,y:l,width:g}};b.publish("game:road/cant-place-here",q)}};c.prototype.isRootRoad=function(f){var g=this.getCastleRootPosition();return f.x===g.x&&f.y===g.y};c.prototype.getCastleRootPosition=function(){var f=this.manager.game.castle;return{x:f.x+f.definition.rootRoadPosition.x,y:f.y+f.definition.rootRoadPosition.y}};c.prototype.addRoad=function(f){var j={key:"paths/road",x:f.x,y:f.y},h,g;if(!b.can("add-road",j)){return}h=this.manager.game.createEntity(j);g=this.manager.view.createEntityView(h);this.manager.game.publish("road/add",g);this.updateConnections(false)};c.prototype.removeRoad=function(g,f){if(!b.can("remove-road",f)){return}this.manager.view.removeEntityView(f);this.manager.game.removeEntity(g);this.manager.game.publish("road/remove",f);this.updateConnections(false)};c.prototype.getReducedHits=function(f,g){return this.manager.view.hitMap[g][f].filter(function(h){var l=false;var k=0,j=0;if("undefined"!==typeof h.entity.definition.xOffsetLeft){k+=h.entity.definition.xOffsetLeft}if("undefined"!==typeof h.entity.definition.xOffsetRight){j+=h.entity.definition.xOffsetRight}if((f-h.x>=k*this.manager.view.gridUnit)&&(f-h.x<=j*this.manager.view.gridUnit)){l=true}return(l&&(g-h.y>=-h.entity.definition.offsetY*this.manager.view.gridUnit))},this)}}());(function(){var h=wooga.castle,c=wooga.castle.utils,f=wooga.castle.l10n,d=function(){return false},a=function(k,j){this.manager=k;this.parentNode=j.rootNode;this.build()},g=null,b,e;a.prototype.build=function(){var l=document.createElement("div"),n=document.createElement("div");var k=document.createElement("button");c.addClass(l,"hud_mode castle_upgrade");n.className="infoPanel";n.innerHTML='<p class="specification"></p><div class="menu"></div>';l.appendChild(n);this.rootNode=l;this.infoPanel=n;document.getElementById("game_overlay").appendChild(l);var p=c.bind(function(q){q.preventDefault();if(c.hasClass(q.target,"disabled")){return}var r=q.target.getAttribute("data-actionname");if(this.handle){this.handle(r,this)}},this);var o={cancel:true,confirm:true};var m;for(m in o){if(o.hasOwnProperty(m)){var j=document.createElement("a");j.className=m;j.setAttribute("href","#");j.innerHTML=m;j.setAttribute("data-actionname",m);c.addClass(j,"action "+m);j.addEventListener("click",p,false);this.infoPanel.querySelector(".menu").appendChild(j)}}this.game=wooga.castle.Game.instance()};a.prototype.handle=function(j,k){if("confirm"===j){if(wooga.castle.Game.instance().drain("gold",this.target.entity.definition.upgradeCost,this.target)){this.confirm()}}else{if("cancel"===j){this.cancel()}}};a.prototype.activate=function(m){var o=m.target,l,j,k,n=true;this.target=o;if(!c.can("upgrade-castle",o)){return}this.manager.view.isFocusedEntityView=function(p){return p===o};if(o.entity.definition.unlockCondition==="level"){k=o.entity.definition.unlockValue;if(wooga.castle.playerData.level<k){j=this.infoPanel.querySelector(".specification p");j.innerHTML="Upgrading requires level <strong>"+k+"</strong>.";this.infoPanel.querySelector(".specification .gold").innerHTML=this.game.playerData.gold;n=false}}if(n===true){l=o.entity.definition.upgradeCost;j=this.infoPanel.querySelector("p.specification");j.innerHTML="Upgrade your castle for <strong>"+l+"</strong> coins."}o.makeDynamic();c.can("touch-entity",d);c.can("entity/contract/change",d);this.show();c.publish("view:entity/ensureVisible",o)};a.prototype.confirm=function(){wooga.castle.playerData.upgradingCastle=true;this.target.setUnderConstruction(true);var j=new b(this.target);this.deactivate()};a.prototype.cancel=function(){this.deactivate()};a.getEntityName=function(j){return(j||wooga.castle.game.castle).key.indexOf("campsite")!==-1?"Campsite":"Castle"};a.prototype.deactivate=function(){this.manager.view.isFocusedEntityView=this.manager.view.isFocusedEntityViewDefault;this.target.makeStatic();if(this.target.actionsMenu){this.target.actionsMenu.destructor()}this.target=null;this.hide();c.can.remove("touch-entity",d);c.can.remove("entity/contract/change",d);this.manager.setMode(wooga.castle.GameModesManager.Mode.BASIC)};a.prototype.position=function(){var l=this.rootNode.style,j=this.target,n=j.y+(j.height*0.8),m=j.x+j.width*0.5,k=j.view.gridUnit;if(m<j.view.gridUnit*5){m=j.view.gridUnit*5}if(m>1430){m=1490-(j.view.gridUnit*5)}l.webkitTransform="translate3d("+m+"px, "+n+"px, 0)"};a.prototype.show=function(){this.position();c.addClass(this.rootNode,"active")};a.prototype.hide=function(){c.removeClass(this.rootNode,"active")};b=function(k,j){g=this;this.castle=k;this.initiallyHidden=j;this.game=wooga.castle.Game.instance();this.build()};b.instance=function(){return g};b.prototype.build=function(){var j=this,k=this.castle;wooga.castle.net.getTemplate(c.urlFor("templates/castle-complete.html")).addCallback(function(l){var n=document.createElement("div"),o=e.acceptedCount();n.innerHTML=l.data;j.node=n;var m=Math.max(k.entity.definition.friendsToUpgrade-o,0);j.populateScreen(m,k.entity.definition.friendsToUpgrade).wireIn();if(j.initiallyHidden){j.hide()}else{j.show()}c.enableScrollability(j.ul);n.querySelector("hr").style.display="block";document.querySelector("#mlm-content").appendChild(n)},this)};b.prototype.populateScreen=function(m,n){var j,l,o;j=this.node.querySelector(".items li.hidden");l=j.parentNode;this.li=j;this.ul=l;l.innerHTML="";l.appendChild(j);o=e.get();var q=0;Object.keys(o).map(function(r){Object.keys(o[r]).map(function(s){if(q++>=n){return false}this.addInvitee(o[r][s],r)},this)},this);if(m){var p=this.castle.entity.definition.partyInvites,k=0;p.forEach(function(r){if(k>=m||e.invited("game",wooga.castle.game.entitiesDefinition[r].name)){return}++k;this.addInvitee(c.extend({key:wooga.castle.game.entitiesDefinition[r].name},wooga.castle.game.entitiesDefinition[r]),"game")},this)}return this};b.prototype.addInvitee=function(k,q){var o=this.li.cloneNode(true),l=o.querySelector("button"),p=e.invited(q,k.key);o.querySelector("h6").innerHTML=k.name||k.key;var j=o.querySelector(".specialistImg img");if(k.specialistImg){j.src=c.urlForEntityImage(k.specialistImg);j.style.visibility="visible"}else{j.style.visibility="hidden"}if(p){var r=o.querySelector(".cost"),n=o.querySelector(".invite");if(r){r.parentNode.removeChild(r)}if(n){n.parentNode.removeChild(n)}c.removeClass(o.querySelector(".invited")||{},"hidden")}else{if(k.cost){l.setAttribute("data-cost",k.cost);o.querySelector(".cost").innerHTML="Hire for <i></i>"+k.cost;c.toggleClass(o,"unaffordable",!wooga.castle.game.hasStat("gold",k.cost))}o.querySelector(".invite").setAttribute("data-person",JSON.stringify(k))}if(k.picture){var m=o.querySelector(".image img");m.src=k.picture;m.style.visibility="visible"}c.removeClass(o,"hidden");this.ul.appendChild(o)};b.prototype.wireIn=function(){var j=this,l=this.node,n=wooga.castle.capabilities.touch,k=function(o){o.preventDefault();j.hide();if("true"===l.getAttribute("data-can-advance")){if(wooga.castle.playerData.castleUpgradeTokens){wooga.castle.playerData.castleUpgradeTokens.forEach(function(p){wooga.castle.tokens.remove(p)})}if(wooga.castle.playerData.castleUpgradeToken){wooga.castle.tokens.remove(wooga.castle.playerData.castleUpgradeToken)}wooga.castle.playerData.castleUpgradeTokens=null;wooga.castle.playerData.castleUpgradeToken=null;delete wooga.castle.playerData.castleUpgradeTokens;delete wooga.castle.playerData.castleUpgradeToken;j.castle.upgrade();wooga.castle.game.publish("player/update")}},m=function(p){var o=c.parents(p.target,"button");if(!o){return}if(c.hasClass(o,"preventGostCklickOnNotify")){return}c.addClass(o,"preventGostCklickOnNotify");setTimeout(function(){c.removeClass(o,"preventGostCklickOnNotify")},2000);p.preventDefault();if(c.hasClass(o,"invite")){try{j.handleGameInvite(JSON.parse(o.getAttribute("data-person")),o)}catch(q){}}};l.querySelector(".cancel").addEventListener(n?"touchend":"click",k,false);l.querySelector(".ok").addEventListener(n?"touchend":"click",k,false);l.querySelector(".askFriends").addEventListener(n?"touchend":"click",function(o){if(!wooga.castle.playerData.castleUpgradeToken){wooga.castle.playerData.castleUpgradeToken=wooga.castle.tokens.generate()}wooga.castle.game.publish("player/update")},false);l.querySelector(".requiredItems").addEventListener(n?"touchend":"click",m,false)};b.prototype.handleGameInvite=function(k,m){if(!this.game.drain("gold",k.cost)){wooga.notify(c.goldDeltaMessage(k.cost,"hire this specialist."),"gold");return}var l=m.parentNode,j=l.querySelector(".cost"),n=l.querySelector(".invited");j.parentNode.removeChild(j);l.removeChild(m);c.removeClass(n,"hidden");wooga.castle.publish("invited/from-game",{person:k});this.beforeShow()};b.prototype.hide=function(){this.node.style.display="none";setTimeout(c.bind(function(){c.can.remove("show-overlay",d);c.publish("view:castle-upgrade/hide",{screen:this});this.afterHide()},this),48)};b.prototype.show=function(){c.can("show-overlay",d);this.beforeShow();this.node.style.display="block";c.publish("view:castle-upgrade/show",{screen:this})};b.prototype.beforeShow=function(){var k=this.node,m=e.acceptedCount(),j=this.castle.entity.definition.friendsToUpgrade,l=j<=m;this.setProfessionalInfo(k.querySelector("#castleInfo"),j);if(l){k.querySelector(".askFriends").style.display="none";k.querySelector(".ok").style.display="inline-block"}else{k.querySelector(".askFriends").style.display="none";Array.prototype.forEach.call(k.querySelectorAll(".invite"),function(o){var q=o.getAttribute("data-person");if(q){try{var n=JSON.parse(q);if(n){c.toggleClass(c.parents(o,"li"),"unaffordable",!wooga.castle.game.hasStat("gold",n.cost))}}catch(p){}}})}k.setAttribute("data-can-advance",l?"true":"false");k.querySelector(".value.gold").innerHTML=this.game.getStat("gold")};b.prototype.setProfessionalInfo=function(k,j){var l="<p>You need some help to complete the Castle:<br>Hire {NUMBER} {PROS} to help you!</p>";l=l.replace("{NUMBER}",j);l=l.replace("{PROS}",j>1?"Professionals":"Professional");k.innerHTML=l};b.prototype.afterHide=function(){this.game.worldView.publish("castleUpgradeScreen/close")};b.prototype.invalidate=function(){this.populateScreen(Math.max(0,this.castle.entity.definition.friendsToUpgrade-e.acceptedCount()),this.castle.entity.definition.friendsToUpgrade)};b.prototype.destructor=function(){this.node.parentNode.removeChild(this.node);delete this.node;g=null;e.reset()};wooga.castle.subscribe("game/ready",function(k){if(k.game.playerData.upgradingCastle){var j=new b(k.game.castle.entityView,true)}});e=Object.create(null);c.oprop(e,"_game",{});c.oprop(e,"add",function(k,j){this[("_"+k).toLowerCase()][j.key]=j;this._save();return this});c.oprop(e,"addFromGame",function(j){return this.add("game",j)});c.oprop(e,"_save",function(){wooga.castle.playerData.invitations={game:this._game};return this});c.oprop(e,"_load",function(){var j=wooga.castle.playerData.invitations;if(j){this._game=j.game||this._game}return this});c.oprop(e,"reset",function(){this._game={};this._save();return this});c.oprop(e,"invited",function(k,j){k=String(k).toLowerCase();return this["_"+k][j]});c.oprop(e,"get",function(k){var j={game:c.extend({},this._game)};return k?j[k]:j});c.oprop(e,"inviteesCount",function(j){if(!j){return this._game.length}return this[("_"+j).toLowerCase()].length});c.oprop(e,"acceptedCount",function(k){var j=function(l){return Object.keys(l).length};if(!k){return j(this._game)}return j(this[("_"+k).toLowerCase()])});wooga.castle.subscribe("invited/from-game",function(j){e.addFromGame(j.person)});wooga.castle.subscribe("game/ready",function(j){e._load()});wooga.castle.InvitationHandler=e;wooga.castle.CastleUpgradeMode=a;wooga.castle.CastleCompleteScreen=b}());(function(){var b=wooga.castle.utils;var a=function(d,c){this.manager=c;b.extend(this,d);this.subscribed={};this.events=b.extend({},a.Events);this.flags=b.extend({},a.Flags)};a.Events={SUBGOALS_COMPLETE:"goal/subgoals-complete",GOAL_COMPLETE:"goals/complete",PROGRESS:"goal/subgoal-updated",SUBGOAL_COMPLETE:"goal/subgoal-complete",SUBGOAL_COLLECTED:"goal/subgoal-collected",COLLECT_REWARDS:"goal/collect-rewards",NEW:"goal/new"};a.Flags={published_new:false,progressed:false,collected:false,published_subgoals_complete:false,published_collect:false,published_complete:false,SUBGOAL_COLLECTED:-1};a.State={GOAL_STATE_NEW:1,GOAL_STATE_STARTED:2,GOAL_STATE_SUBGOALS_COMPLETE:3,GOAL_STATE_COLLECTED:-1};a.prototype.game=null;a.prototype.view=null;a.prototype.subgoals=[];a.prototype.rewards=[];a.prototype.goalID=null;a.prototype.wireIn=function(d,c){this.game=d;this.view=c;if(!wooga.castle.playerData.goals[this.goalID]){wooga.castle.playerData.goals[this.goalID]={state:this.state||a.State.GOAL_STATE_STARTED,subgoals:{}}}var e=wooga.castle.playerData.goals[this.goalID];this.state=e.state;if(this.state!==a.State.GOAL_STATE_COLLECTED){if(!e.subgoals){e.subgoals={}}this.setupSubscribers();this.subgoals.map(this.setupSubgoalData,this)}this.maybeUpdateState();return this};a.prototype.setupSubgoalData=function(g){var f=this.getSubgoalStat(g.subgoalID);g.have=a.Flags.SUBGOAL_COLLECTED===f?g.amount:f;g.amount=parseInt(g.amount,10);g.imageSrc=(g.icon&&this.manager.imageSrcFor(g.icon))||(this.type==="pay"?this.getSrcForStat(this.action):this.manager.imageSrcFor(g.objects["entity.definition.key"]||g.objects.value));g.complete=g.have===g.amount;g.collected=a.Flags.SUBGOAL_COLLECTED===f;if(g.complete&&!g.collected){b.when("have goal icon",b.bind(function(){this.game.publish(this.events.SUBGOAL_COMPLETE,{entity:this,goal:this,line:this.manager,subgoal:g,actionPerformed:""})},this))}if(g.type==="have"){this.doHaveThing(g)}if(/whack/i.test(g.action)){var e=this._subgoalWantsTree(g);if(!!e){var c=wooga.castle.game.entities.filter(function(h){return(/tree/i).test(h.key)});var d=this._analyzeTrees(c,g,e);if(!d.OK){while(d.shouldSpawn-->0){if("whackable"===d.shouldSpawnA.toLowerCase()){b.publish("spawn/tree")}else{b.publish("spawn",d.shouldSpawnA)}}}}}return g};a.prototype.getSubgoalStat=function(c){var e=this.game.playerData.goals[this.goalID]?(this.game.playerData.goals[this.goalID].subgoals||0)[c]:null;var d=e?parseInt(e,10):0;return isNaN(d)?0:d};a.prototype.setupSubscribers=function(){var c=this.subscribed;this.subgoals.forEach(function(e){if(e.type==="listen"||e.type==="have"){var d=e.action.indexOf(":");if(!c[e.action]){b.subscribe(e.action,this.maybeUpdateSubgoal,this);c[e.action]=true}if(d!==-1){e._action=e.action;e.action=e.action.substring(d+1)}}},this);return this};a.prototype.maybeUpdateSubgoal=function(c){if(!c){return this}this.subgoals.forEach(function(j){if(j.action===c._channel){var h=j.objects,g,e,d,f;for(e in h){if(h.hasOwnProperty(e)){d=String(b.deep(c,e));f=String(h[e]);if(j.have>=j.amount){return}if(d!==f){if(!(e.indexOf("boost")!==-1&&parseInt(d,10)>=parseInt(f,10))&&!(f==="house"&&d==="uhouse")){return}}}}j.have++;this.saveSubgoalStats().maybeUpdateState();g={entity:this,goal:this,line:this.manager,subgoal:j,actionPerformed:c._channel};this.game.publish(this.events.PROGRESS,g);if(j.complete){this.game.publish(this.events.SUBGOAL_COMPLETE,g)}}},this);return this};a.prototype.collectSubgoal=function(c){if(c.complete&&!c.collected){if(c.rewards){c.rewards.forEach(function(d){this.game.increase(d.type,d.amount)},this);this.game.publish(this.events.SUBGOAL_COLLECTED,{subgoal:c,goal:this,line:this.manager})}c.collected=true;this.saveSubgoalStats().maybeUpdateState()}return this};a.prototype.announce=function(){this.game.publish(this.events.NEW,{goalID:this.goalID,goal:this,line:this.manager});return this};a.prototype.maybeUpdateState=function(){var f=0,c=0,e=this.flags.progressed,d=this;d.subgoals.forEach(function(g){e=e||(g.have!==0);if(g.have>=g.amount){f++;g.complete=true;g.collected=g.rewards?!!g.collected:true;if(g.collected){c++}}},this);this.flags.progressed=e;if(e){d.state=d.state===a.State.GOAL_STATE_COLLECTED?a.State.GOAL_STATE_COLLECTED:a.State.GOAL_STATE_STARTED}this.subgoals_completed=f>=d.subgoals.length;if(this.state===a.State.GOAL_STATE_STARTED&&this.subgoals_completed){d.advance()}return this};a.prototype.saveSubgoalStats=function(){if(-1===[a.State.GOAL_STATE_COLLECTED,a.State.GOAL_STATE_SUBGOALS_COMPLETE].indexOf(this.state)){this.subgoals.forEach(function(c){wooga.castle.playerData.goals[this.goalID].subgoals[c.subgoalID]=c.collected?a.Flags.SUBGOAL_COLLECTED:c.have},this)}return this};a.prototype.destroySubscribers=function(){var d=this.subscribed,c;this.subgoals.forEach(function(e){c=e._action||e.action;if(d[e.action]){this.game.unsubscribe(e.action,this.maybeUpdateSubgoal,this);d[e.action]=false}},this);return this};a.prototype.destroyLocalData=function(){var c=this.game.playerData.goals[this.goalID];c.state=a.State.GOAL_STATE_COLLECTED;delete c.subgoals;return this};a.prototype.destructor=function(){this.destroySubscribers().destroyLocalData()};a.prototype.getState=function(){return this.state};a.prototype.advance=function(){switch(this.state){case a.State.GOAL_STATE_NEW:case a.State.GOAL_STATE_STARTED:this.state=a.State.GOAL_STATE_SUBGOALS_COMPLETE;if(!this.flags.published_subgoals_complete){this.game.publish(this.events.SUBGOALS_COMPLETE,{goalID:this.goalID,line:this.manager,goal:this});this.flags.published_subgoals_complete=true}break;case a.State.GOAL_STATE_SUBGOALS_COMPLETE:this.state=a.State.GOAL_STATE_COLLECTED;break;default:break}wooga.castle.publish("request-save");return this};a.prototype.collectRewards=function(){if(this.flags.collected){return this}var c=(this.rewards||[]);this.advance();if(c.length){Array.prototype.map.call(c,function(d){this.game.increase(d.type,d.amount,this)},this);if(!this.flags.published_collect){this.game.publish(this.events.COLLECT_REWARDS,{goal:this,rewards:c,line:this.manager})}this.flags.published_collect=true}this.flags.collected=true;if(!this.flags.published_complete){this.game.publish(this.events.GOAL_COMPLETE,{goal:this,line:this.manager});this.flags.published_complete=true}wooga.castle.publish("request-save");return this};a.prototype.htmlState=function(){var d=this.state;switch(d){case a.State.GOAL_STATE_SUBGOALS_COMPLETE:var c=this.subgoals.filter(function(e){return e.rewards&&!e.collected});if(c.length!==0){d=a.State.GOAL_STATE_STARTED}break;default:break}return d};a.prototype.doHaveThing=function(c){this.game.entities.forEach(function(d){var f={_channel:c.action,entity:d,entityView:d.entityView,contract:d.contract,key:d.key,connected:d.connected};this.maybeUpdateSubgoal(f)},this);return this};a.prototype._subgoalWantsTree=function(d){var c;for(c in d.objects){if(d.objects.hasOwnProperty(c)){if(/tree|whackable/i.test(d.objects[c])){return c}}}return false};a.prototype._analyzeTrees=function(d,g,c){var e=g.objects[c];c=(c||"").replace(/^entity\./,"");var f=d.filter(function(h){return(b.deep(h,c)===e)});return{OK:f.length>=g.amount,shouldSpawnA:e,shouldSpawn:g.amount-f.length}};wooga.castle.Goal=a}());(function(d,a){var b=wooga.castle.utils;b.can("have goal screen",b.disabler);var e=function(g,f){this.manager=g;this.goal=f;this.elementsCache={}};e.prototype.build=function(h,g){var f=new EJS({text:h}),k=a.createElement("div"),j=b.extend({},g);j.AFTER_SUBGOALS_BUTTON_TEXT=j._AFTER_SUBGOALS_BUTTON_TEXT;this.l10n=j;k.innerHTML=f.render(this.provideTemplateData());k.className="goals";this.element=k;if(this.manager.screenRootNode){this.manager.screenRootNode.appendChild(this.element)}this.wireIn();b.can.remove("have goal screen",b.disabler);return this};e.prototype.destructor=function(){var f=this.element;if(f&&f.parentNode){f.parentNode.removeChild(f)}return this};e.prototype.wireIn=function(){var f=Array.prototype.map;this.elementsCache={current_stat_displays:this.element.getElementsByClassName("current"),pay_goal_buttons:this.element.querySelectorAll(".pay .pay"),pay_goal_current_stat_displays:this.element.querySelectorAll(".pay .current"),subgoals:this.element.getElementsByClassName("subgoal")};f.call(this.element.querySelectorAll(".button.collect-goal"),function(g){b.addTouchHandler(g,this.advanceButtonHandler,this)},this);f.call(this.element.querySelectorAll("button.cancel"),function(g){b.addTouchHandler(g,this.cancelButtonHandler,this)},this);f.call(this.element.querySelectorAll(".pay .pay"),function(g){b.addTouchHandler(g,this.handlePayButtonTap,this)},this);f.call(this.elementsCache.subgoals,function(g){b.addTouchHandler(g,function(m){var j=b.parents(m.target,".subgoal");g=this.subgoalForHTMLEntity(j);if(g.complete&&!g.collected){var l=j.querySelector(".description");var k=l.offsetWidth;var h=l.offsetHeight;wooga.castle.game.publish("goals/collectReward",{rewards:g.rewards,width:k,height:h,top:b.getElementTop(l),left:b.getElementLeft(l)});this.goal.collectSubgoal(g);this.invalidate();this.element.className+=" "}},this)},this);this.scrollingUtils=b.enableScrollability(this.element.querySelector("ul.subgoal-list"));b.addClass(this.element,"hidden")};e.prototype.advanceButtonHandler=function(f){if(b.can("advance goal screen",this)){this.manager.advance(true)}};e.prototype.cancelButtonHandler=function(f){if(b.can("close-goals")){this.manager.hide()}};var c=function(f){return f.id.split("-").pop()};e.prototype.subgoalForHTMLEntity=function(f){return this.goal.subgoals.filter(function(g){return c(f)===g.subgoalID})[0]};e.prototype.handlePayButtonTap=function(f){var g=this.subgoalForHTMLEntity(b.parents(f.target,".subgoal"));if(this.manager.manager.game.drain(g.action,g.amount)){g.have=g.amount;this.invalidate()}f.preventDefault()};e.prototype.invalidate=function(){this.goal.maybeUpdateState().saveSubgoalStats();var g=this.goal.state;this.setDOMState();var h=Array.prototype.map;h.call(this.elementsCache.current_stat_displays,function(k){var j=k.className.split(/\s/g).filter(function(l){return(/gold|food|level/i).test(l)})[0];if(j){k.innerText=wooga.castle.game.getStat(j)}});if(wooga.castle.Goal.State.GOAL_STATE_STARTED===g){this.invalidateStats();h.call(this.elementsCache.pay_goal_buttons,function(k){var j=b.parents(k,"li.pay");if(!b.hasClass(j,"done")){var l=j.id.split("-").pop();var m=this.goal.subgoals.filter(function(n){return l===n.subgoalID})[0];b.toggleClass(j,"unaffordable",!this.manager.manager.game.hasStat(m.action,m.amount))}},this);h.call(this.elementsCache.pay_goal_current_stat_displays,function(k){var j=b.parents(k,"li.pay");if(!b.hasClass(j,"done")){var l=j.id.split("-").pop();var m=this.goal.subgoals.filter(function(n){return l===n.subgoalID})[0];k.innerHTML=Math.min(m.amount,b.deep(wooga.castle.playerData,k.getAttribute("data-stat")))}},this)}var f=this.goal;h.call(this.elementsCache.subgoals,function(j){var k=this.subgoalForHTMLEntity(j);if(k.complete){b.addClass(j,"done")}if(k.collected){b.addClass(j,"collected")}},this);this.scrollingUtils.animateTo(0);this.element.calssName+=" "};e.prototype.setDOMState=function(){this.element.setAttribute("data-state",this.goal.htmlState())};e.prototype.invalidateStats=function(){this.goal.subgoals.forEach(function(g,f){this.element.querySelector("#subgoal-"+g.subgoalID+" .have").innerText=g.have;if(g.have>=g.amount){b.addClass(this.element.querySelector("#subgoal-"+g.subgoalID),"done")}},this)};e.prototype.show=function(){this.goal.subgoals.sort(this.sortSubgoals);this.rerenderSubgoals();wooga.castle.Overlay.show();this.invalidate();b.removeClass(this.element,"hidden");return this};e.prototype.getElementBySubgoalId=function(f){return a.getElementById("subgoal-"+f)};e.prototype.rerenderSubgoals=function(){var f=this;this.goal.subgoals.forEach(function(h){var g=f.getElementBySubgoalId(h.subgoalID);g.parentNode.appendChild(g)})};e.prototype.hide=function(){b.addClass(this.element,"hidden");wooga.castle.Overlay.hide();b.publish("view:goals/close",{screen:this,line:this.manager});return this};e.prototype.sortSubgoals=function(g,f){return g.collected===f.collected?f.complete-g.complete:g.collected-f.collected};e.prototype.provideTemplateData=function(){return{l10n:this.l10n,data:this.goal}};wooga.castle.GoalScreen=e;b.can("advance goal screen",function(g){var f=wooga.castle.Goal.State;return[f.GOAL_STATE_NEW,f.GOAL_STATE_SUBGOALS_COMPLETE,f.GOAL_STATE_COLLECTED].indexOf(g.goal.htmlState())!==-1})}(window,document));(function(){var a=wooga.castle.utils;a.can("have goal icon",a.disabler);var b=function(c){this.manager=c;this.build()};b.prototype.build=function(){var c=document.getElementById("goals-drawer");if(!c){c=document.createElement("div");c.id="goals-drawer";this.manager.rootNode.appendChild(c)}this.element=c;this.buildIcons();a.can.remove("have goal icon",a.disabler)};b.prototype.buildIcons=function(){var c=this._readyIcon();this.manager.lines.map(function(d){this.buildIcon(d,c)},this)};b.prototype._readyIcon=function(){var d=document.createElement("a");d.className="goalIcon";var c=document.createElement("figure");d.appendChild(c);return d};b.prototype.buildIcon=function(c,d){var e=this;d=d?d.cloneNode(true):this._readyIcon();d.setAttribute("data-line-id",c.line.id);c.icon=d;c.updateIcon=function(){var f=this.getGoalIcon();if(this.icon){this.icon.firstChild.style.background="url("+f+") 50% 50% no-repeat";this.icon.className="goalIcon"}};c.updateIcon();d.addEventListener("click",function(f){e.manager.hide();c.show()},false);e.element.appendChild(d)};b.prototype.show=function(){};b.prototype.hide=function(){};wooga.castle.GoalsDrawer=b}());(function(){var c=wooga.castle.utils,b=null;var f={OK:"OK",_AFTER_SUBGOALS_BUTTON_TEXT:"Pay {count} <i></i>",GOAL_COMPLETED:"Goal Completed!",SHARE_GOAL_COMPLETED:"Share",COLLECT_REWARDS:"Collect",ALREADY_FINISHED:"You've already completed that goal."};var d={TEMPLATE_URL:c.urlFor("templates/goals.html"),ICON_URL:c.urlFor("images/hud/tasklist.png")};var e;var a=function(h,g,j){if(!h){return}this.line=g;this.goalID=j;this.goal=null;this.manager=h;if(this.manager){this.screenRootNode=this.manager.rootNode}if(!j){this.goalID=this.getNextGoalID();this.publishNewGoalOnBuild()}};a.State={COMPLETE:-1};a.prototype.getNextGoalID=function(){var j,h=Object.keys(this.line.goals).map(function(k){return k.split("/").pop()}),g=-1;if(!this.goalID){j=h[0]}else{g=h.indexOf(this.goalID);if(h.length<=g+1){j=-1}else{j=h[g+1]}}return j};a.prototype.imageSrcFor=function(g){return this.manager.imageSrcFor(g)};a.prototype.build=function(){var g=this.getCurrentGoal();if(!g){if(a.State.COMPLETE===this.goalID){this.finishLine()}return}this.goal=g;this.goal.wireIn(this.manager.game,this.manager.view);this.screen=this.provideGoalsScreen(g,f);if(this._isNewGoal){this._isNewGoal=false;setTimeout(function(){g.announce()},25)}this.built=true;return this};a.prototype.provideGoalsScreen=function(g,h){return(new (this.provideGoalScreenClass())(this,g)).build(e.template,h)};a.prototype.provideGoalScreenClass=function(){return wooga.castle.GoalScreen};a.prototype.show=function(){if(c.can("enter-goals")){this.screen.show();this.manager.view.publish("goals/show",{line:this,goal:this.goal,screen:this.screen})}return this};a.prototype.hide=function(){this.screen.hide();return this};a.prototype.getCurrentGoal=function(){var h=this.get(this.goalID),g;if(h){g=this.createGoal(h)}return g};a.prototype.createGoal=function(g){return new wooga.castle.Goal(g,this)};a.prototype.get=function(g){return((this.line||0).goals||0)["goals/"+g]};a.prototype.advance=function(h){var g=this.goal;g.advance();this.screen.invalidate();if(g.state===wooga.castle.Goal.State.GOAL_STATE_COLLECTED){this.hide().completeGoal().progressLine()}return this};a.prototype.publishNewGoalOnBuild=function(){this._isNewGoal=true;this.built=false;if(this.manager){this.manager.saveLine(this.line.id,this.goalID)}return this};a.prototype.completeGoal=function(){this.goal.collectRewards();this.goal.destructor();this.screen.hide().destructor();return this};a.prototype.progressLine=function(){this.goalID=this.getNextGoalID();this.goal=null;this.built=false;this.publishNewGoalOnBuild();this.build();return this};a.prototype.getGoalIcon=function(){return d.ICON_URL};a.prototype.finishLine=function(){this.manager.finishLine(this)};e=function(h,g,j){if(b){throw"Goals is a singleton"}b=this;this.game=h;this.view=g;this.subscribed={};this.element=null;this.template=null;this.rootNode=j.rootNode;this.getCurrentLines();wooga.castle.net.getCached(d.TEMPLATE_URL).addCallback(function(k){e.template=k.data;this._build();wooga.castle.publish("goals/template-loaded",this)},this);this.view.subscribe("goals/show",function(){},this);this.game.subscribe(wooga.castle.Goal.Events.NEW,function(k){if(k.line&&k.line.updateIcon){k.line.updateIcon()}});this.game.subscribe("player/level-up",function(k){setTimeout(c.bind(this.maybeStartNewLines,this),250)},this);this.game.subscribe("goal/collect-rewards",function(k){setTimeout(c.bind(this.maybeStartNewLines,this),250)},this);this.game.subscribe("goal/subgoals-complete",function(k){if(k.line.icon){c.addClass(k.line.icon,"complete")}},this)};e.l10n=f;e.prototype.maybeStartNewLines=function(){var g;Object.keys(wooga.castle.goals).forEach(function(h){g=wooga.castle.goals[h];if(this.userCanStartLine(g)&&!this.userStartedLine(h)){this.activateLine(h,g).build()}},this);g=null};e.prototype.userStartedLine=function(g){return"undefined"!==typeof wooga.castle.playerData.goalLines[g]};e.prototype.userCanStartLine=function(g){var h=wooga.castle.playerData;return(!g.unlockLevel||(g.unlockLevel<=h.level))&&(!g.unlockGoal||this.userCompletedGoal(g.unlockGoal))};e.prototype.userCompletedGoal=function(h){var g=wooga.castle.playerData;return g.goals[h]&&g.goals[h].state===wooga.castle.Goal.State.GOAL_STATE_COLLECTED};e.prototype.activateLine=function(k,h,j){h.id=k;var g=new a(this,h,j||0);this.lines.push(g);if(this.drawer){this.drawer.buildIcon(g)}return g};e.prototype.getCurrentLines=function(){var j=this.game,h=j.playerData.goalLines,k=[],g,l=wooga.castle.goals;this.lines=[];Object.keys(h).map(function(m){if(l.hasOwnProperty(m)&&a.State.COMPLETE!==h[m]){this.activateLine(m,l[m],h[m])}},this)};e.prototype.saveLine=function(h,g){this.game.playerData.goalLines[h]=g};e.prototype._build=function(){this.lines.map(function(g){if(!g.built){g.build()}});this.drawer=new wooga.castle.GoalsDrawer(this);wooga.castle.publish("goals/ready")};e.instance=function(){return b};e.prototype.show=function(){(this.lines.length===1?this.lines[0]:this.drawer).show()};e.prototype.hide=function(){this.drawer.hide()};e.getLineForGoal=function(h){var g;Object.keys(wooga.castle.goals).forEach(function(k){if(g){return false}var j=new a(null,wooga.castle.goals[k]);if(j.get(h)){g=k}},this);return g};e.prototype.finishLine=function(g){wooga.castle.playerData.goalLines["line/"+g.id]=a.State.COMPLETE;if(g.icon&&g.icon.parentNode){g.icon.parentNode.removeChild(g.icon)}this.lines=this.lines.filter(function(h){return h.id!==g.id})};e.prototype.imageSrcFor=function(h){var j,g;if(["gold","food"].indexOf(h)!==-1){j=c.urlFor("/images/popup-"+wooga.castle.GRID_UNIT+"/"+h+(h==="gold"?"Cost":"")+".png")}else{g=this.game.entitiesDefinition[h];j=g?(g.icon?c.urlForEntityImage(g.icon):g.image.src):c.urlForEntityImage(h)}return j};wooga.castle.GoalLine=a;wooga.castle.Goals=e}());(function(){var a=wooga.castle.utils;wooga.castle.RoadView=function(c,d){wooga.castle.EntityView.call(this,c,d);this.roadType=0;this.updateImage()};var b=wooga.castle.RoadView;b.prototype=new wooga.castle.EntityView();b.prototype.constructor=b;b.prototype.setRoadType=function(c){if(c!==this.roadType){this.roadType=c;this.updateImage();this.view.bufferCanvasChanges.push(this)}};b.prototype.updateImage=function(){this.spritey=this.view.game.entitiesDefinition["paths/road-"+this.roadType].spritey;this.image=this.view.game.entitiesDefinition["paths/road-"+this.roadType].image};b.prototype.getImageFrame=function(){return{x:0,y:this.spritey*this.view.gridUnit,width:this.width,height:this.height}}}());(function(){var b=wooga.castle.utils,a;function d(e){return{left:e.x+(e.width*0.5),top:e.y-(e.entity?(e.entity.definition.offsetY||0)*wooga.castle.GRID_UNIT:0)}}var c=function(e){if(a){throw"InPlaceNotificaiton is a singleton"}a=this;this.view=e;this.rootNode=document.getElementById("game_overlay");b.subscribe("game/ready",function(f){b.subscribe("view:drydock/show",function(g){g.negative=true;g.text="Complete more goals first!";a.show(g)});wooga.castle.subscribe("game/not-enough-food",function(h){if(h.entityView.entity.contract){var g=h.entityView.entity.contract.requiredFood-wooga.castle.playerData.food;h.text="You need "+g+" more food!"}else{h.text="You need more food!"}h.negative=true;a.show(h)});wooga.castle.subscribe("game/not-enough-gold",function(g){g.negative=true;a.show(g)});e.game.subscribe("contract/start",function(g){if("ship"===g.entity.definition["class"]){setTimeout(function(){a.show({entityView:g.entity.entityView,text:"Repair Started!"})},25)}});wooga.castle.subscribe("entity/coming-soon",function(g){a.show({entityView:g,text:"Coming Soon..."})});wooga.castle.subscribe("gold/drain",function(g){g.negative=false;a.show(g)});wooga.castle.subscribe("food/drain",function(g){g.negative=false;a.show(g)});b.subscribe("view:root-road-tap",function(g){a.show(b.extend({text:"Cannot remove that!",negative:true},g))});b.subscribe("game:road/cant-place-here",function(g){a.show(b.extend({text:"Can't place road here",negative:true},g))});b.subscribe("game:building/connected",function(g){a.showBuildingConnectedTimeout=window.setTimeout(function(){a.show(b.extend({text:"Building Connected",negative:true},g))},20)});b.subscribe("game:entity/buy",function(g){if(a.showBuildingConnectedTimeout){window.clearTimeout(a.showBuildingConnectedTimeout)}a.show(b.extend({text:"-"+g.entity.definition.goldCost+" gold",negative:true},g,{entityView:g.entity.entityView}))})},this)};c.instance=function(){return a};c.prototype.show=function(g){var k=g.text,j=g.image,h=document.createElement("div"),f=a.rootNode,e=d(g.entityView);h.setAttribute("class","quick-notif");b.addClass(h,"flyout");h.style.left=e.left+"px";h.style.top=e.top+"px";if(j){h.style.backgroundImage="url("+j.src+")"}if(k){h.innerHTML=k}h.addEventListener("webkitAnimationEnd",function(l){if(l.target===h&&h.parentNode){h.parentNode.removeChild(h)}});f.appendChild(h);return this};wooga.castle.InPlaceNotification=c;wooga.castle.subscribe("game/worldViewInit",function(e){var f=new c(e.view)})}());(function(){var b=wooga.castle.utils,a=function(d,e,f){this.manager=d;this.config=e;this.mode=f;this.rig();this.build()};a.prototype.manager=null;a.prototype.heap={};a.prototype.rig=function(){var d=this.manager;this.manager.view.isFocusedEntityView=function(e){return e===d};this.manager.view.subscribe("entity/blur",this.destructor,this)};a.prototype.build=function(){var g=document.createElement("div"),f=this.manager,d=f.view,h=this.config.actions;f.addEventHandler("dragstart",function(j){this.hide()},this);f.addEventHandler("dragend",function(){this.show()},this);g.setAttribute("class","in-place-actions");this.node=g;this.addActionButtons(g,h);d.addEventHandler("moved",this.position,this);g.addEventListener("click",b.bind(function(j){j.preventDefault();if(b.hasClass(j.target,"disabled")){return}var k=j.target.getAttribute("data-actionname");if(this.mode.handle){this.mode.handle(k,this)}switch(k){case"move":this.destructor();break;case"destroy":break;default:break}},this),false);this.position();var e=document.getElementById("game_overlay");e.appendChild(g)};a.prototype.position=function(){var e=this.node.style,d=this.manager,g=d.y+d.height,f=d.x+d.width*0.5;e.webkitTransform="translate3d("+f+"px, "+g+"px, 0)"};a.prototype.addActionButtons=function(e,g){var f=Object.keys(g),d=this;b.addClass(e,"has-"+Math.max(f.length,2));f.map(function(j){var h=document.createElement("a");h.href="#";h.setAttribute("data-actionname",j);b.addClass(h,"action "+j);e.appendChild(h);d.setActionEnabled(j,!g[j].disabled)})};a.prototype.setActionEnabled=function(f,e){var d=this.node.querySelector("."+f);if(d){b.toggleClass(d,"disabled",!e)}};a.prototype.destructor=function(){if(this.node&&this.node.parentNode){this.node.parentNode.removeChild(this.node)}this.manager.view.unsubscribe("entity/blur",this.destructor,this);this.manager.view.isFocusedEntityView=this.manager.view.isFocusedEntityViewDefault;this.manager.view.removeEventHandler("moved",this.position,this)};a.prototype.hide=function(){this.node.style.display="none"};a.prototype.show=function(){this.position();this.node.style.display="block"};b.subscribe("game/ready",function(e){var d=e.view;b.subscribe("view:entity/focused",function(g){var j=b.bind(function(k){k.preventDefault();if(b.hasClass(k.target,"disabled")){return}var l=k.target.getAttribute("data-actionname");if(this.handle){this.handle(l,this)}},g.infoMode);var h;for(h in g.entityView.actions){if(g.entityView.actions.hasOwnProperty(h)){var f=document.createElement("a");f.className=h;f.setAttribute("href","#");f.innerHTML=h;f.setAttribute("data-actionname",h);b.addClass(f,"action "+h);if(/\//.test(h)){f.style.backgroundImage="url("+b.getEntityImageUrl(h)+")";b.addClass(f,"custom")}f.addEventListener("click",j,false);g.infoMode.menu.appendChild(f)}}});b.subscribe("view:entity/yesno",function(g){var f=new wooga.castle.EntityYesNo(g)})});var c=function(g){var m=document.createElement("div"),r=document.createElement("div"),f=document.createElement("div");b.addClass(m,"hud_mode destroy_entity yesno");r.className="infoPanel";r.innerHTML='<p class="specification">'+g.message+"</p>";f.className="menu";m.appendChild(r);this.rootNode=m;this.infoPanel=r;document.getElementById("game_overlay").appendChild(m);var o=b.bind(function(e){e.preventDefault();if(!b.hasClass(e.target,"disabled")){var s=e.target.getAttribute("data-actionname");if(this.handle){this.handle(s,this)}}return false},this);var l=b.extend({cancel:true,confirm:true},g.actions||{});var j;for(j in l){if(l.hasOwnProperty(j)){var q=document.createElement("a");q.className=j;q.setAttribute("href","#");q.innerHTML=j;q.setAttribute("data-actionname",j);b.addClass(q,"action "+j);q.addEventListener("click",o,false);f.appendChild(q)}}this.infoPanel.appendChild(f);var n=g.entityView,k=g.entity,p=n.y,h=n.x+n.width*0.5,d=n.view.gridUnit;if(h<d*5){h=d*5}if(h>1430){h=1490-(d*5)}this.rootNode.style.webkitTransform=k.is("decoration")?"translate3d("+h+"px, "+p-k.definition.influenceArea*d+"px, 0)":"translate3d("+h+"px, "+p+"px, 0)";this.config=g;b.publish("view:request-mode",{mode:"yesnoer"});b.addClass(this.rootNode,"active");this.callbacks={confirm:g.confirm||function(){},cancel:g.cancel||function(){}}};c.prototype.handle=function(d){this.callbacks[d]();this.destroy()};c.prototype.destroy=function(){b.removeClass(this.rootNode,"active");this.rootNode.parentNode.removeChild(this.rootNode);b.publish("view:request-mode",{mode:wooga.castle.GameModesManager.Mode.BASIC})};wooga.castle.EntityYesNo=c;wooga.castle.InPlaceActionsMenu=a}());(function(){var c=wooga.castle.utils,e=function(){return false},d={LEVEL_UP_TEMPLATE:c.urlFor("templates/level-up.html")},a=[];var b=function(){var f={level:wooga.castle.xp.level,rewards:wooga.castle.xp.rewards(),unlocked:b.unlockedAt(wooga.castle.xp.level)};this.data=f;setTimeout(function(g){g.build()},20,this)};b.prototype.build=function(){var g;g=document.createElement("div");g.id="level-up-wrapper";c.addClass(g,"hidden");var f=new EJS({text:b.template});g.innerHTML=f.render({data:this.data});this.rig(g);setTimeout(function(){c.when("show-overlay",function(){b.game.worldView.rootNode.parentNode.appendChild(g);wooga.castle.Overlay.show();c.removeClass(g,"hidden")})},25);this.wrap=g;return this};b.unlockedAt=function(k){var f,g,h=[],j=this.game.entitiesDefinition;for(g in j){if(j.hasOwnProperty(g)){f=j[g];if("level"===f.unlockCondition&&k===f.unlockValue){h.push(c.extend({iconURL:c.urlForEntityImage(f.icon)},f));break}}}return h};b.prototype.collectReward=function(){if(c.isArray(this.data.rewards)){this.data.rewards.map(function(f){wooga.castle.game.increase(f.type,f.amount)})}return this};b.prototype.rig=function(g){var f=g.querySelector("button.share");if(f){f.addEventListener("click",c.bind(function(j){this.collectReward();this.hide();var h=j.touches?j.touches[0]||j:j;c.clickBuster.preventGhostClick(h.clientX,h.clientY)},this),false)}return this};b.prototype.hide=function(){c.addClass(this.wrap,"hidden");wooga.castle.Overlay.hide()};wooga.castle.subscribe("game/init",function(f){b.game=f.game;wooga.castle.net.getCached(d.LEVEL_UP_TEMPLATE).addCallback(function(g){b.template=g.data});b.game.subscribe("player/level-up",function(){var g=new wooga.castle.LevelUP()})});wooga.castle.LevelUP=b}());(function(){var b=wooga.castle.utils,e=wooga.castle.GRID_UNIT/24,a=null,c=function(){return 0},d=function(f,g){a=this;this.game=f;f.worldView.allowDrag(false);this.config=g;this.currentStep=c();this.step()};d.prototype.config={};d.prototype.game=null;d.prototype.currentStep=0;d.prototype.screen=null;d.getCurrentStep=c;d.instance=function(){return a};d.prototype.show=function(){if(this.screen){this.screen.fireEvent("resize")}document.body.setAttribute("data-in-tutorial",true);this.screen.node.style.display="block";return this};d.prototype.hide=function(){this.screen.node.style.display="none";return this};d.prototype.step=function(){if(this.config[this.currentStep-1]&&this.config[this.currentStep-1].subroutine){d.Hilite.subroutines[this.config[this.currentStep-1].subroutine+"Cleanup"].call(this)}var g=this.config[this.currentStep],f;if(!g){if(this.currentStep){document.body.removeAttribute("data-in-tutorial");this.game.playerData.doneTutorial=true;wooga.castle.Storage.save("doneTutorial",this.game.playerData.doneTutorial);this.game.worldView.allowDrag(true);this.game.publish("tutorial/done")}return}f=new d.Screen(this,g);this.screen=f;if(this.currentStep===0){f.show()}if(g.subroutine){d.Hilite.subroutines[g.subroutine].call(this)}};d.prototype.next=function(){var f=this.screen;this.currentStep+=1;f.destructor();this.step();setTimeout(b.bind(this.screen.show,this.screen),300);this.screen.show()};d.prototype.back=function(){var f=this.screen;this.currentStep-=1;if(this.currentStep<0){this.currentStep=0}d.setCurrentStep(this.currentStep);this.step();f.destructor()};d.Screen=function(g,f){if(!f){return}this.listeners=[];this.manager=g;this.config=f;this.build();this.setupScrolling();this.makeArrow(f.arrow);this.makeHilite(f.hilite);this.makeDialog(f);this.addHideListener(f.hide);this.addProgressor(f.next);this.addRegressor(f.back);this.addShowListener(f.show);this.setupCanAnswer(f.can)};d.Screen.prototype.manager=null;d.Screen.prototype.config=null;d.Screen.prototype.node=null;d.Screen.prototype.arrow=null;d.Screen.prototype.listeners=[];d.Screen.prototype.canAnswer=null;d.Screen.prototype.domhandlers={resize:function(f){this.fireEvent("resize")},drag:function(){this.fireEvent("drag")}};b.mixin(d.Screen,b.ObservableMixin);d.Screen.prototype.build=function(){var f=document.createElement("div");f.setAttribute("class","tutscreen step_"+this.manager.currentStep);f.setAttribute("data-tutorial_screen_id",this.manager.currentStep);this.setupDOMListeners();this.node=this.manager.config.root.appendChild(f)};d.Screen.prototype.setupScrolling=function(){var f=this.manager.game.worldView;if(this.config.center){f.allowDrag(true);f.centerToTile.apply(f,this.config.center);this.listen("view:centered",this.onViewCentered)}f.allowDrag(!!this.config.scroll);this.listen("view:shop/get preview center",this.getPreviewCenter)};d.Screen.prototype.onViewCentered=function(g){var f=this.config.center||[-16,5],h=g.isDragAllowed;g.allowDrag(true);g.centerToTile.apply(g,f);g.allowDrag(h);this.fireEvent("recentered",f)};d.Screen.prototype.getPreviewCenter=function(g){var f=this.config.center||[-14,5];g.center={x:f[0],y:f[1]}};d.Screen.prototype.makeArrow=function(f){if(!f){return}this.arrow=new d.Arrow(this,f);this.node.appendChild(this.arrow.arrow)};d.Screen.prototype.makeHilite=function(f){if(!f){return}f.x=f.position[0];f.y=f.position[1];this.hilite=new d.Hilite(this,f);this.node.appendChild(this.hilite.hilite)};d.Screen.prototype.makeDialog=function(f){this.makeText(f.text);this.makeChar()};d.Screen.prototype.makeText=function(g){if(!g){return}var h=document.createElement("div");h.setAttribute("class","tutorial-text");h.innerHTML=this.text=g;var f=this;if(wooga.castle.switches.cheatmode){h.addEventListener(wooga.castle.capabilities.touch?"touchend":"click",function(){f.manager.next()},false)}if(this.config.textY&&!wooga.castle.capabilities.iPad){h.style.webkitTransform="translate(0,"+(this.config.textY||0)+"px)"}this.textNode=this.node.appendChild(h)};d.Screen.prototype.makeChar=function(){var f=document.createElement("div");f.setAttribute("class","tutorial-char");var g=this;if(wooga.castle.switches.cheatmode){f.addEventListener(wooga.castle.capabilities.touch?"touchend":"click",function(){g.manager.next()},false)}if(this.config.textY){f.style.webkitTransform="translate(0,"+(this.config.textY||0)+"px)"}this.charNode=this.node.appendChild(f)};d.Screen.prototype.setupCanAnswer=function(g){if(!g){return}if(!b.isArray(g)){g=[g]}var f=this;this.canAnswer=function(j){var h=(g.indexOf(j._action)!==-1);return h&&f.validate("can",j)};b.can("*",this.canAnswer)};d.Screen.prototype.addHideListener=function(f){if(f){this.listen(f,function(g){this.hide()})}};d.Screen.prototype.addShowListener=function(f){if(f){var g=function(h){if(h){if(!this.validate("show",h)){return}}this.show()};this.listen(f,g)}};d.Screen.prototype.addProgressor=function(f){if(f){this.listen(f,function(g){if(this.validate("next",g)){this.next()}else{this.hide()}})}};d.Screen.prototype.addRegressor=function(f){if(f){this.listen(f,function(g){this.back()})}};d.Screen.prototype.validate=function(m,n){var h,k,j,g;if(this.config.valid){h=this.config.valid[m]}var f=!h;if(h){if(!b.isArray(h)){h=[h]}f=true;for(j=0,g=h.length;f&&j<g;j++){k=h[j];f=(b.deep(n,k.key)===k.value)}}return f};d.Screen.prototype.listen=function(h,g){var f;if(!h){return}if(!b.isArray(h)){h=[h]}f=h.length-1;do{this._listen(h[f],g);f--}while(f>=0)};d.Screen.prototype._listen=function(f,g){var h=wooga.castle,j=f.split(":");if(j.length===2){h=b.getPublisher(j[0]);f=j[1]}this.listeners.push([h,f,g]);h.subscribe(f,g,this)};d.Screen.prototype.setupDOMListeners=function(){var f=this;window.addEventListener("resize",function(){f.domhandlers.resize.call(f)},false);d.canvas().addEventHandler("drag",this.domhandlers.drag,this)};d.Screen.prototype.removeDOMListeners=function(){window.removeEventListener("resize",this.domhandlers.resize,false);d.canvas().removeEventHandler("drag",this.domhandlers.drag,this);if(this.domhandlers.back){this.removeEventHandler("resize",this.domhandlers.back.resize,this);this.removeEventHandler("drag",this.domhandlers.back.drag,this)}};d.Screen.prototype._unlisten=function(){this.listeners.forEach(function(f){f[0].unsubscribe(f[1],f[2],this)},this)};d.Screen.prototype.destructor=function(){var f=this.node;this._unlisten();this.removeDOMListeners();if(this.arrow instanceof d.Arrow){this.arrow.remove();delete this.arrow}if(this.hilite instanceof d.Hilite){this.hilite.remove();delete this.hilite}if(f&&f.parentNode){f.parentNode.removeChild(f)}if(this.canAnswer){b.can.remove("*",this.canAnswer)}this.canAnswer=null};d.Screen.prototype.show=function(){if(this.arrow){this.fireEvent("resize")}this.node.style.display="block"};d.Screen.prototype.hide=function(){this.node.style.display="none"};d.Screen.prototype.next=function(){this.manager.next()};d.Screen.prototype.back=function(){this.manager.back()};d.position=function(j){var k={},f=j.position,h,g;if(b.isArray(f)){h=d.canvas();g=h.gridUnit;k.left=h.scrollLeft+(h.mapWidth*0.5+f[0])*g;k.top=h.scrollTop+(h.mapHeight*0.5+f[1])*g}else{if(j.node){if(!b.isVisible(j.node)){k=false}else{k=b.offset(j.node)}}}if(k){k.left+=e*(j.left||0);k.top+=e*(j.top||0)}return k};d.canvas=function(){var f=wooga.castle.Game.instance().worldView;d.canvas=function(){return f};return f};d.Arrow=function(g,f){this.manager=g;this.config=f;if(!f){return}this.build()};d.Arrow.prototype.manager=null;d.Arrow.prototype.config=null;d.Arrow.prototype.arrow=null;d.Arrow.prototype.build=function(){var f=this.config,h=f.position,g=f.rotation||0,j,k;if(typeof h==="string"){this.node=document.querySelector(h)}this.arrow=j=document.createElement("div");j.setAttribute("class","tutarrow");j.style.webkitTransform="rotate(-"+g+"deg)";k=document.createElement("figure");k.setAttribute("class","arrow");if(f.type&&f.type==="right"){k.setAttribute("class","arrow right")}j.appendChild(k);this.manager.addEventHandler("drag",this.position,this);this.manager.addEventHandler("resize",this.position,this);this.manager.addEventHandler("recentered",this.position,this);this.position()};d.Arrow.prototype.queryToCoords=function(){return d.position(b.extend({node:this.node},this.config))};d.Arrow.prototype.position=function(){var g=this.queryToCoords(),f=this.arrow.style;if(false===g){f.display="none"}else{f.display="block";f.top=g.top+"px";f.left=g.left+"px"}};d.Arrow.prototype.remove=function(){if(this.arrow.parentNode){this.arrow.parentNode.removeChild(this.arrow)}this.manager.removeEventHandler("drag",this.position,this);this.manager.removeEventHandler("resize",this.position,this)};d.Hilite=function(g,f){this.manager=g;this.config=f;if(!f){return}this.build()};d.Hilite.prototype.manager=null;d.Hilite.prototype.config=null;d.Hilite.prototype.hilite=null;d.Hilite.prototype.build=function(){var j=this.config,k=j.position,h=d.canvas(),g=h.gridUnit,f;if(typeof k==="string"){this.node=document.querySelector(k)}this.hilite=f=document.createElement("div");f.setAttribute("class","tuthilite");f.style.height=j.height*g+"px";f.style.width=j.width*g+"px";this.manager.addEventHandler("drag",this.position,this);this.manager.addEventHandler("resize",this.position,this);this.manager.addEventHandler("recentered",this.position,this);this.position()};d.Hilite.prototype.queryToCoords=function(){return d.position(b.extend({node:this.node},this.config))};d.Hilite.prototype.position=function(){var g=this.queryToCoords(),f=this.hilite.style;if(false===g){f.display="none"}else{f.display="block";f.top=g.top+"px";f.left=g.left+"px"}};d.Hilite.prototype.remove=function(){if(this.hilite.parentNode){this.hilite.parentNode.removeChild(this.hilite)}this.manager.removeEventHandler("drag",this.position,this);this.manager.removeEventHandler("resize",this.position,this)};d.Hilite.subroutines={_housePlacementCorrections:function(k){var l=this.game.worldView;var h=l.moveEntityView;var j=l.gridUnit;var g=this.config[this.currentStep].hilite;var f=l.clientXYtoWorldXY(k);if((f.x>=g.position[0])&&(f.x<g.position[0]+g.width)&&(f.y>=g.position[1])&&(f.y<g.position[1]+g.height)){h.beforeMove();h.x=(g.position[0]+l.mapWidth/2)*j;h.y=(g.position[1]+h.entity.definition.offsetY+l.mapHeight/2)*j;h.fireEvent("moved",h);h.moved()}},housePlacementCorrections:function(){this.game.worldView.addEventHandler("touch",d.Hilite.subroutines._housePlacementCorrections,this)},housePlacementCorrectionsCleanup:function(){this.game.worldView.removeEventHandler("touch",d.Hilite.subroutines._housePlacementCorrections,this)}};wooga.castle.subscribe("game/ready",function(h){if(wooga.castle.playerData.doneTutorial||wooga.castle.switches.nowelcome){return}var f=b.extend(wooga.castle.tutorial,{root:h.domNode}),g;g=(new d(h.game,f)).hide();wooga.castle.publish("tutorial/ready",{instance:g})},this);wooga.castle.Tutorial=d}());(function(){var a=wooga.castle.utils,c=wooga.castle.net,b;wooga.castle.TransactionsManager=function(e){this.game=e;if(wooga.castle.switches.noPersistency){console.log("In noPersistency mode, no one can hear you scream. Also, we don't save your stuff");return}function k(){if(!e.playerData.doneTutorial){return}var l="playerData";wooga.castle.Storage.save(l,e.playerData)}function j(o,n){var m,l;return function(r,q){var p=function p(){r.call(q);l=setTimeout(p,n)};if(m){clearTimeout(m)}if(l){clearTimeout(l)}m=setTimeout(function(){r.call(q);l=setTimeout(p,n)},o)}}var h=j(b.SAVE_LOCALLY_THROTTLE,b.SAVE_LOCALLY_TIMEOUT,"LS");function d(){h(k)}var g=function(){var l=new d()};g();var f=["game:contract/","game:player/update","game:entity/buy","game:goal/","game:goals/","invited/","request-save"];f.forEach(function(l){wooga.castle.utils.subscribe(l,g)})};b=wooga.castle.TransactionsManager;b.SAVE_LOCALLY_TIMEOUT=30*1000;b.SAVE_LOCALLY_THROTTLE=2*1000}());(function(){var a=function(b,c){this.parent.call(this,b,c)};a.prototype=new wooga.castle.Entity();a.prototype.constructor=a;a.prototype.parent=wooga.castle.Entity;a.prototype.getInfoModeString=function(){return'<p><span class="population">Supported Population: '+this.definition.population+"</span></p>"};wooga.castle.Castle=a}());(function(){var b=wooga.castle.utils,a=function(c,d){this.parent.call(this,c,d);this.actionsMenu=null;this.initEventHandlers();this.entity.selectable=true;this.wasPrevConstruction=false;this.underConstructionImage=this.view.game.entitiesDefinition["buildings/castle_construction"].image;this.setUnderConstruction(wooga.castle.playerData.upgradingCastle);this.actions={upgrade:{disabled:!this.entity.definition.upgradeTo}};this.events=b.extend({},a.Events)};a.Events={UPGRADE:"castle/upgrade"};a.prototype=new wooga.castle.EntityView();a.prototype.parent=wooga.castle.EntityView;b.mixin(a,b.ObservableMixin);a.prototype.constructor=a;a.prototype.actionsMenu=null;a.prototype.initEventHandlers=function(){this.addEventHandler("touch",this.touchHandler,this)};a.prototype.touchHandler=function(c){};a.prototype.isFocusable=function(){return true};a.prototype.setUnderConstruction=function(c){this.isUnderConstruction=c;this.image=c?this.underConstructionImage:this.entity.definition.image;if(c){this.makeDynamic()}this.cacheImageFrame();this.makeStatic()};a.prototype.getImageFrame=function(){if(!this.isUnderConstruction){return this.parent.prototype.getImageFrame.call(this)}else{return{x:0,y:0,width:this.width,height:this.height}}};a.prototype.upgrade=function(){var e={key:this.entity.definition.upgradeTo,x:this.entity.x,y:this.entity.y},d=this.view.game;var c=d.createEntity(e);this._entity=this.entity;this.entity=c;this.entity.entityView=this;d.removeEntity(this._entity);d.updateMapData();this.actions.upgrade.disabled=!this.entity.definition.upgradeTo;wooga.castle.CastleCompleteScreen.instance().destructor();this.setUnderConstruction(wooga.castle.playerData.upgradingCastle=false);wooga.castle.Game.instance().publish(this.events.UPGRADE,{entityView:this,entity:this.entity,text:"Upgrading..."})};wooga.castle.CastleView=a}());(function(){var a=wooga.castle.utils,b=function(d,c){this.manager=d;this.parentNode=c.rootNode;this.build()};b.prototype.build=function(){var d=document.createElement("div"),f=document.createElement("div");a.addClass(d,"hud_mode destroy_entity");f.className="infoPanel";f.innerHTML='<p class="specification">Sell <span class="entityclass"></span> <span class="whatyouget"></span></p><div class="menu"></div>';d.appendChild(f);this.rootNode=d;this.infoPanel=f;document.getElementById("game_overlay").appendChild(d);var h=a.bind(function(j){j.preventDefault();if(a.hasClass(j.target,"disabled")){return}var k=j.target.getAttribute("data-actionname");if(this.handle){this.handle(k,this)}switch(k){case"cancel":break;case"confirm":break;default:break}},this);var g={cancel:true,confirm:true};var e;for(e in g){if(g.hasOwnProperty(e)){var c=document.createElement("a");c.className=e;c.setAttribute("href","#");c.innerHTML=e;c.setAttribute("data-actionname",e);a.addClass(c,"action "+e);c.addEventListener("click",h,false);this.infoPanel.querySelector(".menu").appendChild(c)}}this.game=wooga.castle.Game.instance()};b.prototype.handle=function(c,d){if("confirm"===c){this.confirm()}else{if("cancel"===c){this.cancel()}}};b.prototype.confirm=function(){var h=this.target.entity.definition,f=this.game,j=this.target,e=j.entity,d=b.goldGain(j),c=b.foodGain(j),g={entity:e,entityView:j,rewards:[]};if(d){f.increase("gold",d,j);g.rewards.push({type:"gold",amount:d})}if(c){f.increase("food",c,j);g.rewards.push({type:"food",amount:c})}e.fireEvent("destroy");f.publish("entity/destroy",g);f.worldView.publish("entityView/destroy",g);f.removeEntity(e);f.worldView.removeEntityView(j);if("function"===typeof j.destructor){j.destructor()}f.updateMapData();f.publish("player/update");this.deactivate()};b.prototype.cancel=function(){this.deactivate()};b.goldGain=function(c){return Math.floor(c.entity.definition.goldCost*0.5)+(c.entity.contract&&c.entity.contract.requiredGold&&c.entity.contractStartTime?c.entity.contract.requiredGold:0)};b.foodGain=function(c){return(c.entity.contractStartTime&&c.entity.contract&&c.entity.contract.requiredFood)?c.entity.contract.requiredFood:0};b.prototype.activate=function(c){var e=this.target=c.target;this.manager.view.isFocusedEntityView=function(g){return g===e};this.infoPanel.querySelector(".entityclass").innerHTML=e.entity.getCallableName();var f=b.goldGain(e),d=b.foodGain(e);this.infoPanel.querySelector(".whatyouget").innerHTML="for "+f+" coins"+((d)?" and "+d+" food":"")+".";this.show();a.publish("view:entity/ensureVisible",e)};b.prototype.deactivate=function(){this.manager.view.isFocusedEntityView=this.manager.view.isFocusedEntityViewDefault;if(this.target.actionsMenu){this.target.actionsMenu.destructor()}this.target=null;this.hide();this.manager.setMode(wooga.castle.GameModesManager.Mode.BASIC)};b.prototype.position=function(){var f=this.rootNode.style,c=this.target,h=c.y,g=c.x+c.width*0.5,d=c.view.gridUnit;if(g<c.view.gridUnit*5){g=c.view.gridUnit*5}if(g>1430){g=1490-(c.view.gridUnit*5)}if(c instanceof wooga.castle.DecorationView){var e=h-c.entity.definition.influenceArea*d;f.webkitTransform="translate3d("+g+"px, "+e+"px, 0)"}else{f.webkitTransform="translate3d("+g+"px, "+h+"px, 0)"}};b.prototype.show=function(){this.position();a.addClass(this.rootNode,"active")};b.prototype.hide=function(){a.removeClass(this.rootNode,"active")};wooga.castle.DestroyMode=b}());(function(){var a=function(b,c){this.user=b;this.migrations=c||[];this.latestVersion=this.migrations[this.migrations.length-1].version};a.prototype.userHasLatestVersion=function(){return this.user.dataVersion===this.latestVersion};a.prototype.run=function(b){if(this.userHasLatestVersion()){return}this.migrations.forEach(function(c){if(this.user.dataVersion>=c.version){return}c.run(this.user);if(Number.POSITIVE_INFINITY!==c.version){this.user.dataVersion=c.version}},this)};wooga.castle.MigrationRunner=a;wooga.castle.utils.subscribe("have player data",function(b){var c=new wooga.castle.MigrationRunner(b.game.playerData,wooga.castle.migrations);c.run()})}());(function(){wooga.castle.migrations=[{version:1,name:"adding a version info attribute",run:function(a){a.dataVersion=a.dataVersion||1}},{version:2,name:"migrating removed rock-goal",run:function(a){if(a.goals&&a.goals["7016"]&&(a.goals["7016"]!==-1)){a.goals["7016"]=null;delete a.goals["7016"];a.goals["7017"]={state:1,subgoals:{"7017s0":0,"7017s1":0}}}}},{version:3,name:"changing to goal lines",run:function(b){if(!b.goalLines){var a={};Object.keys(b.goals||{}).map(function(c){var d=wooga.castle.Goals.getLineForGoal(c);a[d]=c});b.goalLines=a}}},{version:4,name:"no moar goals",run:function(a){a.goalLines={"line/4000":0};a.goals={}}},{version:5,name:"remove campsite",run:function(b){var a=b.map.entities.map(function(c){if(c.key.indexOf("campsite")!==-1){c.key="buildings/castle_1"}})}},{version:6,name:"no moar goals, again",run:function(a){a.goalLines={"line/1":0};a.goals={}}},{version:7,name:"no moar goals, again",run:function(a){a.goalLines={"line/1":0};a.goals={}}},{version:8,name:"adding unlockablee",run:function(b){var a=[{key:"unlock/1"},{key:"unlock/2"},{key:"unlock/3"},{key:"unlock/4"},{key:"unlock/5"}];b.map.entities=b.map.entities.concat(a)}},{version:9,name:"new trees",run:function(a){var b=["b","d","y","r"];a.map.entities=a.map.entities.map(function(c){c.key=c.key==="nature/tree-small"?"nature/tree-small-"+b[Math.floor(Math.random()*b.length)]:(c.key==="nature/tree-big"?"nature/tree-big-"+(Math.random()<0.5?1:2)+"-"+b[Math.floor(Math.random()*b.length)]:c.key);return c})}},{version:10,name:"adding collected items bucket",run:function(a){a.collectedItems=a.collectedItems||[]}},{version:11,name:"translating playerData coordinates to new mapHeight",run:function(a){a.map.height=36;a.map.entities.forEach(function(b){if("undefined"!==typeof b.y){b.y+=2}})}},{version:12,name:"all your rocks are one rock are belong to me",run:function(a){a.map.entities.map(function(b){if(b.key.indexOf("rock")!==-1){b.key="nature/rock"}return b})}}]}());(function(){var c=function(d,e){wooga.castle.Entity.call(this,d,e);if(!arguments.length){return this}this.whacks=this.definition.whacks};var a=wooga.castle.utils;wooga.castle.utils["extends"](c,wooga.castle.Entity);c.prototype.whack=function(){if(!a.can("whack",this)){return false}this.whacks--;this.game.publish("entity/whack",{entity:this});this.reward("whack");if(!this.whacks){this.game.publish("entity/whack-complete",{entity:this});this.reward("complete")}return true};c.prototype.reward=function(d){var e=(this.definition.rewards||0)[d];if(e){Array.prototype.map.call(e,function(f){this.game.increase(f.type,f.amount,this)},this);this.game.publish("entity/whack-rewards",{entity:this,rewards:e})}};function b(d){if(d.entity){if(/tree/.test(d.entity.key)){return !b.tree}}return true}a.can("whack",b);a.subscribe("game/ready",function(d){a.subscribe("view:entity/whacking",function(e){if(/tree/.test(e.entityView.entity.key)){b.tree=true}}).subscribe("game:entity/whack",function(e){if(/tree/.test(e.entity.key)){b.tree=false}})});wooga.castle.Whackable=c}());(function(){var b=function(c,d){this.parent.call(this,c,d);this.addEventHandler("touch",this.touchHandler,this);if(!d.definition.hasWhackStates){this.getImageFrame=this.parent.prototype.getImageFrame}else{this.frame=0}},a=wooga.castle.utils;a["extends"](b,wooga.castle.EntityView);b.prototype.touchHandler=function(c){if(!a.can("whack",this)){return false}if(!this.busy){if(this.view.game.drain("food",15,this)){this.busy=true;this.makeDynamic();this.view.publish("entity/whacking",{entityView:this,text:this.getWhackActionName(),callback:a.bind(function(){this.entity.whack();this.busy=false;this.makeStatic();this.frame=this.entity.definition.whacks-this.entity.whacks;a.publish("food/drain",{amount:15,text:"-15 Food",entityView:this})},this)})}}};b.prototype.getWhackActionName=function(){return(/rock/i).test(this.entity.key)?"Smashing":"Chopping"};b.prototype.getImageFrame=function(c){var d=c?0:this.frame;return{x:d*this.width,y:(this.entity.definition.spritey||0)*this.view.gridUnit,height:this.height,width:this.width}};wooga.castle.subscribe("game/ready",function(d){var c=d.game;c.subscribe("entity/whack-complete",function(f){var e=f.entity.entityView;if(!e){return}e.view.removeEntityView(e);c.removeEntity(f.entity);c.updateMapData()})},this);wooga.castle.WhackableView=b;a.can("whack",function(c){return a.can("touch-entity",c)})}());(function(){var b=wooga.castle.utils,a=wooga.castle.House,c=function(d,e){this.clicked=e.clicked;this.parent.call(this,d,e);b.subscribe("house/drop",function(f){if(f.item===this.definition.requiredItem){this._setUpgradeable(true);this.fireEvent("contract startable")}},this);this._setUpgradeable((this.contractState!==c.ContractState.STARTED)&&d.playerData.collectedItems.indexOf(this.definition.requiredItem)!==-1);b.subscribe("game:drydock/get required item",this._answerGetRequiredItem,this)};b["extends"](c,a);c.ContractState=b.extend({},a.ContractState);c.prototype._answerGetRequiredItem=function(d){if(d.item!==this.definition.requiredItem){d.item=null}};c.prototype.startContract=function(){if(this.contractState===a.ContractState.IDLE){this.contractState=a.ContractState.STARTED;this.contractStartTime=Date.now();this.contractTimeout=setTimeout(b.bind(this.finishContract,this),this.contract.requiredTime);this.game.publish("contract/start",{entity:this,contract:this.contract,update:{state:this.contractState,startTime:this.contractStartTime}});if(this.upgradable){this.game.publish("drydock/started-stage-repair",{entity:this});this._setUpgradeable(false)}wooga.castle.publish("request-save");this.fireEvent("contractChange")}};c.prototype.upgrade=function(){var e={key:this.definition.upgradeTo,x:this.x,y:this.y};var d=this.game.createEntity(e);this.entityView.bindToEntity(d);this.game.removeEntity(this);if(!d.definition.upgradeTo){d.x-=2;d.y+=4}this.game.updateMapData();d.fireEvent("upgrade");wooga.castle.publish("request-save");return this};c.prototype.collectContract=function(){wooga.castle.House.prototype.collectContract.apply(this,arguments);this._setUpgradeable(false);if(this.definition.upgradeTo){this.upgrade()}};c.prototype.getInfoModeString=function(){var d;if(this.contractState===a.ContractState.STARTED){d='<div class="progress"><div style="width: 0%;"></div></div><p>Repair complete in <span id="timeLeft">'+b.formatTime(this.getContractTimeLeft())+"</span></p>"}else{if(this.definition.upgradeTo){d="<p>Search Mysterious buildings for "+wooga.castle.entityDefinitions[this.definition.requiredItem].name+" first</p>"}else{d="<p>Find the missing Captain to set sail...</p>"}}return d};c.prototype._setUpgradeable=function(d){this.upgradable=d;this.selectable=!this.upgradable;return this};c.prototype.destructor=function(){wooga.castle.House.prototype.destructor.call(this);b.unsubscribe("game:drydock/get required item",this._answerGetRequiredItem,this)};c.prototype.toSerializable=function(){var d=a.prototype.toSerializable.call(this);d.clicked=this.clicked;return d};wooga.castle.Ship=c}());(function(d){var b=function(e,f){this.parent.call(this,e,f);this.actions={};this.actions[this.entity.definition.requiredItem]=true},c=wooga.castle.HouseView,a=wooga.castle.utils;a["extends"](b,c);b.prototype.touchHandler=function(f){if(wooga.castle.playerData.doneTutorial&&!this.entity.clicked){this.entity.clicked=true;this.entity.game.updateMapData();this.setActionIcon();wooga.castle.publish("request save")}if(this.entity.upgradable){a.publish("view:entity/yesno",{entityView:this,entity:this.entity,message:"Do you want to upgrade for "+this.entity.definition.upgradeCost+" gold?",confirm:a.bind(this.entity.startContract,this.entity)})}else{if(this.entity.contractState===wooga.castle.Ship.ContractState.FINISHED){if(!this.busy){this.busy=true;var e=this;setTimeout(a.bind(e.collectContract,e),500)}}}};b.prototype.setActionIcon=function(){if(!this.icon){this.createActionIcon()}var g=this.entity.contractState,e=d.Ship.ContractState,f=this.entity.upgradable?"block":"none",h;if(this.entity.clicked){switch(g){case e.FINISHED:h=this.iconDefinitions.collect;f="block";break;case e.IDLE:h=this.iconDefinitions.start;break;case e.STARTED:h=this.iconDefinitions.running;f="none";break;default:f="none"}}else{f="block";h=this.iconDefinitions.please_touch_me}this._changeActionIconByDefinition(h);this.icon.style.display=f;this.icon.className="ship actionIcon "+g};b.prototype._initIconDefinitions=function(){this.iconDefinitions=this.iconDefinitions||{};var e=this._initIconDefinition("contracts/repair");this.iconDefinitions.start=e;this.iconDefinitions.collect=this._initIconDefinition("contracts/repaired");this.iconDefinitions.running=this._initIconDefinition("contracts/repairing");this.iconDefinitions.please_touch_me=this._initIconDefinition("contracts/exclamation");return this};b.prototype.bindToEntity=function(e){var f;if(this.entity){this.entity.removeEventHandler("upgrade",this.invalidate,this);this.entity.removeEventHandler("contract startable",this.onContractStartable,this);f=this.entity.clicked}this.parent.prototype.bindToEntity.call(this,e);e.addEventHandler("upgrade",this.upgrade,this);e.addEventHandler("contract startable",this.onContractStartable,this);e.clicked=f||e.clicked;this.busy=false;this.actions={};this.actions[this.entity.definition.requiredItem]=true};b.prototype.onContractStartable=function(){this.setActionIcon()};b.prototype.invalidate=function(){this.parent.prototype.invalidate.call(this);if(!this.iconDefinitions){this._initIconDefinitions()}this.setActionIcon()};b.prototype.isFocusable=function(){return !this.busy&&this.entity.selectable&&(this.entity.contractState!==wooga.castle.Ship.ContractState.FINISHED)};b.prototype.upgrade=function(){this.view.publish("ship/upgrading",{entityView:this,text:"Finishing",callback:a.bind(this.invalidate,this)});return this};wooga.castle.ShipView=b}(wooga.castle));(function(){var a=wooga.castle.utils,b=function(c,e,d){this.view=c;this.name=d;this.root=e;b._instances[d]=this;this.attach();this.timeout=null};b._instances={};b.get=function(c){return b._instances[c]};b.prototype.attach=function(){this.element=document.createElement("div");this.element.setAttribute("data-for",this.name);a.addClass(this.element,"doober-tooltip");if("coins"===this.name){this.parentElement=document.getElementById("coins");this.element.style.width=this.parentElement.offsetWidth+"px"}this.root.appendChild(this.element)};b.prototype.add=function(c){if(this.busy){setTimeout(a.bind(function(){this.add(c)},this),300);return this}if("coins"===this.name){this.element.style.width=this.parentElement.offsetWidth+"px"}a.toggleClass(this.element,"on",true);if(this.timeout){clearTimeout(this.timeout)}this.timeout=setTimeout(a.bind(this.hide,this),3000);return this};b.prototype.hide=function(){a.removeClass(this.element,"on");var c=this;this.busy=true;setTimeout(function(){c.element.innerHTML="";c.busy=false},300)};wooga.castle.DooberTooltip=b;wooga.castle.subscribe("game/ready",function(d){var c=document.createElement("div");a.addClass(c,"doober-tooltips");document.getElementById("main-stats").appendChild(c);["coins","food","level","gold-in-goal-sceen"].map(function(e){var f=new b(d.worldView,c,e)})})}());(function(d){var l=d.utils,k,e,h,b=d.Goal,f=d.Goals,g=d.GoalScreen,a=d.GoalLine,j=d.Ship,c=function(p,o,q){q=q||{};this.game=p;this.view=o;this.config=q;this.rootNode=q.rootNode||o.rootNode;this.drydock=this.getDrydock();var n=(function(s){var r;for(r in s){if(s.hasOwnProperty(r)){break}}if(!r){return r}else{s[r].id=r;return s[r]}}(q));this.line=n?new k(this,n,this.getLineGoalID(n.id)):null;this.view.subscribe("drydock/show",function(r){if(wooga.castle.drydockGoals&&wooga.castle.switches.enabledrydock&&this.line){this.show()}else{wooga.castle.publish("entity/coming-soon",r.entityView)}},this);this.view.subscribe("drydock/hide",this.hide,this)};c.prototype.build=function(n){if(!this.line){return}this.template=n;this.line.build();this.invalidateShipState()};c.prototype.show=function(){if(this.line){if((this.line.goal)&&this.line.goal.state===b.State.GOAL_STATE_COLLECTED&&(this.drydock.contractState===j.ContractState.FINISHED)){var n=this.drydock.contract;var o={storyTitle:"Upgrade Complete!",rewards:n.rewards,rootNode:this.rootNode};this.screen=new e(this.view,o).build(d.Goals.template,c.prepareL10n(d.Goals.l10n));this.screen.addEventHandler("hide",function(){this.drydock.upgrade();this.drydock=this.getDrydock();this.line.progressLine();wooga.castle.publish("request-save")},this);this.screen.show()}else{this.line.show()}}return this};c.prototype.hide=function(){if(!this.line){return}this.line.hide();return this};c.prototype.getDrydock=function(){return this.game.entities.filter(function(n){return n.definition["class"]==="ship"})[0]};c.prototype.invalidateShipState=function(){if(this.line.goal&&this.line.goal.state===b.State.GOAL_STATE_COLLECTED){if(j.ContractState.IDLE===this.drydock.contractState){this.drydock.startContract()}}return this};c.prototype.saveLine=function(o,n){this.game.playerData.goalLines[o]=n;return this};c.prototype.getLineGoalID=function(n){return this.game.playerData.goalLines[n]};c.prototype.finishLine=function(){var n=this.drydock;n.move({x:-7,y:14});n.entityView.invalidate();d.playerData.goalLines[this.line.id]=-1;this.line=null};c.prototype.imageSrcFor=f.prototype.imageSrcFor;c.prepareL10n=function(n){return l.extend({},n,{SHARE_GOAL_COMPLETED:"Start",REPAIRING:"Repairing",GOAL_COMPLETED:"Rewards",PLEASE_WAIT_UNTIL_CONSTRUCTION_IS_COMPLETE:"Please wait until construction is complete"})};d.DrydockGoals=c;d.subscribe("goals/template-loaded",function(p){if(d.drydockGoals&&d.switches.enabledrydock){var n=p.game,o=new c(n,n.worldView,d.drydockGoals);o.build(d.Goals.tempalte)}});var m=function(o,n){this.parent.call(this,o,n);this.events.SUBGOALS_COMPLETE=m.Events.SUBGOALS_COMPLETE;this.events.GOAL_COMPLETE=m.Events.GOAL_COMPLETE};l["extends"](m,b);m.Events=l.extend({},b.Events,{GOAL_COMPLETE:"drydockgoal/complete",SUBGOALS_COMPLETE:"drydockgoal/subgoals-complete"});m.State=l.extend({},b.State);d.DrydockGoal=m;k=function(o,n,p){this.parent.apply(this,arguments)};l["extends"](k,a);k.prototype.createGoal=function(n){return new m(n,this)};k.prototype.provideGoalsScreen=function(n,o){n.repairing_img=this.manager.game.entitiesDefinition["contracts/repairing"].image.src;return this.parent.prototype.provideGoalsScreen.call(this,n,c.prepareL10n(o))};k.prototype.provideGoalScreenClass=function(){return h};k.prototype.advance=function(){this.goal.advance();this.screen.invalidate();this.manager.invalidateShipState();if(this.goal.state===b.State.GOAL_STATE_COLLECTED){this.goal.collectRewards();this.hide()}return this};k.prototype.progressLine=function(){this.goal.destructor();this.screen.destructor();a.prototype.progressLine.call(this)};h=function(){return g.apply(this,arguments)};l["extends"](h,g);h.prototype.build=function(){var n=g.prototype.build.apply(this,arguments);l.addClass(this.element,"drydock");return n};h.prototype.invalidate=function(){var n=g.prototype.invalidate.call(this);if(this.goal.state===m.State.GOAL_STATE_COLLECTED){if(this.timer){return}var p=(function(q,t){var s=q.definition.contract.requiredTime,u=q.contractStartTime,r=function(v){return(v<10?"0":"")+v};return function(){var w=s-(Date.now()-u),v=new Date(w);if(w<0){return}t.innerHTML=r(v.getUTCHours())+"h:"+r(v.getUTCMinutes())+"m:"+r(v.getUTCSeconds())+"s"}}(this.manager.manager.drydock,this.element.querySelector(".drydock-screen-repairing .specification h6")));this.timer=setInterval(p,995);p()}var o=d.Viewport.getClientSize();this.element.style.maxHeight=o.height+"px";[].map.call(this.element.querySelectorAll(".screen"),function(q){q.style.maxHeight=o.height+"px"});return n};h.prototype.hide=function(){g.prototype.hide.call(this);if(this.timer){clearInterval(this.timer);this.timer=null}return this};e=function(n,o){this.config=o;this.view=n;this.manager={screenRootNode:o.rootNode};this.flags={collected:false}};l["extends"](e,h);l.mixin(e,l.ObservableMixin);e.prototype.provideTemplateData=function(){return{l10n:l.extend({},this.l10n,{SHARE_GOAL_COMPLETED:"Collect"}),data:this.config}};e.prototype.invalidate=function(){this.setDOMState();return this};e.prototype.setDOMState=function(){this.element.setAttribute("data-state",3);return this};e.prototype.advanceButtonHandler=function(){this.fireEvent("advance");this.hide();return this};e.prototype.cancelButtonHandler=function(){this.fireEvent("cancel");this.hide();return this};e.prototype.collectRewards=function(){if(!this.flags.collected){(this.config.rewards||[]).forEach(function(n){this.view.game.increase(n.type,n.amount,this)},this);this.flags.collected=true}return this};e.prototype.show=function(){this.fireEvent("show");this.collectRewards();this.parent.prototype.show.call(this)};e.prototype.hide=function(){this.fireEvent("hide");this.parent.prototype.hide.call(this);return this}}(wooga.castle));(function(){var a=wooga.castle.utils,c=function(e,d){this.game=e;this.view=d},b=["nature/tree-small-d","nature/tree-small-b","nature/tree-small-y","nature/tree-small-r","nature/tree-big-2-b","nature/tree-big-2-d","nature/tree-big-2-y","nature/tree-big-2-r","nature/tree-big-1-b","nature/tree-big-1-d","nature/tree-big-1-y","nature/tree-big-1-r"];c.prototype.spawnStartup=function(){if(this.getAllowedEnemies()){this.spawn("characters/troll")}};c.prototype.getAllowedEnemies=function(e){e=typeof e==="undefined"?1:e;var d=this.game.entities.filter(function(f){return f.definition["class"]==="enemy"});return Math.max(e-d.length,0)};c.prototype.spawnRandomEnemies=function(e){var f=this.getAllowedEnemies(e);var d=["characters/troll","characters/giant","characters/goblins"];while(f>0){this.spawn(d[Math.floor(Math.random()*d.length)]);f--}};c.prototype.spawn=function(g){var h=this.view,f=this.game;var e=f.createEntity({key:g,x:0,y:0});var d=h.createEntityView(e);if(d.findNewPosition()){d.invalidatePosition()}else{h.removeEntityView(d);f.removeEntity(e)}};c.prototype.spawnAtLocation=function(e){var d=this.view.createEntityView(this.game.createEntity(e));if(e.invalidate||e.invalidate===undefined){d.invalidatePosition()}return d};c.prototype.handleSpawnAtLocationPublish=function(d){d.spawned=this.spawnAtLocation(d)};c.getRandomTreeKey=function(){return b[Math.floor(Math.random()*b.length)]};wooga.castle.Spawner=c;wooga.castle.subscribe("map is alterable",function(e){var d=new c(e.game,e.worldView);d.spawnStartup();a.subscribe("spawn",d.spawn,d);a.subscribe("spawn/tree",function(){this.spawn(c.getRandomTreeKey())},d);a.subscribe("spawn enemy",d.spawnRandomEnemies,d);a.subscribe("spawn at location",d.handleSpawnAtLocationPublish,d)})}());(function(){var b=wooga.castle.House.ContractState;var a=function(c){if(!wooga.castle.isNativeWrapper()){return}this.game=c;this.notificationCandidates=[];this.timeFrames=[5*60,30*60,5*60*60,13*60*60,23.5*60*60,25*60*60];this.filteredNotifs=[];this.initFilteredNotifs();c.subscribe("contract/start",this.startHandler,this);c.subscribe("construction/start",this.startHandler,this);wooga.castle.subscribe("game/ready",function(d){if(this.notificationCandidates.length===0){c.entities.forEach(function(e){if(this.isAllowed(e)){if(e.contractState===b.STARTED||e.contractState===b.CONSTRUCTION){this.addNotifCandidate(e)}}},this);this.filterNotifications();this.scheduleIosNotifs(this.filteredNotifs)}},this)};a.prototype.isAllowed=function(c){return c.is(["any house","farm","unlockable"])};a.prototype.startHandler=function(c){if(!this.isAllowed(c.entity)){return}setTimeout(wooga.castle.utils.bind(function(){this.removeOutdatedNotifs(c);this.addNotifCandidate(c.entity);this.filterNotifications();this.scheduleIosNotifs(this.filteredNotifs)},this),20)};a.prototype.initFilteredNotifs=function(){var c;for(c=0;c<this.timeFrames.length-1;c++){this.filteredNotifs[c]=-1}};a.prototype.removeOutdatedNotifs=function(f){var e,d;var c=Date.now();for(e=this.notificationCandidates.length-1;e>=0;e--){if(this.notificationCandidates[e].date<c){this.notificationCandidates.splice(e,1)}}for(d=0;d<this.filteredNotifs.length;d++){if(this.filteredNotifs[d]!==-1&&this.filteredNotifs[d].date<c){this.filteredNotifs[d]=-1}}};a.prototype.addNotifCandidate=function(g){var h,f,e,d,c,k;for(h=this.notificationCandidates.length-1;h>=0;h--){f=this.notificationCandidates[h];if(g.definition.name===f.entity.definition.name){if(g.contractStartTime&&g.contract.requiredTime===f.entity.contract.requiredTime){e=g.contract.requiredTime;c=g.contractStartTime}else{if(g.constructionStartTime&&g.contract.constructionTime===f.entity.contract.constructionTime){e=g.contract.constructionTime;c=g.constructionStartTime}}if(c){d=f.date-e;k=Date.now()-d;if(k<e*0.2){f.date=c+e;return}}}}var j=g.constructionStartTime?g.constructionStartTime+g.contract.constructionTime:g.contractStartTime+g.contract.requiredTime;this.notificationCandidates.push({date:j,entity:g})};a.prototype.filterNotifications=function(){var g,d,f,e,c;for(e=0;e<this.notificationCandidates.length;e++){f=this.notificationCandidates[e].date-Date.now();for(c=0;c<this.filteredNotifs.length;c++){g=this.timeFrames[c]*1000;d=this.timeFrames[c+1]*1000;if(f>g&&f<=d){if(this.filteredNotifs[c]!==-1){if(this.filteredNotifs[c].date>this.notificationCandidates[e].date){this.filteredNotifs[c]=this.notificationCandidates[e]}}else{this.filteredNotifs[c]=this.notificationCandidates[e]}break}}}};a.prototype.scheduleIosNotifs=function(e){var c,d,g,f="";if(window.plugins&&window.plugins.localNotification&&window.plugins.localNotification.cancelAll){window.plugins.localNotification.cancelAll()}for(d=0;d<e.length;d++){if(e[d]!==-1){c=new Date();c.setSeconds((new Date()).getSeconds()+Math.round((e[d].date-Date.now())/1000));if(e[d].entity.is("any house")){f="A "+e[d].entity.definition.name.toLowerCase()+" is waiting for tax collection!"}if(e[d].entity.is("farm")){f="Your "+this.game.entitiesDefinition[e[d].entity.seedName].name.toLowerCase()+" want to be harvested!"}if(e[d].entity.is("unlockable")){f=e[d].entity.definition.name+" is waiting to be revealed!"}if(e[d].entity.is("ship")){f="The drydock has been repaired!"}g=(e[d].date+d.toString());if(window.plugins&&window.plugins.localNotification&&window.plugins.localNotification.add){window.plugins.localNotification.add({date:c,message:f,badge:0,id:g})}}}};wooga.castle.NotificationHandler=a}());(function(){wooga.castle.Storage={storageTypes:{},config:"",path:"customLocalStorage.txt",save:function(a,b){var c=this.storageTypes[this.config];if(c){c.save(a,b)}},restore:function(a){var b=this.storageTypes[this.config];if(b){return b.restore(a)}},removeItem:function(a){var b=this.storageTypes[this.config];if(b){b.removeItem(a)}},clear:function(){var a=this.storageTypes[this.config];if(a){a.clear()}}};wooga.castle.Storage.storageTypes.local={save:function(a,b){localStorage[a]=JSON.stringify(b)},restore:function(a){return localStorage[a]},removeItem:function(a){localStorage.removeItem(a)},clear:function(){localStorage.clear()}};wooga.castle.Storage.storageTypes.ios={customStorage:{},readData:{},save:function(b,c){var a=wooga.castle.Storage.storageTypes.ios;a.customStorage[b]=c;window.requestFileSystem(LocalFileSystem.PERSISTENT,0,a.write,a.fail)},restore:function(b){var a=wooga.castle.Storage.storageTypes.ios;var c=a.read();return JSON.stringify(a.readData[b])},removeItem:function(b){var a=wooga.castle.Storage.storageTypes.ios;delete this.customStorage[b];window.requestFileSystem(LocalFileSystem.PERSISTENT,0,a.write,a.fail)},clear:function(){var a=wooga.castle.Storage.storageTypes.ios;this.customStorage={};window.requestFileSystem(LocalFileSystem.PERSISTENT,0,a.write,a.fail)},write:function(c,b){var a=wooga.castle.Storage.storageTypes.ios;c.root.getFile("customLocalStorage.txt",{create:true},function(d){d.createWriter(function(e){e.write(JSON.stringify(a.customStorage))},a.fail)},a.fail)},read:function(){var a=wooga.castle.Storage.storageTypes.ios;var b="default";$.ajax({url:"../../Documents/customLocalStorage.txt",async:false,success:function(c){a.readData=JSON.parse(c)}})},fail:function(a){console.log("sth. went wrong in wooga.castle.Storage");console.log(a.code)}}}());if(typeof PhoneGap==="undefined"){if(typeof(DeviceInfo)!=="object"){DeviceInfo={}}PhoneGap={commandQueue:[],commandQueueFlushing:false,_constructors:[],documentEventHandler:{},windowEventHandler:{}};PhoneGap.resources={base:true};PhoneGap.hasResource=function(a){return PhoneGap.resources[a]};PhoneGap.addResource=function(a){PhoneGap.resources[a]=true};PhoneGap.available=DeviceInfo.uuid!=undefined;PhoneGap.addConstructor=function(a){var b=document.readyState;if((b=="loaded"||b=="complete")&&DeviceInfo.uuid!=null){a()}else{PhoneGap._constructors.push(a)}};(function(){var a=setInterval(function(){var c=document.readyState;if((c=="loaded"||c=="complete")&&DeviceInfo.uuid!=null){clearInterval(a);while(PhoneGap._constructors.length>0){var b=PhoneGap._constructors.shift();try{b()}catch(d){if(typeof(console.log)=="function"){console.log("Failed to run constructor: "+console.processMessage(d))}else{alert("Failed to run constructor: "+d.message)}}}var d=document.createEvent("Events");d.initEvent("deviceready");document.dispatchEvent(d)}},1)})();PhoneGap.sessionKey=0;PhoneGap.callbackId=0;PhoneGap.callbacks={};PhoneGap.callbackStatus={NO_RESULT:0,OK:1,CLASS_NOT_FOUND_EXCEPTION:2,ILLEGAL_ACCESS_EXCEPTION:3,INSTANTIATION_EXCEPTION:4,MALFORMED_URL_EXCEPTION:5,IO_EXCEPTION:6,INVALID_ACTION:7,JSON_EXCEPTION:8,ERROR:9};PhoneGap.createGapBridge=function(){gapBridge=document.createElement("iframe");gapBridge.setAttribute("style","display:none;");gapBridge.setAttribute("height","0px");gapBridge.setAttribute("width","0px");gapBridge.setAttribute("frameborder","0");document.documentElement.appendChild(gapBridge);return gapBridge};PhoneGap.exec=function(){if(!PhoneGap.available){alert("ERROR: Attempting to call PhoneGap.exec() before 'deviceready'. Ignoring.");return}var b,g,h,e,c;var a=null;if(typeof arguments[0]!=="string"){b=arguments[0];g=arguments[1];h=arguments[2];e=arguments[3];c=arguments[4];a="INVALID"}else{splitCommand=arguments[0].split(".");e=splitCommand.pop();h=splitCommand.join(".");c=Array.prototype.splice.call(arguments,1)}var d={className:h,methodName:e,arguments:[]};if(b||g){a=h+PhoneGap.callbackId++;PhoneGap.callbacks[a]={success:b,fail:g}}if(a!=null){d.arguments.push(a)}for(var f=0;f<c.length;++f){var j=c[f];if(j==undefined||j==null){continue}else{if(typeof(j)=="object"){d.options=j}else{d.arguments.push(j)}}}PhoneGap.commandQueue.push(JSON.stringify(d));if(PhoneGap.commandQueue.length==1&&!PhoneGap.commandQueueFlushing){if(!PhoneGap.gapBridge){PhoneGap.gapBridge=PhoneGap.createGapBridge()}PhoneGap.gapBridge.src="gap://ready"}};PhoneGap.getAndClearQueuedCommands=function(){json=JSON.stringify(PhoneGap.commandQueue);PhoneGap.commandQueue=[];return json};PhoneGap.callbackSuccess=function(b,a){if(PhoneGap.callbacks[b]){if(a.status==PhoneGap.callbackStatus.OK){try{if(PhoneGap.callbacks[b].success){PhoneGap.callbacks[b].success(a.message)}}catch(c){console.log("Error in success callback: "+b+" = "+c)}}if(!a.keepCallback){delete PhoneGap.callbacks[b]}}};PhoneGap.callbackError=function(b,a){if(PhoneGap.callbacks[b]){try{if(PhoneGap.callbacks[b].fail){PhoneGap.callbacks[b].fail(a.message)}}catch(c){console.log("Error in error callback: "+b+" = "+c)}if(!a.keepCallback){delete PhoneGap.callbacks[b]}}};PhoneGap.clone=function(c){if(!c){return c}if(c instanceof Array){var b=new Array();for(var a=0;a<c.length;++a){b.push(PhoneGap.clone(c[a]))}return b}if(c instanceof Function){return c}if(!(c instanceof Object)){return c}if(c instanceof Date){return c}b=new Object();for(a in c){if(!(a in b)||b[a]!=c[a]){b[a]=PhoneGap.clone(c[a])}}return b};PhoneGap.m_document_addEventListener=document.addEventListener;PhoneGap.m_window_addEventListener=window.addEventListener;PhoneGap.addWindowEventHandler=function(a,b){PhoneGap.windowEventHandler[a]=b};PhoneGap.addDocumentEventHandler=function(a,b){PhoneGap.documentEventHandler[a]=b};document.addEventListener=function(a,c,b){var d=a.toLowerCase();if(typeof PhoneGap.documentEventHandler[d]!=="undefined"){if(PhoneGap.documentEventHandler[d](d,c,true)){return}}PhoneGap.m_document_addEventListener.call(document,a,c,b)};window.addEventListener=function(a,c,b){var d=a.toLowerCase();if(typeof PhoneGap.windowEventHandler[d]!=="undefined"){if(PhoneGap.windowEventHandler[d](d,c,true)){return}}PhoneGap.m_window_addEventListener.call(window,a,c,b)};PhoneGap.m_document_removeEventListener=document.removeEventListener;PhoneGap.m_window_removeEventListener=window.removeEventListener;document.removeEventListener=function(a,c,b){var d=a.toLowerCase();if(typeof PhoneGap.documentEventHandler[d]!=="undefined"){if(PhoneGap.documentEventHandler[d](d,c,false)){return}}PhoneGap.m_document_removeEventListener.call(document,a,c,b)};window.removeEventListener=function(a,c,b){var d=a.toLowerCase();if(typeof PhoneGap.windowEventHandler[d]!=="undefined"){if(PhoneGap.windowEventHandler[d](d,c,false)){return}}PhoneGap.m_window_removeEventListener.call(window,a,c,b)};PhoneGap.fireDocumentEvent=function(b,c){var d=document.createEvent("Events");d.initEvent(b);if(c){for(var a in c){d[a]=c[a]}}document.dispatchEvent(d)};PhoneGap.fireWindowEvent=function(b,c){var d=document.createEvent("Events");d.initEvent(b);if(c){for(var a in c){d[a]=c[a]}}window.dispatchEvent(d)};PhoneGap.fireEvent=function(b,f,c){var d=document.createEvent("Events");d.initEvent(b);if(c){for(var a in c){d[a]=c[a]}}f=f||document;if(f.dispatchEvent===undefined){f=document}f.dispatchEvent(d)};PhoneGap.createUUID=function(){return PhoneGap.UUIDcreatePart(4)+"-"+PhoneGap.UUIDcreatePart(2)+"-"+PhoneGap.UUIDcreatePart(2)+"-"+PhoneGap.UUIDcreatePart(2)+"-"+PhoneGap.UUIDcreatePart(6)};PhoneGap.UUIDcreatePart=function(d){var b="";for(var a=0;a<d;a++){var c=parseInt((Math.random()*256)).toString(16);if(c.length==1){c="0"+c}b+=c}return b}}if(!PhoneGap.hasResource("debugconsole")){PhoneGap.addResource("debugconsole");var DebugConsole=function(){this.winConsole=window.console;this.logLevel=DebugConsole.INFO_LEVEL};DebugConsole.ALL_LEVEL=1;DebugConsole.INFO_LEVEL=1;DebugConsole.WARN_LEVEL=2;DebugConsole.ERROR_LEVEL=4;DebugConsole.NONE_LEVEL=8;DebugConsole.prototype.setLevel=function(a){this.logLevel=a};DebugConsole.prototype.processMessage=function(b,d){if(d===undefined){d=0}if(typeof(b)!="object"){return(this.isDeprecated?"WARNING: debug object is deprecated, please use console object \n"+b:b)}else{function a(e){return e.replace(/^/mg,"    ")}function c(h,k){var j="";for(var f in h){try{if(typeof(h[f])=="object"&&k<d){j+=f+":\n"+a(c(h[f]))+"\n"}else{j+=f+" = "+a(String(h[f])).replace(/^    /,"")+"\n"}}catch(g){j+=f+" = EXCEPTION: "+g.message+"\n"}}return j}return("Object:\n"+c(b,d))}};DebugConsole.prototype.log=function(a,b){if(PhoneGap.available&&this.logLevel<=DebugConsole.INFO_LEVEL){PhoneGap.exec(null,null,"com.phonegap.debugconsole","log",[this.processMessage(a,b),{logLevel:"INFO"}])}else{this.winConsole.log(a)}};DebugConsole.prototype.warn=function(a,b){if(PhoneGap.available&&this.logLevel<=DebugConsole.WARN_LEVEL){PhoneGap.exec(null,null,"com.phonegap.debugconsole","log",[this.processMessage(a,b),{logLevel:"WARN"}])}else{this.winConsole.error(a)}};DebugConsole.prototype.error=function(a,b){if(PhoneGap.available&&this.logLevel<=DebugConsole.ERROR_LEVEL){PhoneGap.exec(null,null,"com.phonegap.debugconsole","log",[this.processMessage(a,b),{logLevel:"ERROR"}])}else{this.winConsole.error(a)}};PhoneGap.addConstructor(function(){window.console=new DebugConsole()})}if(!PhoneGap.hasResource("position")){PhoneGap.addResource("position");Position=function(b,a){this.coords=Coordinates.cloneFrom(b);this.timestamp=a||new Date().getTime()};Position.prototype.equals=function(a){return(this.coords&&a&&a.coords&&this.coords.latitude==a.coords.latitude&&this.coords.longitude==a.coords.longitude)};Position.prototype.clone=function(){return new Position(this.coords?this.coords.clone():null,this.timestamp?this.timestamp:new Date().getTime())};Coordinates=function(f,a,e,d,b,c,g){this.latitude=f;this.longitude=a;this.altitude=e;this.accuracy=d;this.heading=b;this.speed=c;this.altitudeAccuracy=(g!="undefined")?g:null};Coordinates.prototype.clone=function(){return new Coordinates(this.latitude,this.longitude,this.altitude,this.accuracy,this.heading,this.speed,this.altitudeAccuracy)};Coordinates.cloneFrom=function(a){return new Coordinates(a.latitude,a.longitude,a.altitude,a.accuracy,a.heading,a.speed,a.altitudeAccuracy)};PositionOptions=function(b,c,a){this.enableHighAccuracy=b||false;this.timeout=c||10000;this.maximumAge=a||0;if(this.maximumAge<0){this.maximumAge=0}};PositionError=function(b,a){this.code=b||0;this.message=a||""};PositionError.UNKNOWN_ERROR=0;PositionError.PERMISSION_DENIED=1;PositionError.POSITION_UNAVAILABLE=2;PositionError.TIMEOUT=3}if(!PhoneGap.hasResource("acceleration")){PhoneGap.addResource("acceleration");Acceleration=function(a,c,b){this.x=a;this.y=c;this.z=b;this.timestamp=new Date().getTime()};AccelerationOptions=function(){this.timeout=10000}}if(!PhoneGap.hasResource("accelerometer")){PhoneGap.addResource("accelerometer");Accelerometer=function(){this.lastAcceleration=new Acceleration(0,0,0)};Accelerometer.prototype.getCurrentAcceleration=function(a,b,c){if(typeof a=="function"){a(this.lastAcceleration)}};Accelerometer.prototype._onAccelUpdate=function(a,c,b){this.lastAcceleration=new Acceleration(a,c,b)};Accelerometer.prototype.watchAcceleration=function(a,c,d){var e=(d!=undefined&&d.frequency!=undefined)?d.frequency:10000;var b={desiredFrequency:e};PhoneGap.exec(null,null,"com.phonegap.accelerometer","start",[d]);return setInterval(function(){navigator.accelerometer.getCurrentAcceleration(a,c,d)},e)};Accelerometer.prototype.clearWatch=function(a){PhoneGap.exec(null,null,"com.phonegap.accelerometer","stop",[]);clearInterval(a)};Accelerometer.install=function(){if(typeof navigator.accelerometer=="undefined"){navigator.accelerometer=new Accelerometer()}};Accelerometer.installDeviceMotionHandler=function(){if(!(window.DeviceMotionEvent==undefined)){return}var b=this;var a="devicemotion";b.deviceMotionWatchId=null;b.deviceMotionListenerCount=0;b.deviceMotionLastEventTimestamp=0;var e=window.addEventListener;var g=window.removeEventListener;var d=!(window.dispatchEvent===undefined);var c=function(k){var h=document.createEvent("Events");h.initEvent(a);h.acceleration=null;h.rotationRate=null;h.accelerationIncludingGravity=k;var j=new Date().getTime();h.interval=(b.deviceMotionLastEventTimestamp==0)?0:(j-b.deviceMotionLastEventTimestamp);b.deviceMotionLastEventTimestamp=j;if(d){window.dispatchEvent(h)}else{document.dispatchEvent(h)}};var f=function(){};window.addEventListener=function(){if(arguments[0]===a){++(b.deviceMotionListenerCount);if(b.deviceMotionListenerCount==1){b.deviceMotionWatchId=navigator.accelerometer.watchAcceleration(c,f,{frequency:500})}}if(!d){return document.addEventListener.apply(this,arguments)}else{return e.apply(this,arguments)}};window.removeEventListener=function(){if(arguments[0]===a){--(b.deviceMotionListenerCount);if(b.deviceMotionListenerCount==0){navigator.accelerometer.clearWatch(b.deviceMotionWatchId)}}if(!d){return document.removeEventListener.apply(this,arguments)}else{return g.apply(this,arguments)}}};PhoneGap.addConstructor(Accelerometer.install);PhoneGap.addConstructor(Accelerometer.installDeviceMotionHandler)}if(!PhoneGap.hasResource("battery")){PhoneGap.addResource("battery");var Battery=function(){this._level=null;this._isPlugged=null;this._batteryListener=[];this._lowListener=[];this._criticalListener=[]};Battery.prototype.eventHandler=function(a,b,d){var c=navigator.battery;if(d){if(c._batteryListener.length===0&&c._lowListener.length===0&&c._criticalListener.length===0){PhoneGap.exec(c._status,c._error,"com.phonegap.battery","start",[])}if(a==="batterystatus"){var e=c._batteryListener.indexOf(b);if(e===-1){c._batteryListener.push(b)}}else{if(a==="batterylow"){var e=c._lowListener.indexOf(b);if(e===-1){c._lowListener.push(b)}}else{if(a==="batterycritical"){var e=c._criticalListener.indexOf(b);if(e===-1){c._criticalListener.push(b)}}}}}else{if(a==="batterystatus"){var e=c._batteryListener.indexOf(b);if(e>-1){c._batteryListener.splice(e,1)}}else{if(a==="batterylow"){var e=c._lowListener.indexOf(b);if(e>-1){c._lowListener.splice(e,1)}}else{if(a==="batterycritical"){var e=c._criticalListener.indexOf(b);if(e>-1){c._criticalListener.splice(e,1)}}}}if(c._batteryListener.length===0&&c._lowListener.length===0&&c._criticalListener.length===0){PhoneGap.exec(null,null,"com.phonegap.battery","stop",[])}}};Battery.prototype._status=function(b){if(b){var a=this;if(a._level!=b.level||a._isPlugged!=b.isPlugged){PhoneGap.fireEvent("batterystatus",window,b);if(b.level==20||b.level==5){if(b.level==20){PhoneGap.fireEvent("batterylow",window,b)}else{PhoneGap.fireEvent("batterycritical",window,b)}}}a._level=b.level;a._isPlugged=b.isPlugged}};Battery.prototype._error=function(a){console.log("Error initializing Battery: "+a)};PhoneGap.addConstructor(function(){if(typeof navigator.battery==="undefined"){navigator.battery=new Battery();PhoneGap.addWindowEventHandler("batterystatus",navigator.battery.eventHandler);PhoneGap.addWindowEventHandler("batterylow",navigator.battery.eventHandler);PhoneGap.addWindowEventHandler("batterycritical",navigator.battery.eventHandler)}})}if(!PhoneGap.hasResource("camera")){PhoneGap.addResource("camera");Camera=function(){};Camera.DestinationType={DATA_URL:0,FILE_URI:1};Camera.prototype.DestinationType=Camera.DestinationType;Camera.PictureSourceType={PHOTOLIBRARY:0,CAMERA:1,SAVEDPHOTOALBUM:2};Camera.prototype.PictureSourceType=Camera.PictureSourceType;Camera.EncodingType={JPEG:0,PNG:1};Camera.prototype.EncodingType=Camera.EncodingType;Camera.MediaType={PICTURE:0,VIDEO:1,ALLMEDIA:2};Camera.prototype.MediaType=Camera.MediaType;Camera.prototype.getPicture=function(a,b,c){if(typeof a!="function"){console.log("Camera Error: successCallback is not a function");return}if(b&&(typeof b!="function")){console.log("Camera Error: errorCallback is not a function");return}PhoneGap.exec(a,b,"com.phonegap.camera","getPicture",[c])};PhoneGap.addConstructor(function(){if(typeof navigator.camera=="undefined"){navigator.camera=new Camera()}})}if(!PhoneGap.hasResource("device")){PhoneGap.addResource("device");Device=function(){this.platform=null;this.version=null;this.name=null;this.phonegap=null;this.uuid=null;try{this.platform=DeviceInfo.platform;this.version=DeviceInfo.version;this.name=DeviceInfo.name;this.phonegap=DeviceInfo.gap;this.uuid=DeviceInfo.uuid}catch(a){}this.available=PhoneGap.available=this.uuid!=null};PhoneGap.addConstructor(function(){if(typeof navigator.device==="undefined"){navigator.device=window.device=new Device()}})}if(!PhoneGap.hasResource("capture")){PhoneGap.addResource("capture");function CaptureError(){this.code=null}CaptureError.CAPTURE_INTERNAL_ERR=0;CaptureError.CAPTURE_APPLICATION_BUSY=1;CaptureError.CAPTURE_INVALID_ARGUMENT=2;CaptureError.CAPTURE_NO_MEDIA_FILES=3;CaptureError.CAPTURE_NOT_SUPPORTED=20;function Capture(){this.supportedAudioModes=[];this.supportedImageModes=[];this.supportedVideoModes=[]}Capture.prototype.captureAudio=function(a,b,c){PhoneGap.exec(a,b,"com.phonegap.mediacapture","captureAudio",[c])};Capture.prototype.captureImage=function(a,b,c){PhoneGap.exec(a,b,"com.phonegap.mediacapture","captureImage",[c])};Capture.prototype._castMediaFile=function(c){var d=[];var b;for(b=0;b<c.message.length;b++){var a=new MediaFile();a.name=c.message[b].name;a.fullPath=c.message[b].fullPath;a.type=c.message[b].type;a.lastModifiedDate=c.message[b].lastModifiedDate;a.size=c.message[b].size;d.push(a)}c.message=d;return c};Capture.prototype.captureVideo=function(a,b,c){PhoneGap.exec(a,b,"com.phonegap.mediacapture","captureVideo",[c])};function ConfigurationData(){this.type;this.height=0;this.width=0}var CaptureImageOptions=function(){this.limit=1;this.mode=null};var CaptureVideoOptions=function(){this.limit=1;this.duration=0;this.mode=null};var CaptureAudioOptions=function(){this.limit=1;this.duration=0;this.mode=null};function MediaFile(c,b,e,a,d){this.name=c||null;this.fullPath=b||null;this.type=e||null;this.lastModifiedDate=a||null;this.size=d||0}MediaFile.prototype.getFormatData=function(a,b){if(typeof this.fullPath==="undefined"||this.fullPath===null){b({code:CaptureError.CAPTURE_INVALID_ARGUMENT})}else{PhoneGap.exec(a,b,"com.phonegap.mediacapture","getFormatData",[this.fullPath,this.type])}};function MediaFileData(b,d,a,c,e){this.codecs=b||null;this.bitrate=d||0;this.height=a||0;this.width=c||0;this.duration=e||0}PhoneGap.addConstructor(function(){if(typeof navigator.device==="undefined"){navigator.device=window.device=new Device()}if(typeof navigator.device.capture==="undefined"){navigator.device.capture=window.device.capture=new Capture()}})}if(!PhoneGap.hasResource("contact")){PhoneGap.addResource("contact");var Contact=function(c,l,a,h,e,g,d,n,b,m,k,o,f,j){this.id=c||null;this.displayName=l||null;this.name=a||null;this.nickname=h||null;this.phoneNumbers=e||null;this.emails=g||null;this.addresses=d||null;this.ims=n||null;this.organizations=b||null;this.birthday=m||null;this.note=k||null;this.photos=o||null;this.categories=f||null;this.urls=j||null};Contact.prototype.convertDatesOut=function(){var d=new Array("birthday");for(var b=0;b<d.length;b++){var c=this[d[b]];if(c){if(!c instanceof Date){try{c=new Date(c)}catch(a){c=null}}if(c instanceof Date){c=c.valueOf()}this[d[b]]=c}}};Contact.prototype.convertDatesIn=function(){var d=new Array("birthday");for(var b=0;b<d.length;b++){var c=this[d[b]];if(c){try{this[d[b]]=new Date(parseFloat(c))}catch(a){console.log("exception creating date")}}}};Contact.prototype.remove=function(c,a){if(this.id==null){var b=new ContactError();b.code=ContactError.UNKNOWN_ERROR;a(b)}else{PhoneGap.exec(c,a,"com.phonegap.contacts","remove",[{contact:this}])}};Contact.prototype.display=function(b,a){if(this.id==null){if(typeof b=="function"){var c=new ContactError();c.code=ContactError.UNKNOWN_ERROR;b(c)}}else{PhoneGap.exec(null,b,"com.phonegap.contacts","displayContact",[this.id,a])}};Contact.prototype.clone=function(){var a=PhoneGap.clone(this);a.id=null;if(a.phoneNumbers){for(i=0;i<a.phoneNumbers.length;i++){a.phoneNumbers[i].id=null}}if(a.emails){for(i=0;i<a.emails.length;i++){a.emails[i].id=null}}if(a.addresses){for(i=0;i<a.addresses.length;i++){a.addresses[i].id=null}}if(a.ims){for(i=0;i<a.ims.length;i++){a.ims[i].id=null}}if(a.organizations){for(i=0;i<a.organizations.length;i++){a.organizations[i].id=null}}if(a.photos){for(i=0;i<a.photos.length;i++){a.photos[i].id=null}}if(a.urls){for(i=0;i<a.urls.length;i++){a.urls[i].id=null}}return a};Contact.prototype.save=function(c,b){var a=PhoneGap.clone(this);a.convertDatesOut();PhoneGap.exec(c,b,"com.phonegap.contacts","save",[{contact:a}])};var ContactName=function(e,a,c,b,d,f){this.formatted=e!="undefined"?e:null;this.familyName=a!="undefined"?a:null;this.givenName=c!="undefined"?c:null;this.middleName=b!="undefined"?b:null;this.honorificPrefix=d!="undefined"?d:null;this.honorificSuffix=f!="undefined"?f:null};var ContactField=function(b,c,a,d){this.type=b!="undefined"?b:null;this.value=c!="undefined"?c:null;this.pref=a!="undefined"?a:null;this.id=d!="undefined"?d:null};var ContactAddress=function(j,e,d,f,g,h,a,c,b){this.pref=j!="undefined"?j:null;this.type=e!="undefined"?e:null;this.formatted=d!="undefined"?d:null;this.streetAddress=f!="undefined"?f:null;this.locality=g!="undefined"?g:null;this.region=h!="undefined"?h:null;this.postalCode=a!="undefined"?a:null;this.country=c!="undefined"?c:null;this.id=b!="undefined"?b:null};var ContactOrganization=function(a,c,b,d,e){this.pref=a!="undefined"?a:null;this.type=c!="undefined"?c:null;this.name=b!="undefined"?b:null;this.department=d!="undefined"?d:null;this.title=e!="undefined"?e:null};var Contacts=function(){this.inProgress=false;this.records=new Array()};Contacts.prototype.find=function(a,d,c,b){if(d===null){throw new TypeError("You must specify a success callback for the find command.")}if(a===null||a==="undefined"||a.length==="undefined"||a.length<=0){if(typeof c==="function"){c({code:ContactError.INVALID_ARGUMENT_ERROR})}}else{PhoneGap.exec(d,c,"com.phonegap.contacts","search",[{fields:a,findOptions:b}])}};Contacts.prototype._findCallback=function(b){var d=new Array();try{for(var a=0;a<b.message.length;a++){var c=navigator.contacts.create(b.message[a]);c.convertDatesIn();d.push(c)}b.message=d}catch(f){console.log("Error parsing contacts: "+f)}return b};Contacts.prototype._contactCallback=function(a){var b=null;if(a.message){try{b=navigator.contacts.create(a.message);b.convertDatesIn()}catch(c){console.log("Error parsing contact")}}a.message=b;return a};Contacts.prototype._errCallback=function(a){var b=new ContactError();b.code=a.message;a.message=b;return a};Contacts.prototype.newContactUI=function(a){PhoneGap.exec(a,null,"com.phonegap.contacts","newContact",[])};Contacts.prototype.chooseContact=function(a,b){PhoneGap.exec(a,null,"com.phonegap.contacts","chooseContact",b)};Contacts.prototype.create=function(c){var b;var a=new Contact();for(b in c){if(a[b]!=="undefined"){a[b]=c[b]}}return a};var ContactFindOptions=function(c,a,b){this.filter=c||"";this.multiple=a||false};var ContactError=function(){this.code=null};ContactError.UNKNOWN_ERROR=0;ContactError.INVALID_ARGUMENT_ERROR=1;ContactError.TIMEOUT_ERROR=2;ContactError.PENDING_OPERATION_ERROR=3;ContactError.IO_ERROR=4;ContactError.NOT_SUPPORTED_ERROR=5;ContactError.PERMISSION_DENIED_ERROR=20;PhoneGap.addConstructor(function(){if(typeof navigator.contacts=="undefined"){navigator.contacts=new Contacts()}})}if(!PhoneGap.hasResource("file")){PhoneGap.addResource("file");FileProperties=function(a){this.filePath=a;this.size=0;this.lastModifiedDate=null};File=function(c,b,e,a,d){this.name=c||null;this.fullPath=b||null;this.type=e||null;this.lastModifiedDate=a||null;this.size=d||0};File._createEvent=function(b,c){var a={type:b};a.target=c;return a};FileError=function(){this.code=null};FileError.NOT_FOUND_ERR=1;FileError.SECURITY_ERR=2;FileError.ABORT_ERR=3;FileError.NOT_READABLE_ERR=4;FileError.ENCODING_ERR=5;FileError.NO_MODIFICATION_ALLOWED_ERR=6;FileError.INVALID_STATE_ERR=7;FileError.SYNTAX_ERR=8;FileError.INVALID_MODIFICATION_ERR=9;FileError.QUOTA_EXCEEDED_ERR=10;FileError.TYPE_MISMATCH_ERR=11;FileError.PATH_EXISTS_ERR=12;FileMgr=function(){};FileMgr.prototype.testFileExists=function(c,a,b){PhoneGap.exec(a,b,"com.phonegap.file","testFileExists",[c])};FileMgr.prototype.testDirectoryExists=function(c,a,b){PhoneGap.exec(a,b,"com.phonegap.file","testDirectoryExists",[c])};FileMgr.prototype.getFreeDiskSpace=function(a,b){PhoneGap.exec(a,b,"com.phonegap.file","getFreeDiskSpace",[])};FileMgr.prototype.write=function(e,d,b,a,c){PhoneGap.exec(a,c,"com.phonegap.file","write",[e,d,b])};FileMgr.prototype.truncate=function(d,c,a,b){PhoneGap.exec(a,b,"com.phonegap.file","truncateFile",[d,c])};FileMgr.prototype.readAsText=function(d,c,a,b){PhoneGap.exec(a,b,"com.phonegap.file","readFile",[d,c])};FileMgr.prototype.readAsDataURL=function(c,a,b){PhoneGap.exec(a,b,"com.phonegap.file","readAsDataURL",[c])};PhoneGap.addConstructor(function(){if(typeof navigator.fileMgr==="undefined"){navigator.fileMgr=new FileMgr()}});FileReader=function(){this.fileName="";this.readyState=0;this.result=null;this.error=null;this.onloadstart=null;this.onprogress=null;this.onload=null;this.onerror=null;this.onloadend=null;this.onabort=null};FileReader.EMPTY=0;FileReader.LOADING=1;FileReader.DONE=2;FileReader.prototype.abort=function(){var a;this.readyState=FileReader.DONE;this.result=null;var b=new FileError();b.code=b.ABORT_ERR;this.error=b;if(typeof this.onerror==="function"){a=File._createEvent("error",this);this.onerror(a)}if(typeof this.onabort==="function"){a=File._createEvent("abort",this);this.onabort(a)}if(typeof this.onloadend==="function"){a=File._createEvent("loadend",this);this.onloadend(a)}};FileReader.prototype.readAsText=function(c,e){this.fileName="";if(typeof c.fullPath==="undefined"){this.fileName=c}else{this.fileName=c.fullPath}this.readyState=FileReader.LOADING;if(typeof this.onloadstart==="function"){var a=File._createEvent("loadstart",this);this.onloadstart(a)}var b=e?e:"UTF-8";var d=this;navigator.fileMgr.readAsText(this.fileName,b,function(g){var f;if(d.readyState===FileReader.DONE){return}d.result=decodeURIComponent(g);if(typeof d.onload==="function"){f=File._createEvent("load",d);d.onload(f)}d.readyState=FileReader.DONE;if(typeof d.onloadend==="function"){f=File._createEvent("loadend",d);d.onloadend(f)}},function(g){var f;if(d.readyState===FileReader.DONE){return}d.error=g;if(typeof d.onerror==="function"){f=File._createEvent("error",d);d.onerror(f)}d.readyState=FileReader.DONE;if(typeof d.onloadend==="function"){f=File._createEvent("loadend",d);d.onloadend(f)}})};FileReader.prototype.readAsDataURL=function(b){this.fileName="";if(typeof b.fullPath==="undefined"){this.fileName=b}else{this.fileName=b.fullPath}this.readyState=FileReader.LOADING;if(typeof this.onloadstart==="function"){var a=File._createEvent("loadstart",this);this.onloadstart(a)}var c=this;navigator.fileMgr.readAsDataURL(this.fileName,function(e){var d;if(c.readyState===FileReader.DONE){return}c.result=e;if(typeof c.onload==="function"){d=File._createEvent("load",c);c.onload(d)}c.readyState=FileReader.DONE;if(typeof c.onloadend==="function"){d=File._createEvent("loadend",c);c.onloadend(d)}},function(f){var d;if(c.readyState===FileReader.DONE){return}c.error=f;if(typeof c.onerror==="function"){d=File._createEvent("error",c);c.onerror(d)}c.readyState=FileReader.DONE;if(typeof c.onloadend==="function"){d=File._createEvent("loadend",c);c.onloadend(d)}})};FileReader.prototype.readAsBinaryString=function(a){this.fileName=a};FileReader.prototype.readAsArrayBuffer=function(a){this.fileName=a};FileWriter=function(a){this.fileName="";this.length=0;if(a){this.fileName=a.fullPath||a;this.length=a.size||0}this.position=0;this.readyState=0;this.result=null;this.error=null;this.onwritestart=null;this.onprogress=null;this.onwrite=null;this.onwriteend=null;this.onabort=null;this.onerror=null};FileWriter.INIT=0;FileWriter.WRITING=1;FileWriter.DONE=2;FileWriter.prototype.abort=function(){if(this.readyState===FileWriter.DONE||this.readyState===FileWriter.INIT){throw FileError.INVALID_STATE_ERR}var b=new FileError(),a;b.code=b.ABORT_ERR;this.error=b;if(typeof this.onerror==="function"){a=File._createEvent("error",this);this.onerror(a)}if(typeof this.onabort==="function"){a=File._createEvent("abort",this);this.onabort(a)}this.readyState=FileWriter.DONE;if(typeof this.onwriteend=="function"){a=File._createEvent("writeend",this);this.onwriteend(a)}};FileWriter.prototype.writeAsText=function(c,e,a){if(this.readyState===FileWriter.WRITING){throw FileError.INVALID_STATE_ERR}if(a!==true){a=false}this.fileName=c;this.readyState=FileWriter.WRITING;var d=this;if(typeof d.onwritestart==="function"){var b=File._createEvent("writestart",d);d.onwritestart(b)}navigator.fileMgr.writeAsText(c,e,a,function(g){var f;if(d.readyState===FileWriter.DONE){return}d.result=g;if(typeof d.onwrite==="function"){f=File._createEvent("write",d);d.onwrite(f)}d.readyState=FileWriter.DONE;if(typeof d.onwriteend==="function"){f=File._createEvent("writeend",d);d.onwriteend(f)}},function(g){var f;if(d.readyState===FileWriter.DONE){return}d.error=g;if(typeof d.onerror==="function"){f=File._createEvent("error",d);d.onerror(f)}d.readyState=FileWriter.DONE;if(typeof d.onwriteend==="function"){f=File._createEvent("writeend",d);d.onwriteend(f)}})};FileWriter.prototype.write=function(c){if(this.readyState===FileWriter.WRITING){throw FileError.INVALID_STATE_ERR}this.readyState=FileWriter.WRITING;var b=this;if(typeof b.onwritestart==="function"){var a=File._createEvent("writestart",b);b.onwritestart(a)}navigator.fileMgr.write(this.fileName,c,this.position,function(e){var d;if(b.readyState===FileWriter.DONE){return}b.position+=e;b.length=b.position;if(typeof b.onwrite==="function"){d=File._createEvent("write",b);b.onwrite(d)}b.readyState=FileWriter.DONE;if(typeof b.onwriteend==="function"){d=File._createEvent("writeend",b);b.onwriteend(d)}},function(f){var d;if(b.readyState===FileWriter.DONE){return}b.error=f;if(typeof b.onerror==="function"){d=File._createEvent("error",b);b.onerror(d)}b.readyState=FileWriter.DONE;if(typeof b.onwriteend==="function"){d=File._createEvent("writeend",b);b.onwriteend(d)}})};FileWriter.prototype.seek=function(a){if(this.readyState===FileWriter.WRITING){throw FileError.INVALID_STATE_ERR}if(!a){return}if(a<0){this.position=Math.max(a+this.length,0)}else{if(a>this.length){this.position=this.length}else{this.position=a}}};FileWriter.prototype.truncate=function(b){if(this.readyState===FileWriter.WRITING){throw FileError.INVALID_STATE_ERR}this.readyState=FileWriter.WRITING;var c=this;if(typeof c.onwritestart==="function"){var a=File._createEvent("writestart",c);c.onwritestart(a)}navigator.fileMgr.truncate(this.fileName,b,function(e){var d;if(c.readyState===FileWriter.DONE){return}c.length=e;c.position=Math.min(c.position,e);if(typeof c.onwrite==="function"){d=File._createEvent("write",c);c.onwrite(d)}c.readyState=FileWriter.DONE;if(typeof c.onwriteend==="function"){d=File._createEvent("writeend",c);c.onwriteend(d)}},function(f){var d;if(c.readyState===FileWriter.DONE){return}c.error=f;if(typeof c.onerror==="function"){d=File._createEvent("error",c);c.onerror(d)}c.readyState=FileWriter.DONE;if(typeof c.onwriteend==="function"){d=File._createEvent("writeend",c);c.onwriteend(d)}})};LocalFileSystem=function(){};LocalFileSystem.TEMPORARY=0;LocalFileSystem.PERSISTENT=1;LocalFileSystem.RESOURCE=2;LocalFileSystem.APPLICATION=3;LocalFileSystem.prototype.requestFileSystem=function(d,c,a,b){if(d<0||d>3){if(typeof b=="function"){b({code:FileError.SYNTAX_ERR})}}else{PhoneGap.exec(a,b,"com.phonegap.file","requestFileSystem",[d,c])}};LocalFileSystem.prototype.resolveLocalFileSystemURI=function(c,a,b){PhoneGap.exec(a,b,"com.phonegap.file","resolveLocalFileSystemURI",[c])};LocalFileSystem.prototype._castFS=function(a){var b=null;b=new DirectoryEntry();b.isDirectory=a.message.root.isDirectory;b.isFile=a.message.root.isFile;b.name=a.message.root.name;b.fullPath=a.message.root.fullPath;a.message.root=b;return a};LocalFileSystem.prototype._castEntry=function(a){var b=null;if(a.message.isDirectory){b=new DirectoryEntry()}else{if(a.message.isFile){b=new FileEntry()}}b.isDirectory=a.message.isDirectory;b.isFile=a.message.isFile;b.name=a.message.name;b.fullPath=a.message.fullPath;a.message=b;return a};LocalFileSystem.prototype._castEntries=function(b){var a=b.message;var c=[];for(i=0;i<a.length;i++){c.push(window.localFileSystem._createEntry(a[i]))}b.message=c;return b};LocalFileSystem.prototype._createEntry=function(a){var b=null;if(a.isDirectory){b=new DirectoryEntry()}else{if(a.isFile){b=new FileEntry()}}b.isDirectory=a.isDirectory;b.isFile=a.isFile;b.name=a.name;b.fullPath=a.fullPath;return b};LocalFileSystem.prototype._castDate=function(c){if(c.message.modificationTime){var a=new Metadata();a.modificationTime=new Date(c.message.modificationTime);c.message=a}else{if(c.message.lastModifiedDate){var b=new File();b.size=c.message.size;b.type=c.message.type;b.name=c.message.name;b.fullPath=c.message.fullPath;b.lastModifiedDate=new Date(c.message.lastModifiedDate);c.message=b}}return c};LocalFileSystem.prototype._castError=function(a){var b=new FileError();b.code=a.message;a.message=b;return a};Metadata=function(){this.modificationTime=null};Flags=function(a,b){this.create=a||false;this.exclusive=b||false};FileSystem=function(){this.name=null;this.root=null};DirectoryEntry=function(){this.isFile=false;this.isDirectory=true;this.name=null;this.fullPath=null;this.filesystem=null};DirectoryEntry.prototype.copyTo=function(d,b,a,c){PhoneGap.exec(a,c,"com.phonegap.file","copyTo",[this.fullPath,d,b])};DirectoryEntry.prototype.getMetadata=function(a,b){PhoneGap.exec(a,b,"com.phonegap.file","getMetadata",[this.fullPath])};DirectoryEntry.prototype.getParent=function(a,b){PhoneGap.exec(a,b,"com.phonegap.file","getParent",[this.fullPath])};DirectoryEntry.prototype.moveTo=function(d,b,a,c){PhoneGap.exec(a,c,"com.phonegap.file","moveTo",[this.fullPath,d,b])};DirectoryEntry.prototype.remove=function(a,b){PhoneGap.exec(a,b,"com.phonegap.file","remove",[this.fullPath])};DirectoryEntry.prototype.toURI=function(c,a,b){return"file://localhost"+this.fullPath};DirectoryEntry.prototype.createReader=function(a,b){return new DirectoryReader(this.fullPath)};DirectoryEntry.prototype.getDirectory=function(d,c,a,b){PhoneGap.exec(a,b,"com.phonegap.file","getDirectory",[this.fullPath,d,c])};DirectoryEntry.prototype.getFile=function(d,c,a,b){PhoneGap.exec(a,b,"com.phonegap.file","getFile",[this.fullPath,d,c])};DirectoryEntry.prototype.removeRecursively=function(a,b){PhoneGap.exec(a,b,"com.phonegap.file","removeRecursively",[this.fullPath])};DirectoryReader=function(a){this.fullPath=a||null};DirectoryReader.prototype.readEntries=function(a,b){PhoneGap.exec(a,b,"com.phonegap.file","readEntries",[this.fullPath])};FileEntry=function(){this.isFile=true;this.isDirectory=false;this.name=null;this.fullPath=null;this.filesystem=null};FileEntry.prototype.copyTo=function(d,b,a,c){PhoneGap.exec(a,c,"com.phonegap.file","copyTo",[this.fullPath,d,b])};FileEntry.prototype.getMetadata=function(a,b){PhoneGap.exec(a,b,"com.phonegap.file","getMetadata",[this.fullPath])};FileEntry.prototype.getParent=function(a,b){PhoneGap.exec(a,b,"com.phonegap.file","getParent",[this.fullPath])};FileEntry.prototype.moveTo=function(d,b,a,c){PhoneGap.exec(a,c,"com.phonegap.file","moveTo",[this.fullPath,d,b])};FileEntry.prototype.remove=function(a,b){PhoneGap.exec(a,b,"com.phonegap.file","remove",[this.fullPath])};FileEntry.prototype.toURI=function(c,a,b){return"file://localhost"+this.fullPath};FileEntry.prototype.createWriter=function(a,b){this.file(function(c){var d=new FileWriter(c);if(d.fileName==null||d.fileName==""){if(typeof b=="function"){b({code:FileError.INVALID_STATE_ERR})}}if(typeof a=="function"){a(d)}},b)};FileEntry.prototype.file=function(a,b){PhoneGap.exec(a,b,"com.phonegap.file","getFileMetadata",[this.fullPath])};PhoneGap.addConstructor(function(){var a=new LocalFileSystem();if(typeof window.localFileSystem=="undefined"){window.localFileSystem=a}if(typeof window.requestFileSystem=="undefined"){window.requestFileSystem=a.requestFileSystem}if(typeof window.resolveLocalFileSystemURI=="undefined"){window.resolveLocalFileSystemURI=a.resolveLocalFileSystemURI}})}if(!PhoneGap.hasResource("filetransfer")){PhoneGap.addResource("filetransfer");FileTransfer=function(){};FileUploadResult=function(){this.bytesSent=0;this.responseCode=null;this.response=null};FileTransferError=function(a){this.code=a||null};FileTransferError.FILE_NOT_FOUND_ERR=1;FileTransferError.INVALID_URL_ERR=2;FileTransferError.CONNECTION_ERR=3;FileTransfer.prototype.upload=function(d,e,a,b,c){if(!c.params){c.params={}}c.filePath=d;c.server=e;if(!c.fileKey){c.fileKey="file"}if(!c.fileName){c.fileName="image.jpg"}if(!c.mimeType){c.mimeType="image/jpeg"}if(typeof a!="function"){console.log("FileTransfer Error: successCallback is not a function");return}if(b&&(typeof b!="function")){console.log("FileTransfer Error: errorCallback is not a function");return}PhoneGap.exec(a,b,"com.phonegap.filetransfer","upload",[c])};FileTransfer.prototype._castTransferError=function(a){var b=new FileTransferError(a.message);a.message=b;return a};FileTransfer.prototype._castUploadResult=function(b){var a=new FileUploadResult();a.bytesSent=b.message.bytesSent;a.responseCode=b.message.responseCode;a.response=decodeURIComponent(b.message.response);b.message=a;return b};FileUploadOptions=function(a,d,c,b){this.fileKey=a||null;this.fileName=d||null;this.mimeType=c||null;this.params=b||null};PhoneGap.addConstructor(function(){if(typeof navigator.fileTransfer=="undefined"){navigator.fileTransfer=new FileTransfer()}})}if(!PhoneGap.hasResource("geolocation")){PhoneGap.addResource("geolocation");Geolocation=function(){this.lastPosition=null;this.listener=null;this.timeoutTimerId=0};Geolocation.prototype.getCurrentPosition=function(c,f,l){var g=c;if(!g||typeof(g)!="function"){g=function(m){}}var d=f;if(!d||typeof(d)!="function"){d=function(m){}}var k=this;var a=0;var h;var e=new PositionOptions();if(l){if(l.maximumAge){if(this.lastPosition){var b=new Date().getTime();if((b-this.lastPosition.timestamp)<l.maximumAge){g(this.lastPosition);return}}e.maximumAge=l.maximumAge}if(l.enableHighAccuracy){e.enableHighAccuracy=(l.enableHighAccuracy==true)}if(l.timeout){e.timeout=l.timeout}}this.listener={success:g,fail:d};this.start(e);var j=function(){k.setError(new PositionError(PositionError.TIMEOUT,"Geolocation Error: Timeout."))};clearTimeout(this.timeoutTimerId);this.timeoutTimerId=setTimeout(j,e.timeout)};Geolocation.prototype.watchPosition=function(a,c,d){var b=this;var h=new PositionOptions();if(d){if(d.maximumAge){h.maximumAge=d.maximumAge}if(d.enableHighAccuracy){h.enableHighAccuracy=d.enableHighAccuracy}if(d.timeout){h.timeout=d.timeout}}var e=this;var f=e.lastPosition?e.lastPosition.clone():null;var g=function(){var j=function(k){if(f==null||!k.equals(f)){a(k)}f=k.clone()};e.getCurrentPosition(j,c,h)};g();return setInterval(g,h.timeout)};Geolocation.prototype.clearWatch=function(a){clearInterval(a)};Geolocation.prototype.setLocation=function(a){var b=new Position(a.coords,a.timestamp);if(this.timeoutTimerId){clearTimeout(this.timeoutTimerId);this.timeoutTimerId=0}this.lastError=null;this.lastPosition=b;if(this.listener&&typeof(this.listener.success)=="function"){this.listener.success(b)}this.listener=null};Geolocation.prototype.setError=function(a){var b=new PositionError(a.code,a.message);if(this.timeoutTimerId){clearTimeout(this.timeoutTimerId);this.timeoutTimerId=0}this.lastError=b;if(this.listener&&typeof(this.listener.fail)=="function"){this.listener.fail(b)}this.listener=null};Geolocation.prototype.start=function(a){PhoneGap.exec(null,null,"com.phonegap.geolocation","startLocation",[a])};Geolocation.prototype.stop=function(){PhoneGap.exec(null,null,"com.phonegap.geolocation","stopLocation",[])};PhoneGap.addConstructor(function(){if(typeof navigator._geo=="undefined"){var a=function(f,d,e){var b=function(j,g,h){j[h]=function(){return g[h].apply(g,arguments)}};for(var c in e){b(f,d,e[c])}};navigator._geo=new Geolocation();a(navigator.geolocation,navigator._geo,["setLocation","getCurrentPosition","watchPosition","clearWatch","setError","start","stop"])}})}if(!PhoneGap.hasResource("compass")){PhoneGap.addResource("compass");CompassError=function(){this.code=null};CompassError.COMPASS_INTERNAL_ERR=0;CompassError.COMPASS_NOT_SUPPORTED=20;CompassHeading=function(){this.magneticHeading=null;this.trueHeading=null;this.headingAccuracy=null;this.timestamp=null};Compass=function(){this.timers={}};Compass.prototype.getCurrentHeading=function(a,b,c){if(typeof a!=="function"){console.log("Compass Error: successCallback is not a function");return}if(b&&(typeof b!=="function")){console.log("Compass Error: errorCallback is not a function");return}PhoneGap.exec(a,b,"com.phonegap.geolocation","getCurrentHeading",[])};Compass.prototype.watchHeading=function(a,b,c){var d=(c!==undefined)?c.frequency:100;if(typeof a!=="function"){console.log("Compass Error: successCallback is not a function");return}if(b&&(typeof b!=="function")){console.log("Compass Error: errorCallback is not a function");return}var e=PhoneGap.createUUID();navigator.compass.timers[e]=setInterval(function(){PhoneGap.exec(a,b,"com.phonegap.geolocation","getCurrentHeading",[{repeats:1}])},d);return e};Compass.prototype.clearWatch=function(a){if(a&&navigator.compass.timers[a]){clearInterval(navigator.compass.timers[a]);delete navigator.compass.timers[a]}if(navigator.compass.timers.length==0){PhoneGap.exec(null,null,"com.phonegap.geolocation","stopHeading",[])}};Compass.prototype.watchHeadingFilter=function(a,b,c){if(c===undefined||c.filter===undefined){console.log("Compass Error:  options.filter not specified");return}if(typeof a!=="function"){console.log("Compass Error: successCallback is not a function");return}if(b&&(typeof b!=="function")){console.log("Compass Error: errorCallback is not a function");return}PhoneGap.exec(a,b,"com.phonegap.geolocation","watchHeadingFilter",[c])};Compass.prototype.clearWatchFilter=function(){PhoneGap.exec(null,null,"com.phonegap.geolocation","stopHeading",[])};PhoneGap.addConstructor(function(){if(typeof navigator.compass=="undefined"){navigator.compass=new Compass()}})}if(!PhoneGap.hasResource("media")){PhoneGap.addResource("media");PhoneGap.mediaObjects={};PhoneGap.Media=function(){};PhoneGap.Media.getMediaObject=function(a){return PhoneGap.mediaObjects[a]};PhoneGap.Media.onStatus=function(d,c,a){var b=PhoneGap.mediaObjects[d];if(c==Media.MEDIA_STATE){if(a==Media.MEDIA_STOPPED){if(b.successCallback){b.successCallback()}}if(b.statusCallback){b.statusCallback(a)}}else{if(c==Media.MEDIA_DURATION){b._duration=a}else{if(c==Media.MEDIA_ERROR){if(b.errorCallback){b.errorCallback(a)}}else{if(c==Media.MEDIA_POSITION){b._position=a}}}}};Media=function(e,a,c,b,d){if(a&&(typeof a!="function")){console.log("Media Error: successCallback is not a function");return}if(c&&(typeof c!="function")){console.log("Media Error: errorCallback is not a function");return}if(b&&(typeof b!="function")){console.log("Media Error: statusCallback is not a function");return}if(d&&(typeof d!="function")){console.log("Media Error: positionCallback is not a function");return}this.id=PhoneGap.createUUID();PhoneGap.mediaObjects[this.id]=this;this.src=e;this.successCallback=a;this.errorCallback=c;this.statusCallback=b;this.positionCallback=d;this._duration=-1;this._position=-1};Media.MEDIA_STATE=1;Media.MEDIA_DURATION=2;Media.MEDIA_POSITION=3;Media.MEDIA_ERROR=9;Media.MEDIA_NONE=0;Media.MEDIA_STARTING=1;Media.MEDIA_RUNNING=2;Media.MEDIA_PAUSED=3;Media.MEDIA_STOPPED=4;Media.MEDIA_MSG=["None","Starting","Running","Paused","Stopped"];MediaError=function(){this.code=null,this.message=""};MediaError.MEDIA_ERR_ABORTED=1;MediaError.MEDIA_ERR_NETWORK=2;MediaError.MEDIA_ERR_DECODE=3;MediaError.MEDIA_ERR_NONE_SUPPORTED=4;Media.prototype.play=function(a){PhoneGap.exec(null,null,"com.phonegap.media","play",[this.id,this.src,a])};Media.prototype.stop=function(){PhoneGap.exec(null,null,"com.phonegap.media","stop",[this.id,this.src])};Media.prototype.pause=function(){PhoneGap.exec(null,null,"com.phonegap.media","pause",[this.id,this.src])};Media.prototype.seekTo=function(a){PhoneGap.exec(null,null,"com.phonegap.media","seekTo",[this.id,this.src,a])};Media.prototype.getDuration=function(){return this._duration};Media.prototype.getCurrentPosition=function(c,b){var a=(b==undefined||b==null)?null:b;PhoneGap.exec(c,b,"com.phonegap.media","getCurrentPosition",[this.id,this.src])};Media.prototype.prepare=function(b,a){PhoneGap.exec(b,a,"com.phonegap.media","prepare",[this.id,this.src])};Media.prototype.startRecord=function(){PhoneGap.exec(null,null,"com.phonegap.media","startAudioRecord",[this.id,this.src])};Media.prototype.stopRecord=function(){PhoneGap.exec(null,null,"com.phonegap.media","stopAudioRecord",[this.id,this.src])};Media.prototype.release=function(){PhoneGap.exec(null,null,"com.phonegap.media","release",[this.id,this.src])}}if(!PhoneGap.hasResource("notification")){PhoneGap.addResource("notification");Notification=function(){};Notification.prototype.alert=function(c,d,f,e){var b=f;if(f==null||typeof f==="undefined"){b="Alert"}var a=(e||"OK");PhoneGap.exec(d,null,"com.phonegap.notification","alert",[c,{title:b,buttonLabel:a}])};Notification.prototype.confirm=function(c,a,f,d){var b=(f||"Confirm");var e=(d||"OK,Cancel");this.alert(c,a,b,e)};Notification.prototype.blink=function(a,b){};Notification.prototype.vibrate=function(a){PhoneGap.exec(null,null,"com.phonegap.notification","vibrate",[])};Notification.prototype.beep=function(b,a){new Media("beep.wav").play()};PhoneGap.addConstructor(function(){if(typeof navigator.notification=="undefined"){navigator.notification=new Notification()}})}if(!PhoneGap.hasResource("orientation")){PhoneGap.addResource("orientation");Orientation=function(){this.currentOrientation=null};Orientation.prototype.setOrientation=function(a){Orientation.currentOrientation=a;var b=document.createEvent("Events");b.initEvent("orientationChanged","false","false");b.orientation=a;document.dispatchEvent(b)};Orientation.prototype.getCurrentOrientation=function(a,b){};Orientation.prototype.watchOrientation=function(a,b){this.getCurrentPosition(a,b);return setInterval(function(){navigator.orientation.getCurrentOrientation(a,b)},10000)};Orientation.prototype.clearWatch=function(a){clearInterval(a)};Orientation.install=function(){if(typeof navigator.orientation=="undefined"){navigator.orientation=new Orientation()}var d=!(window.dispatchEvent===undefined);if(d){return}var a=this;var b="orientationchange";var f="orientationchange_pg";var c=window.addEventListener;var e=window.removeEventListener;window.onorientationchange=function(){PhoneGap.fireEvent(f,window)};window.addEventListener=function(){if(arguments[0]===b){arguments[0]=f}if(!d){return document.addEventListener.apply(this,arguments)}else{return c.apply(this,arguments)}};window.removeEventListener=function(){if(arguments[0]===b){arguments[0]=f}if(!d){return document.removeEventListener.apply(this,arguments)}else{return e.apply(this,arguments)}}};PhoneGap.addConstructor(Orientation.install)}if(!PhoneGap.hasResource("sms")){PhoneGap.addResource("sms");Sms=function(){};Sms.prototype.send=function(e,d,a,b,c){};PhoneGap.addConstructor(function(){if(typeof navigator.sms=="undefined"){navigator.sms=new Sms()}})}if(!PhoneGap.hasResource("telephony")){PhoneGap.addResource("telephony");Telephony=function(){};Telephony.prototype.call=function(a){};PhoneGap.addConstructor(function(){if(typeof navigator.telephony=="undefined"){navigator.telephony=new Telephony()}})}if(!PhoneGap.hasResource("network")){PhoneGap.addResource("network");Connection=function(){this.type=Connection.UNKNOWN;try{this.type=DeviceInfo.connection.type}catch(a){}};Connection.UNKNOWN="unknown";Connection.ETHERNET="ethernet";Connection.WIFI="wifi";Connection.CELL_2G="2g";Connection.CELL_3G="3g";Connection.CELL_4G="4g";Connection.NONE="none";PhoneGap.addConstructor(function(){if(typeof navigator.network=="undefined"){navigator.network={}}if(typeof navigator.network.connection=="undefined"){navigator.network.connection=new Connection()}})}if(!PhoneGap.hasResource("splashscreen")){PhoneGap.addResource("splashscreen");SplashScreen=function(){};SplashScreen.prototype.show=function(){PhoneGap.exec(null,null,"com.phonegap.splashscreen","show",[])};SplashScreen.prototype.hide=function(){PhoneGap.exec(null,null,"com.phonegap.splashscreen","hide",[])};PhoneGap.addConstructor(function(){if(typeof navigator.splashscreen=="undefined"){navigator.splashscreen=new SplashScreen()}})}(function(){function a(){if(wooga.castle.config){wooga.castle.config.wrapperIOS=true}var b=wooga.castle.utils;if(window.devicePixelRatio===2){document.querySelector("[name=viewport]").setAttribute("content","initial-scale=0.5, maximum-scale=0.5, user-scalable=no;")}if(navigator.userAgent.indexOf("iPad")!==-1){b.addClass(document.body,"ipad")}if(window.orientation===0||window.orientation===180){b.removeClass(document.body,"landscape")}else{b.addClass(document.body,"landscape")}}window.addEventListener("load",function(){document.addEventListener("deviceready",a,false)},false);window.addEventListener("orientationchange",function(){},false)}());(function(){if(typeof PhoneGap!=="undefined"){var a=function(){};a.prototype.add=function(b){var d={date:false,message:"",hasAction:true,action:"View",badge:0,id:0};var c;for(c in d){if(d.hasOwnProperty(c)){if(typeof b[c]!=="undefined"){d[c]=b[c]}}}if(typeof d.date==="object"){d.date=Math.round(d.date.getTime()/1000)}PhoneGap.exec("LocalNotification.addNotification",d)};a.prototype.cancel=function(b){PhoneGap.exec("LocalNotification.cancelNotification",b)};a.prototype.cancelAll=function(b){PhoneGap.exec("LocalNotification.cancelAllNotifications")};PhoneGap.addConstructor(function(){if(!window.plugins){window.plugins={}}window.plugins.localNotification=new a()})}}());(function(){var b=wooga.castle.utils;function a(d,e){wooga.castle.Entity.call(this,d,e);this.x=this.definition.x;this.y=this.definition.y;this.trees=false;var c=this.definition.contract.requiredTime;this.contract={requiredTime:c};this.contractStartTime=e.contractStartTime;this.contractState=e.contractState||"inactive"}b["extends"](a,wooga.castle.Entity);a.prototype.spawnTrees=function(e){var g,d,f,c,n,h=e?e.x+e.width:null,k=e?e.y+e.height:null;this.trees=this.trees||[];for(g=this.x,d=this.x+this.definition.width,f,c,0;g<d;g++){for(c=this.y+this.definition.height,f=this.y;f<c;f++){if(!e||((e.x>g||g>h)||(e.y>=f||f>k))){if(Math.random()>0.425){n={invalidate:false,key:wooga.castle.Spawner.getRandomTreeKey(),x:g,y:f};if(!this.game.isAreaOnCoast({x:n.x,y:n.y,width:2,height:1})){b.publish("spawn at location",n);this.trees.push(n.spawned)}}}}}this.entityView.invalidatePosition()};a.prototype.unlock=function(){var c=(function(e,f){var d=e.entities.filter(function(g){return g.definition["class"]==="statichouse"&&g.x>=f.x&&g.x+g.definition.width<=f.x+f.definition.width&&g.y>=f.y&&g.y+(g.definition.height+(g.definition.offsetY||0))<=f.y+f.definition.height});return d[0]}(this.game,this));if(c){this.spawnTrees({x:c.x-2,y:c.y+(c.definition.offsetY||0),height:c.definition.height,width:c.definition.width+1})}else{this.spawnTrees()}this.fireEvent("unlock");wooga.castle.utils.publish("game:unlockable/unlock",{entity:this});wooga.castle.game.removeEntity(this)};a.prototype.startContract=function(){this.contractStartTime=(new Date()).getTime();this.contractState="started";this.countdown();wooga.castle.utils.publish("game:contract/start",{entity:this,contract:this.contract})};a.prototype.finishContract=function(){this.contractState="finished";this.contractTimeLeft=0;delete this.contractStartTime;var c=this.contract;wooga.castle.utils.publish("game:contract/update",{entity:this,contract:c,update:{state:"finished"}});this.fireEvent("finishContract")};a.prototype.countdown=function(){var c=setInterval(b.bind(function(){var d=(new Date().getTime())-this.contractStartTime;if(d<=this.contract.requiredTime){this.contractTimeLeft=this.contract.requiredTime-d;this.fireEvent("countdown")}else{clearInterval(c);this.finishContract()}},this),1000)};a.prototype.toSerializable=function(){var c=this.parent.prototype.toSerializable.call(this);c.contract=this.contract;c.contractStartTime=this.contractStartTime;c.contractState=this.contractState;return c};wooga.castle.UnlockableArea=a;b.subscribe("game/ready",function(){var d=wooga.castle.game.getPopulation();var c=(new Date().getTime());wooga.castle.game.entities.forEach(function(f){if(f.is("unlockable")){if(f.contractStartTime){if(f.contractStartTime+f.contract.requiredTime>c){f.countdown()}else{f.finishContract()}}else{if(f.definition.unlock<=d){f.unlock()}}}});b.subscribe("game:unlockable/keyTouch",function(){var e=wooga.castle.game.getPopulation();wooga.castle.game.entities.forEach(function(f){if(f.is("unlockable")&&f.definition.unlock<=e){f.startContract()}})})})}());(function(){var b=wooga.castle.utils,a=wooga.castle.GRID_UNIT;function c(d,e){wooga.castle.EntityView.call(this,d,e);this.entity.addEventHandler("unlock",this.onUnlock,this);this.entity.addEventHandler("countdown",this.countdown,this);this.entity.addEventHandler("finishContract",this.finishContract,this);this.nth=this.entity.key.replace(/\D/g,"");this.wasScrolledOn=false;this.addEventHandler("dragend",function(){this.wasScrolledOn=true},this);this.addEventHandler("touchend",function(){if(!this.wasScrolledOn){if(this.entity.contractTimeLeft===0){this.entity.unlock()}else{var g=this.entity.definition.unlock-wooga.castle.game.getPopulation();if(g>0){var f="You need "+g+" more houses to unlock this area!";if(g===1){f=f.replace("houses","house")}wooga.notify(f,"unlockies")}}}this.wasScrolledOn=false},false)}b["extends"](c,wooga.castle.EntityView);c.prototype.draw=function(e,d,h){var f=document.createElement("figure"),g=this.setupDomNode(f);g.setupDomNodeTitle(f);g.setupDomNodePopulationForUnlock(f.querySelector("header"));document.getElementById("game_overlay").appendChild(f);this.domNode=f;this.domTextNode=f.querySelector("div p");this.draw=function(){}};c.prototype.countdown=function(){this.domTextNode.innerHTML="Revealed in "+b.formatTime(this.entity.contractTimeLeft)};c.prototype.finishContract=function(){this.domTextNode.innerHTML="Touch to reveal the area";wooga.notify(this.entity.definition.name+" is ready to be revealed!","discover")};c.prototype.setupDomNode=function(e){var d=e.style;b.addClass(e,"unlockable-dom-node");e.setAttribute("data-zone-number",this.nth);d.left=this.x+"px";d.top=this.y+"px";d.width=this.width+"px";d.height=this.height+"px";d.backgroundImage="url("+this.image.src+")";d.backgroundPosition=this.entity.definition.spritex*a+"px "+this.entity.definition.spritey*a+"px";e.addEventListener("webkitAnimationEnd",b.bind(function(){this.domNode.style.display="none"},this),false);e.id="unlockable-"+this.nth;return this};c.prototype.setupDomNodeTitle=function(e){var d=document.createElement("header");e.appendChild(d);var f=document.createElement("h1");f.innerHTML=this.entity.definition.name.replace(/^\d\s\-/,"");f.setAttribute("data-zone-number",this.nth);d.appendChild(f);return this};c.prototype.setupDomNodePopulationForUnlock=function(d){var e=document.createElement("div");e.innerHTML="<p>Unlocked at population "+this.entity.definition.unlock;d.appendChild(e);return this};c.prototype.onUnlock=function(){b.addClass(this.domNode,"unlocked");wooga.notify("You have unlocked "+this.entity.definition.name,"discover")};wooga.castle.UnlockableAreaView=c}());(function(){var a=wooga.castle.utils;wooga.castle.UnlockableAreaKeyHandler=function(b){a.subscribe("game:population/change",function(d){var c=b.getPopulation();b.entities.forEach(function(h){if(h.is("unlockable")&&h.definition.unlock===c&&h.contractState==="inactive"){var f="unlockable-"+h.entityView.nth;b.updateMapData();var g={entity:d,entityView:d.entityView,destination:f};b.publish("house/throwOutKey",g);setTimeout(g.element._click,10*1000)}})})}}());(function(c){var b=c.utils;function a(d,e){c.House.apply(this,arguments)}b["extends"](a,c.House);a.prototype.activateContract=function(){c.House.prototype.activateContract.call(this);this.startContract()};a.prototype.collectContract=function(d){c.House.prototype.collectContract.call(this,d);this.startContract()};a.prototype.unpauseContract=function(){c.House.prototype.unpauseContract.call(this);if(this.contractState===c.House.ContractState.IDLE){this.startContract()}};a.prototype.getCallableName=function(){return"house"};a.prototype.toSerializable=function(){var d=c.House.prototype.toSerializable.call(this);d.contract={state:this.contractState,startTime:this.contractStartTime,pauseTime:this.contractPauseTime};return d};c.UnfoodedHouse=a}(wooga.castle));(function(c){var a=c.utils;function b(d,e){c.UnfoodedHouse.call(this,d,e);this.draggable=false;this.contractPauseTime=this.contractPauseTime||0;this.isHidden=(typeof e.isHidden!=="undefined")?e.isHidden:true}a["extends"](b,c.UnfoodedHouse);b.prototype.getProperName=function(){return this.connected?this.parent.prototype.getProperName.call(this):"Mysterious Building"};b.prototype.disconnect=function(d){if(d){this.entityView.changeStateImages(false)}c.House.prototype.disconnect.call(this,d)};b.prototype.connect=function(d){this.entityView.changeStateImages(true);c.House.prototype.connect.call(this,d)};c.SpecialBuilding=b}(wooga.castle));(function(b){var a=wooga.castle.utils;function c(d,e){b.HouseView.call(this,d,e);this.actions={};this.entity=e;this.hiddenImageDef=this.view.game.entitiesDefinition[this.entity.key+"-hidden"];this.hiddenImage=this.hiddenImageDef.image;this.hiddenImageWidth=this.hiddenImageDef.width;this.hiddenImageHeight=this.hiddenImageDef.height;this.unlockedImageDef=this.view.game.entitiesDefinition[this.entity.key];this.unlockedImage=this.unlockedImageDef.image;this.unlockedImageWidth=this.unlockedImageDef.width;this.unlockedImageHeight=this.unlockedImageDef.height}a["extends"](c,b.HouseView);c.prototype.changeStateImages=function(e){this.invalidate();if(this.entity.isHidden&&!e){this.image=this.hiddenImage;var d=this.view.gridUnit;this.x+=(this.unlockedImageWidth-this.hiddenImageWidth)*d;this.y+=(this.unlockedImageHeight-this.hiddenImageHeight)*d;this.updateImageFrame(this.hiddenImageWidth,this.hiddenImageHeight)}else{var f=this.view.game.entitiesDefinition[this.entity.key];f.image=this.unlockedImage;this.image=this.unlockedImage;this.updateImageFrame(this.unlockedImageWidth,this.unlockedImageHeight);if(this.entity.isHidden){this.notifyDiscover()}this.entity.isHidden=false;wooga.castle.game.publish("player/update")}};c.prototype.notifyDiscover=function(){var d="the ";if(this.entity.key==="buildings/ozzystent"){d=""}wooga.notify("You have rescued "+d+this.entity.definition.name,"discover")};c.prototype.updateImageFrame=function(f,d){var e=this.view.gridUnit;this.defaultImageFrame.width=f*e;this.defaultImageFrame.height=d*e;this.image.height=f*e;this.image.width=d*e};b.SpecialBuildingView=c}(wooga.castle));(function(b){function a(c,d){b.Whackable.call(this,c,d);if(!arguments.length){return this}}b.utils["extends"](a,wooga.castle.Whackable);b.Rock=a}(wooga.castle));(function(){function b(c,d){wooga.castle.Whackable.call(this,c,d);if(!arguments.length){return this}}var a=wooga.castle.utils;wooga.castle.utils["extends"](b,wooga.castle.Whackable);b.prototype.reward=function(c){wooga.castle.Whackable.prototype.reward.call(this,c);if("complete"===c&&Math.random()<0.25){var d=["characters/troll","characters/giant","characters/goblins","decorations/flower_daisy","decorations/flower_rose","decorations/flower_dalia","decorations/flower_sunflower"];a.publish("spawn at location",{key:d[Math.floor(Math.random()*d.length)],x:this.x,y:this.y})}};wooga.castle.Tree=b}());document.addEventListener("DOMContentLoaded",function(){wooga.castle.DEV=wooga.castle.DEV||false;function b(c){return document.querySelector(c)}function a(e,c){var d=b(e);if(d){d.addEventListener("click",function(f){f.preventDefault();f.stopPropagation();c(f);return false},false)}else{window.alert("id: "+e+" not found")}}a("#dev-menu button.cancel",function(){b("#dev-menu").classList.remove("active")});a("#coins",function(){b("#dev-menu").classList.add("active")});a("button[name=clear_storage]",function(c){if(window.confirm("All your progress will be loose. Continue?")){wooga.castle.Storage.clear();window.location.reload()}});a("button[name=giveme_xp]",function(){wooga.castle.xp.addXP(70)});a("button[name=reload]",function(c){window.location.reload()});a("button[name=activate_fast]",function(c){var d;for(d in wooga.castle.entityDefinitions){if(wooga.castle.entityDefinitions.hasOwnProperty(d)){var e=wooga.castle.entityDefinitions[d];if(e.contract){e.contract.requiredTime*=0.0001}}}b("button[name=activate_fast]").disabled=true});a("button[name=giveme_money]",function(c){wooga.castle.playerData.gold+=10000});a("button[name=giveme_food]",function(c){wooga.castle.playerData.food+=5000});a("button[name=reconnect]",function(d){var c=window.cookie;var e=window.prompt("Insert an url WITHOUT the 'http://'",c);if(e){window.cookie=e;window.location="http://"+e}});a("button[name=unlock]",function(c){wooga.castle.game.entities.filter(function(d){return d.definition["class"]==="unlockable"}).forEach(function(d){d.unlock();d.game.removeEntity(d);wooga.castle.game.worldView.removeEntityView(d.entityView)})});a("button[name=untree]",function(c){wooga.castle.game.entities.filter(function(d){return(/tree/i).test(d.key)}).forEach(function(d){d.game.removeEntity(d);d.entityView.view.removeEntityView(d.entityView)})});document.querySelector("#dev-menu h2").innerHTML=window.wooga.castle.version});(function(c){var a=c.utils,b={},d={};d._grabAttention=function(h,g){var f=this.element||this.node,e="grab-attention";a.addClass(f,e);window.setTimeout(function(){a.removeClass(f,e);if(h){h.call(g)}},3000);return this};d._setAttentionGrabberTimeout=function(){var f=this.element||this.node,e={handleEvent:a.bind(function(g){this._setAttentionGrabberTimeout()},this)};if(!this._shaker){this._shaker=a.bind(function(){this._grabAttention(this._setAttentionGrabberTimeout,this)},this);f.addEventListener("click",e,true);f.addEventListener("touchstart",e,true)}this._clearAttentionGrabberTimeout()._shaker_timeout=window.setTimeout(this._shaker,7000);return this};d._clearAttentionGrabberTimeout=function(){if(this._shaker_timeout){window.clearTimeout(this._shaker_timeout)}return this};a.mixin(c.GoalScreen,d);a.mixin(c.Shop,d);a.mixin(c.CastleCompleteScreen,d);a.subscribe("game/ready",function(e){if(c.playerData.doneTutorial){[].forEach.call(document.querySelectorAll(".comic, .intro"),function(f){if(f&&f.parentNode){f.parentNode.removeChild(f)}})}a.subscribe("game:moveMode/activated",function(){this.inMoveMode=true},b);a.subscribe("game:moveMode/deactivated",function(){this.inMoveMode=false},b);a.subscribe("view:goals/show",function(f){f.screen._setAttentionGrabberTimeout()});a.subscribe("view:goals/close",function(f){f.screen._clearAttentionGrabberTimeout()});a.subscribe("view:shop/visible",function(f){f.shop._setAttentionGrabberTimeout()});a.subscribe("view:shop/hidden",function(f){f.shop._clearAttentionGrabberTimeout()});a.subscribe("view:castle-upgrade/show",function(f){f.screen._setAttentionGrabberTimeout()});a.subscribe("view:castle-upgrade/hide",function(f){f.screen._clearAttentionGrabberTimeout()})})}(wooga.castle));(function(d){var b=d.utils;var c={};function a(h,f){var e=document.getElementById("game"),j,k,g="channel-"+f;if(c[g]&&c[g].div&&b.hasClass(c[g].div,g)){k=c[g].div;clearTimeout(c[g].timeout);k.innerHTML=h;c[g].timeout=setTimeout(c[g].fn,6*1000);e.appendChild(k)}else{c[g]={};k=document.createElement("div");k.className="notification channel-"+f;k.innerHTML=h;c[g].div=k;e.appendChild(k);j="translate("+(k.offsetWidth+20)+"px, 0)";c[g].fn=function(){if(c[g]){b.removeOnTransitionEnd(c[g].div);c[g].div.style.webkitTransform=j;delete c[g].fn;delete c[g].div;delete c[g]}};k.style.webkitTransform=j;k.addEventListener("webkitTransitionEnd",function(l){if(c[g]){c[g].timeout=setTimeout(c[g].fn,6*1000)}},false);k.style.visibility="visible";window.setTimeout(function(){b.addClass(k,"ready");k.style.webkitTransform="translate(0px,0)"},1)}}d.Notifier={show:a}}(wooga.castle));(function(){var b=wooga.castle.PathFinder=function(){};var c=function(d){var e=d.definition["class"];return e==="house"||e==="uhouse"};var a=function(d){return d.key==="paths/road"};b.initRoadsGraph=function(){var d=wooga.castle.RoadsMode.getRoadRootPosition(wooga.castle.game.castle);return b.generateGraph(wooga.castle.game.gridMap,d.x,d.y,null,Math.random())};b.generateGraph=function(k,j,g,h,d){if(k[g]&&k[g][j]){var l=k[g][j];if(l.dirtyFlag!==d){var e=l.filter(a)[0];l.dirtyFlag=d;if(e){var n=[];var m={entity:e,distance:h?Infinity:0,neighbors:n};if(h){n.push(h)}var f=[{x:j,y:g-1},{x:j+1,y:g},{x:j,y:g+1},{x:j-1,y:g}];f.forEach(function(p){var o=b.generateGraph(k,p.x,p.y,m,d);if(o){n.push(o)}});l.node=m;return m}}}};b.calculateDistances=function(d){d.neighbors.forEach(function(e){if(d.distance+1<e.distance){e.distance=d.distance+1;b.calculateDistances(e)}})};b.findPath=function(g,e){var f=e;var d=[f];var h=function(j){if(j.distance===f.distance-1){f=j;d.push(f)}};while(f.distance>0){f.neighbors.forEach(h)}return d.reverse()};b.findHouseConnections=function(k,d,l,e){l=l||[];e=e||Math.random();var f=[];var j=d.entity.x;var h=d.entity.y;if(k[h]&&k[h][j]){var m=k[h][j];if(m.connectedRoadDirtyFlag!==e){m.connectedRoadDirtyFlag=e;var g=[{x:j,y:h-1},{x:j,y:h+1},{x:j-1,y:h},{x:j+1,y:h}];g.forEach(function(r){if(k[r.y]&&k[r.y][r.x]){var q=k[r.y][r.x];var p=q.filter(c);if(p.length){if(l.indexOf(p[0])===-1){l.push(p[0]);f.push(d)}}else{var n=q.filter(a)[0];if(n){var o=b.findHouseConnections(k,q.node,l,e);Array.prototype.push.apply(f,o)}}}})}}return f}}());(function(){var a=wooga.castle.utils;var b=wooga.castle.People=function(c){this._game=c;this.entities=[];this.updateGraph();this.addEventHandler("path walked",function(d){d.target.remove();this.respawn()},this);this.addEventHandler("remove",function(d){this.entities.splice(this.entities.indexOf(d.target),1)},this);wooga.castle.subscribe("game/ready",this.initPopulation,this);c.subscribe("tutorial/done",this.resetPopulation,this);c.subscribe("building/connected",this.resetPopulation,this);c.subscribe("building/disconnected",this.resetPopulation,this);c.subscribe("road/add",this.updateGraph,this);c.subscribe("road/remove",this.updateGraph,this)};a.mixin(b,a.ObservableMixin);b.prototype.updateGraph=function(){var c=wooga.castle.PathFinder;this.graph=c.initRoadsGraph();c.calculateDistances(this.graph)};b.prototype.spawn=function(){var f=wooga.castle.PathFinder;var k=f.findHouseConnections(this._game.gridMap,this.graph);if(k.length){var e=wooga.castle.RoadsMode.getRoadRootPosition(this._game.castle);var h=[],d,g,c,j;for(g=0,c=Math.min(k.length,2);g<c;g++){d=k.splice(Math.floor(Math.random()*k.length),1)[0];j=f.findPath(this.graph,d);h.push({x:e.x,y:e.y,delay:(g+1)*6000+Math.random()*1500,path:j,speed:0.05})}this.generateGroup(h)}};b.prototype.respawn=function(){if(!this.entities.length){var c=this;c.spawnTimeout=setTimeout(function(){c.spawn()},6000+Math.random()*1500)}};b.prototype.initPopulation=function(){if(this._game.playerData.doneTutorial){this.spawn()}};b.prototype.resetPopulation=function(){this.removePopulation();this.initPopulation()};b.prototype.generateGroup=function(c){c.forEach(function(d){this.generatePerson(d)},this)};b.prototype.generatePerson=function(d){var c=new wooga.castle.Person(this,d);this.entities.push(c);return c};b.prototype.removePopulation=function(){clearTimeout(this.spawnTimeout);while(this.entities.length){this.entities[this.entities.length-1].remove()}}}());(function(){var a=wooga.castle.PeopleView=function(c,f,b){this._people=c;this._worldView=f;this._gameModesManager=b;this.id="people view";this.x=0;this.y=0;this.width=f.mapWidthPx;this.height=f.mapHeightPx;this.views=[];var e=false;c.addEventHandler("create",function(g){if(g.target instanceof wooga.castle.Person){this.createPersonView(g.target);e=true}},this);c.addEventHandler("remove",function(h){var g;this.views.forEach(function(j,k){if(h.target===j.entity){g=k}});this.views.splice(g,1);e=true},this);c.addEventHandler("move",function(){if(this.canDraw()){this._worldView.enableRendering()}e=true},this);c.entities.forEach(this.createPersonView,this);var d=this;setInterval(function(){if(e&&d.canDraw()){d.updateRenderingPath();e=false}},250);this.updateRenderingPath();this.addToWorldView()};a.prototype.canDraw=function(){return !this._worldView.isScrolling&&this._gameModesManager.mode===wooga.castle.GameModesManager.Mode.BASIC};a.prototype.addToWorldView=function(){this._worldView.entitiesViews[this.id]=this;this._worldView.filterVisibleViews()};a.prototype.createPersonView=function(b){this.views.push(new wooga.castle.PersonView(b,this._worldView))};a.prototype.drawStatic=function(){};a.prototype.drawDynamic=function(){if(this.canDraw()){this.draw()}};a.prototype.draw=function(){var b=this._worldView.ctx,g=this._worldView.scrollLeft,f=this._worldView.scrollTop,d,e,c;b.save();b.beginPath();this.views.forEach(function(h){b.rect(h.x+g,h.y+f,h.width,h.height)});b.clip();this.renderingPath.forEach(function(h){h.draw(b,h.x+g,h.y+f)});b.restore()};a.prototype.updateRenderingPath=function(){var g=[];var e=wooga.castle.GRID_UNIT;var f,d,b,c;this.views.forEach(function(h){c=a.getHitMapCells(h.x,h.y,h.width,h.height,e);for(d=c.startY;d<c.endY;d+=e){for(f=c.startX;f<c.endX;f+=e){wooga.castle.utils.pushIfUnique(g,this._worldView.hitMap[d][f])}}g.push(h)},this);this.renderingPath=g.sort(a.zIndexSort)};a.getHitMapCells=function(g,f,b,j,c){var e=g-g%c;var k=g+b;if(k%c){k+=c-k%c}var d=f-f%c;var h=f+j;if(h%c){h+=c-h%c}return{startX:e,endX:k,startY:d,endY:h}};a.zIndexSort=function(d,c){var e=wooga.castle.GRID_UNIT;var g=d.y+d.height;var f=c.y+c.height;if(g%e){g-=g%e-e}if(f%e){f-=f%e-e}return g-f||d.zIndex-c.zIndex}}());(function(){var a=wooga.castle.utils;var b=wooga.castle.Person=function(c,d){this.eventsBubbleTarget=c;this.id=Math.random();this.definition=wooga.castle.entityDefinitions[b.DEFINTION_URI];this.x=d.x;this.y=d.y;this.speed=d.speed;this.width=this.definition.width;this.height=this.definition.height;this.walkDirection=0;var e=this;var f=function(){e.fireEvent("create");if(d.path){e.walk(d.path)}};if(d.delay){this.timeout=setTimeout(function(){f()},d.delay)}else{f()}};b.WalkDirection={TOP:1,RIGHT:2,DOWN:3,LEFT:4};b.DEFINTION_URI="characters/person-skin";a.mixin(b,a.ObservableMixin);b.prototype.snapToGrid=function(){this.x=Math.round(this.x);this.y=Math.round(this.y);this.fireEvent("move")};b.prototype.updateWalkDirection=function(d,c){if(d.x===c.x&&d.y<c.y){return b.WalkDirection.TOP}if(d.x>c.x&&d.y===c.y){return b.WalkDirection.RIGHT}if(d.x===c.x&&d.y>c.y){return b.WalkDirection.DOWN}if(d.x<c.x&&d.y===c.y){return b.WalkDirection.LEFT}return false};b.prototype.walk=function(k){var g=this;var c=function(l){return Math.round(g.x*10)/10===l.x&&Math.round(g.y*10)/10===l.y};var d=0,h,f;var j=k[d].entity;var e=function(){if(c(j)){d++;if(!k[d]){g.snapToGrid();g.fireEvent("path walked");return}var l=g.updateWalkDirection(k[d].entity,k[d-1].entity);if(l){g.fireEvent("update walk direction",{direction:l})}j=k[d].entity;h=(j.x-g.x)*g.speed;f=(j.y-g.y)*g.speed}g.x+=h;g.y+=f;g.fireEvent("move");g.walkTimeout=setTimeout(e,33)};e()};b.prototype.remove=function(){clearTimeout(this.timeout);clearTimeout(this.walkTimeout);this.fireEvent("remove")}}());(function(){var a=wooga.castle.PersonView=function(b,c){this.definition=wooga.castle.entityDefinitions[wooga.castle.Person.DEFINTION_URI];this.entity=b;this.zIndex=this.definition.zIndex||0;this._worldView=c;this.width=b.width*wooga.castle.GRID_UNIT;this.height=b.height*wooga.castle.GRID_UNIT;this.image=this.definition.image;this.spriteRatio=1.3125;this.frameWidth=this.image.width/this.definition.animationLength;this.frameHeight=this.definition.height*this._worldView.gridUnit*this.spriteRatio;this.frameIndex=0;this.color=Math.floor(Math.random()*1000)%5;this.frameX=0;this.frameY=(this.spriteRatio*this._worldView.gridUnit)*this.color*2;b.addEventHandler("move",function(){this.updatePosition(b,this._worldView)},this);b.addEventHandler("update walk direction",function(d){this.updateImage(d.direction)},this)};a.prototype.updatePosition=function(){this.x=(this.entity.x*wooga.castle.GRID_UNIT+this._worldView.mapWidthPx/2)|0;this.y=(this.entity.y*wooga.castle.GRID_UNIT+this._worldView.mapHeightPx/2)|0};a.prototype.updateImage=function(b){switch(b){case wooga.castle.Person.WalkDirection.RIGHT:this.frameY=(this._worldView.gridUnit*this.spriteRatio*this.color*2)+this._worldView.gridUnit*this.spriteRatio;break;case wooga.castle.Person.WalkDirection.LEFT:this.frameY=(this.spriteRatio*this._worldView.gridUnit*this.color*2);break}};a.prototype.draw=function(c,b,d){b+=Math.sin(Date.now()/50);d+=Math.sin(Date.now()/50);c.drawImage(this.image,this.frameX,this.frameY,this.frameWidth,this.frameHeight,b,d,this.width,this.height)};a.prototype.drawStatic=function(){};a.prototype.drawDynamic=function(){}}());(function(a){var b=function(c){this.message={item:c.item,entityView:c.entityView,element:null,drop:this};a.utils.publish("house/drop",this.message);a.playerData.collectedItems.push(c.item);a.utils.publish("request save");this.config=c;this.item=c.item;setTimeout(this.message.element._click,10*1000);a.utils.subscribe("game:drydock/started-stage-repair",function(d){if(d.entity.definition.requiredItem===this.item){this.message.element._click()}},this)};a.utils.subscribe("game/ready",function(){a.utils.subscribe("game:contract/collect",function(d){if(!d.entity.is("statichouse")){return}var e={item:d.entity.definition.drops,entity:d.entity},c;a.utils.publish("game:drydock/get required item",e);if(e.item&&a.playerData.collectedItems.indexOf(e.item)===-1){c=new b({item:e.item,entityView:d.entityView,entity:d.entity})}})});a.Drop=b}(wooga.castle));